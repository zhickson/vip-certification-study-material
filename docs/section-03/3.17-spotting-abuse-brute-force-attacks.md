# 3.17 Spotting Abuse and Brute Force Attacks - Study Notes

## Overview

Detecting brute force and abuse attacks requires monitoring login attempts, analyzing traffic patterns, and identifying suspicious activity. Early detection helps prevent successful attacks.

**Key Reference:** [WordPress Security - WordPress Codex](https://codex.wordpress.org/Hardening_WordPress)

---

## 1. Identifying Brute Force Attacks

### Login Attempt Patterns

**Signs of Brute Force:**
- Multiple failed login attempts from same IP
- Attempts with common usernames (admin, administrator)
- Rapid successive attempts
- Attempts from multiple IPs (distributed)

### Monitoring Login Attempts

```php
function log_failed_login( $username ) {
	$ip = $_SERVER['REMOTE_ADDR'];
	$user_agent = $_SERVER['HTTP_USER_AGENT'];
	$time = current_time( 'mysql' );

	// Log to database
	global $wpdb;
	$wpdb->insert(
		$wpdb->prefix . 'failed_logins',
		array(
			'username' => $username,
			'ip' => $ip,
			'user_agent' => $user_agent,
			'time' => $time,
		)
	);

	// Check for brute force pattern
	check_brute_force_pattern( $ip );
}
add_action( 'wp_login_failed', 'log_failed_login' );

function check_brute_force_pattern( $ip ) {
	global $wpdb;

	// Count attempts in last 15 minutes
	$recent_attempts = $wpdb->get_var( $wpdb->prepare(
		"SELECT COUNT(*) FROM {$wpdb->prefix}failed_logins
		WHERE ip = %s AND time > DATE_SUB(NOW(), INTERVAL 15 MINUTE)",
		$ip
	) );

	if ( $recent_attempts >= 5 ) {
		// Block IP
		block_ip( $ip );

		// Alert admin
		wp_mail(
			get_option( 'admin_email' ),
			'Brute Force Attack Detected',
			"IP {$ip} has made {$recent_attempts} failed login attempts."
		);
	}
}
```

---

## 2. Analyzing Logs

### Server Access Logs

**Apache Log Analysis:**
```bash
# Count failed login attempts
grep "wp-login.php" /var/log/apache2/access.log | grep "POST" | wc -l

# Find IPs with most attempts
grep "wp-login.php" /var/log/apache2/access.log | awk '{print $1}' | sort | uniq -c | sort -rn

# Find suspicious patterns
grep "wp-login.php" /var/log/apache2/access.log | grep -E "(admin|administrator)" | awk '{print $1}' | sort | uniq -c
```

**Nginx Log Analysis:**
```bash
# Similar patterns for Nginx
grep "wp-login.php" /var/log/nginx/access.log | awk '{print $1}' | sort | uniq -c | sort -rn
```

### WordPress Error Logs

```php
// Enable error logging
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
define( 'WP_DEBUG_DISPLAY', false );

// Logs to wp-content/debug.log
```

**Analyze Error Logs:**
```bash
# Find authentication errors
grep "authentication" wp-content/debug.log

# Find failed logins
grep "login" wp-content/debug.log | grep -i "fail"
```

---

## 3. Traffic Pattern Analysis

### Unusual Traffic Spikes

```php
function monitor_traffic() {
	$ip = $_SERVER['REMOTE_ADDR'];
	$transient_key = 'traffic_' . md5( $ip );

	$requests = get_transient( $transient_key );
	if ( false === $requests ) {
		$requests = 0;
	}

	$requests++;

	// Alert if more than 100 requests per minute
	if ( $requests > 100 ) {
		error_log( "Suspicious traffic from IP: {$ip} - {$requests} requests/minute" );
	}

	set_transient( $transient_key, $requests, MINUTE_IN_SECONDS );
}
add_action( 'init', 'monitor_traffic' );
```

### Geographic Anomalies

```php
function check_geographic_patterns() {
	$ip = $_SERVER['REMOTE_ADDR'];

	// Get location (using service like ipapi.co)
	$location = get_ip_location( $ip );

	// Check if unusual location
	$expected_countries = array( 'US', 'CA', 'GB' );
	if ( ! in_array( $location['country'], $expected_countries, true ) ) {
		log_suspicious_activity( $ip, 'unusual_location', $location );
	}
}
```

---

## 4. Security Plugins

### Wordfence Security

- Monitors login attempts
- Blocks suspicious IPs
- Alerts on brute force
- Real-time threat intelligence

### iThemes Security

- Brute force protection
- Login attempt limiting
- IP blocking
- Security logging

### Sucuri Security

- Malware scanning
- DDoS protection
- Brute force monitoring
- Security alerts

---

## 5. Custom Detection System

### Complete Brute Force Detection

```php
class Brute_Force_Detector {
	private $max_attempts = 5;
	private $time_window = 15; // minutes
	private $block_duration = 60; // minutes

	public function __construct() {
		add_action( 'wp_login_failed', array( $this, 'log_failed_attempt' ) );
		add_action( 'wp_login', array( $this, 'clear_failed_attempts' ), 10, 2 );
		add_filter( 'authenticate', array( $this, 'check_blocked_ip' ), 5, 3 );
	}

	public function log_failed_attempt( $username ) {
		$ip = $this->get_client_ip();
		$this->record_attempt( $ip, $username );

		if ( $this->is_brute_force( $ip ) ) {
			$this->block_ip( $ip );
			$this->alert_admin( $ip, $username );
		}
	}

	private function record_attempt( $ip, $username ) {
		$transient_key = 'login_attempts_' . md5( $ip );
		$attempts = get_transient( $transient_key );

		if ( false === $attempts ) {
			$attempts = array();
		}

		$attempts[] = array(
			'time' => time(),
			'username' => $username,
		);

		set_transient( $transient_key, $attempts, $this->time_window * MINUTE_IN_SECONDS );
	}

	private function is_brute_force( $ip ) {
		$transient_key = 'login_attempts_' . md5( $ip );
		$attempts = get_transient( $transient_key );

		if ( false === $attempts ) {
			return false;
		}

		// Count recent attempts
		$recent = array_filter( $attempts, function( $attempt ) {
			return ( time() - $attempt['time'] ) < ( $this->time_window * 60 );
		} );

		return count( $recent ) >= $this->max_attempts;
	}

	private function block_ip( $ip ) {
		$transient_key = 'blocked_ip_' . md5( $ip );
		set_transient( $transient_key, true, $this->block_duration * MINUTE_IN_SECONDS );

		// Log to database
		$this->log_blocked_ip( $ip );
	}

	public function check_blocked_ip( $user, $username, $password ) {
		$ip = $this->get_client_ip();
		$transient_key = 'blocked_ip_' . md5( $ip );

		if ( get_transient( $transient_key ) ) {
			return new WP_Error(
				'ip_blocked',
				'Your IP address has been temporarily blocked due to suspicious activity.'
			);
		}

		return $user;
	}

	private function alert_admin( $ip, $username ) {
		wp_mail(
			get_option( 'admin_email' ),
			'Brute Force Attack Detected',
			"IP: {$ip}\nUsername: {$username}\nTime: " . current_time( 'mysql' )
		);
	}

	private function get_client_ip() {
		$ip_keys = array(
			'HTTP_CF_CONNECTING_IP', // Cloudflare
			'HTTP_X_REAL_IP',
			'HTTP_X_FORWARDED_FOR',
			'REMOTE_ADDR',
		);

		foreach ( $ip_keys as $key ) {
			if ( ! empty( $_SERVER[ $key ] ) ) {
				$ip = $_SERVER[ $key ];
				if ( strpos( $ip, ',' ) !== false ) {
					$ip = explode( ',', $ip )[0];
				}
				return trim( $ip );
			}
		}

		return '0.0.0.0';
	}
}

new Brute_Force_Detector();
```

---

## 6. Monitoring Tools

### Query Monitor

- Database query analysis
- HTTP request monitoring
- Performance profiling
- Hook analysis

### Debug Bar

- Query monitoring
- Cache analysis
- Hook inspection
- Performance metrics

### Server Monitoring

**New Relic:**
- Application performance
- Error tracking
- Traffic analysis

**Datadog:**
- Infrastructure monitoring
- Log aggregation
- Alerting

---

## 7. Alerting

### Email Alerts

```php
function send_security_alert( $type, $details ) {
	$subject = "Security Alert: {$type}";
	$message = print_r( $details, true );

	wp_mail(
		get_option( 'admin_email' ),
		$subject,
		$message,
		array( 'Content-Type: text/html; charset=UTF-8' )
	);
}
```

### Slack Integration

```php
function send_slack_alert( $message ) {
	$webhook_url = get_option( 'slack_webhook_url' );

	wp_remote_post( $webhook_url, array(
		'body' => json_encode( array(
			'text' => $message,
		) ),
		'headers' => array(
			'Content-Type' => 'application/json',
		),
	) );
}
```

---

## Exam Tips

### Key Points to Remember

1. **Brute Force Indicators:**
   - Multiple failed logins from same IP
   - Common usernames (admin, administrator)
   - Rapid successive attempts
   - Distributed attempts

2. **Detection Methods:**
   - Log analysis
   - Traffic pattern analysis
   - Security plugins
   - Custom detection systems

3. **Monitoring:**
   - Server access logs
   - WordPress error logs
   - Database logs
   - Application monitoring

4. **Response:**
   - Block suspicious IPs
   - Alert administrators
   - Log incidents
   - Review and adjust

---

## Additional Resources

- [WordPress Security - WordPress Codex](https://codex.wordpress.org/Hardening_WordPress)
- [Brute Force Attacks - OWASP](https://owasp.org/www-community/attacks/Brute_force_attack)
