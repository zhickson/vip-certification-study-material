# 3.5 Access Control Best Practices - Study Notes

## Overview

Access control ensures users can only perform actions they're authorized to perform. WordPress uses capabilities and roles to enforce access control. Following best practices prevents unauthorized access and privilege escalation.

**Key Reference:** [Roles and Capabilities - WordPress Developer Resources](https://developer.wordpress.org/plugins/security/checking-user-capabilities/)

---

## 1. Using current_user_can()

### Basic Capability Checks

```php
// Check if current user has a capability
if ( ! current_user_can( 'edit_posts' ) ) {
	wp_die( 'You do not have permission to edit posts.' );
}

// Proceed with action
$post_id = wp_insert_post( $post_data );
```

### Object-Specific Capability Checks

```php
// Check capability for specific post
if ( ! current_user_can( 'edit_post', $post_id ) ) {
	wp_die( 'You do not have permission to edit this post.' );
}

// Check capability for specific user
if ( ! current_user_can( 'edit_user', $user_id ) ) {
	wp_die( 'You do not have permission to edit this user.' );
}
```

### Core Implementation

```882:912:wordpress/wp-includes/capabilities.php
/**
 * Returns whether the current user has the specified capability.
 *
 * This function also accepts an ID of an object to check against if the capability is a meta capability. Meta
 * capabilities such as `edit_post` and `edit_user` are capabilities used by the `map_meta_cap()` function to
 * map to primitive capabilities that a user or role has, such as `edit_posts` and `edit_others_posts`.
 *
 * Example usage:
 *
 *     current_user_can( 'edit_posts' );
 *     current_user_can( 'edit_post', $post->ID );
 *     current_user_can( 'edit_post_meta', $post->ID, $meta_key );
 *
 * While checking against particular roles in place of a capability is supported
 * in part, this practice is discouraged as it may produce unreliable results.
 *
 * Note: Will always return true if the current user is a super admin, unless specifically denied.
 *
 * @since 2.0.0
 * @since 5.3.0 Formalized the existing and already documented `...$args` parameter
 *              by updating the function signature. The second parameter was changed
 *              from `$args` to `...$args`.
 * @since 5.8.0 Converted to wrapper for the user_can() function.
 *
 * @see WP_User::has_cap()
 * @see map_meta_cap()
 *
 * @param string $capability Capability name.
 * @param mixed  ...$args    Optional further parameters, typically starting with an object ID.
 * @return bool Whether the current user has the given capability. If `$capability` is a meta cap and `$object_id` is
 *              passed, whether the current user has the given meta capability for the given object.
 */
function current_user_can( $capability, ...$args ) {
	return user_can( wp_get_current_user(), $capability, ...$args );
}
```

---

## 2. Capabilities vs Roles

### Why Use Capabilities, Not Roles

```php
// ❌ BAD - Checking role directly
if ( ! in_array( 'administrator', $user->roles, true ) ) {
	wp_die( 'Access denied' );
}

// ✅ GOOD - Checking capability
if ( ! current_user_can( 'manage_options' ) ) {
	wp_die( 'Access denied' );
}
```

**Reasons:**
1. Capabilities are more granular
2. Roles can be changed by plugins
3. Capabilities can be granted/removed independently
4. More flexible and maintainable

---

## 3. Common Capabilities

### Post Capabilities

- `edit_posts` - Edit any post
- `edit_others_posts` - Edit posts by other users
- `edit_published_posts` - Edit published posts
- `publish_posts` - Publish posts
- `delete_posts` - Delete posts
- `delete_others_posts` - Delete posts by other users
- `delete_published_posts` - Delete published posts

### User Capabilities

- `edit_users` - Edit users
- `delete_users` - Delete users
- `create_users` - Create new users
- `list_users` - List users

### Options Capabilities

- `manage_options` - Access settings pages
- `edit_theme_options` - Edit theme options

### Plugin/Theme Capabilities

- `activate_plugins` - Activate plugins
- `install_plugins` - Install plugins
- `edit_plugins` - Edit plugin files
- `switch_themes` - Switch themes
- `edit_themes` - Edit theme files

---

## 4. Meta Capabilities

Meta capabilities are dynamically mapped to primitive capabilities based on context:

```45:880:wordpress/wp-includes/capabilities.php
function map_meta_cap( $cap, $user_id, ...$args ) {
	$caps = array();
```

### Examples

```php
// edit_post is a meta capability
// It maps to:
// - edit_posts (if user owns the post)
// - edit_others_posts (if user doesn't own the post)
// - edit_published_posts (if post is published)
current_user_can( 'edit_post', $post_id );

// edit_user is a meta capability
// It maps to:
// - edit_users (if editing other users)
// - edit_user (if editing self)
current_user_can( 'edit_user', $user_id );
```

---

## 5. Least Privilege Principle

### Grant Minimum Required Access

```php
// ❌ BAD - Granting too much access
if ( current_user_can( 'manage_options' ) ) {
	// Allow access to simple feature
}

// ✅ GOOD - Use specific capability
if ( current_user_can( 'edit_posts' ) ) {
	// Allow access to feature
}
```

### Create Custom Capabilities

```php
// Register custom capability
function register_custom_capabilities() {
	$role = get_role( 'editor' );
	if ( $role ) {
		$role->add_cap( 'manage_custom_feature' );
	}
}
add_action( 'init', 'register_custom_capabilities' );

// Check custom capability
if ( ! current_user_can( 'manage_custom_feature' ) ) {
	wp_die( 'Access denied' );
}
```

---

## 6. Access Control Patterns

### Pattern 1: Admin Pages

```php
function my_admin_page() {
	// Check capability
	if ( ! current_user_can( 'manage_options' ) ) {
		wp_die( 'You do not have permission to access this page.' );
	}

	// Render page
	echo '<div class="wrap">';
	echo '<h1>Admin Page</h1>';
	echo '</div>';
}
```

### Pattern 2: AJAX Handlers

```php
function my_ajax_handler() {
	// Check capability
	if ( ! current_user_can( 'edit_posts' ) ) {
		wp_send_json_error( array( 'message' => 'Permission denied' ) );
	}

	// Process request
	$result = process_request();
	wp_send_json_success( $result );
}
add_action( 'wp_ajax_my_action', 'my_ajax_handler' );
```

### Pattern 3: REST API Endpoints

```php
register_rest_route( 'myplugin/v1', '/endpoint', array(
	'methods' => 'POST',
	'permission_callback' => function() {
		return current_user_can( 'edit_posts' );
	},
	'callback' => function( $request ) {
		// Process request
		return new WP_REST_Response( array( 'success' => true ) );
	},
) );
```

### Pattern 4: Form Processing

```php
function handle_form_submission() {
	// Check nonce first
	if ( ! isset( $_POST['nonce'] ) || ! wp_verify_nonce( $_POST['nonce'], 'form_action' ) ) {
		wp_die( 'Security check failed' );
	}

	// Check capability
	if ( ! current_user_can( 'edit_posts' ) ) {
		wp_die( 'You do not have permission to perform this action.' );
	}

	// Process form
	process_form_data();
}
```

---

## 7. Common Mistakes

### Mistake 1: No Capability Check

```php
// ❌ BAD - No access control
function delete_post() {
	$post_id = $_GET['post_id'];
	wp_delete_post( $post_id );
}

// ✅ GOOD - Check capability
function delete_post() {
	if ( ! current_user_can( 'delete_post', $_GET['post_id'] ) ) {
		wp_die( 'Permission denied' );
	}
	$post_id = absint( $_GET['post_id'] );
	wp_delete_post( $post_id );
}
```

### Mistake 2: Checking Role Instead of Capability

```php
// ❌ BAD
$user = wp_get_current_user();
if ( ! in_array( 'administrator', $user->roles, true ) ) {
	wp_die( 'Access denied' );
}

// ✅ GOOD
if ( ! current_user_can( 'manage_options' ) ) {
	wp_die( 'Access denied' );
}
```

### Mistake 3: Trusting User ID from Request

```php
// ❌ BAD - Trusting user ID from request
$user_id = $_GET['user_id'];
if ( current_user_can( 'edit_user', $user_id ) ) {
	// Still vulnerable - user could change user_id
}

// ✅ GOOD - Validate and check
$user_id = absint( $_GET['user_id'] );
if ( ! current_user_can( 'edit_user', $user_id ) ) {
	wp_die( 'Permission denied' );
}
```

### Mistake 4: Checking Capability After Action

```php
// ❌ BAD - Check after action
wp_delete_post( $post_id );
if ( ! current_user_can( 'delete_post', $post_id ) ) {
	// Too late!
}

// ✅ GOOD - Check before action
if ( ! current_user_can( 'delete_post', $post_id ) ) {
	wp_die( 'Permission denied' );
}
wp_delete_post( $post_id );
```

---

## 8. Best Practices

### 1. Always Check Capabilities

Every action that modifies data should check capabilities:

```php
function update_post_meta() {
	// Check capability
	if ( ! current_user_can( 'edit_post', $post_id ) ) {
		return new WP_Error( 'permission_denied', 'Permission denied' );
	}

	// Proceed
	update_post_meta( $post_id, $key, $value );
}
```

### 2. Use Specific Capabilities

Use the most specific capability possible:

```php
// Instead of manage_options
if ( current_user_can( 'edit_posts' ) ) {
	// More specific
}
```

### 3. Check Before Action

Always check capabilities before performing actions:

```php
if ( ! current_user_can( 'delete_post', $post_id ) ) {
	wp_die( 'Permission denied' );
}
wp_delete_post( $post_id );
```

### 4. Provide Clear Error Messages

```php
if ( ! current_user_can( 'edit_post', $post_id ) ) {
	wp_die( 'You do not have permission to edit this post.', 'Permission Denied', array( 'response' => 403 ) );
}
```

### 5. Use Meta Capabilities for Objects

```php
// For post-specific actions
current_user_can( 'edit_post', $post_id );

// For user-specific actions
current_user_can( 'edit_user', $user_id );
```

---

## Exam Tips

### Key Points to Remember

1. **Always use `current_user_can()`:**
   - Check capabilities, not roles
   - Use meta capabilities for object-specific checks

2. **Least Privilege:**
   - Grant minimum required access
   - Use specific capabilities
   - Create custom capabilities when needed

3. **Check Before Action:**
   - Always check capabilities before performing actions
   - Never trust user input for authorization

4. **Common Capabilities:**
   - `edit_posts` - Edit posts
   - `manage_options` - Access settings
   - `edit_users` - Edit users
   - `activate_plugins` - Activate plugins

5. **Common Mistakes:**
   - No capability check
   - Checking role instead of capability
   - Trusting user input
   - Checking after action

---

## Additional Resources

- [Roles and Capabilities - WordPress Developer Resources](https://developer.wordpress.org/plugins/security/checking-user-capabilities/)
- [Capability vs Role Check - WordPress Codex](https://codex.wordpress.org/Roles_and_Capabilities#Capability_vs_Role_Check)
- Core Files:
  - `wp-includes/capabilities.php` - Capability system
  - `wp-includes/user.php` - User functions
