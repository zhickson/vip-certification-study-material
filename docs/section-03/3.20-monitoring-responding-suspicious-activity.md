# 3.20 Monitoring and Responding to Suspicious Activity - Study Notes

## Overview

Monitoring and responding to suspicious activity involves detecting anomalies, setting up alerts, and implementing automated responses. This topic covers monitoring strategies and incident response procedures.

**Key Reference:** [WordPress Security - WordPress Codex](https://codex.wordpress.org/Hardening_WordPress)

---

## 1. Setting Up Monitoring

### Real-Time Monitoring

```php
function monitor_suspicious_activity() {
	// Check for multiple failed logins
	$failed_logins = get_failed_login_count( $_SERVER['REMOTE_ADDR'] );
	if ( $failed_logins > 5 ) {
		trigger_alert( 'brute_force', array(
			'ip' => $_SERVER['REMOTE_ADDR'],
			'attempts' => $failed_logins,
		) );
	}

	// Check for unusual file modifications
	check_file_integrity();

	// Check for suspicious database queries
	monitor_database_queries();
}
add_action( 'init', 'monitor_suspicious_activity' );
```

### Log Monitoring

```php
function monitor_logs() {
	$log_file = WP_CONTENT_DIR . '/debug.log';

	if ( ! file_exists( $log_file ) ) {
		return;
	}

	$recent_logs = tail_file( $log_file, 100 );

	foreach ( $recent_logs as $log_line ) {
		// Check for security events
		if ( preg_match( '/\[AUTH\].*Failed login/', $log_line ) ) {
			handle_failed_login_alert( $log_line );
		}

		if ( preg_match( '/\[ERROR\].*Database error/', $log_line ) ) {
			handle_database_error_alert( $log_line );
		}
	}
}
```

---

## 2. Detecting Suspicious Patterns

### Unusual Login Patterns

```php
function detect_unusual_logins() {
	global $wpdb;

	// Check for logins from new locations
	$recent_logins = $wpdb->get_results(
		"SELECT * FROM {$wpdb->prefix}security_logs
		WHERE event = 'login_success'
		AND timestamp >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
		ORDER BY timestamp DESC"
	);

	foreach ( $recent_logins as $login ) {
		$location = get_ip_location( $login->ip_address );
		$user_locations = get_user_usual_locations( $login->user_id );

		if ( ! in_array( $location['country'], $user_locations, true ) ) {
			trigger_alert( 'unusual_location', array(
				'user_id' => $login->user_id,
				'location' => $location,
				'ip' => $login->ip_address,
			) );
		}
	}
}
```

### Rapid Changes

```php
function detect_rapid_changes() {
	global $wpdb;

	// Check for many changes in short time
	$recent_changes = $wpdb->get_var(
		"SELECT COUNT(*) FROM {$wpdb->prefix}security_logs
		WHERE event LIKE '%_changed'
		AND user_id = " . get_current_user_id() . "
		AND timestamp >= DATE_SUB(NOW(), INTERVAL 1 HOUR)"
	);

	if ( $recent_changes > 50 ) {
		trigger_alert( 'rapid_changes', array(
			'user_id' => get_current_user_id(),
			'changes' => $recent_changes,
		) );
	}
}
```

---

## 3. Alerting System

### Email Alerts

```php
function trigger_alert( $type, $data ) {
	$subject = "Security Alert: {$type}";
	$message = build_alert_message( $type, $data );

	wp_mail(
		get_option( 'admin_email' ),
		$subject,
		$message,
		array( 'Content-Type: text/html; charset=UTF-8' )
	);

	// Also log
	error_log( "[ALERT] {$type}: " . json_encode( $data ) );
}

function build_alert_message( $type, $data ) {
	$message = "<h2>Security Alert: {$type}</h2>";
	$message .= "<p>Time: " . current_time( 'mysql' ) . "</p>";
	$message .= "<pre>" . print_r( $data, true ) . "</pre>";
	return $message;
}
```

### Slack Integration

```php
function send_slack_alert( $type, $data ) {
	$webhook_url = get_option( 'slack_webhook_url' );

	$payload = array(
		'text' => "Security Alert: {$type}",
		'attachments' => array(
			array(
				'color' => 'danger',
				'fields' => array(
					array(
						'title' => 'Type',
						'value' => $type,
						'short' => true,
					),
					array(
						'title' => 'Time',
						'value' => current_time( 'mysql' ),
						'short' => true,
					),
					array(
						'title' => 'Details',
						'value' => json_encode( $data, JSON_PRETTY_PRINT ),
						'short' => false,
					),
				),
			),
		),
	);

	wp_remote_post( $webhook_url, array(
		'body' => json_encode( $payload ),
		'headers' => array(
			'Content-Type' => 'application/json',
		),
	) );
}
```

---

## 4. Automated Responses

### IP Blocking

```php
function auto_block_ip( $ip, $reason ) {
	// Block IP
	$transient_key = 'blocked_ip_' . md5( $ip );
	set_transient( $transient_key, true, 60 * MINUTE_IN_SECONDS );

	// Log block
	log_to_database( array(
		'event' => 'ip_blocked',
		'details' => array(
			'ip' => $ip,
			'reason' => $reason,
		),
	) );

	// Alert
	trigger_alert( 'ip_blocked', array(
		'ip' => $ip,
		'reason' => $reason,
	) );
}
```

### User Lockout

```php
function lockout_user( $user_id, $reason ) {
	// Add user meta
	update_user_meta( $user_id, 'account_locked', true );
	update_user_meta( $user_id, 'lockout_reason', $reason );
	update_user_meta( $user_id, 'lockout_time', current_time( 'mysql' ) );

	// Log
	log_to_database( array(
		'event' => 'user_locked',
		'object_type' => 'user',
		'object_id' => $user_id,
		'details' => array( 'reason' => $reason ),
	) );

	// Alert
	trigger_alert( 'user_locked', array(
		'user_id' => $user_id,
		'reason' => $reason,
	) );
}
```

---

## 5. Incident Response

### Response Procedures

```php
function handle_security_incident( $incident_type, $data ) {
	switch ( $incident_type ) {
		case 'brute_force':
			// Block IP
			auto_block_ip( $data['ip'], 'Brute force attack' );
			// Alert admin
			trigger_alert( 'brute_force', $data );
			break;

		case 'suspicious_login':
			// Require 2FA
			require_2fa( $data['user_id'] );
			// Alert user
			notify_user( $data['user_id'], 'Suspicious login detected' );
			break;

		case 'file_modification':
			// Alert admin
			trigger_alert( 'file_modification', $data );
			// Check integrity
			verify_file_integrity( $data['file'] );
			break;

		case 'database_error':
			// Log error
			log_to_database( array(
				'event' => 'database_error',
				'details' => $data,
			) );
			// Alert if critical
			if ( $data['critical'] ) {
				trigger_alert( 'database_error', $data );
			}
			break;
	}
}
```

---

## 6. Monitoring Dashboard

### Admin Dashboard Widget

```php
function add_security_dashboard_widget() {
	wp_add_dashboard_widget(
		'security_monitor',
		'Security Monitor',
		'display_security_monitor'
	);
}
add_action( 'wp_dashboard_setup', 'add_security_dashboard_widget' );

function display_security_monitor() {
	global $wpdb;

	// Recent security events
	$recent_events = $wpdb->get_results(
		"SELECT * FROM {$wpdb->prefix}security_logs
		WHERE timestamp >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
		ORDER BY timestamp DESC
		LIMIT 10"
	);

	echo '<h3>Recent Security Events</h3>';
	echo '<table class="widefat">';
	echo '<thead><tr><th>Time</th><th>Event</th><th>User</th><th>IP</th></tr></thead>';
	echo '<tbody>';

	foreach ( $recent_events as $event ) {
		$user = $event->user_id ? get_userdata( $event->user_id ) : null;
		echo '<tr>';
		echo '<td>' . esc_html( $event->timestamp ) . '</td>';
		echo '<td>' . esc_html( $event->event ) . '</td>';
		echo '<td>' . ( $user ? esc_html( $user->user_login ) : 'N/A' ) . '</td>';
		echo '<td>' . esc_html( $event->ip_address ) . '</td>';
		echo '</tr>';
	}

	echo '</tbody></table>';

	// Statistics
	$failed_logins = $wpdb->get_var(
		"SELECT COUNT(*) FROM {$wpdb->prefix}security_logs
		WHERE event = 'login_failed'
		AND timestamp >= DATE_SUB(NOW(), INTERVAL 24 HOUR)"
	);

	echo '<h3>Statistics (Last 24 Hours)</h3>';
	echo '<p>Failed Login Attempts: ' . esc_html( $failed_logins ) . '</p>';
}
```

---

## Exam Tips

### Key Points to Remember

1. **Monitoring:**
   - Real-time monitoring
   - Log analysis
   - Pattern detection
   - Anomaly detection

2. **Alerting:**
   - Email alerts
   - Slack/webhook integration
   - Threshold-based alerts
   - Immediate critical alerts

3. **Automated Response:**
   - IP blocking
   - User lockout
   - Rate limiting
   - Incident handling

4. **Incident Response:**
   - Document procedures
   - Automated responses
   - Manual intervention
   - Post-incident analysis

---

## Additional Resources

- [WordPress Security - WordPress Codex](https://codex.wordpress.org/Hardening_WordPress)
- [Incident Response - OWASP](https://owasp.org/www-community/Incident_Response)
