# 3.7 Securing AJAX and REST API Endpoints - Study Notes

## Overview

AJAX and REST API endpoints are common attack vectors. Properly securing these endpoints requires nonce verification, capability checks, and input validation. This topic covers best practices for securing both AJAX and REST API endpoints.

**Key Reference:** [AJAX in Plugins - WordPress Developer Resources](https://developer.wordpress.org/plugins/javascript/ajax/) | [REST API Handbook - WordPress Developer Resources](https://developer.wordpress.org/rest-api/)

---

## 1. Securing AJAX Endpoints

### Basic AJAX Security Pattern

```php
function my_ajax_handler() {
	// 1. Verify nonce
	check_ajax_referer( 'my_action', 'nonce' );

	// 2. Check capability
	if ( ! current_user_can( 'edit_posts' ) ) {
		wp_send_json_error( array( 'message' => 'Permission denied' ) );
	}

	// 3. Validate and sanitize input
	$post_id = isset( $_POST['post_id'] ) ? absint( $_POST['post_id'] ) : 0;
	if ( ! $post_id ) {
		wp_send_json_error( array( 'message' => 'Invalid post ID' ) );
	}

	// 4. Process request
	$result = process_request( $post_id );

	// 5. Send response
	wp_send_json_success( $result );
}
add_action( 'wp_ajax_my_action', 'my_ajax_handler' );
```

### check_ajax_referer() Function

```1397:1451:wordpress/wp-includes/pluggable.php
if ( ! function_exists( 'check_ajax_referer' ) ) :
	/**
	 * Verifies the Ajax request to prevent processing requests external of the blog.
	 *
	 * @since 2.0.3
	 *
	 * @param int|string   $action    Action nonce.
	 * @param false|string $query_arg Optional. Key to check for the nonce in `$_REQUEST` (since 2.5). If false,
	 *                                `$_REQUEST` values will be evaluated for '_ajax_nonce', and '_wpnonce'
	 *                                (in that order). Default false.
	 * @param bool         $stop      Optional. Whether to stop early when the nonce cannot be verified.
	 *                                Default true.
	 * @return int|false 1 if the nonce is valid and generated between 0-12 hours ago,
	 *                   2 if the nonce is valid and generated between 12-24 hours ago.
	 *                   False if the nonce is invalid.
	 */
	function check_ajax_referer( $action = -1, $query_arg = false, $stop = true ) {
		if ( -1 === $action ) {
			_doing_it_wrong( __FUNCTION__, __( 'You should specify an action to be verified by using the first parameter.' ), '4.7.0' );
		}

		$nonce = '';

		if ( $query_arg && isset( $_REQUEST[ $query_arg ] ) ) {
			$nonce = $_REQUEST[ $query_arg ];
		} elseif ( isset( $_REQUEST['_ajax_nonce'] ) ) {
			$nonce = $_REQUEST['_ajax_nonce'];
		} elseif ( isset( $_REQUEST['_wpnonce'] ) ) {
			$nonce = $_REQUEST['_wpnonce'];
		}

		$result = wp_verify_nonce( $nonce, $action );

		/**
		 * Fires once the Ajax request has been validated or not.
		 *
		 * @since 2.1.0
		 *
		 * @param string    $action The Ajax nonce action.
		 * @param false|int $result False if the nonce is invalid, 1 if the nonce is valid and generated between
		 *                          0-12 hours ago, 2 if the nonce is valid and generated between 12-24 hours ago.
		 */
		do_action( 'check_ajax_referer', $action, $result );

		if ( $stop && false === $result ) {
			if ( wp_doing_ajax() ) {
				wp_die( -1, 403 );
			} else {
				die( '-1' );
			}
		}

		return $result;
	}
endif;
```

### Front-End AJAX (Public Endpoints)

For public AJAX endpoints (wp_ajax_nopriv_):

```php
function public_ajax_handler() {
	// 1. Verify nonce (still required!)
	check_ajax_referer( 'public_action', 'nonce' );

	// 2. No capability check needed for public actions
	// But validate input carefully

	// 3. Validate and sanitize input
	$email = isset( $_POST['email'] ) ? sanitize_email( $_POST['email'] ) : '';
	if ( ! is_email( $email ) ) {
		wp_send_json_error( array( 'message' => 'Invalid email' ) );
	}

	// 4. Process request
	$result = process_public_request( $email );

	// 5. Send response
	wp_send_json_success( $result );
}
add_action( 'wp_ajax_nopriv_public_action', 'public_ajax_handler' );
add_action( 'wp_ajax_public_action', 'public_ajax_handler' );
```

### Complete AJAX Example

**Backend:**
```php
function register_ajax_handlers() {
	add_action( 'wp_ajax_delete_item', 'handle_delete_item' );
}
add_action( 'init', 'register_ajax_handlers' );

function handle_delete_item() {
	// 1. Verify nonce
	check_ajax_referer( 'delete_item', 'nonce' );

	// 2. Check capability
	if ( ! current_user_can( 'delete_posts' ) ) {
		wp_send_json_error( array( 'message' => 'Permission denied' ) );
	}

	// 3. Validate input
	$item_id = isset( $_POST['item_id'] ) ? absint( $_POST['item_id'] ) : 0;
	if ( ! $item_id ) {
		wp_send_json_error( array( 'message' => 'Invalid item ID' ) );
	}

	// 4. Additional permission check
	if ( ! current_user_can( 'delete_post', $item_id ) ) {
		wp_send_json_error( array( 'message' => 'Cannot delete this item' ) );
	}

	// 5. Process
	$deleted = wp_delete_post( $item_id, true );

	if ( $deleted ) {
		wp_send_json_success( array( 'message' => 'Item deleted' ) );
	} else {
		wp_send_json_error( array( 'message' => 'Failed to delete' ) );
	}
}
```

**Frontend:**
```javascript
jQuery(document).ready(function($) {
	$('#delete-button').on('click', function(e) {
		e.preventDefault();

		$.ajax({
			url: ajaxurl,
			type: 'POST',
			data: {
				action: 'delete_item',
				nonce: myAjax.nonce, // Localized nonce
				item_id: $('#item-id').val()
			},
			success: function(response) {
				if (response.success) {
					alert('Item deleted');
				} else {
					alert('Error: ' + response.data.message);
				}
			}
		});
	});
});
```

**Localize Script:**
```php
function enqueue_ajax_script() {
	wp_enqueue_script( 'my-ajax-script', 'path/to/script.js', array( 'jquery' ) );
	wp_localize_script( 'my-ajax-script', 'myAjax', array(
		'ajaxurl' => admin_url( 'admin-ajax.php' ),
		'nonce' => wp_create_nonce( 'delete_item' ),
	) );
}
add_action( 'wp_enqueue_scripts', 'enqueue_ajax_script' );
```

---

## 2. Securing REST API Endpoints

### Basic REST Endpoint Security

```php
register_rest_route( 'myplugin/v1', '/items', array(
	'methods' => 'POST',
	'permission_callback' => function( $request ) {
		// Check capability
		return current_user_can( 'edit_posts' );
	},
	'callback' => function( $request ) {
		// Validate and sanitize parameters
		$title = sanitize_text_field( $request->get_param( 'title' ) );
		if ( empty( $title ) ) {
			return new WP_Error( 'invalid_title', 'Title is required', array( 'status' => 400 ) );
		}

		// Process request
		$post_id = wp_insert_post( array(
			'post_title' => $title,
			'post_status' => 'publish',
		) );

		if ( is_wp_error( $post_id ) ) {
			return $post_id;
		}

		return new WP_REST_Response( array( 'id' => $post_id ), 201 );
	},
) );
```

### Object-Specific Permissions

```php
register_rest_route( 'myplugin/v1', '/items/(?P<id>\d+)', array(
	'methods' => 'PUT',
	'permission_callback' => function( $request ) {
		$post_id = (int) $request['id'];

		// Check capability for specific post
		return current_user_can( 'edit_post', $post_id );
	},
	'callback' => function( $request ) {
		$post_id = (int) $request['id'];

		// Validate post exists
		$post = get_post( $post_id );
		if ( ! $post ) {
			return new WP_Error( 'post_not_found', 'Post not found', array( 'status' => 404 ) );
		}

		// Update post
		$updated = wp_update_post( array(
			'ID' => $post_id,
			'post_title' => sanitize_text_field( $request->get_param( 'title' ) ),
		) );

		if ( is_wp_error( $updated ) ) {
			return $updated;
		}

		return new WP_REST_Response( array( 'success' => true ), 200 );
	},
) );
```

### Public REST Endpoints

For public endpoints, still validate input:

```php
register_rest_route( 'myplugin/v1', '/public', array(
	'methods' => 'GET',
	'permission_callback' => '__return_true', // Public endpoint
	'callback' => function( $request ) {
		// Still validate and sanitize input
		$search = sanitize_text_field( $request->get_param( 'search' ) );

		// Process request
		$results = search_items( $search );

		return new WP_REST_Response( $results, 200 );
	},
) );
```

### REST API Authentication

REST API supports multiple authentication methods:

1. **Cookie Authentication** (for logged-in users)
2. **Application Passwords** (WP 5.6+)
3. **OAuth** (via plugins)

```php
// Check if user is authenticated
register_rest_route( 'myplugin/v1', '/protected', array(
	'methods' => 'GET',
	'permission_callback' => function( $request ) {
		// Check if user is logged in
		if ( ! is_user_logged_in() ) {
			return new WP_Error( 'unauthorized', 'Authentication required', array( 'status' => 401 ) );
		}

		// Check capability
		return current_user_can( 'read' );
	},
	'callback' => function( $request ) {
		return new WP_REST_Response( array( 'data' => 'protected' ), 200 );
	},
) );
```

---

## 3. Common Security Mistakes

### Mistake 1: Missing Nonce Verification

```php
// ❌ BAD - No nonce check
function bad_ajax_handler() {
	if ( ! current_user_can( 'edit_posts' ) ) {
		wp_die();
	}
	// Process
}

// ✅ GOOD - Nonce check included
function good_ajax_handler() {
	check_ajax_referer( 'action', 'nonce' );
	if ( ! current_user_can( 'edit_posts' ) ) {
		wp_die();
	}
	// Process
}
```

### Mistake 2: Missing Capability Check

```php
// ❌ BAD - No capability check
function bad_ajax_handler() {
	check_ajax_referer( 'action', 'nonce' );
	// Process without checking capability
}

// ✅ GOOD - Capability check included
function good_ajax_handler() {
	check_ajax_referer( 'action', 'nonce' );
	if ( ! current_user_can( 'edit_posts' ) ) {
		wp_send_json_error( array( 'message' => 'Permission denied' ) );
	}
	// Process
}
```

### Mistake 3: Missing permission_callback

```php
// ❌ BAD - No permission_callback
register_rest_route( 'myplugin/v1', '/endpoint', array(
	'methods' => 'POST',
	'callback' => function( $request ) {
		// No permission check!
	},
) );

// ✅ GOOD - permission_callback included
register_rest_route( 'myplugin/v1', '/endpoint', array(
	'methods' => 'POST',
	'permission_callback' => function( $request ) {
		return current_user_can( 'edit_posts' );
	},
	'callback' => function( $request ) {
		// Process
	},
) );
```

### Mistake 4: Unsanitized Input

```php
// ❌ BAD - Unsanitized input
function bad_handler() {
	check_ajax_referer( 'action', 'nonce' );
	$title = $_POST['title']; // Unsanitized!
	update_post_meta( $post_id, 'title', $title );
}

// ✅ GOOD - Sanitized input
function good_handler() {
	check_ajax_referer( 'action', 'nonce' );
	$title = sanitize_text_field( $_POST['title'] );
	update_post_meta( $post_id, 'title', $title );
}
```

---

## 4. Best Practices

### 1. Always Verify Nonces (AJAX)

```php
check_ajax_referer( 'action_name', 'nonce' );
```

### 2. Always Check Capabilities

```php
if ( ! current_user_can( 'required_capability' ) ) {
	wp_send_json_error( array( 'message' => 'Permission denied' ) );
}
```

### 3. Always Use permission_callback (REST)

```php
'permission_callback' => function( $request ) {
	return current_user_can( 'required_capability' );
}
```

### 4. Validate and Sanitize All Input

```php
$post_id = isset( $_POST['post_id'] ) ? absint( $_POST['post_id'] ) : 0;
$title = sanitize_text_field( $request->get_param( 'title' ) );
```

### 5. Return Appropriate Error Messages

```php
wp_send_json_error( array( 'message' => 'Permission denied' ) );
// OR
return new WP_Error( 'error_code', 'Error message', array( 'status' => 403 ) );
```

---

## Exam Tips

### Key Points to Remember

1. **AJAX Security:**
   - Always use `check_ajax_referer()`
   - Always check capabilities
   - Always validate and sanitize input
   - Use `wp_send_json_success()` / `wp_send_json_error()`

2. **REST API Security:**
   - Always use `permission_callback`
   - Check capabilities in permission_callback
   - Validate and sanitize request parameters
   - Return appropriate WP_Error for failures

3. **Common Mistakes:**
   - Missing nonce verification
   - Missing capability checks
   - Missing permission_callback
   - Unsanitized input
   - No input validation

4. **Public Endpoints:**
   - Still require nonce verification
   - Still validate and sanitize input
   - Be extra careful with validation

---

## Additional Resources

- [AJAX in Plugins - WordPress Developer Resources](https://developer.wordpress.org/plugins/javascript/ajax/)
- [REST API Handbook - WordPress Developer Resources](https://developer.wordpress.org/rest-api/)
- [REST API Authentication - WordPress Developer Resources](https://developer.wordpress.org/rest-api/using-the-rest-api/authentication/)
- Core Files:
  - `wp-includes/pluggable.php` - `check_ajax_referer()`
  - `wp-includes/rest-api.php` - REST API functions
