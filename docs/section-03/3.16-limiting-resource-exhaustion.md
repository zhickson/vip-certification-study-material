# 3.16 Limiting Resource Exhaustion - Study Notes

## Overview

Preventing resource exhaustion requires implementing rate limiting, query limits, memory limits, and other controls to prevent attackers from consuming server resources.

**Key Reference:** [WordPress Performance - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/performance/)

---

## 1. Rate Limiting

### Login Rate Limiting

```php
function limit_login_attempts( $user, $username, $password ) {
	$ip = $_SERVER['REMOTE_ADDR'];
	$transient_key = 'login_attempts_' . md5( $ip );
	$attempts = get_transient( $transient_key );

	if ( false === $attempts ) {
		$attempts = 0;
	}

	$attempts++;

	if ( $attempts >= 5 ) {
		set_transient( $transient_key, $attempts, 15 * MINUTE_IN_SECONDS );
		return new WP_Error( 'too_many_attempts', 'Too many login attempts. Please try again in 15 minutes.' );
	}

	set_transient( $transient_key, $attempts, 15 * MINUTE_IN_SECONDS );

	return $user;
}
add_filter( 'authenticate', 'limit_login_attempts', 30, 3 );
```

### API Rate Limiting

```php
function limit_api_requests() {
	$ip = $_SERVER['REMOTE_ADDR'];
	$transient_key = 'api_requests_' . md5( $ip );
	$requests = get_transient( $transient_key );

	if ( false === $requests ) {
		$requests = 0;
	}

	$requests++;

	if ( $requests > 100 ) { // 100 requests per minute
		wp_die( 'Rate limit exceeded', 'Too Many Requests', array( 'response' => 429 ) );
	}

	set_transient( $transient_key, $requests, MINUTE_IN_SECONDS );
}
add_action( 'rest_api_init', 'limit_api_requests' );
```

---

## 2. Query Limits

### Limit WP_Query Results

```php
// Always set limits
$args = array(
	'posts_per_page' => 10, // Always limit
	'no_found_rows' => true, // Skip count query
);

$query = new WP_Query( $args );
```

### Limit Database Queries

```php
global $wpdb;

// Always use LIMIT
$results = $wpdb->get_results(
	$wpdb->prepare(
		"SELECT * FROM {$wpdb->posts} WHERE post_status = %s LIMIT %d",
		'publish',
		100 // Limit results
	)
);
```

### Prevent Unbounded Queries

```php
// ❌ BAD - No limit
$posts = get_posts(); // Could return thousands

// ✅ GOOD - Always limit
$posts = get_posts( array(
	'numberposts' => 10,
) );
```

---

## 3. Memory Limits

### Set PHP Memory Limits

```php
// In wp-config.php
define( 'WP_MEMORY_LIMIT', '256M' );
define( 'WP_MAX_MEMORY_LIMIT', '512M' );
```

### Limit Memory Usage in Code

```php
function process_large_dataset() {
	$memory_limit = ini_get( 'memory_limit' );
	$memory_usage = memory_get_usage( true );

	// Check if approaching limit
	if ( $memory_usage > ( $memory_limit * 0.8 ) ) {
		return new WP_Error( 'memory_limit', 'Approaching memory limit' );
	}

	// Process in batches
	$batch_size = 100;
	$offset = 0;

	while ( $batch = get_batch( $offset, $batch_size ) ) {
		process_batch( $batch );
		$offset += $batch_size;

		// Check memory after each batch
		if ( memory_get_usage( true ) > ( $memory_limit * 0.8 ) ) {
			break;
		}
	}
}
```

---

## 4. Execution Time Limits

### Set Time Limits

```php
// In wp-config.php or functions.php
set_time_limit( 30 ); // 30 seconds

// For long operations, increase temporarily
set_time_limit( 300 ); // 5 minutes for imports
```

### Timeout for Remote Requests

```php
// Set timeout for wp_remote_get
$args = array(
	'timeout' => 5, // 5 seconds
);
$response = wp_remote_get( $url, $args );
```

---

## 5. CAPTCHA Protection

### Login CAPTCHA

```php
function add_login_captcha() {
	?>
	<p>
		<label for="captcha">CAPTCHA:</label>
		<input type="text" name="captcha" id="captcha" required>
		<img src="<?php echo esc_url( get_captcha_image() ); ?>" alt="CAPTCHA">
	</p>
	<?php
}
add_action( 'login_form', 'add_login_captcha' );

function verify_login_captcha( $user, $username, $password ) {
	if ( ! verify_captcha( $_POST['captcha'] ) ) {
		return new WP_Error( 'invalid_captcha', 'Invalid CAPTCHA' );
	}
	return $user;
}
add_filter( 'authenticate', 'verify_login_captcha', 20, 3 );
```

### reCAPTCHA Integration

```php
// Use Google reCAPTCHA
function verify_recaptcha( $token ) {
	$secret = get_option( 'recaptcha_secret' );
	$response = wp_remote_post( 'https://www.google.com/recaptcha/api/siteverify', array(
		'body' => array(
			'secret' => $secret,
			'response' => $token,
		),
	) );

	$result = json_decode( wp_remote_retrieve_body( $response ) );
	return $result->success;
}
```

---

## 6. CDN and Host-Level Mitigation

### CDN Protection

- Use CDN with DDoS protection (Cloudflare, Akamai)
- CDN filters malicious traffic
- Reduces load on origin server

### Host-Level Rate Limiting

**Apache (mod_evasive):**
```apache
<IfModule mod_evasive20.c>
	DOSHashTableSize    3097
	DOSPageCount        2
	DOSSiteCount        50
	DOSPageInterval     1
	DOSSiteInterval     1
	DOSBlockingPeriod   10
</IfModule>
```

**Nginx:**
```nginx
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;

location /wp-login.php {
	limit_req zone=login burst=2;
}

location /wp-json/ {
	limit_req zone=api burst=20;
}
```

---

## 7. WordPress-Specific Protections

### Disable WP-Cron

```php
// In wp-config.php
define( 'DISABLE_WP_CRON', true );
```

Then set up system cron:
```bash
*/15 * * * * wget -q -O - https://yoursite.com/wp-cron.php?doing_wp_cron >/dev/null 2>&1
```

### Limit Search Queries

```php
function limit_search_queries( $query ) {
	if ( $query->is_search() ) {
		$query->set( 'posts_per_page', 10 );
		$query->set( 'no_found_rows', true );
	}
}
add_action( 'pre_get_posts', 'limit_search_queries' );
```

### Cache Expensive Operations

```php
function get_expensive_data() {
	$cache_key = 'expensive_data';
	$cached = wp_cache_get( $cache_key );

	if ( false !== $cached ) {
		return $cached;
	}

	$data = perform_expensive_operation();
	wp_cache_set( $cache_key, $data, '', HOUR_IN_SECONDS );

	return $data;
}
```

---

## 8. Monitoring and Alerts

### Monitor Resource Usage

```php
function log_resource_usage() {
	$memory = memory_get_usage( true );
	$peak_memory = memory_get_peak_usage( true );
	$execution_time = timer_stop();

	if ( $memory > 100 * 1024 * 1024 ) { // 100MB
		error_log( "High memory usage: {$memory} bytes" );
	}

	if ( $execution_time > 5 ) { // 5 seconds
		error_log( "Slow page load: {$execution_time} seconds" );
	}
}
add_action( 'shutdown', 'log_resource_usage' );
```

### Alert on Thresholds

```php
function check_resource_thresholds() {
	$memory_limit = ini_get( 'memory_limit' );
	$memory_usage = memory_get_usage( true );
	$usage_percent = ( $memory_usage / $memory_limit ) * 100;

	if ( $usage_percent > 80 ) {
		// Send alert
		wp_mail( 'admin@example.com', 'High Memory Usage', "Memory usage: {$usage_percent}%" );
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Rate Limiting:**
   - Limit login attempts
   - Limit API requests
   - Use transients for tracking

2. **Query Limits:**
   - Always set `posts_per_page`
   - Use `LIMIT` in SQL queries
   - Prevent unbounded queries

3. **Memory Limits:**
   - Set appropriate limits
   - Process in batches
   - Monitor memory usage

4. **Time Limits:**
   - Set execution time limits
   - Set request timeouts
   - Prevent long-running operations

5. **Protection Layers:**
   - Application-level (rate limiting)
   - Host-level (mod_evasive, nginx)
   - CDN-level (DDoS protection)

---

## Additional Resources

- [WordPress Performance - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/performance/)
- [Rate Limiting - OWASP](https://owasp.org/www-community/controls/Blocking_Brute_Force_Attacks)
