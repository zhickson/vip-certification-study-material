# 3.8 Nonce Usage and CSRF Protection - Study Notes

## Overview

Cross-Site Request Forgery (CSRF) attacks trick authenticated users into performing unwanted actions. WordPress uses nonces (number used once) to prevent CSRF attacks. Understanding how to generate, verify, and use nonces is essential for secure WordPress development.

**Key Reference:** [WordPress Nonces - WordPress Developer Resources](https://developer.wordpress.org/plugins/security/nonces/)

---

## 1. Understanding CSRF Attacks

### What is CSRF?

CSRF attacks occur when a malicious site tricks a logged-in user into performing actions on another site without their knowledge.

**Example Attack:**
```html
<!-- Malicious site -->
<img src="https://yoursite.com/wp-admin/admin.php?action=delete_post&post_id=123" />
```

If the user is logged in, this could delete a post without their knowledge.

### How Nonces Prevent CSRF

Nonces are cryptographic tokens tied to:
- A specific action
- A specific user
- A specific user session
- A time window (12-24 hours)

This makes it impossible for attackers to forge valid requests.

---

## 2. Generating Nonces

### wp_create_nonce()

Creates a nonce for a specific action:

```2520:2544:wordpress/wp-includes/pluggable.php
if ( ! function_exists( 'wp_create_nonce' ) ) :
	/**
	 * Creates a cryptographic token tied to a specific action, user, user session,
	 * and window of time.
	 *
	 * @since 2.0.3
	 * @since 4.0.0 Session tokens were integrated with nonce creation.
	 *
	 * @param string|int $action Scalar value to add context to the nonce.
	 * @return string The token.
	 */
	function wp_create_nonce( $action = -1 ) {
		$user = wp_get_current_user();
		$uid  = (int) $user->ID;
		if ( ! $uid ) {
			/** This filter is documented in wp-includes/pluggable.php */
			$uid = apply_filters( 'nonce_user_logged_out', $uid, $action );
		}

		$token = wp_get_session_token();
		$i     = wp_nonce_tick( $action );

		return substr( wp_hash( $i . '|' . $action . '|' . $uid . '|' . $token, 'nonce' ), -12, 10 );
	}
endif;
```

**Usage:**
```php
$nonce = wp_create_nonce( 'delete_post_123' );
```

### wp_nonce_field()

Generates a hidden form field with nonce:

```1873:1912:wordpress/wp-includes/functions.php
/**
 * Retrieves or display nonce hidden field for forms.
 *
 * The nonce field is used to validate that the contents of the form came from
 * the location on the current site and not somewhere else. The nonce does not
 * offer absolute protection, but should protect against most cases. It is very
 * important to use nonce field in forms.
 *
 * The $action and $name are optional, but if you want to have better security,
 * it is strongly suggested to set those two parameters. It is easier to just
 * call the function without any parameters, because validation of the nonce
 * doesn't require any parameters, but since crackers know what the default is
 * it won't be difficult for them to find a way around your nonce and cause
 * damage.
 *
 * The input name will be whatever $name value you gave. The input value will be
 * the nonce creation value.
 *
 * @since 2.0.4
 *
 * @param int|string $action  Optional. Action name. Default -1.
 * @param string     $name    Optional. Nonce name. Default '_wpnonce'.
 * @param bool       $referer Optional. Whether to set the referer field for validation. Default true.
 * @param bool       $display Optional. Whether to display or return hidden form field. Default true.
 * @return string Nonce field HTML markup.
 */
function wp_nonce_field( $action = -1, $name = '_wpnonce', $referer = true, $display = true ) {
	$name        = esc_attr( $name );
	$nonce_field = '<input type="hidden" id="' . $name . '" name="' . $name . '" value="' . wp_create_nonce( $action ) . '" />';

	if ( $referer ) {
		$nonce_field .= wp_referer_field( false );
	}

	if ( $display ) {
		echo $nonce_field;
	}

	return $nonce_field;
}
```

**Usage in Forms:**
```php
<form method="post" action="">
	<?php wp_nonce_field( 'my_action', 'my_nonce' ); ?>
	<!-- Form fields -->
	<input type="submit" value="Submit">
</form>
```

### wp_nonce_url()

Adds nonce to URL:

```php
$url = wp_nonce_url(
	admin_url( 'admin.php?action=delete&post_id=123' ),
	'delete-post_123',
	'nonce'
);
// Result: admin.php?action=delete&post_id=123&nonce=abc123...
```

---

## 3. Verifying Nonces

### wp_verify_nonce()

Verifies a nonce value:

```2454:2518:wordpress/wp-includes/pluggable.php
if ( ! function_exists( 'wp_verify_nonce' ) ) :
	/**
	 * Verifies that a correct security nonce was used with time limit.
	 *
	 * A nonce is valid for between 12 and 24 hours (by default).
	 *
	 * @since 2.0.3
	 *
	 * @param string     $nonce  Nonce value that was used for verification, usually via a form field.
	 * @param string|int $action Should give context to what is taking place and be the same when nonce was created.
	 * @return int|false 1 if the nonce is valid and generated between 0-12 hours ago,
	 *                   2 if the nonce is valid and generated between 12-24 hours ago.
	 *                   False if the nonce is invalid.
	 */
	function wp_verify_nonce( $nonce, $action = -1 ) {
		$nonce = (string) $nonce;
		$user  = wp_get_current_user();
		$uid   = (int) $user->ID;
		if ( ! $uid ) {
			/**
			 * Filters whether the user who generated the nonce is logged out.
			 *
			 * @since 3.5.0
			 *
			 * @param int        $uid    ID of the nonce-owning user.
			 * @param string|int $action The nonce action, or -1 if none was provided.
			 */
			$uid = apply_filters( 'nonce_user_logged_out', $uid, $action );
		}

		if ( empty( $nonce ) ) {
			return false;
		}

		$token = wp_get_session_token();
		$i     = wp_nonce_tick( $action );

		// Nonce generated 0-12 hours ago.
		$expected = substr( wp_hash( $i . '|' . $action . '|' . $uid . '|' . $token, 'nonce' ), -12, 10 );
		if ( hash_equals( $expected, $nonce ) ) {
			return 1;
		}

		// Nonce generated 12-24 hours ago.
		$expected = substr( wp_hash( ( $i - 1 ) . '|' . $action . '|' . $uid . '|' . $token, 'nonce' ), -12, 10 );
		if ( hash_equals( $expected, $nonce ) ) {
			return 2;
		}

		/**
		 * Fires when nonce verification fails.
		 *
		 * @since 4.4.0
		 *
		 * @param string     $nonce  The invalid nonce.
		 * @param string|int $action The nonce action.
		 * @param WP_User    $user   The current user object.
		 * @param string     $token  The user's session token.
		 */
		do_action( 'wp_verify_nonce_failed', $nonce, $action, $user, $token );

		// Invalid nonce.
		return false;
	}
endif;
```

**Usage:**
```php
if ( ! isset( $_POST['nonce'] ) || ! wp_verify_nonce( $_POST['nonce'], 'my_action' ) ) {
	wp_die( 'Security check failed' );
}
```

### check_admin_referer()

Verifies nonce for admin requests (also checks referer):

```1368:1394:wordpress/wp-includes/pluggable.php
	function check_admin_referer( $action = -1, $query_arg = '_wpnonce' ) {
		if ( -1 === $action ) {
			_doing_it_wrong( __FUNCTION__, __( 'You should specify an action to be verified by using the first parameter.' ), '3.2.0' );
		}

		$adminurl = strtolower( admin_url() );
		$referer  = strtolower( wp_get_referer() );
		$result   = isset( $_REQUEST[ $query_arg ] ) ? wp_verify_nonce( $_REQUEST[ $query_arg ], $action ) : false;

		/**
		 * Fires once the admin request has been validated or not.
		 *
		 * @since 1.5.1
		 *
		 * @param string    $action The nonce action.
		 * @param false|int $result False if the nonce is invalid, 1 if the nonce is valid and generated between
		 *                          0-12 hours ago, 2 if the nonce is valid and generated between 12-24 hours ago.
		 */
		do_action( 'check_admin_referer', $action, $result );

		if ( ! $result && ! ( -1 === $action && str_starts_with( $referer, $adminurl ) ) ) {
			wp_nonce_ays( $action );
			die();
		}

		return $result;
	}
```

**Usage:**
```php
// In admin forms
check_admin_referer( 'my_action', 'my_nonce' );
```

### check_ajax_referer()

Verifies nonce for AJAX requests:

```1413:1450:wordpress/wp-includes/pluggable.php
	function check_ajax_referer( $action = -1, $query_arg = false, $stop = true ) {
		if ( -1 === $action ) {
			_doing_it_wrong( __FUNCTION__, __( 'You should specify an action to be verified by using the first parameter.' ), '4.7.0' );
		}

		$nonce = '';

		if ( $query_arg && isset( $_REQUEST[ $query_arg ] ) ) {
			$nonce = $_REQUEST[ $query_arg ];
		} elseif ( isset( $_REQUEST['_ajax_nonce'] ) ) {
			$nonce = $_REQUEST['_ajax_nonce'];
		} elseif ( isset( $_REQUEST['_wpnonce'] ) ) {
			$nonce = $_REQUEST['_wpnonce'];
		}

		$result = wp_verify_nonce( $nonce, $action );

		/**
		 * Fires once the Ajax request has been validated or not.
		 *
		 * @since 2.1.0
		 *
		 * @param string    $action The Ajax nonce action.
		 * @param false|int $result False if the nonce is invalid, 1 if the nonce is valid and generated between
		 *                          0-12 hours ago, 2 if the nonce is valid and generated between 12-24 hours ago.
		 */
		do_action( 'check_ajax_referer', $action, $result );

		if ( $stop && false === $result ) {
			if ( wp_doing_ajax() ) {
				wp_die( -1, 403 );
			} else {
				die( '-1' );
			}
		}

		return $result;
	}
```

**Usage:**
```php
// In AJAX handlers
check_ajax_referer( 'my_ajax_action', 'nonce' );
```

---

## 4. Complete Examples

### Admin Form Example

```php
// Display form
function render_admin_form() {
	?>
	<form method="post" action="">
		<?php wp_nonce_field( 'save_settings', 'settings_nonce' ); ?>
		<input type="text" name="setting_value" value="<?php echo esc_attr( get_option( 'my_setting' ) ); ?>">
		<?php submit_button(); ?>
	</form>
	<?php
}

// Process form
function handle_admin_form() {
	// Verify nonce
	if ( ! isset( $_POST['settings_nonce'] ) || ! wp_verify_nonce( $_POST['settings_nonce'], 'save_settings' ) ) {
		wp_die( 'Security check failed' );
	}

	// Check capability
	if ( ! current_user_can( 'manage_options' ) ) {
		wp_die( 'Permission denied' );
	}

	// Process
	$value = sanitize_text_field( $_POST['setting_value'] );
	update_option( 'my_setting', $value );

	wp_redirect( add_query_arg( 'updated', 'true', admin_url( 'admin.php?page=my-page' ) ) );
	exit;
}
add_action( 'admin_init', 'handle_admin_form' );
```

### AJAX Example

**Backend:**
```php
function my_ajax_handler() {
	// Verify nonce
	check_ajax_referer( 'my_ajax_action', 'nonce' );

	// Check capability
	if ( ! current_user_can( 'edit_posts' ) ) {
		wp_send_json_error( array( 'message' => 'Permission denied' ) );
	}

	// Process
	$result = process_ajax_request();

	wp_send_json_success( $result );
}
add_action( 'wp_ajax_my_action', 'my_ajax_handler' );
```

**Frontend:**
```php
// Enqueue script with nonce
function enqueue_script() {
	wp_enqueue_script( 'my-script', 'path/to/script.js', array( 'jquery' ) );
	wp_localize_script( 'my-script', 'myAjax', array(
		'ajaxurl' => admin_url( 'admin-ajax.php' ),
		'nonce' => wp_create_nonce( 'my_ajax_action' ),
	) );
}
add_action( 'wp_enqueue_scripts', 'enqueue_script' );
```

```javascript
jQuery.ajax({
	url: myAjax.ajaxurl,
	type: 'POST',
	data: {
		action: 'my_action',
		nonce: myAjax.nonce,
		data: someData
	},
	success: function(response) {
		// Handle response
	}
});
```

### URL Action Example

```php
// Generate URL with nonce
$delete_url = wp_nonce_url(
	admin_url( 'admin.php?action=delete&post_id=' . $post_id ),
	'delete-post_' . $post_id,
	'nonce'
);

// Verify in handler
function handle_delete() {
	if ( ! isset( $_GET['nonce'] ) || ! wp_verify_nonce( $_GET['nonce'], 'delete-post_' . $_GET['post_id'] ) ) {
		wp_die( 'Security check failed' );
	}

	// Process deletion
}
```

---

## 5. Best Practices

### 1. Use Specific Action Names

```php
// ✅ GOOD - Specific action
wp_create_nonce( 'delete_post_123' );

// ❌ BAD - Generic action
wp_create_nonce( 'action' );
```

### 2. Always Verify Nonces

```php
// Always verify before processing
if ( ! wp_verify_nonce( $_POST['nonce'], 'action' ) ) {
	wp_die( 'Security check failed' );
}
```

### 3. Use Appropriate Verification Function

- `check_admin_referer()` - For admin forms
- `check_ajax_referer()` - For AJAX requests
- `wp_verify_nonce()` - For custom implementations

### 4. Include Nonce in All Forms

```php
// Always include in forms
<?php wp_nonce_field( 'action', 'nonce_name' ); ?>
```

### 5. Use Nonces for Both Admin and Front-End

```php
// Admin forms
check_admin_referer( 'action', 'nonce' );

// Front-end forms
if ( ! wp_verify_nonce( $_POST['nonce'], 'action' ) ) {
	wp_die( 'Security check failed' );
}
```

---

## 6. Common Mistakes

### Mistake 1: No Nonce Verification

```php
// ❌ BAD
function handle_form() {
	// No nonce check!
	process_form();
}

// ✅ GOOD
function handle_form() {
	if ( ! wp_verify_nonce( $_POST['nonce'], 'action' ) ) {
		wp_die( 'Security check failed' );
	}
	process_form();
}
```

### Mistake 2: Wrong Action Name

```php
// ❌ BAD - Mismatched action
wp_create_nonce( 'delete_post' );
wp_verify_nonce( $_POST['nonce'], 'delete' ); // Wrong!

// ✅ GOOD - Matching action
wp_create_nonce( 'delete_post' );
wp_verify_nonce( $_POST['nonce'], 'delete_post' );
```

### Mistake 3: Not Including Nonce in Form

```php
// ❌ BAD - No nonce field
<form method="post">
	<input type="text" name="data">
	<input type="submit">
</form>

// ✅ GOOD - Nonce included
<form method="post">
	<?php wp_nonce_field( 'action', 'nonce' ); ?>
	<input type="text" name="data">
	<input type="submit">
</form>
```

---

## Exam Tips

### Key Points to Remember

1. **Nonce Generation:**
   - `wp_create_nonce( $action )` - Create nonce
   - `wp_nonce_field( $action, $name )` - Form field
   - `wp_nonce_url( $url, $action, $name )` - URL nonce

2. **Nonce Verification:**
   - `wp_verify_nonce( $nonce, $action )` - General verification
   - `check_admin_referer( $action, $name )` - Admin forms
   - `check_ajax_referer( $action, $name )` - AJAX requests

3. **Best Practices:**
   - Use specific action names
   - Always verify nonces
   - Include nonces in all forms
   - Use appropriate verification function

4. **Common Mistakes:**
   - No nonce verification
   - Mismatched action names
   - Missing nonce in forms
   - Using wrong verification function

---

## Additional Resources

- [WordPress Nonces - WordPress Developer Resources](https://developer.wordpress.org/plugins/security/nonces/)
- [WordPress Nonces - WordPress Codex](https://codex.wordpress.org/WordPress_Nonces)
- Core Files:
  - `wp-includes/pluggable.php` - Nonce functions
  - `wp-includes/functions.php` - `wp_nonce_field()`
