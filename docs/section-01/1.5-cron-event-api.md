# 1.5 Cron / Event API - Study Notes

## Overview

WordPress Cron (WP-Cron) is a pseudo-cron system that schedules tasks to run at specific times. Unlike system cron, WP-Cron is triggered by page visits, making it suitable for WordPress environments where system-level cron access may not be available. Understanding how to schedule, manage, and optimise cron events is crucial for enterprise WordPress development.

**Key Reference:** [WP-Cron - WordPress Developer Resources](https://developer.wordpress.org/plugins/cron/)

---

## 1. Register Custom Cron Events

### Scheduling Recurring Events

**Function:** `wp_schedule_event( $timestamp, $recurrence, $hook, $args = array(), $wp_error = false )`

Schedules a recurring event that runs at specified intervals.

**Core Implementation:**
```234:313:wordpress/wp-includes/cron.php
function wp_schedule_event( $timestamp, $recurrence, $hook, $args = array(), $wp_error = false ) {
	// Make sure timestamp is a positive integer.
	if ( ! is_numeric( $timestamp ) || $timestamp <= 0 ) {
		if ( $wp_error ) {
			return new WP_Error(
				'invalid_timestamp',
				__( 'Event timestamp must be a valid Unix timestamp.' )
			);
		}

		return false;
	}

	$schedules = wp_get_schedules();

	if ( ! isset( $schedules[ $recurrence ] ) ) {
		if ( $wp_error ) {
			return new WP_Error(
				'invalid_schedule',
				__( 'Event schedule does not exist.' )
			);
		}

		return false;
	}

	$event = (object) array(
		'hook'      => $hook,
		'timestamp' => $timestamp,
		'schedule'  => $recurrence,
		'args'      => $args,
		'interval'  => $schedules[ $recurrence ]['interval'],
	);

	/** This filter is documented in wp-includes/cron.php */
	$pre = apply_filters( 'pre_schedule_event', null, $event, $wp_error );

	if ( null !== $pre ) {
		if ( $wp_error && false === $pre ) {
			return new WP_Error(
				'pre_schedule_event_false',
				__( 'A plugin prevented the event from being scheduled.' )
			);
		}

		if ( ! $wp_error && is_wp_error( $pre ) ) {
			return false;
		}

		return $pre;
	}

	/** This filter is documented in wp-includes/cron.php */
	$event = apply_filters( 'schedule_event', $event );

	// A plugin disallowed this event.
	if ( ! $event ) {
		if ( $wp_error ) {
			return new WP_Error(
				'schedule_event_false',
				__( 'A plugin disallowed this event.' )
			);
		}

		return false;
	}

	$key = md5( serialize( $event->args ) );

	$crons = _get_cron_array();

	$crons[ $event->timestamp ][ $event->hook ][ $key ] = array(
		'schedule' => $event->schedule,
		'args'     => $event->args,
		'interval' => $event->interval,
	);
	uksort( $crons, 'strnatcasecmp' );

	return _set_cron_array( $crons, $wp_error );
}
```

**Available Recurrences:**
- `hourly` - Every hour
- `twicedaily` - Twice per day (every 12 hours)
- `daily` - Once per day
- `weekly` - Once per week

**Example:**
```php
// Schedule daily backup
if ( ! wp_next_scheduled( 'my_plugin_daily_backup' ) ) {
	wp_schedule_event( time(), 'daily', 'my_plugin_daily_backup' );
}

// Hook callback
add_action( 'my_plugin_daily_backup', 'perform_daily_backup' );
function perform_daily_backup() {
	// Backup logic
}
```

### Scheduling Single Events

**Function:** `wp_schedule_single_event( $timestamp, $hook, $args = array(), $wp_error = false )`

Schedules an event to run once at a specific time.

**Core Implementation:**
```39:200:wordpress/wp-includes/cron.php
function wp_schedule_single_event( $timestamp, $hook, $args = array(), $wp_error = false ) {
	// Make sure timestamp is a positive integer.
	if ( ! is_numeric( $timestamp ) || $timestamp <= 0 ) {
		if ( $wp_error ) {
			return new WP_Error(
				'invalid_timestamp',
				__( 'Event timestamp must be a valid Unix timestamp.' )
			);
		}

		return false;
	}

	$event = (object) array(
		'hook'      => $hook,
		'timestamp' => $timestamp,
		'schedule'  => false,
		'args'      => $args,
	);

	/**
	 * Filter to override scheduling an event.
	 *
	 * Returning a non-null value will short-circuit adding the event to the
	 * cron array, causing the function to return the filtered value instead.
	 *
	 * Both single events and recurring events are passed through this filter;
	 * single events have `$event->schedule` as false, whereas recurring events
	 * have this set to a recurrence from wp_get_schedules(). Recurring
	 * events also have the integer recurrence interval set as `$event->interval`.
	 *
	 * For plugins replacing wp-cron, it is recommended you check for an
	 * identical event within ten minutes and apply the {@see 'schedule_event'}
	 * filter to check if another plugin has disallowed the event before scheduling.
	 *
	 * Return true if the event was scheduled, false or a WP_Error if not.
	 *
	 * @since 5.1.0
	 * @since 5.7.0 The `$wp_error` parameter was added, and a `WP_Error` object can now be returned.
	 *
	 * @param null|bool|WP_Error $result   The value to return instead. Default null to continue adding the event.
	 * @param object             $event    {
	 *     An object containing an event's data.
	 *
	 *     @type string       $hook      Action hook to execute when the event is run.
	 *     @type int          $timestamp Unix timestamp (UTC) for when to next run the event.
	 *     @type string|false $schedule  How often the event should subsequently recur.
	 *     @type array        $args      Array containing each separate argument to pass to the hook's callback function.
	 *     @type int          $interval  Optional. The interval time in seconds for the schedule. Only present for recurring events.
	 * }
	 * @param bool               $wp_error Whether to return a WP_Error on failure.
	 */
	$pre = apply_filters( 'pre_schedule_event', null, $event, $wp_error );

	if ( null !== $pre ) {
		if ( $wp_error && false === $pre ) {
			return new WP_Error(
				'pre_schedule_event_false',
				__( 'A plugin prevented the event from being scheduled.' )
			);
		}

		if ( ! $wp_error && is_wp_error( $pre ) ) {
			return false;
		}

		return $pre;
	}

	/*
	 * Check for a duplicated event.
	 *
	 * Don't schedule an event if there's already an identical event
	 * within 10 minutes.
	 *
	 * When scheduling events within ten minutes of the current time,
	 * all past identical events are considered duplicates.
	 *
	 * When scheduling an event with a past timestamp (ie, before the
	 * current time) all events scheduled within the next ten minutes
	 * are considered duplicates.
	 */
	$crons = _get_cron_array();

	$key       = md5( serialize( $event->args ) );
	$duplicate = false;

	if ( $event->timestamp < time() + 10 * MINUTE_IN_SECONDS ) {
		$min_timestamp = 0;
	} else {
		$min_timestamp = $event->timestamp - 10 * MINUTE_IN_SECONDS;
	}

	if ( $event->timestamp < time() ) {
		$max_timestamp = time() + 10 * MINUTE_IN_SECONDS;
	} else {
		$max_timestamp = $event->timestamp + 10 * MINUTE_IN_SECONDS;
	}

	foreach ( $crons as $event_timestamp => $cron ) {
		if ( $event_timestamp < $min_timestamp ) {
			continue;
		}

		if ( $event_timestamp > $max_timestamp ) {
			break;
		}

		if ( isset( $cron[ $event->hook ][ $key ] ) ) {
			$duplicate = true;
			break;
		}
	}

	if ( $duplicate ) {
		if ( $wp_error ) {
			return new WP_Error(
				'duplicate_event',
				__( 'A duplicate event already exists.' )
			);
		}

		return false;
	}

	/**
	 * Modify an event before it is scheduled.
	 *
	 * @since 3.1.0
	 *
	 * @param object|false $event {
	 *     An object containing an event's data, or boolean false to prevent the event from being scheduled.
	 *
	 *     @type string       $hook      Action hook to execute when the event is run.
	 *     @type int          $timestamp Unix timestamp (UTC) for when to next run the event.
	 *     @type string|false $schedule  How often the event should subsequently recur.
	 *     @type array        $args      Array containing each separate argument to pass to the hook's callback function.
	 *     @type int          $interval  Optional. The interval time in seconds for the schedule. Only present for recurring events.
	 * }
	 */
	$event = apply_filters( 'schedule_event', $event );

	// A plugin disallowed this event.
	if ( ! $event ) {
		if ( $wp_error ) {
			return new WP_Error(
				'schedule_event_false',
				__( 'A plugin disallowed this event.' )
			);
		}

		return false;
	}

	$crons[ $event->timestamp ][ $event->hook ][ $key ] = array(
		'schedule' => $event->schedule,
		'args'     => $event->args,
	);
	uksort( $crons, 'strnatcasecmp' );

	return _set_cron_array( $crons, $wp_error );
}
```

**Example:**
```php
// Schedule one-time event in 1 hour
wp_schedule_single_event( time() + HOUR_IN_SECONDS, 'send_reminder_email', array( $user_id ) );

add_action( 'send_reminder_email', 'send_user_reminder' );
function send_user_reminder( $user_id ) {
	wp_mail( get_userdata( $user_id )->user_email, 'Reminder', 'Your reminder message' );
}
```

### Custom Recurrence Schedules

Add custom recurrence intervals using the `cron_schedules` filter.

**Core Implementation:**
```1103:1140:wordpress/wp-includes/cron.php
function wp_get_schedules() {
	$schedules = array(
		'hourly'     => array(
			'interval' => HOUR_IN_SECONDS,
			'display'  => __( 'Once Hourly' ),
		),
		'twicedaily' => array(
			'interval' => 12 * HOUR_IN_SECONDS,
			'display'  => __( 'Twice Daily' ),
		),
		'daily'      => array(
			'interval' => DAY_IN_SECONDS,
			'display'  => __( 'Once Daily' ),
		),
		'weekly'     => array(
			'interval' => WEEK_IN_SECONDS,
			'display'  => __( 'Once Weekly' ),
		),
	);

	/**
	 * Filters the non-default cron schedules.
	 *
	 * @since 2.1.0
	 *
	 * @param array $new_schedules {
	 *     An array of non-default cron schedules keyed by the schedule name. Default empty array.
	 *
	 *     @type array ...$0 {
	 *         Cron schedule information.
	 *
	 *         @type int    $interval The schedule interval in seconds.
	 *         @type string $display  The schedule display name.
	 *     }
	 * }
	 */
	return array_merge( apply_filters( 'cron_schedules', array() ), $schedules );
}
```

**Example:**
```php
// Add custom schedule
add_filter( 'cron_schedules', 'add_custom_cron_schedule' );
function add_custom_cron_schedule( $schedules ) {
	$schedules['every_5_minutes'] = array(
		'interval' => 5 * MINUTE_IN_SECONDS,
		'display'  => __( 'Every 5 Minutes' ),
	);

	$schedules['monthly'] = array(
		'interval' => MONTH_IN_SECONDS,
		'display'  => __( 'Once Monthly' ),
	);

	return $schedules;
}

// Use custom schedule
if ( ! wp_next_scheduled( 'my_plugin_frequent_check' ) ) {
	wp_schedule_event( time(), 'every_5_minutes', 'my_plugin_frequent_check' );
}
```

### Preventing Duplicate Events

Always check if an event is already scheduled before scheduling it.

**Function:** `wp_next_scheduled( $hook, $args = array() )`

Returns the timestamp of the next scheduled event, or `false` if none exists.

**Core Implementation:**
```832:860:wordpress/wp-includes/cron.php
function wp_next_scheduled( $hook, $args = array() ) {
	$next_event = wp_get_scheduled_event( $hook, $args );

	if ( ! $next_event ) {
		return false;
	}

	/**
	 * Filters the timestamp of the next scheduled event for the given hook.
	 *
	 * @since 6.8.0
	 *
	 * @param int    $timestamp  Unix timestamp (UTC) for when to next run the event.
	 * @param object $next_event {
	 *     An object containing an event's data.
	 *
	 *     @type string $hook      Action hook of the event.
	 *     @type int    $timestamp Unix timestamp (UTC) for when to next run the event.
	 *     @type string $schedule  How often the event should subsequently recur.
	 *     @type array  $args      Array containing each separate argument to pass to the hook
	 *                             callback function.
	 *     @type int    $interval  Optional. The interval time in seconds for the schedule. Only
	 *                             present for recurring events.
	 * }
	 * @param array  $args       Array containing each separate argument to pass to the hook
	 *                           callback function.
	 */
	return apply_filters( 'wp_next_scheduled', $next_event->timestamp, $next_event, $hook, $args );
}
```

**Example:**
```php
// ✅ GOOD - Check before scheduling
if ( ! wp_next_scheduled( 'my_plugin_daily_task' ) ) {
	wp_schedule_event( time(), 'daily', 'my_plugin_daily_task' );
}

// ❌ BAD - May create duplicates
wp_schedule_event( time(), 'daily', 'my_plugin_daily_task' );
```

---

## 2. Distinguish Between WP-Cron and System Cron Jobs

### WP-Cron (Pseudo-Cron)

**Characteristics:**
- Triggered by page visits
- Runs during HTTP requests
- No system-level access required
- Can be delayed if site has low traffic
- Uses `wp-cron.php` file

**How It Works:**
```1:47:wordpress/wp-cron.php
<?php
/**
 * A pseudo-cron daemon for scheduling WordPress tasks.
 *
 * WP-Cron is triggered when the site receives a visit. In the scenario
 * where a site may not receive enough visits to execute scheduled tasks
 * in a timely manner, this file can be called directly or via a server
 * cron daemon for X number of times.
 *
 * Defining DISABLE_WP_CRON as true and calling this file directly are
 * mutually exclusive and the latter does not rely on the former to work.
 *
 * The HTTP request to this file will not slow down the visitor who happens to
 * visit when a scheduled cron event runs.
 *
 * @package WordPress
 */

ignore_user_abort( true );

if ( ! headers_sent() ) {
	header( 'Expires: Wed, 11 Jan 1984 05:00:00 GMT' );
	header( 'Cache-Control: no-cache, must-revalidate, max-age=0' );
}

// Don't run cron until the request finishes, if possible.
if ( function_exists( 'fastcgi_finish_request' ) ) {
	fastcgi_finish_request();
} elseif ( function_exists( 'litespeed_finish_request' ) ) {
	litespeed_finish_request();
}

if ( ! empty( $_POST ) || defined( 'DOING_AJAX' ) || defined( 'DOING_CRON' ) ) {
	die();
}

/**
 * Tell WordPress the cron task is running.
 *
 * @var bool
 */
define( 'DOING_CRON', true );

if ( ! defined( 'ABSPATH' ) ) {
	/** Set up WordPress environment */
	require_once __DIR__ . '/wp-load.php';
}
```

**When WP-Cron Runs:**
- On page load (via `shutdown` hook)
- Through non-blocking HTTP request to `wp-cron.php`
- Can be disabled with `DISABLE_WP_CRON` constant

### System Cron Jobs

**Characteristics:**
- Runs independently of page visits
- More reliable timing
- Requires server access
- Better for high-traffic sites
- Uses system-level cron daemon

**Setting Up System Cron:**

1. **Disable WP-Cron:**
```php
// In wp-config.php
define( 'DISABLE_WP_CRON', true );
```

2. **Add System Cron Job:**
```bash
# Run every 5 minutes
*/5 * * * * wget -q -O - https://example.com/wp-cron.php?doing_wp_cron >/dev/null 2>&1

# Or using curl
*/5 * * * * curl -s https://example.com/wp-cron.php?doing_wp_cron >/dev/null 2>&1
```

**Comparison:**

| Aspect | WP-Cron | System Cron |
|-------|---------|-------------|
| **Trigger** | Page visits | System scheduler |
| **Reliability** | Depends on traffic | Always runs |
| **Performance** | Can impact page load | No impact on requests |
| **Setup** | Automatic | Manual configuration |
| **Access Required** | None | Server/cPanel access |

---

## 3. Handle Missed or Duplicate Events

### Preventing Duplicate Events

WordPress automatically prevents duplicate events within 10 minutes:

```108:162:wordpress/wp-includes/cron.php
	/*
	 * Check for a duplicated event.
	 *
	 * Don't schedule an event if there's already an identical event
	 * within 10 minutes.
	 *
	 * When scheduling events within ten minutes of the current time,
	 * all past identical events are considered duplicates.
	 *
	 * When scheduling an event with a past timestamp (ie, before the
	 * current time) all events scheduled within the next ten minutes
	 * are considered duplicates.
	 */
	$crons = _get_cron_array();

	$key       = md5( serialize( $event->args ) );
	$duplicate = false;

	if ( $event->timestamp < time() + 10 * MINUTE_IN_SECONDS ) {
		$min_timestamp = 0;
	} else {
		$min_timestamp = $event->timestamp - 10 * MINUTE_IN_SECONDS;
	}

	if ( $event->timestamp < time() ) {
		$max_timestamp = time() + 10 * MINUTE_IN_SECONDS;
	} else {
		$max_timestamp = $event->timestamp + 10 * MINUTE_IN_SECONDS;
	}

	foreach ( $crons as $event_timestamp => $cron ) {
		if ( $event_timestamp < $min_timestamp ) {
			continue;
		}

		if ( $event_timestamp > $max_timestamp ) {
			break;
		}

		if ( isset( $cron[ $event->hook ][ $key ] ) ) {
			$duplicate = true;
			break;
		}
	}

	if ( $duplicate ) {
		if ( $wp_error ) {
			return new WP_Error(
				'duplicate_event',
				__( 'A duplicate event already exists.' )
			);
		}

		return false;
	}
```

### Handling Missed Events

WordPress runs all events that are due when `wp-cron.php` is executed. Events scheduled in the past are executed immediately.

**Best Practices:**

1. **Use Idempotent Callbacks:**
```php
add_action( 'my_plugin_sync', 'sync_data' );
function sync_data() {
	// Check if already synced
	$last_sync = get_option( 'last_sync_timestamp' );
	$now = time();

	// Only sync if not synced in last hour
	if ( $last_sync && ( $now - $last_sync ) < HOUR_IN_SECONDS ) {
		return;
	}

	// Perform sync
	perform_sync();

	update_option( 'last_sync_timestamp', $now );
}
```

2. **Handle Long-Running Tasks:**
```php
add_action( 'my_plugin_process_queue', 'process_queue' );
function process_queue() {
	$lock_key = 'processing_queue';

	// Prevent concurrent execution
	if ( get_transient( $lock_key ) ) {
		return;
	}

	set_transient( $lock_key, true, 5 * MINUTE_IN_SECONDS );

	try {
		// Process items
		process_queue_items();
	} finally {
		delete_transient( $lock_key );
	}
}
```

3. **Reschedule Failed Events:**
```php
add_action( 'my_plugin_task', 'perform_task' );
function perform_task() {
	$result = do_expensive_operation();

	if ( is_wp_error( $result ) ) {
		// Reschedule for retry in 15 minutes
		wp_schedule_single_event( time() + 15 * MINUTE_IN_SECONDS, 'my_plugin_task' );
		error_log( 'Task failed, rescheduled: ' . $result->get_error_message() );
		return;
	}

	// Success - log and continue
}
```

### Unscheduling Events

**Functions:**
- `wp_unschedule_event( $timestamp, $hook, $args = array() )` - Unschedule specific event
- `wp_clear_scheduled_hook( $hook, $args = array() )` - Clear all events for a hook

**Example:**
```php
// Unschedule on plugin deactivation
register_deactivation_hook( __FILE__, 'my_plugin_deactivate' );
function my_plugin_deactivate() {
	$timestamp = wp_next_scheduled( 'my_plugin_daily_task' );
	if ( $timestamp ) {
		wp_unschedule_event( $timestamp, 'my_plugin_daily_task' );
	}

	// Or clear all instances
	wp_clear_scheduled_hook( 'my_plugin_daily_task' );
}
```

---

## 4. Optimise Cron Performance in High-Traffic Environments

### Use System Cron Instead of WP-Cron

For high-traffic sites, disable WP-Cron and use system cron:

```php
// wp-config.php
define( 'DISABLE_WP_CRON', true );
```

**Benefits:**
- No impact on page load times
- More reliable execution timing
- Better resource management
- Prevents concurrent execution issues

### Limit Concurrent Execution

Use transients to prevent multiple instances:

```php
add_action( 'my_plugin_heavy_task', 'heavy_task' );
function heavy_task() {
	$lock = 'heavy_task_running';

	// Check if already running
	if ( get_transient( $lock ) ) {
		return;
	}

	// Set lock for 10 minutes
	set_transient( $lock, true, 10 * MINUTE_IN_SECONDS );

	try {
		// Perform heavy operation
		perform_heavy_operation();
	} finally {
		// Always release lock
		delete_transient( $lock );
	}
}
```

### Batch Processing

Break large tasks into smaller batches:

```php
add_action( 'my_plugin_process_batch', 'process_batch' );
function process_batch( $offset = 0 ) {
	$batch_size = 100;
	$items = get_items_to_process( $offset, $batch_size );

	if ( empty( $items ) ) {
		// All done
		return;
	}

	// Process batch
	foreach ( $items as $item ) {
		process_item( $item );
	}

	// Schedule next batch
	wp_schedule_single_event( time() + 30, 'my_plugin_process_batch', array( $offset + $batch_size ) );
}
```

### Monitor Cron Performance

Track execution time and failures:

```php
add_action( 'my_plugin_task', 'monitored_task' );
function monitored_task() {
	$start_time = microtime( true );

	try {
		perform_task();
		$duration = microtime( true ) - $start_time;

		// Log success
		update_option( 'last_task_duration', $duration );
		update_option( 'last_task_status', 'success' );
	} catch ( Exception $e ) {
		// Log failure
		update_option( 'last_task_status', 'failed' );
		update_option( 'last_task_error', $e->getMessage() );

		error_log( 'Cron task failed: ' . $e->getMessage() );
	}
}
```

### Use Appropriate Schedules

Avoid scheduling too frequently:

```php
// ❌ BAD - Too frequent for high-traffic site
wp_schedule_event( time(), 'hourly', 'my_plugin_frequent_task' );

// ✅ GOOD - Less frequent, batch processing
wp_schedule_event( time(), 'daily', 'my_plugin_daily_task' );
```

### Clean Up Old Events

Remove unnecessary scheduled events:

```php
// Remove old single events that never ran
function cleanup_old_cron_events() {
	$crons = _get_cron_array();
	$now = time();
	$cleaned = 0;

	foreach ( $crons as $timestamp => $cronhooks ) {
		// Remove events older than 24 hours that are single events
		if ( $timestamp < $now - DAY_IN_SECONDS ) {
			foreach ( $cronhooks as $hook => $keys ) {
				foreach ( $keys as $key => $data ) {
					if ( false === $data['schedule'] ) {
						wp_unschedule_event( $timestamp, $hook, $data['args'] );
						$cleaned++;
					}
				}
			}
		}
	}

	return $cleaned;
}
```

---

## Exam Tips

### Key Points to Remember

1. **WP-Cron vs System Cron:**
   - WP-Cron: Triggered by page visits, pseudo-cron
   - System Cron: Independent, more reliable
   - Use `DISABLE_WP_CRON` to switch to system cron

2. **Scheduling:**
   - Always check `wp_next_scheduled()` before scheduling
   - Use UTC timestamps
   - Duplicate events within 10 minutes are prevented automatically

3. **Recurrence Schedules:**
   - Default: hourly, twicedaily, daily, weekly
   - Add custom schedules via `cron_schedules` filter
   - Interval must be in seconds

4. **Performance:**
   - Use system cron for high-traffic sites
   - Prevent concurrent execution with locks
   - Batch large tasks
   - Monitor execution time

5. **Common Mistakes:**
   - Not checking for existing events before scheduling
   - Scheduling too frequently
   - Not cleaning up on deactivation
   - Not handling missed events gracefully

---

## Additional Resources

- [WP-Cron - WordPress Developer Resources](https://developer.wordpress.org/plugins/cron/)
- [Function Reference: wp_schedule_event](https://developer.wordpress.org/reference/functions/wp_schedule_event/)
- [Function Reference: wp_schedule_single_event](https://developer.wordpress.org/reference/functions/wp_schedule_single_event/)
- Core Files:
  - `wp-includes/cron.php` - Cron API implementation
  - `wp-cron.php` - Cron execution file
