# 1.9 Multisite - Study Notes

## Overview

WordPress Multisite is a feature that allows you to create a network of multiple WordPress sites from a single WordPress installation. All sites share the same WordPress core, plugins, and themes, but have separate content, users, and settings. Understanding when to use Multisite vs multiple installs, and how to manage sites, roles, and permissions is crucial for enterprise WordPress development.

**Key Reference:** [Create a Network - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/multisite/create-network/)

---

## 1. Understand Multisite Architecture and Shared Database Structure

### Database Structure

**Shared Tables (Network-wide):**
- `wp_users` - All users across network
- `wp_usermeta` - User metadata
- `wp_blogs` - Site information (WP 4.5+)
- `wp_blog_versions` - Site versions
- `wp_registration_log` - Site registrations
- `wp_signups` - Pending site signups
- `wp_site` - Network information
- `wp_sitemeta` - Network options

**Per-Site Tables:**
Each site has its own set of tables with a numeric prefix:
- `wp_1_posts`, `wp_2_posts`, etc.
- `wp_1_options`, `wp_2_options`, etc.
- `wp_1_postmeta`, `wp_2_postmeta`, etc.

**Table Prefix Pattern:**
```php
$wpdb->get_blog_prefix( $site_id ); // Returns 'wp_1_', 'wp_2_', etc.
```

### Site vs Network

- **Network:** The entire Multisite installation
- **Site:** Individual WordPress site within the network
- **Main Site:** The first site (ID = 1), acts as network admin

### Core Classes

**WP_Site Class:**
```26:107:wordpress/wp-includes/class-wp-site.php
final class WP_Site {

	/**
	 * Site ID.
	 *
	 * Named "blog" vs. "site" for legacy reasons.
	 *
	 * A numeric string, for compatibility reasons.
	 *
	 * @since 4.5.0
	 * @var string
	 */
	public $blog_id;

	/**
	 * Domain of the site.
	 *
	 * @since 4.5.0
	 * @var string
	 */
	public $domain = '';

	/**
	 * Path of the site.
	 *
	 * @since 4.5.0
	 * @var string
	 */
	public $path = '';

	/**
	 * The ID of the site's parent network.
	 *
	 * Named "site" vs. "network" for legacy reasons. An individual site's "site" is
	 * its network.
	 *
	 * A numeric string, for compatibility reasons.
	 *
	 * @since 4.5.0
	 * @var string
	 */
	public $site_id = '0';

	/**
	 * The date and time on which the site was created or registered.
	 *
	 * @since 4.5.0
	 * @var string Date in MySQL's datetime format.
	 */
	public $registered = '0000-00-00 00:00:00';

	/**
	 * The date and time on which site settings were last updated.
	 *
	 * @since 4.5.0
	 * @var string Date in MySQL's datetime format.
	 */
	public $last_updated = '0000-00-00 00:00:00';

	/**
	 * Whether the site should be treated as public.
	 *
	 * A numeric string, for compatibility reasons.
	 *
	 * @since 4.5.0
	 * @var string
	 */
	public $public = '1';

	/**
	 * Whether the site should be treated as archived.
	 *
	 * A numeric string, for compatibility reasons.
	 *
	 * @since 4.5.0
	 * @var string
	 */
	public $archived = '0';

	/**
	 * Whether the site should be treated as mature.
	 *
	 * A numeric string, for compatibility reasons.
	 *
	 * @since 4.5.0
	 * @var string
	 */
```

---

## 2. Evaluate When to Use Multisite vs Multiple Installs

### Use Multisite When:

- **Related Sites:** Sites share content, users, or functionality
- **Central Management:** Need to manage multiple sites from one admin
- **Shared Resources:** Want to share plugins/themes across sites
- **User Management:** Users need access to multiple sites
- **Cost Efficiency:** Want to reduce hosting costs

**Examples:**
- Corporate intranet with department sites
- Educational institution with course sites
- Franchise with location sites
- Multi-language sites

### Use Multiple Installs When:

- **Isolated Sites:** Sites are completely independent
- **Different Requirements:** Sites need different plugins/themes
- **Security Isolation:** Need complete separation for security
- **Different Versions:** Sites need different WordPress versions
- **Performance:** Sites have very different traffic patterns

**Examples:**
- Client sites on shared hosting
- Sites with conflicting plugin requirements
- High-security sites requiring isolation

---

## 3. Manage Site Creation, Roles, and Permissions

### Creating Sites

**Function:** `wp_insert_site( $data )`

**Core Implementation:**
```11:42:wordpress/wp-includes/ms-site.php
/**
 * Inserts a new site into the database.
 *
 * @since 5.1.0
 *
 * @global wpdb $wpdb WordPress database abstraction object.
 *
 * @param array $data {
 *     Data for the new site that should be inserted.
 *
 *     @type string $domain       Site domain. Default empty string.
 *     @type string $path         Site path. Default '/'.
 *     @type int    $network_id   The site's network ID. Default is the current network ID.
 *     @type string $registered   When the site was registered, in SQL datetime format. Default is
 *                                the current time.
 *     @type string $last_updated When the site was last updated, in SQL datetime format. Default is
 *                                the value of $registered.
 *     @type int    $public       Whether the site is public. Default 1.
 *     @type int    $archived     Whether the site is archived. Default 0.
 *     @type int    $mature       Whether the site is mature. Default 0.
 *     @type int    $spam         Whether the site is spam. Default 0.
 *     @type int    $deleted      Whether the site is deleted. Default 0.
 *     @type int    $lang_id      The site's language ID. Currently unused. Default 0.
 *     @type int    $user_id      User ID for the site administrator. Passed to the
 *                                `wp_initialize_site` hook.
 *     @type string $title        Site title. Default is 'Site %d' where %d is the site ID. Passed
 *                                to the `wp_initialize_site` hook.
 *     @type array  $options      Custom option $key => $value pairs to use. Default empty array. Passed
 *                                to the `wp_initialize_site` hook.
 *     @type array  $meta         Custom site metadata $key => $value pairs to use. Default empty array.
 *                                Passed to the `wp_initialize_site` hook.
 * }
 * @return int|WP_Error The new site's ID on success, or error object on failure.
 */
```

**Example:**
```php
$site_id = wp_insert_site( array(
	'domain'  => 'newsite.example.com',
	'path'    => '/',
	'title'   => 'New Site',
	'user_id' => 1,
	'options' => array(
		'blogname' => 'New Site',
	),
) );
```

### Site Roles

**Network Admin:**
- Full control over entire network
- Can create/delete sites
- Manages network settings
- Access via `is_super_admin()`

**Site Admin:**
- Full control over individual site
- Cannot manage network
- Can manage site users, plugins, themes

**User Roles:**
- Same roles as single-site (Administrator, Editor, Author, etc.)
- Roles are site-specific
- Users can have different roles on different sites

### Switching Between Sites

```php
// Switch to a site
switch_to_blog( $site_id );

// Do something on that site
$posts = get_posts();

// Restore original site
restore_current_blog();
```

**Important:** Always restore after switching!

---

## 4. Recognize Limitations (Plugins/Themes, Domain Mapping)

### Plugin Limitations

- **Network Activation:** Plugins activated network-wide affect all sites
- **Site-Specific Activation:** Some plugins may not work properly
- **Plugin Compatibility:** Not all plugins support Multisite
- **Update Management:** Updates affect all sites

### Theme Limitations

- **Network Themes:** Themes available to all sites
- **Site-Specific Themes:** Can enable/disable per site
- **Theme Updates:** Updates affect all sites using theme
- **Child Themes:** Work the same as single-site

### Domain Mapping

**Limitations:**
- Requires additional configuration
- May need DNS changes
- Some hosting providers have restrictions
- SSL certificates needed per domain

**Solutions:**
- Use domain mapping plugins
- Configure at server level
- Use CDN with custom domains

### Other Limitations

- **Performance:** All sites share same database
- **Backups:** More complex backup strategies needed
- **Scaling:** Harder to scale individual sites
- **Plugin Conflicts:** Network-activated plugins affect all sites
- **Database Size:** Can grow very large with many sites

---

## Exam Tips

### Key Points to Remember

1. **Database Structure:**
   - Shared tables for users and network data
   - Per-site tables with numeric prefixes
   - Main site always has ID = 1

2. **When to Use:**
   - Multisite: Related sites, shared management
   - Multiple installs: Isolated sites, different requirements

3. **Site Management:**
   - Use `switch_to_blog()` to work with different sites
   - Always call `restore_current_blog()`
   - Network admin has full control

4. **Limitations:**
   - Plugin/theme compatibility
   - Domain mapping complexity
   - Performance considerations
   - Backup complexity

---

## Additional Resources

- [Create a Network - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/multisite/create-network/)
- [Multisite Network Administration - WordPress Codex](https://codex.wordpress.org/Multisite_Network_Administration)
- Core Files:
  - `wp-includes/ms-site.php` - Site management functions
  - `wp-includes/class-wp-site.php` - WP_Site class
