# 1.11 WP_Query - Study Notes

## Overview

WP_Query is the core class WordPress uses to query posts from the database. It handles all post queries including the main query, custom queries, and archive queries. Understanding how to construct efficient and secure queries with WP_Query is essential for WordPress development.

**Key Reference:** [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)

---

## 1. Build Custom Queries with Arguments (Meta, Taxonomy, Date)

### Basic WP_Query Usage

**Class:** `WP_Query`

**Core Implementation:**
```18:125:wordpress/wp-includes/class-wp-query.php
#[AllowDynamicProperties]
class WP_Query {

	/**
	 * Query vars set by the user.
	 *
	 * @since 1.5.0
	 * @var array
	 */
	public $query;

	/**
	 * Query vars, after parsing.
	 *
	 * @since 1.5.0
	 * @var array
	 */
	public $query_vars = array();

	/**
	 * Taxonomy query, as passed to get_tax_sql().
	 *
	 * @since 3.1.0
	 * @var WP_Tax_Query|null A taxonomy query instance.
	 */
	public $tax_query;

	/**
	 * Metadata query container.
	 *
	 * @since 3.2.0
	 * @var WP_Meta_Query A meta query instance.
	 */
	public $meta_query = false;

	/**
	 * Date query container.
	 *
	 * @since 3.7.0
	 * @var WP_Date_Query A date query instance.
	 */
	public $date_query = false;
```

**Example:**
```php
$args = array(
	'post_type' => 'post',
	'posts_per_page' => 10,
	'orderby' => 'date',
	'order' => 'DESC',
);

$query = new WP_Query( $args );

if ( $query->have_posts() ) {
	while ( $query->have_posts() ) {
		$query->the_post();
		// Display post
	}
	wp_reset_postdata();
}
```

### Meta Queries

Query posts by custom field values:

```php
$args = array(
	'post_type' => 'product',
	'meta_query' => array(
		'relation' => 'AND',
		array(
			'key' => 'price',
			'value' => 100,
			'compare' => '>=',
			'type' => 'NUMERIC',
		),
		array(
			'key' => 'featured',
			'value' => 'yes',
			'compare' => '=',
		),
	),
);

$query = new WP_Query( $args );
```

**Meta Query Parameters:**
- `key` - Meta key to query
- `value` - Value to compare
- `compare` - Comparison operator (=, !=, >, >=, <, <=, LIKE, NOT LIKE, IN, NOT IN, BETWEEN, NOT BETWEEN, EXISTS, NOT EXISTS)
- `type` - Value type (NUMERIC, BINARY, CHAR, DATE, DATETIME, DECIMAL, SIGNED, TIME, UNSIGNED)

### Taxonomy Queries

Query posts by taxonomy terms:

```php
$args = array(
	'post_type' => 'product',
	'tax_query' => array(
		'relation' => 'AND',
		array(
			'taxonomy' => 'product_category',
			'field' => 'slug',
			'terms' => array( 'electronics', 'computers' ),
			'operator' => 'IN',
		),
		array(
			'taxonomy' => 'product_tag',
			'field' => 'term_id',
			'terms' => array( 5, 12 ),
			'operator' => 'NOT IN',
		),
	),
);

$query = new WP_Query( $args );
```

**Taxonomy Query Parameters:**
- `taxonomy` - Taxonomy name
- `field` - Field to match (term_id, name, slug, term_taxonomy_id)
- `terms` - Term values to match
- `operator` - Operator (IN, NOT IN, AND, EXISTS, NOT EXISTS)

### Date Queries

Query posts by date:

```php
$args = array(
	'date_query' => array(
		array(
			'year' => 2024,
			'month' => 3,
		),
		array(
			'after' => '2024-01-01',
			'before' => '2024-12-31',
			'inclusive' => true,
		),
	),
);

$query = new WP_Query( $args );
```

**Date Query Parameters:**
- `year`, `month`, `day`, `hour`, `minute`, `second`
- `after`, `before` - Date strings
- `inclusive` - Include boundary dates
- `compare` - Comparison operator

---

## 2. Handle Pagination Correctly

### Basic Pagination

```php
$paged = ( get_query_var( 'paged' ) ) ? get_query_var( 'paged' ) : 1;

$args = array(
	'post_type' => 'post',
	'posts_per_page' => 10,
	'paged' => $paged,
);

$query = new WP_Query( $args );
```

### Pagination Functions

```php
// Get pagination links
echo paginate_links( array(
	'total' => $query->max_num_pages,
	'current' => $paged,
) );

// Previous/Next links
previous_posts_link( 'Previous' );
next_posts_link( 'Next', $query->max_num_pages );
```

### Archive Pagination

For archive pages, use `posts_per_archive_page`:

```php
$args = array(
	'post_type' => 'product',
	'posts_per_archive_page' => 20,
);
```

---

## 3. Distinguish Between WP_Query, query_posts, and get_posts

### WP_Query

- **Use:** Custom queries, secondary loops
- **Returns:** WP_Query object
- **Modifies:** Nothing (safe)
- **Best For:** Complex queries, multiple queries

```php
$query = new WP_Query( $args );
if ( $query->have_posts() ) {
	while ( $query->have_posts() ) {
		$query->the_post();
	}
	wp_reset_postdata();
}
```

### get_posts()

- **Use:** Simple queries, get array of posts
- **Returns:** Array of WP_Post objects
- **Modifies:** Nothing (safe)
- **Best For:** Simple queries, no loop needed

```php
$posts = get_posts( array(
	'post_type' => 'product',
	'posts_per_page' => 10,
) );

foreach ( $posts as $post ) {
	setup_postdata( $post );
	// Display post
}
wp_reset_postdata();
```

### query_posts()

- **Use:** ❌ **NEVER USE** - Modifies main query
- **Returns:** Array of posts
- **Modifies:** Main query (dangerous!)
- **Best For:** Nothing - use pre_get_posts filter instead

```php
// ❌ BAD - Don't use!
query_posts( $args );

// ✅ GOOD - Use pre_get_posts filter
add_action( 'pre_get_posts', 'modify_main_query' );
function modify_main_query( $query ) {
	if ( ! is_admin() && $query->is_main_query() ) {
		$query->set( 'posts_per_page', 10 );
	}
}
```

---

## 4. Optimize Queries with Indexes and Caching

### Query Optimization

**1. Limit Results:**
```php
// ✅ GOOD
$args = array(
	'posts_per_page' => 10,
	'no_found_rows' => true, // Skip pagination count
);

// ❌ BAD - No limit
$args = array(
	'posts_per_page' => -1, // Gets all posts!
);
```

**2. Use Specific Fields:**
```php
$args = array(
	'fields' => 'ids', // Only get IDs, not full objects
);
```

**3. Avoid Expensive Queries:**
```php
// ❌ BAD - Multiple meta queries
$args = array(
	'meta_query' => array(
		array( 'key' => 'field1' ),
		array( 'key' => 'field2' ),
		array( 'key' => 'field3' ),
	),
);

// ✅ GOOD - Use transients
$posts = get_transient( 'cached_posts' );
if ( false === $posts ) {
	$query = new WP_Query( $args );
	$posts = $query->posts;
	set_transient( 'cached_posts', $posts, HOUR_IN_SECONDS );
}
```

**4. Use Indexes:**
- Add indexes to frequently queried meta keys
- Use `meta_key` + `meta_value` for simple queries
- Avoid LIKE queries on meta values

### Caching Queries

```php
function get_cached_products() {
	$cache_key = 'products_' . md5( serialize( $args ) );
	$posts = wp_cache_get( $cache_key );

	if ( false === $posts ) {
		$query = new WP_Query( $args );
		$posts = $query->posts;
		wp_cache_set( $cache_key, $posts, '', 3600 );
	}

	return $posts;
}
```

---

## Exam Tips

### Key Points to Remember

1. **WP_Query vs get_posts vs query_posts:**
   - WP_Query: Custom queries, safe
   - get_posts: Simple queries, safe
   - query_posts: Never use!

2. **Query Arguments:**
   - `meta_query` for custom fields
   - `tax_query` for taxonomies
   - `date_query` for dates
   - Always use `posts_per_page`

3. **Pagination:**
   - Use `paged` for custom queries
   - Use `posts_per_archive_page` for archives
   - Always reset postdata

4. **Optimization:**
   - Limit results
   - Use caching
   - Add database indexes
   - Avoid unbounded queries

---

## Additional Resources

- [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)
- [Function Reference: get_posts](https://developer.wordpress.org/reference/functions/get_posts/)
- Core Files:
  - `wp-includes/class-wp-query.php` - WP_Query class
