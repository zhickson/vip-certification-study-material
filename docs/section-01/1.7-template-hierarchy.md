# 1.7 Template Hierarchy - Study Notes

## Overview

WordPress uses a template hierarchy to determine which template file to load for different types of content. The hierarchy allows themes to provide specific templates for different scenarios while maintaining fallbacks. Understanding the hierarchy is essential for both classic PHP-based themes and modern block themes.

**Key Reference:** [Template Hierarchy - WordPress Developer Resources](https://developer.wordpress.org/themes/basics/template-hierarchy/)

---

## 1. Navigate Classic PHP-Based Template Hierarchy

### How Template Resolution Works

WordPress checks template files in order of specificity, from most specific to least specific, until it finds a matching file.

**Core Implementation:**
```67:105:wordpress/wp-includes/template-loader.php
	$tag_templates = array(
		'is_embed'             => 'get_embed_template',
		'is_404'               => 'get_404_template',
		'is_search'            => 'get_search_template',
		'is_front_page'        => 'get_front_page_template',
		'is_home'              => 'get_home_template',
		'is_privacy_policy'    => 'get_privacy_policy_template',
		'is_post_type_archive' => 'get_post_type_archive_template',
		'is_tax'               => 'get_taxonomy_template',
		'is_attachment'        => 'get_attachment_template',
		'is_single'            => 'get_single_template',
		'is_page'              => 'get_page_template',
		'is_singular'          => 'get_singular_template',
		'is_category'          => 'get_category_template',
		'is_tag'               => 'get_tag_template',
		'is_author'            => 'get_author_template',
		'is_date'              => 'get_date_template',
		'is_archive'           => 'get_archive_template',
	);
	$template      = false;

	// Loop through each of the template conditionals, and find the appropriate template file.
	foreach ( $tag_templates as $tag => $template_getter ) {
		if ( call_user_func( $tag ) ) {
			$template = call_user_func( $template_getter );
		}

		if ( $template ) {
			if ( 'is_attachment' === $tag ) {
				remove_filter( 'the_content', 'prepend_attachment' );
			}

			break;
		}
	}

	if ( ! $template ) {
		$template = get_index_template();
	}
```

### Template Hierarchy Order

#### Homepage Templates

1. `front-page.php` - Static front page
2. `home.php` - Blog posts index
3. `index.php` - Fallback

#### Single Post Templates

1. `single-{post-type}-{slug}.php` - Specific post type and slug
2. `single-{post-type}.php` - Specific post type
3. `single.php` - All single posts
4. `singular.php` - All singular content
5. `index.php` - Fallback

**Example:**
- Post type `product` with slug `widget`: `single-product-widget.php`
- Post type `product`: `single-product.php`
- Any single post: `single.php`

#### Page Templates

1. Custom page template (assigned in page editor)
2. `page-{slug}.php` - Specific page slug
3. `page-{id}.php` - Specific page ID
4. `page.php` - All pages
5. `singular.php` - All singular content
6. `index.php` - Fallback

#### Category Templates

1. `category-{slug}.php` - Specific category slug
2. `category-{id}.php` - Specific category ID
3. `category.php` - All categories
4. `archive.php` - All archives
5. `index.php` - Fallback

#### Tag Templates

1. `tag-{slug}.php` - Specific tag slug
2. `tag-{id}.php` - Specific tag ID
3. `tag.php` - All tags
4. `archive.php` - All archives
5. `index.php` - Fallback

#### Taxonomy Templates

1. `taxonomy-{taxonomy}-{term}.php` - Specific taxonomy and term
2. `taxonomy-{taxonomy}.php` - Specific taxonomy
3. `taxonomy.php` - All taxonomies
4. `archive.php` - All archives
5. `index.php` - Fallback

#### Author Templates

1. `author-{nicename}.php` - Specific author nicename
2. `author-{id}.php` - Specific author ID
3. `author.php` - All authors
4. `archive.php` - All archives
5. `index.php` - Fallback

#### Archive Templates

1. `archive-{post-type}.php` - Specific post type archive
2. `archive.php` - All archives
3. `index.php` - Fallback

#### Search Templates

1. `search.php` - Search results
2. `index.php` - Fallback

#### 404 Templates

1. `404.php` - Not found page
2. `index.php` - Fallback

### Template Location Priority

**Core Implementation:**
```722:753:wordpress/wp-includes/template.php
function locate_template( $template_names, $load = false, $load_once = true, $args = array() ) {
	global $wp_stylesheet_path, $wp_template_path;

	if ( ! isset( $wp_stylesheet_path ) || ! isset( $wp_template_path ) ) {
		wp_set_template_globals();
	}

	$is_child_theme = is_child_theme();

	$located = '';
	foreach ( (array) $template_names as $template_name ) {
		if ( ! $template_name ) {
			continue;
		}
		if ( file_exists( $wp_stylesheet_path . '/' . $template_name ) ) {
			$located = $wp_stylesheet_path . '/' . $template_name;
			break;
		} elseif ( $is_child_theme && file_exists( $wp_template_path . '/' . $template_name ) ) {
			$located = $wp_template_path . '/' . $template_name;
			break;
		} elseif ( file_exists( ABSPATH . WPINC . '/theme-compat/' . $template_name ) ) {
			$located = ABSPATH . WPINC . '/theme-compat/' . $template_name;
			break;
		}
	}

	if ( $load && '' !== $located ) {
		load_template( $located, $load_once, $args );
	}

	return $located;
}
```

**Search Order:**
1. Child theme directory (if child theme)
2. Parent theme directory
3. WordPress core theme-compat directory

### Filtering Template Hierarchy

You can modify the template hierarchy using filters:

```php
// Modify single post template hierarchy
add_filter( 'single_template_hierarchy', 'my_custom_single_hierarchy' );
function my_custom_single_hierarchy( $templates ) {
	$post = get_queried_object();

	// Add custom template for specific post meta
	if ( get_post_meta( $post->ID, 'use_custom_template', true ) ) {
		array_unshift( $templates, 'single-custom.php' );
	}

	return $templates;
}
```

---

## 2. Use theme.json in Block Themes

### What is theme.json?

`theme.json` is a configuration file in block themes that defines:
- Global styles (colors, typography, spacing)
- Block settings and styles
- Template parts
- Custom CSS properties

### theme.json Structure

```json
{
	"$schema": "https://schemas.wp.org/trunk/theme.json",
	"version": 2,
	"settings": {
		"color": {
			"palette": [
				{
					"slug": "primary",
					"color": "#0073aa",
					"name": "Primary"
				}
			]
		},
		"typography": {
			"fontFamilies": [
				{
					"fontFamily": "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto",
					"slug": "system"
				}
			]
		}
	},
	"styles": {
		"color": {
			"background": "#ffffff",
			"text": "#000000"
		}
	},
	"templateParts": {
		"header": {
			"area": "header"
		},
		"footer": {
			"area": "footer"
		}
	}
}
```

### Block Theme Detection

**Core Implementation:**
```1578:1598:wordpress/wp-includes/class-wp-theme.php
	public function is_block_theme() {
		if ( isset( $this->block_theme ) ) {
			return $this->block_theme;
		}

		$paths_to_index_block_template = array(
			$this->get_file_path( '/templates/index.html' ),
			$this->get_file_path( '/block-templates/index.html' ),
		);

		$this->block_theme = false;

		foreach ( $paths_to_index_block_template as $path_to_index_block_template ) {
			if ( is_file( $path_to_index_block_template ) && is_readable( $path_to_index_block_template ) ) {
				$this->block_theme = true;
				break;
			}
		}

		return $this->block_theme;
	}
```

A block theme is detected if it contains:
- `/templates/index.html` or
- `/block-templates/index.html`

### Block Template Hierarchy

Block themes use HTML templates stored in the database (`wp_template` post type) or theme files.

**Template Resolution:**
```153:193:wordpress/wp-includes/block-template.php
function resolve_block_template( $template_type, $template_hierarchy, $fallback_template ) {
	if ( ! $template_type ) {
		return null;
	}

	if ( empty( $template_hierarchy ) ) {
		$template_hierarchy = array( $template_type );
	}

	$slugs = array_map(
		'_strip_template_file_suffix',
		$template_hierarchy
	);

	// Find all potential templates 'wp_template' post matching the hierarchy.
	$query     = array(
		'slug__in' => $slugs,
	);
	$templates = get_block_templates( $query );

	// Order these templates per slug priority.
	// Build map of template slugs to their priority in the current hierarchy.
	$slug_priorities = array_flip( $slugs );

	usort(
		$templates,
		static function ( $template_a, $template_b ) use ( $slug_priorities ) {
			return $slug_priorities[ $template_a->slug ] - $slug_priorities[ $template_b->slug ];
		}
	);

	$theme_base_path        = get_stylesheet_directory() . DIRECTORY_SEPARATOR;
	$parent_theme_base_path = get_template_directory() . DIRECTORY_SEPARATOR;

	// Is the active theme a child theme, and is the PHP fallback template part of it?
	if (
		str_starts_with( $fallback_template, $theme_base_path ) &&
		! str_contains( $fallback_template, $parent_theme_base_path )
	) {
		$fallback_template_slug = substr(
			$fallback_template,
```

**Block Template Locations:**
1. Database (`wp_template` post type) - User-edited templates
2. Theme `/templates/` directory - Theme-provided templates
3. Parent theme `/templates/` directory (if child theme)
4. PHP fallback templates (if hybrid theme)

### Block Template Hierarchy Order

Block templates follow similar hierarchy to PHP templates:

**Single Post:**
1. `single-{post-type}-{slug}` (database or file)
2. `single-{post-type}` (database or file)
3. `single` (database or file)
4. `singular` (database or file)
5. `index` (database or file)

**Page:**
1. Custom template (assigned in editor)
2. `page-{slug}` (database or file)
3. `page-{id}` (database or file)
4. `page` (database or file)
5. `singular` (database or file)
6. `index` (database or file)

---

## 3. Override Core Templates Safely

### Using Template Filters

**Filter:** `template_include`

**Core Implementation:**
```107:114:wordpress/wp-includes/template-loader.php
	/**
	 * Filters the path of the current template before including it.
	 *
	 * @since 3.0.0
	 *
	 * @param string $template The path of the template to include.
	 */
	$template = apply_filters( 'template_include', $template );
```

**Example:**
```php
add_filter( 'template_include', 'my_custom_template_override' );
function my_custom_template_override( $template ) {
	// Override for specific conditions
	if ( is_single() && 'product' === get_post_type() ) {
		$custom_template = locate_template( 'custom-product.php' );
		if ( $custom_template ) {
			return $custom_template;
		}
	}

	return $template;
}
```

### Using Template Hierarchy Filters

Modify the hierarchy before templates are located:

```php
// Add custom template to hierarchy
add_filter( 'single_template_hierarchy', 'add_custom_single_template' );
function add_custom_single_template( $templates ) {
	$post = get_queried_object();

	// Add custom template based on post meta
	if ( get_post_meta( $post->ID, 'custom_layout', true ) ) {
		array_unshift( $templates, 'single-custom-layout.php' );
	}

	return $templates;
}
```

### Child Theme Overrides

Child themes automatically override parent theme templates:

```
Parent Theme:
- single.php
- page.php

Child Theme:
- single.php (overrides parent)
- page.php (overrides parent)
```

### Best Practices

1. **Always Provide Fallbacks:**
```php
// ✅ GOOD
$template = locate_template( array( 'custom-template.php', 'fallback.php' ) );
if ( $template ) {
	return $template;
}
return $original_template;

// ❌ BAD - No fallback
return 'custom-template.php'; // May not exist
```

2. **Check File Existence:**
```php
$custom_template = get_template_directory() . '/custom-template.php';
if ( file_exists( $custom_template ) ) {
	return $custom_template;
}
```

3. **Use Appropriate Hooks:**
```php
// ✅ GOOD - Modify hierarchy
add_filter( 'single_template_hierarchy', 'my_filter' );

// ✅ GOOD - Override final template
add_filter( 'template_include', 'my_override' );

// ❌ BAD - Direct file include
include 'custom-template.php'; // Bypasses WordPress
```

---

## 4. Debug Template Selection

### Debugging Tools

#### 1. Query Monitor Plugin

Query Monitor shows:
- Which template is being used
- Template hierarchy order
- Template location (child/parent/core)

#### 2. Template Debug Mode

Enable template debugging in `wp-config.php`:

```php
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_DISPLAY', false );
define( 'SCRIPT_DEBUG', true );
```

#### 3. Custom Debug Code

```php
add_action( 'template_redirect', 'debug_template_selection' );
function debug_template_selection() {
	if ( ! current_user_can( 'manage_options' ) ) {
		return;
	}

	global $template;
	error_log( 'Template: ' . $template );
	error_log( 'Template Hierarchy: ' . print_r( get_query_template( get_post_type() ), true ) );
}
```

#### 4. Using Template Hierarchy Filters

```php
add_filter( 'single_template_hierarchy', 'log_template_hierarchy' );
function log_template_hierarchy( $templates ) {
	if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
		error_log( 'Single template hierarchy: ' . print_r( $templates, true ) );
	}
	return $templates;
}
```

#### 5. Check Template Conditionals

```php
add_action( 'template_redirect', 'debug_template_conditionals' );
function debug_template_conditionals() {
	if ( ! current_user_can( 'manage_options' ) ) {
		return;
	}

	$conditionals = array(
		'is_front_page' => is_front_page(),
		'is_home' => is_home(),
		'is_single' => is_single(),
		'is_page' => is_page(),
		'is_archive' => is_archive(),
		'is_category' => is_category(),
		'is_tag' => is_tag(),
		'is_author' => is_author(),
		'is_search' => is_search(),
		'is_404' => is_404(),
	);

	error_log( 'Template conditionals: ' . print_r( $conditionals, true ) );
}
```

### Common Issues

1. **Template Not Loading:**
   - Check file permissions
   - Verify file name matches hierarchy
   - Check for PHP syntax errors
   - Ensure file is in correct theme directory

2. **Wrong Template Loading:**
   - Verify template hierarchy order
   - Check for conflicting templates
   - Review template filters
   - Check child theme overrides

3. **Block Template Not Found:**
   - Verify theme is block theme
   - Check template exists in database
   - Verify template file location
   - Check template slug matches hierarchy

---

## Exam Tips

### Key Points to Remember

1. **Template Hierarchy Order:**
   - Most specific → Least specific
   - Child theme → Parent theme → Core
   - Always ends with `index.php`

2. **Block Themes:**
   - Use HTML templates, not PHP
   - Templates stored in database or `/templates/` directory
   - `theme.json` defines styles and settings
   - Detected by presence of `index.html` template

3. **Template Overrides:**
   - Use `template_include` filter for final override
   - Use hierarchy filters to modify search order
   - Always provide fallbacks
   - Check file existence

4. **Common Mistakes:**
   - Not providing `index.php` fallback
   - Incorrect template file naming
   - Bypassing WordPress template system
   - Not checking file existence

---

## Additional Resources

- [Template Hierarchy - WordPress Developer Resources](https://developer.wordpress.org/themes/basics/template-hierarchy/)
- [Block Themes - WordPress Developer Resources](https://developer.wordpress.org/themes/block-themes/)
- [theme.json - WordPress Developer Resources](https://developer.wordpress.org/themes/advanced-topics/theme-json/)
- Core Files:
  - `wp-includes/template-loader.php` - Template resolution logic
  - `wp-includes/template.php` - Template functions
  - `wp-includes/block-template.php` - Block template resolution
