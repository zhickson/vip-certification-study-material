# 1.16 Media Library - Study Notes

## Overview

The WordPress Media Library stores all uploaded files as attachment posts. Understanding the data model, image sizes, and the architectural differences between list and grid views is essential for working with media in WordPress.

**Key Reference:** [Media Library - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/media-library/)

---

## 1. Understand the Data Model (Attachment Posts and Post Meta)

### Attachment as Post Type

Attachments are stored as a special post type:

**Core Implementation:**
```92:124:wordpress/wp-includes/post.php
	register_post_type(
		'attachment',
		array(
			'labels'                => array(
				'name'           => _x( 'Media', 'post type general name' ),
				'name_admin_bar' => _x( 'Media', 'add new from admin bar' ),
				'add_new'        => __( 'Add Media File' ),
				'add_new_item'   => __( 'Add Media File' ),
				'edit_item'      => __( 'Edit Media' ),
				'view_item'      => ( '1' === get_option( 'wp_attachment_pages_enabled' ) ) ? __( 'View Attachment Page' ) : __( 'View Media File' ),
				'attributes'     => __( 'Attachment Attributes' ),
			),
			'public'                => true,
			'show_ui'               => true,
			'_builtin'              => true, /* internal use only. don't use this when registering your own post type. */
			'_edit_link'            => 'post.php?post=%d', /* internal use only. don't use this when registering your own post type. */
			'capability_type'       => 'post',
			'capabilities'          => array(
				'create_posts' => 'upload_files',
			),
			'map_meta_cap'          => true,
			'menu_icon'             => 'dashicons-admin-media',
			'hierarchical'          => false,
			'rewrite'               => false,
			'query_var'             => false,
			'show_in_nav_menus'     => false,
			'delete_with_user'      => true,
			'supports'              => array( 'title', 'author', 'comments' ),
			'show_in_rest'          => true,
			'rest_base'             => 'media',
			'rest_controller_class' => 'WP_REST_Attachments_Controller',
		)
	);
```

### Attachment Metadata

Attachments store metadata in post meta:

```php
// Get attachment metadata
$metadata = wp_get_attachment_metadata( $attachment_id );

// Common metadata fields:
// - width, height (for images)
// - file (file path)
// - sizes (image sizes)
// - image_meta (EXIF data)
```

### Working with Attachments

```php
// Get attachment
$attachment = get_post( $attachment_id );

// Get attachment URL
$url = wp_get_attachment_url( $attachment_id );

// Get attachment image
$image = wp_get_attachment_image( $attachment_id, 'thumbnail' );

// Get attached media
$media = get_attached_media( 'image', $post_id );
```

---

## 2. Intermediate Image Sizes

### Registered Image Sizes

WordPress creates multiple sizes of uploaded images:

**Default Sizes:**
- `thumbnail` - 150x150 (cropped)
- `medium` - 300x300 (max)
- `medium_large` - 768x768 (max)
- `large` - 1024x1024 (max)
- `full` - Original size

### Adding Custom Image Sizes

```php
add_action( 'after_setup_theme', 'add_custom_image_sizes' );
function add_custom_image_sizes() {
	add_image_size( 'product-thumbnail', 300, 300, true );
	add_image_size( 'hero-image', 1920, 1080, false );
}
```

**Parameters:**
- `$name` - Size name
- `$width` - Width in pixels
- `$height` - Height in pixels
- `$crop` - Crop mode (true/false/array)

### Regenerating Image Sizes

```php
// Regenerate thumbnails for existing images
wp_generate_attachment_metadata( $attachment_id, $file );
```

---

## 3. Know the Architectural Difference Between List (PHP) and Grid (Backbone.js) Views

### List View (PHP)

- **Technology:** Server-side PHP rendering
- **Location:** `wp-admin/upload.php`
- **Characteristics:**
  - Full page reloads
  - Traditional table layout
  - Server-rendered HTML
  - Better for accessibility
  - Slower for large libraries

### Grid View (Backbone.js)

- **Technology:** Client-side JavaScript (Backbone.js)
- **Location:** `wp-admin/upload.php?mode=grid`
- **Characteristics:**
  - AJAX-based loading
  - Modern grid interface
  - Faster interactions
  - Better UX for browsing
  - Requires JavaScript

**Core Implementation:**
```1397:1445:wordpress/wp-includes/js/media-models.js
/** @namespace wp */
window.wp = window.wp || {};

/**
 * Create and return a media frame.
 *
 * Handles the default media experience.
 *
 * @alias wp.media
 * @memberOf wp
 * @namespace
 *
 * @param {Object} attributes The properties passed to the main media controller.
 * @return {wp.media.view.MediaFrame} A media workflow.
 */
media = wp.media = function( attributes ) {
	var MediaFrame = media.view.MediaFrame,
		frame;

	if ( ! MediaFrame ) {
		return;
	}

	attributes = _.defaults( attributes || {}, {
		frame: 'select'
	});

	if ( 'select' === attributes.frame && MediaFrame.Select ) {
		frame = new MediaFrame.Select( attributes );
	} else if ( 'post' === attributes.frame && MediaFrame.Post ) {
		frame = new MediaFrame.Post( attributes );
	} else if ( 'manage' === attributes.frame && MediaFrame.Manage ) {
		frame = new MediaFrame.Manage( attributes );
	} else if ( 'image' === attributes.frame && MediaFrame.ImageDetails ) {
		frame = new MediaFrame.ImageDetails( attributes );
	} else if ( 'audio' === attributes.frame && MediaFrame.AudioDetails ) {
		frame = new MediaFrame.AudioDetails( attributes );
	} else if ( 'video' === attributes.frame && MediaFrame.VideoDetails ) {
		frame = new MediaFrame.VideoDetails( attributes );
	} else if ( 'edit-attachments' === attributes.frame && MediaFrame.EditAttachments ) {
		frame = new MediaFrame.EditAttachments( attributes );
	}

	delete attributes.frame;

	media.frame = frame;

	return frame;
};
```

---

## 4. Can Extend via APIs/Hooks

### Media Hooks

**Actions:**
- `add_attachment` - After attachment is added
- `edit_attachment` - After attachment is edited
- `delete_attachment` - Before attachment is deleted
- `wp_insert_attachment` - When inserting attachment

**Filters:**
- `wp_generate_attachment_metadata` - Modify metadata
- `attachment_fields_to_save` - Save custom fields
- `attachment_fields_to_edit` - Add custom fields
- `wp_get_attachment_image_attributes` - Modify image attributes

### Extending Media Library

**Add Custom Fields:**
```php
add_filter( 'attachment_fields_to_edit', 'add_attachment_fields', 10, 2 );
function add_attachment_fields( $fields, $post ) {
	$fields['custom_field'] = array(
		'label' => __( 'Custom Field' ),
		'input' => 'text',
		'value' => get_post_meta( $post->ID, 'custom_field', true ),
	);
	return $fields;
}

add_filter( 'attachment_fields_to_save', 'save_attachment_fields', 10, 2 );
function save_attachment_fields( $post, $attachment ) {
	if ( isset( $attachment['custom_field'] ) ) {
		update_post_meta( $post['ID'], 'custom_field', $attachment['custom_field'] );
	}
	return $post;
}
```

**Modify Image Metadata:**
```php
add_filter( 'wp_generate_attachment_metadata', 'add_image_metadata', 10, 2 );
function add_image_metadata( $metadata, $attachment_id ) {
	// Add custom metadata
	$metadata['custom_data'] = 'value';
	return $metadata;
}
```

---

## Exam Tips

### Key Points to Remember

1. **Data Model:**
   - Attachments are posts with `post_type = 'attachment'`
   - Metadata stored in post meta
   - Use `wp_get_attachment_metadata()` to get metadata

2. **Image Sizes:**
   - WordPress creates multiple sizes automatically
   - Use `add_image_size()` for custom sizes
   - Regenerate for existing images

3. **Views:**
   - List view: PHP, server-side
   - Grid view: Backbone.js, client-side
   - Different technologies, same data

4. **Extension:**
   - Use hooks to extend functionality
   - Add custom fields via filters
   - Modify metadata generation

---

## Additional Resources

- [Media Library - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/media-library/)
- [Function Reference: wp_get_attachment_metadata](https://developer.wordpress.org/reference/functions/wp_get_attachment_metadata/)
- Core Files:
  - `wp-includes/post.php` - Attachment post type
  - `wp-includes/media.php` - Media functions
