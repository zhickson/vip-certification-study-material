# 8.2 Restoring the Codebase - Study Notes

## Overview

Restoring the WordPress codebase involves rolling back to a safe, stable version from backups or version control. Ensuring file integrity, dependency consistency, and matching database schema is critical for successful recovery.

**Key Reference:** [WordPress Deployment - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/deployment/)

---

## 1. Restoring Code from Git

### Restore from Git Commit

**Basic Git Restore:**
```bash
# View commit history
git log --oneline -20

# Restore to specific commit
git checkout <commit-hash>

# Restore to previous commit
git checkout HEAD~1

# Restore to specific tag
git checkout v1.2.3

# Create restore branch
git checkout -b restore-$(date +%Y%m%d) <commit-hash>
```

**Safe Git Restore Process:**
```bash
#!/bin/bash
# git-restore.sh

TARGET_VERSION=$1

if [ -z "$TARGET_VERSION" ]; then
	echo "Usage: ./git-restore.sh <commit-hash-or-tag>"
	echo "Available tags:"
	git tag -l
	exit 1
fi

# 1. Backup current state
echo "Backing up current codebase..."
git stash push -m "backup-before-restore-$(date +%Y%m%d-%H%M%S)"

# 2. Backup database
wp db export backup-before-code-restore-$(date +%Y%m%d-%H%M%S).sql

# 3. Checkout target version
echo "Restoring to $TARGET_VERSION..."
git checkout "$TARGET_VERSION"

# 4. Verify checkout
if [ $? -eq 0 ]; then
	echo "Successfully restored to $TARGET_VERSION"
	git log -1 --oneline
else
	echo "Error: Failed to restore to $TARGET_VERSION"
	git checkout -  # Return to previous branch
	exit 1
fi

# 5. Update dependencies if needed
if [ -f "composer.json" ]; then
	composer install --no-dev
fi

if [ -f "package.json" ]; then
	npm install --production
fi
```

### Restore from Git Tag

**Tag-Based Restore:**
```bash
#!/bin/bash
# restore-from-tag.sh

TAG=$1

if [ -z "$TAG" ]; then
	echo "Usage: ./restore-from-tag.sh <tag-name>"
	echo "Available tags:"
	git tag -l | tail -10
	exit 1
fi

# Verify tag exists
if ! git rev-parse "$TAG" >/dev/null 2>&1; then
	echo "Error: Tag $TAG does not exist"
	exit 1
fi

# Backup current state
git tag "backup-before-restore-$(date +%Y%m%d-%H%M%S)"
wp db export backup-before-restore-$(date +%Y%m%d-%H%M%S).sql

# Checkout tag
git checkout "$TAG"

# Verify
CURRENT_TAG=$(git describe --tags --exact-match HEAD 2>/dev/null)
if [ "$CURRENT_TAG" = "$TAG" ]; then
	echo "Successfully restored to tag: $TAG"
else
	echo "Error: Restore verification failed"
	exit 1
fi
```

### Restore Specific Files from Git

**Selective File Restore:**
```bash
# Restore specific file from commit
git checkout <commit-hash> -- path/to/file.php

# Restore specific directory
git checkout <commit-hash> -- wp-content/plugins/my-plugin/

# Restore from HEAD (undo local changes)
git checkout HEAD -- path/to/file.php

# Restore from previous commit
git checkout HEAD~1 -- path/to/file.php
```

**Selective Restore Script:**
```bash
#!/bin/bash
# restore-files.sh

COMMIT=$1
FILES=$2

if [ -z "$COMMIT" ] || [ -z "$FILES" ]; then
	echo "Usage: ./restore-files.sh <commit-hash> <file1,file2,...>"
	exit 1
fi

# Backup current files
BACKUP_DIR="backup-files-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

IFS=',' read -ra FILE_ARRAY <<< "$FILES"
for file in "${FILE_ARRAY[@]}"; do
	if [ -f "$file" ]; then
		cp "$file" "$BACKUP_DIR/"
	fi
done

# Restore files from commit
for file in "${FILE_ARRAY[@]}"; do
	echo "Restoring $file from $COMMIT..."
	git checkout "$COMMIT" -- "$file"
done

echo "Files restored. Backup saved in $BACKUP_DIR"
```

---

## 2. Restoring from Backups

### Restore from File Backup

**Full Codebase Restore:**
```bash
#!/bin/bash
# restore-codebase.sh

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
	echo "Usage: ./restore-codebase.sh <backup-file.tar.gz>"
	exit 1
fi

# Verify backup exists
if [ ! -f "$BACKUP_FILE" ]; then
	echo "Error: Backup file not found: $BACKUP_FILE"
	exit 1
fi

# Backup current codebase
echo "Backing up current codebase..."
tar -czf backup-before-restore-$(date +%Y%m%d-%H%M%S).tar.gz \
	--exclude='wp-content/cache' \
	--exclude='wp-content/upgrade' \
	wp-content/

# Backup database
wp db export backup-before-code-restore-$(date +%Y%m%d-%H%M%S).sql

# Extract backup
TEMP_DIR=$(mktemp -d)
tar -xzf "$BACKUP_FILE" -C "$TEMP_DIR"

# Restore files
echo "Restoring files..."
rsync -avz --delete "$TEMP_DIR/" /var/www/html/

# Fix permissions
chown -R www-data:www-data /var/www/html/wp-content/
find /var/www/html/wp-content/ -type d -exec chmod 755 {} \;
find /var/www/html/wp-content/ -type f -exec chmod 644 {} \;

# Cleanup
rm -rf "$TEMP_DIR"

echo "Codebase restore complete"
```

### Partial Codebase Restore

**Restore Specific Directories:**
```bash
#!/bin/bash
# restore-partial.sh

BACKUP_FILE=$1
TARGET_DIR=$2

if [ -z "$BACKUP_FILE" ] || [ -z "$TARGET_DIR" ]; then
	echo "Usage: ./restore-partial.sh <backup-file> <target-dir>"
	echo "Example: ./restore-partial.sh backup.tar.gz wp-content/plugins/my-plugin"
	exit 1
fi

# Backup current directory
if [ -d "$TARGET_DIR" ]; then
	tar -czf "backup-$(basename $TARGET_DIR)-$(date +%Y%m%d).tar.gz" "$TARGET_DIR"
fi

# Extract specific directory from backup
tar -xzf "$BACKUP_FILE" "$TARGET_DIR" -C /tmp/

# Restore
if [ -d "/tmp/$TARGET_DIR" ]; then
	rm -rf "$TARGET_DIR"
	mv "/tmp/$TARGET_DIR" "$(dirname $TARGET_DIR)/"
	echo "Restored $TARGET_DIR"
else
	echo "Error: Directory not found in backup"
	exit 1
fi
```

---

## 3. Ensuring File Integrity

### Verify File Checksums

**WordPress Core Checksums:**
```bash
# Verify WordPress core files
wp core verify-checksums

# Verify specific version
wp core verify-checksums --version=6.1

# Download checksums and verify
wp core verify-checksums --version=6.1 --locale=en_US
```

**Custom File Integrity Check:**
```bash
#!/bin/bash
# verify-file-integrity.sh

# Generate checksums
find wp-content/ -type f -exec md5sum {} \; > checksums-current.txt

# Compare with backup checksums
if [ -f "checksums-backup.txt" ]; then
	diff checksums-current.txt checksums-backup.txt
	if [ $? -eq 0 ]; then
		echo "All files match backup checksums"
	else
		echo "WARNING: Files differ from backup"
	fi
fi
```

### Verify File Permissions

**Check and Fix Permissions:**
```bash
#!/bin/bash
# fix-permissions.sh

# WordPress recommended permissions
# Directories: 755
# Files: 644
# wp-config.php: 600

# Fix directory permissions
find /var/www/html/ -type d -exec chmod 755 {} \;

# Fix file permissions
find /var/www/html/ -type f -exec chmod 644 {} \;

# Secure wp-config.php
chmod 600 /var/www/html/wp-config.php

# Fix ownership
chown -R www-data:www-data /var/www/html/

echo "Permissions fixed"
```

---

## 4. Ensuring Dependency Consistency

### Composer Dependencies

**Restore Composer Dependencies:**
```bash
# Install dependencies from composer.lock
composer install --no-dev

# Update composer.lock if needed
composer update --lock

# Verify installed packages
composer show

# Check for outdated packages
composer outdated
```

**Composer Restore Script:**
```bash
#!/bin/bash
# restore-composer.sh

if [ ! -f "composer.json" ]; then
	echo "No composer.json found"
	exit 0
fi

# Backup current vendor
if [ -d "vendor" ]; then
	tar -czf vendor-backup-$(date +%Y%m%d).tar.gz vendor/
fi

# Install dependencies
composer install --no-dev --optimize-autoloader

# Verify installation
if [ -d "vendor" ] && [ -f "vendor/autoload.php" ]; then
	echo "Composer dependencies restored"
else
	echo "Error: Composer installation failed"
	exit 1
fi
```

### NPM Dependencies

**Restore NPM Dependencies:**
```bash
# Install from package-lock.json
npm ci

# Or install from package.json
npm install --production

# Verify installation
npm list --depth=0

# Check for vulnerabilities
npm audit
```

**NPM Restore Script:**
```bash
#!/bin/bash
# restore-npm.sh

if [ ! -f "package.json" ]; then
	echo "No package.json found"
	exit 0
fi

# Backup current node_modules
if [ -d "node_modules" ]; then
	tar -czf node_modules-backup-$(date +%Y%m%d).tar.gz node_modules/
fi

# Install dependencies
if [ -f "package-lock.json" ]; then
	npm ci --production
else
	npm install --production
fi

# Verify
if [ -d "node_modules" ]; then
	echo "NPM dependencies restored"
else
	echo "Error: NPM installation failed"
	exit 1
fi
```

### WordPress Core Dependencies

**Verify WordPress Core:**
```bash
# Check WordPress version
wp core version

# Verify core files
wp core verify-checksums

# Download specific version if needed
wp core download --version=6.1 --force

# Update database if core version changed
wp core update-db
```

---

## 5. Matching Codebase with Database Schema

### Check Version Compatibility

**Version Check Script:**
```bash
#!/bin/bash
# check-version-compatibility.sh

# Get codebase version
if [ -f "wp-includes/version.php" ]; then
	CODE_VERSION=$(grep "wp_version = " wp-includes/version.php | cut -d"'" -f2)
	echo "Codebase WordPress version: $CODE_VERSION"
else
	echo "Error: Cannot determine codebase version"
	exit 1
fi

# Get database version
DB_VERSION=$(wp option get db_version 2>/dev/null)
if [ -n "$DB_VERSION" ]; then
	echo "Database version: $DB_VERSION"
else
	echo "Error: Cannot determine database version"
	exit 1
fi

# Check compatibility
# Database version should match or be compatible with codebase version
echo "Checking compatibility..."
wp core verify-checksums
```

### Update Database Schema

**After Restoring Older Codebase:**
```bash
# Update database to match codebase
wp core update-db

# Check what updates will be applied
wp core update-db --dry-run

# Force update for multisite
wp core update-db --network
```

**Database Update Script:**
```bash
#!/bin/bash
# update-db-schema.sh

# Backup database before update
wp db export backup-before-schema-update-$(date +%Y%m%d-%H%M%S).sql

# Check current versions
CODE_VERSION=$(wp core version)
DB_VERSION=$(wp option get db_version)

echo "Code version: $CODE_VERSION"
echo "DB version: $DB_VERSION"

# Update database
wp core update-db

# Verify update
NEW_DB_VERSION=$(wp option get db_version)
echo "New DB version: $NEW_DB_VERSION"

# Verify checksums
if wp core verify-checksums; then
	echo "Schema update successful"
else
	echo "WARNING: Checksum verification failed"
fi
```

---

## 6. Validating Environment Stability

### Post-Restore Validation

**Comprehensive Validation Script:**
```bash
#!/bin/bash
# validate-restore.sh

echo "Validating codebase restore..."

# 1. Check file integrity
if wp core verify-checksums; then
	echo "✓ WordPress core checksums verified"
else
	echo "✗ ERROR: Core checksum verification failed"
	exit 1
fi

# 2. Check database connection
if wp db check; then
	echo "✓ Database connection successful"
else
	echo "✗ ERROR: Database connection failed"
	exit 1
fi

# 3. Check required files
REQUIRED_FILES=("wp-config.php" "wp-load.php" "index.php")

for file in "${REQUIRED_FILES[@]}"; do
	if [ -f "$file" ]; then
		echo "✓ $file exists"
	else
		echo "✗ ERROR: $file missing"
		exit 1
	fi
done

# 4. Check directory permissions
if [ -r "wp-content" ] && [ -w "wp-content" ]; then
	echo "✓ wp-content is readable and writable"
else
	echo "✗ ERROR: wp-content permissions incorrect"
	exit 1
fi

# 5. Test WordPress functionality
if wp core version > /dev/null 2>&1; then
	echo "✓ WordPress CLI functional"
else
	echo "✗ ERROR: WordPress CLI not functional"
	exit 1
fi

# 6. Check active plugins
ACTIVE_PLUGINS=$(wp plugin list --status=active --format=count)
echo "✓ Active plugins: $ACTIVE_PLUGINS"

# 7. Check active theme
ACTIVE_THEME=$(wp theme list --status=active --field=name)
echo "✓ Active theme: $ACTIVE_THEME"

# 8. Test site URL
SITE_URL=$(wp option get siteurl)
if curl -f -s "$SITE_URL" > /dev/null; then
	echo "✓ Site URL accessible: $SITE_URL"
else
	echo "✗ WARNING: Site URL not accessible: $SITE_URL"
fi

echo "Validation complete"
```

### Test WordPress Functionality

**Functionality Test:**
```bash
#!/bin/bash
# test-wordpress-functionality.sh

# Test admin login
wp user list --role=administrator

# Test post creation
POST_ID=$(wp post create --post_title="Test Post" --post_status=publish --porcelain)
if [ -n "$POST_ID" ]; then
	echo "✓ Post creation successful (ID: $POST_ID)"
	wp post delete "$POST_ID" --force
else
	echo "✗ ERROR: Post creation failed"
	exit 1
fi

# Test plugin activation
wp plugin list

# Test theme switching (if multiple themes available)
wp theme list

# Test database queries
POST_COUNT=$(wp post list --format=count)
echo "✓ Posts in database: $POST_COUNT"

USER_COUNT=$(wp user list --format=count)
echo "✓ Users in database: $USER_COUNT"
```

---

## 7. Rollback Strategies

### Atomic Rollback with Symlinks

**Symlink-Based Deployment:**
```bash
#!/bin/bash
# atomic-rollback.sh

TARGET_VERSION=$1

# Directory structure:
# /var/www/releases/
#   ├── 20240115120000/  # Version 1.2.2
#   ├── 20240115130000/  # Version 1.2.3 (current)
#   └── current -> 20240115130000

RELEASES_DIR="/var/www/releases"
CURRENT_LINK="/var/www/current"

# Find target release
TARGET_RELEASE=$(find "$RELEASES_DIR" -maxdepth 1 -type d -name "*$TARGET_VERSION*" | head -1)

if [ -z "$TARGET_RELEASE" ]; then
	echo "Error: Target version not found"
	exit 1
fi

# Atomic switch
ln -sfn "$TARGET_RELEASE" "$CURRENT_LINK.new"
mv "$CURRENT_LINK.new" "$CURRENT_LINK"

# Reload PHP-FPM
systemctl reload php-fpm

echo "Rolled back to $TARGET_VERSION"
```

### Blue-Green Deployment Rollback

**Blue-Green Rollback:**
```bash
#!/bin/bash
# blue-green-rollback.sh

# Switch from blue (broken) to green (working)
CURRENT_ENV=$(readlink /var/www/current)
if [[ "$CURRENT_ENV" == *"blue"* ]]; then
	TARGET_ENV="/var/www/green"
else
	TARGET_ENV="/var/www/blue"
fi

# Switch
ln -sfn "$TARGET_ENV" /var/www/current
systemctl reload php-fpm

echo "Switched to $(basename $TARGET_ENV) environment"
```

---

## Exam Tips

### Key Points to Remember

1. **Git Restore:**
   - Use `git checkout <commit>` for specific version
   - Use `git checkout <tag>` for tagged releases
   - Always backup before restore
   - Create restore branch for safety

2. **File Backup Restore:**
   - Extract to temporary directory first
   - Use rsync for safe file transfer
   - Fix permissions after restore
   - Verify file integrity

3. **Dependency Management:**
   - Restore Composer: `composer install --no-dev`
   - Restore NPM: `npm ci` or `npm install`
   - Verify dependencies match codebase version
   - Check for security vulnerabilities

4. **Schema Compatibility:**
   - Check WordPress version vs database version
   - Run `wp core update-db` if needed
   - Verify checksums after restore
   - Test functionality after schema update

5. **File Integrity:**
   - Use `wp core verify-checksums`
   - Check file permissions (755 dirs, 644 files)
   - Verify required files exist
   - Test WordPress functionality

6. **Validation:**
   - Always validate after restore
   - Test database connection
   - Test WordPress CLI
   - Test site accessibility
   - Verify plugins/themes

---

## Additional Resources

- [WordPress Deployment - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/deployment/)
- [WP-CLI Commands](https://wp-cli.org/commands/)
- [Git Documentation](https://git-scm.com/doc)
- [Composer Documentation](https://getcomposer.org/doc/)
- [NPM Documentation](https://docs.npmjs.com/)
- Core Files:
  - `wp-includes/version.php` - WordPress version
  - `wp-admin/includes/upgrade.php` - Database upgrade functions
