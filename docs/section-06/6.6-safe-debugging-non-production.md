# 6.6 Safe Debugging in Non-Production Environments - Study Notes

## Overview

Debugging in staging or development environments allows you to replicate production issues safely without impacting live users. Proper configuration and practices ensure accurate debugging while maintaining security and performance.

**Key Reference:** [Debugging in WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)

---

## 1. Configuring Staging to Match Production

### Environment Configuration

**Match Production Settings:**
```php
// wp-config.php - Staging
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
define( 'WP_DEBUG_DISPLAY', false );

// Match production PHP version
// Match production MySQL version
// Match production server configuration
```

### Database Synchronization

**Copy Production Database:**
```bash
# Export production database
wp db export production.sql

# Import to staging
wp db import production.sql

# Update URLs
wp search-replace 'https://example.com' 'https://staging.example.com'
```

### File Synchronization

**Copy Production Files:**
```bash
# Sync uploads directory
rsync -avz production:/var/www/html/wp-content/uploads/ staging:/var/www/html/wp-content/uploads/

# Sync plugins and themes
rsync -avz production:/var/www/html/wp-content/plugins/ staging:/var/www/html/wp-content/plugins/
rsync -avz production:/var/www/html/wp-content/themes/ staging:/var/www/html/wp-content/themes/
```

### Server Configuration

**Match Production Server:**
- Same PHP version
- Same MySQL/MariaDB version
- Same web server (Apache/Nginx)
- Same PHP extensions
- Same memory limits
- Same execution time limits

---

## 2. Reproducing Errors Without Impacting Live Users

### Error Reproduction

**Steps to Reproduce:**
1. Identify error conditions
2. Replicate user actions
3. Monitor error logs
4. Capture error details
5. Test fixes

### Isolated Testing

**Create Test Environment:**
```bash
# Create separate database
wp db create staging_db

# Use separate domain/subdomain
# staging.example.com

# Isolate from production
```

### Data Anonymization

**Protect User Data:**
```php
// Anonymize user data in staging
function anonymize_staging_data() {
    if ( 'staging' === wp_get_environment_type() ) {
        // Replace emails
        // Replace names
        // Remove sensitive data
    }
}
```

### Error Logging

**Enable Comprehensive Logging:**
```php
// wp-config.php
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
define( 'WP_DEBUG_DISPLAY', false );
define( 'SCRIPT_DEBUG', true );

// Log to custom location
ini_set( 'error_log', '/var/log/wordpress-staging-errors.log' );
```

---

## 3. Debugging Configurations Before Deployment

### Pre-Deployment Testing

**Test Configuration Changes:**
```php
// Test new constants
define( 'WP_CACHE', true );
define( 'WP_MEMORY_LIMIT', '256M' );

// Test in staging first
// Verify no errors
// Check performance impact
```

### Plugin/Theme Testing

**Test Updates:**
```bash
# Test plugin updates in staging
wp plugin update plugin-name --dry-run

# Test theme updates
wp theme update theme-name --dry-run

# Verify compatibility
```

### Database Changes

**Test Migrations:**
```php
// Test database schema changes
// Test data migrations
// Verify rollback procedures
// Test on staging database
```

### Performance Testing

**Benchmark Changes:**
```php
// Measure performance impact
timer_start();
// Code changes
$elapsed = timer_stop();

// Compare with production baseline
// Ensure no performance degradation
```

---

## 4. Staging Environment Best Practices

### Access Control

**Restrict Access:**
```php
// Password protect staging
// Use .htaccess or server config
// Limit to development team
// Use IP whitelist if possible
```

### Version Control

**Track Changes:**
```bash
# Use Git for staging
git checkout staging
git pull origin staging

# Test changes
# Commit fixes
# Merge to production
```

### Monitoring

**Monitor Staging:**
- Set up error monitoring
- Track performance metrics
- Monitor resource usage
- Alert on issues

### Cleanup

**Regular Cleanup:**
```bash
# Clean up test data
wp db query "DELETE FROM wp_posts WHERE post_type = 'test'"

# Clear caches
wp cache flush

# Remove debug logs
rm wp-content/debug.log
```

---

## 5. Debugging Workflow

### Issue Identification

**Steps:**
1. Reproduce issue in staging
2. Enable debug logging
3. Capture error details
4. Identify root cause
5. Test fix in staging
6. Deploy to production

### Error Capture

**Capture Error Details:**
```php
// Log error context
error_log( 'Error: ' . $error_message );
error_log( 'Context: ' . print_r( $context, true ) );
error_log( 'Stack trace: ' . wp_debug_backtrace_summary() );
```

### Fix Testing

**Test Fixes:**
```php
// Test fix in staging
// Verify error resolved
// Check for regressions
// Performance testing
// User acceptance testing
```

---

## Exam Tips

### Key Points to Remember

1. **Environment Matching:**
   - Match PHP/MySQL versions
   - Sync database and files
   - Match server configuration
   - Test configuration changes

2. **Safe Debugging:**
   - Use staging for debugging
   - Isolate from production
   - Anonymize sensitive data
   - Enable comprehensive logging

3. **Pre-Deployment:**
   - Test all changes in staging
   - Verify no errors
   - Check performance impact
   - Test rollback procedures

4. **Best Practices:**
   - Restrict staging access
   - Use version control
   - Monitor staging environment
   - Regular cleanup

5. **Workflow:**
   - Reproduce in staging
   - Debug and fix
   - Test thoroughly
   - Deploy to production

---

## Additional Resources

- [Debugging in WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)
- [WP-CLI Database Commands](https://wp-cli.org/commands/db/)
- [Environment Types - WordPress Developer Resources](https://developer.wordpress.org/reference/functions/wp_get_environment_type/)
