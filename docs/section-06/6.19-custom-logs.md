# 6.19 Custom Logs - Study Notes

## Overview

Custom logs allow you to maintain application-specific debug logs, organize debug output by feature, and rotate and manage log size for WordPress debugging and monitoring.

**Key Reference:** [PHP error_log()](https://www.php.net/manual/en/function.error-log.php) | [WordPress Debugging](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)

---

## 1. Writing to Custom Log Files

### Basic Custom Logging

**Simple Log Function:**
```php
function my_custom_log( $message, $data = null ) {
    $log_file = WP_CONTENT_DIR . '/logs/my-plugin.log';
    $log_dir = dirname( $log_file );

    // Create directory if it doesn't exist
    if ( ! file_exists( $log_dir ) ) {
        wp_mkdir_p( $log_dir );
    }

    $timestamp = date( 'Y-m-d H:i:s' );
    $log_message = "[{$timestamp}] {$message}";

    if ( $data !== null ) {
        $log_message .= ' | Data: ' . print_r( $data, true );
    }

    $log_message .= "\n";

    error_log( $log_message, 3, $log_file );
}
```

**Usage:**
```php
my_custom_log( 'User logged in', array( 'user_id' => 1 ) );
my_custom_log( 'Post saved', array( 'post_id' => 123 ) );
```

### Logging Class

**Custom Logger Class:**
```php
class My_Logger {
    private $log_file;
    private $log_level;

    const LEVEL_DEBUG = 'DEBUG';
    const LEVEL_INFO = 'INFO';
    const LEVEL_WARNING = 'WARNING';
    const LEVEL_ERROR = 'ERROR';

    public function __construct( $log_file, $log_level = self::LEVEL_INFO ) {
        $this->log_file = $log_file;
        $this->log_level = $log_level;

        // Create log directory
        $log_dir = dirname( $log_file );
        if ( ! file_exists( $log_dir ) ) {
            wp_mkdir_p( $log_dir );
        }
    }

    public function log( $level, $message, $context = array() ) {
        $levels = array(
            self::LEVEL_DEBUG => 0,
            self::LEVEL_INFO => 1,
            self::LEVEL_WARNING => 2,
            self::LEVEL_ERROR => 3,
        );

        if ( $levels[ $level ] < $levels[ $this->log_level ] ) {
            return;
        }

        $timestamp = date( 'Y-m-d H:i:s' );
        $log_entry = sprintf(
            "[%s] [%s] %s",
            $timestamp,
            $level,
            $message
        );

        if ( ! empty( $context ) ) {
            $log_entry .= ' | Context: ' . json_encode( $context );
        }

        $log_entry .= "\n";

        error_log( $log_entry, 3, $this->log_file );
    }

    public function debug( $message, $context = array() ) {
        $this->log( self::LEVEL_DEBUG, $message, $context );
    }

    public function info( $message, $context = array() ) {
        $this->log( self::LEVEL_INFO, $message, $context );
    }

    public function warning( $message, $context = array() ) {
        $this->log( self::LEVEL_WARNING, $message, $context );
    }

    public function error( $message, $context = array() ) {
        $this->log( self::LEVEL_ERROR, $message, $context );
    }
}

// Usage
$logger = new My_Logger( WP_CONTENT_DIR . '/logs/my-plugin.log', My_Logger::LEVEL_DEBUG );
$logger->info( 'User logged in', array( 'user_id' => 1 ) );
$logger->error( 'Database error', array( 'query' => $query ) );
```

---

## 2. Organizing Debug Output by Feature

### Feature-Based Logging

**Separate Log Files:**
```php
class Feature_Logger {
    private $feature;
    private $log_dir;

    public function __construct( $feature ) {
        $this->feature = $feature;
        $this->log_dir = WP_CONTENT_DIR . '/logs/' . $feature;

        if ( ! file_exists( $this->log_dir ) ) {
            wp_mkdir_p( $this->log_dir );
        }
    }

    public function log( $message, $data = null ) {
        $log_file = $this->log_dir . '/' . date( 'Y-m-d' ) . '.log';

        $timestamp = date( 'Y-m-d H:i:s' );
        $log_message = "[{$timestamp}] {$message}";

        if ( $data !== null ) {
            $log_message .= ' | ' . print_r( $data, true );
        }

        $log_message .= "\n";

        error_log( $log_message, 3, $log_file );
    }
}

// Usage
$auth_logger = new Feature_Logger( 'authentication' );
$auth_logger->log( 'User logged in', array( 'user_id' => 1 ) );

$api_logger = new Feature_Logger( 'api' );
$api_logger->log( 'API request', array( 'endpoint' => '/wp-json/wp/v2/posts' ) );
```

### Log Categories

**Category-Based Logging:**
```php
function my_log( $category, $message, $data = null ) {
    $log_file = WP_CONTENT_DIR . '/logs/' . $category . '.log';

    $timestamp = date( 'Y-m-d H:i:s' );
    $log_message = "[{$timestamp}] [{$category}] {$message}";

    if ( $data !== null ) {
        $log_message .= ' | ' . print_r( $data, true );
    }

    $log_message .= "\n";

    error_log( $log_message, 3, $log_file );
}

// Usage
my_log( 'authentication', 'Login successful', array( 'user_id' => 1 ) );
my_log( 'database', 'Query executed', array( 'query' => $query ) );
my_log( 'api', 'Request received', array( 'endpoint' => '/api/endpoint' ) );
```

---

## 3. Rotating and Managing Log Size

### Log Rotation

**Daily Rotation:**
```php
function my_log_with_rotation( $message, $data = null ) {
    $log_file = WP_CONTENT_DIR . '/logs/my-plugin-' . date( 'Y-m-d' ) . '.log';

    // Log message
    $timestamp = date( 'Y-m-d H:i:s' );
    $log_message = "[{$timestamp}] {$message}";

    if ( $data !== null ) {
        $log_message .= ' | ' . print_r( $data, true );
    }

    $log_message .= "\n";

    error_log( $log_message, 3, $log_file );

    // Clean old logs (older than 30 days)
    $log_dir = dirname( $log_file );
    $files = glob( $log_dir . '/my-plugin-*.log' );

    foreach ( $files as $file ) {
        if ( filemtime( $file ) < strtotime( '-30 days' ) ) {
            unlink( $file );
        }
    }
}
```

### Size-Based Rotation

**Rotate by Size:**
```php
function my_log_with_size_rotation( $message, $data = null ) {
    $log_file = WP_CONTENT_DIR . '/logs/my-plugin.log';
    $max_size = 10 * 1024 * 1024; // 10MB

    // Rotate if file is too large
    if ( file_exists( $log_file ) && filesize( $log_file ) > $max_size ) {
        $backup_file = $log_file . '.' . date( 'Y-m-d-His' );
        rename( $log_file, $backup_file );

        // Keep only last 5 backups
        $backups = glob( $log_file . '.*' );
        if ( count( $backups ) > 5 ) {
            usort( $backups, function( $a, $b ) {
                return filemtime( $a ) - filemtime( $b );
            } );
            unlink( $backups[0] );
        }
    }

    // Log message
    $timestamp = date( 'Y-m-d H:i:s' );
    $log_message = "[{$timestamp}] {$message}";

    if ( $data !== null ) {
        $log_message .= ' | ' . print_r( $data, true );
    }

    $log_message .= "\n";

    error_log( $log_message, 3, $log_file );
}
```

### WordPress Cron for Rotation

**Scheduled Cleanup:**
```php
// Schedule cleanup
add_action( 'init', function() {
    if ( ! wp_next_scheduled( 'my_log_cleanup' ) ) {
        wp_schedule_event( time(), 'daily', 'my_log_cleanup' );
    }
} );

// Cleanup old logs
add_action( 'my_log_cleanup', function() {
    $log_dir = WP_CONTENT_DIR . '/logs';
    $files = glob( $log_dir . '/*.log' );

    foreach ( $files as $file ) {
        // Delete logs older than 30 days
        if ( filemtime( $file ) < strtotime( '-30 days' ) ) {
            unlink( $file );
        }
    }
} );
```

---

## 4. Best Practices

### Security

**Protect Log Files:**
```php
// Add .htaccess to protect logs
function protect_log_directory() {
    $log_dir = WP_CONTENT_DIR . '/logs';
    $htaccess_file = $log_dir . '/.htaccess';

    if ( ! file_exists( $htaccess_file ) ) {
        file_put_contents( $htaccess_file, "deny from all\n" );
    }
}
```

### Performance

**Conditional Logging:**
```php
function my_log( $message, $data = null ) {
    if ( ! defined( 'MY_PLUGIN_DEBUG' ) || ! MY_PLUGIN_DEBUG ) {
        return;
    }

    // Logging code
}
```

### Error Handling

**Handle Log Errors:**
```php
function my_safe_log( $message, $data = null ) {
    $log_file = WP_CONTENT_DIR . '/logs/my-plugin.log';

    try {
        $log_dir = dirname( $log_file );
        if ( ! file_exists( $log_dir ) ) {
            wp_mkdir_p( $log_dir );
        }

        // Log message
        error_log( $message, 3, $log_file );
    } catch ( Exception $e ) {
        // Fallback to WordPress debug log
        error_log( 'Custom log failed: ' . $e->getMessage() );
    }
}
```

---

## Exam Tips

### Key Points to Remember

1. **Custom Logs:**
   - Use `error_log()` with file path
   - Create log directory if needed
   - Include timestamps
   - Add context data

2. **Organization:**
   - Separate logs by feature
   - Use categories
   - Daily log files
   - Feature-specific directories

3. **Rotation:**
   - Daily rotation
   - Size-based rotation
   - Cleanup old logs
   - Use WordPress cron

4. **Best Practices:**
   - Protect log files
   - Conditional logging
   - Error handling
   - Monitor log size

5. **Management:**
   - Regular cleanup
   - Archive old logs
   - Monitor disk space
   - Secure log access

---

## Additional Resources

- [PHP error_log()](https://www.php.net/manual/en/function.error-log.php)
- [WordPress Debugging](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)
- [Log Rotation Best Practices](https://www.loggly.com/ultimate-guide/log-rotation/)
