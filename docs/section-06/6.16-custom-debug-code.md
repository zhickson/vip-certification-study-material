# 6.16 Custom Debug Code - Study Notes

## Overview

Custom debug code using `error_log()`, `var_dump()`, and conditional debug statements is essential for troubleshooting WordPress issues. Understanding when and how to use these tools effectively is crucial for efficient debugging.

**Key Reference:** [PHP error_log()](https://www.php.net/manual/en/function.error-log.php) | [PHP var_dump()](https://www.php.net/manual/en/function.var-dump.php)

---

## 1. Using error_log() and var_dump()

### error_log()

**Basic Usage:**
```php
// Simple log message
error_log( 'Debug message' );

// Log with context
error_log( 'User ID: ' . get_current_user_id() );

// Log array/object
error_log( print_r( $array, true ) );
```

**Log to File:**
```php
// Log to custom file
error_log( 'Debug message', 3, '/path/to/debug.log' );

// Log with timestamp
error_log( date( 'Y-m-d H:i:s' ) . ' - Debug message' );
```

**Log Levels:**
```php
// Different log types
error_log( 'Info message', 0 );        // System log
error_log( 'Email message', 1, 'email@example.com' ); // Email
error_log( 'File message', 3, '/path/to/file.log' );  // File
```

### var_dump()

**Basic Usage:**
```php
// Dump variable
var_dump( $variable );

// Dump multiple variables
var_dump( $var1, $var2, $var3 );

// Dump with label
var_dump( 'User object:', $user );
```

**Output Control:**
```php
// Capture output
ob_start();
var_dump( $variable );
$output = ob_get_clean();
error_log( $output );

// Pretty print
echo '<pre>';
var_dump( $variable );
echo '</pre>';
```

**Limitations:**
- Outputs directly to screen (in development)
- Can break JSON/XML responses
- Should be removed in production
- Use `error_log()` for production debugging

---

## 2. Adding Conditional Debug Statements

### WP_DEBUG Conditional

**Check Before Debugging:**
```php
if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
    error_log( 'Debug message' );
    var_dump( $variable );
}
```

**Custom Debug Flag:**
```php
// Define custom debug flag
define( 'MY_PLUGIN_DEBUG', true );

if ( defined( 'MY_PLUGIN_DEBUG' ) && MY_PLUGIN_DEBUG ) {
    error_log( 'Plugin debug message' );
}
```

### Environment-Based Debugging

**Development Only:**
```php
if ( 'development' === wp_get_environment_type() ) {
    error_log( 'Development debug message' );
}
```

**Staging Only:**
```php
if ( 'staging' === wp_get_environment_type() ) {
    error_log( 'Staging debug message' );
}
```

### User-Based Debugging

**Admin Only:**
```php
if ( current_user_can( 'administrator' ) ) {
    error_log( 'Admin debug message' );
}
```

**Specific User:**
```php
if ( get_current_user_id() === 1 ) {
    error_log( 'User 1 debug message' );
}
```

---

## 3. Removing Temporary Code After Debugging

### Code Organization

**Mark Debug Code:**
```php
// TODO: Remove debug code
error_log( 'Debug message' );

// DEBUG: Remove after testing
var_dump( $variable );

// FIXME: Remove debug statements
if ( WP_DEBUG ) {
    error_log( 'Debug' );
}
```

**Use Functions:**
```php
// Create debug function
function my_debug_log( $message, $data = null ) {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        error_log( $message );
        if ( $data !== null ) {
            error_log( print_r( $data, true ) );
        }
    }
}

// Easy to remove later
my_debug_log( 'Debug message', $variable );
```

### Search and Remove

**Find Debug Code:**
```bash
# Search for error_log
grep -r "error_log" wp-content/

# Search for var_dump
grep -r "var_dump" wp-content/

# Search for debug comments
grep -r "DEBUG\|TODO\|FIXME" wp-content/
```

**Remove Debug Code:**
```php
// Before
if ( WP_DEBUG ) {
    error_log( 'Debug message' );
    var_dump( $variable );
}

// After (removed)
// Debug code removed
```

---

## 4. Best Practices

### Logging Best Practices

**Structured Logging:**
```php
// Good: Structured log
error_log( sprintf(
    '[%s] %s: %s | User: %d | Post: %d',
    date( 'Y-m-d H:i:s' ),
    'POST_SAVE',
    'Post saved successfully',
    get_current_user_id(),
    $post_id
) );
```

**Context Information:**
```php
// Include context
error_log( sprintf(
    'Function: %s | File: %s | Line: %d | Value: %s',
    __FUNCTION__,
    __FILE__,
    __LINE__,
    $value
) );
```

### Performance Considerations

**Avoid in Production:**
```php
// ❌ BAD - Always logs
error_log( 'Debug message' );

// ✅ GOOD - Conditional
if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
    error_log( 'Debug message' );
}
```

**Avoid Expensive Operations:**
```php
// ❌ BAD - Expensive operation
error_log( print_r( get_posts(), true ) );

// ✅ GOOD - Lightweight
if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
    error_log( 'Post count: ' . wp_count_posts()->publish );
}
```

---

## 5. Advanced Debugging Techniques

### Debug Helper Function

**Create Debug Utility:**
```php
class My_Debug {
    public static function log( $message, $data = null, $level = 'info' ) {
        if ( ! defined( 'WP_DEBUG' ) || ! WP_DEBUG ) {
            return;
        }

        $log_message = sprintf(
            '[%s] [%s] %s',
            date( 'Y-m-d H:i:s' ),
            strtoupper( $level ),
            $message
        );

        if ( $data !== null ) {
            $log_message .= ' | Data: ' . print_r( $data, true );
        }

        error_log( $log_message );
    }

    public static function dump( $variable, $label = null ) {
        if ( ! defined( 'WP_DEBUG' ) || ! WP_DEBUG ) {
            return;
        }

        if ( $label ) {
            error_log( $label . ':' );
        }

        ob_start();
        var_dump( $variable );
        error_log( ob_get_clean() );
    }
}

// Usage
My_Debug::log( 'User logged in', array( 'user_id' => 1 ) );
My_Debug::dump( $post, 'Post object' );
```

### Stack Trace

**Log Stack Trace:**
```php
// Log function call stack
error_log( 'Stack trace:' );
error_log( wp_debug_backtrace_summary() );

// Detailed stack trace
$trace = debug_backtrace();
error_log( print_r( $trace, true ) );
```

### Memory Usage

**Log Memory Usage:**
```php
error_log( sprintf(
    'Memory: %s / %s (Peak: %s)',
    size_format( memory_get_usage() ),
    size_format( memory_get_usage( true ) ),
    size_format( memory_get_peak_usage() )
) );
```

---

## Exam Tips

### Key Points to Remember

1. **error_log():**
   - Logs to error log file
   - Can log to custom file
   - Use for production debugging
   - Include context information

2. **var_dump():**
   - Outputs variable details
   - Use in development only
   - Can break JSON/XML
   - Remove in production

3. **Conditional Debugging:**
   - Check WP_DEBUG constant
   - Use environment checks
   - User-based conditions
   - Custom debug flags

4. **Code Cleanup:**
   - Mark debug code
   - Use helper functions
   - Search and remove
   - Document removal

5. **Best Practices:**
   - Only debug when needed
   - Include context
   - Avoid expensive operations
   - Remove after debugging

---

## Additional Resources

- [PHP error_log()](https://www.php.net/manual/en/function.error-log.php)
- [PHP var_dump()](https://www.php.net/manual/en/function.var-dump.php)
- [Debugging in WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)
