# 6.12 Debugging with Actions and Filters - Study Notes

## Overview

WordPress actions and filters can be used for debugging by adding inspection callbacks, capturing data passing through hooks, and temporarily overriding default behavior to isolate issues.

**Key Reference:** [Plugin API - WordPress Developer Resources](https://developer.wordpress.org/plugins/hooks/)

---

## 1. Adding Debug Callbacks to Actions and Filters

### Debug Action Callbacks

**Basic Debug Callback:**
```php
add_action( 'init', 'debug_init', 999 );

function debug_init() {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        error_log( 'init action fired' );
        error_log( 'Current user: ' . get_current_user_id() );
    }
}
```

**Debug with Context:**
```php
add_action( 'save_post', 'debug_save_post', 10, 3 );

function debug_save_post( $post_id, $post, $update ) {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        error_log( sprintf(
            'Post saved: ID=%d, Type=%s, Update=%s',
            $post_id,
            $post->post_type,
            $update ? 'yes' : 'no'
        ) );
    }
}
```

### Debug Filter Callbacks

**Debug Filter Values:**
```php
add_filter( 'the_content', 'debug_the_content', 999 );

function debug_the_content( $content ) {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        error_log( 'the_content filter - Content length: ' . strlen( $content ) );
        error_log( 'the_content filter - Post ID: ' . get_the_ID() );
    }
    return $content;
}
```

**Debug with Return Value:**
```php
add_filter( 'posts_results', 'debug_posts_results', 999 );

function debug_posts_results( $posts ) {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        error_log( 'posts_results - Found ' . count( $posts ) . ' posts' );
        if ( ! empty( $posts ) ) {
            error_log( 'First post ID: ' . $posts[0]->ID );
        }
    }
    return $posts;
}
```

---

## 2. Capturing Data Passing Through Hooks

### Capture Hook Data

**Capture Action Data:**
```php
add_action( 'all', 'capture_all_actions', 1 );

function capture_all_actions( $hook ) {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        global $wp_current_filter;

        // Only log specific hooks
        $important_hooks = array( 'init', 'wp_loaded', 'save_post', 'wp_insert_post' );

        if ( in_array( $hook, $important_hooks, true ) ) {
            error_log( sprintf(
                'Hook fired: %s | Stack: %s',
                $hook,
                implode( ' -> ', $wp_current_filter )
            ) );
        }
    }
}
```

**Capture Filter Data:**
```php
add_filter( 'the_content', 'capture_content_data', 1 );

function capture_content_data( $content ) {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        $data = array(
            'content_length' => strlen( $content ),
            'post_id' => get_the_ID(),
            'post_type' => get_post_type(),
            'hook_stack' => $GLOBALS['wp_current_filter'],
        );

        error_log( 'the_content data: ' . print_r( $data, true ) );
    }
    return $content;
}
```

### Log Hook Arguments

**Capture All Arguments:**
```php
add_action( 'save_post', 'log_save_post_args', 1, 3 );

function log_save_post_args( $post_id, $post, $update ) {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        $args = array(
            'post_id' => $post_id,
            'post_type' => $post->post_type,
            'post_status' => $post->post_status,
            'update' => $update,
            'post_data' => get_post( $post_id, ARRAY_A ),
        );

        error_log( 'save_post arguments: ' . print_r( $args, true ) );
    }
}
```

### Conditional Logging

**Log Only in Specific Context:**
```php
add_action( 'wp', 'debug_wp_context' );

function debug_wp_context() {
    if ( defined( 'WP_DEBUG' ) && WP_DEBUG && is_single() ) {
        global $post, $wp_query;

        error_log( 'Single post context:' );
        error_log( 'Post ID: ' . $post->ID );
        error_log( 'Query vars: ' . print_r( $wp_query->query_vars, true ) );
    }
}
```

---

## 3. Temporarily Overriding Default Behavior

### Override Plugin Behavior

**Temporarily Disable Plugin Hook:**
```php
// Remove plugin's hook
remove_action( 'init', 'problematic_plugin_function', 10 );

// Add debug version
add_action( 'init', 'debug_plugin_function', 10 );

function debug_plugin_function() {
    error_log( 'Plugin function would have run here' );
    // Optionally call original with modifications
}
```

### Override Filter Behavior

**Temporarily Override Filter:**
```php
// Remove default filter
remove_filter( 'the_content', 'wpautop', 10 );

// Add debug version
add_filter( 'the_content', 'debug_wpautop', 10 );

function debug_wpautop( $content ) {
    error_log( 'wpautop would process: ' . strlen( $content ) . ' characters' );
    // Optionally apply wpautop with logging
    $processed = wpautop( $content );
    error_log( 'wpautop processed to: ' . strlen( $processed ) . ' characters' );
    return $processed;
}
```

### Conditional Override

**Override Only in Debug Mode:**
```php
if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
    // Override only when debugging
    add_filter( 'pre_get_posts', 'debug_pre_get_posts', 999 );

    function debug_pre_get_posts( $query ) {
        if ( $query->is_main_query() ) {
            error_log( 'Main query args: ' . print_r( $query->query_vars, true ) );
        }
        return $query;
    }
}
```

---

## 4. Advanced Debugging Techniques

### Hook Execution Timing

**Measure Hook Execution Time:**
```php
add_action( 'all', 'measure_hook_time', 1 );

function measure_hook_time( $hook ) {
    static $hook_times = array();

    if ( ! isset( $hook_times[ $hook ] ) ) {
        $hook_times[ $hook ] = microtime( true );
    } else {
        $elapsed = microtime( true ) - $hook_times[ $hook ];
        if ( $elapsed > 0.1 ) { // Log slow hooks
            error_log( sprintf( 'Slow hook: %s took %.4f seconds', $hook, $elapsed ) );
        }
        unset( $hook_times[ $hook ] );
    }
}
```

### Hook Priority Debugging

**Log Hook Priorities:**
```php
add_action( 'init', 'log_hook_priorities', 999 );

function log_hook_priorities() {
    global $wp_filter;

    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        $hook_name = 'the_content';

        if ( isset( $wp_filter[ $hook_name ] ) ) {
            $hook = $wp_filter[ $hook_name ];
            $priorities = $hook->priorities;

            error_log( 'Hook priorities for ' . $hook_name . ': ' . print_r( $priorities, true ) );

            foreach ( $priorities as $priority ) {
                $callbacks = $hook->callbacks[ $priority ];
                foreach ( $callbacks as $callback_id => $callback_data ) {
                    error_log( sprintf(
                        'Priority %d: %s',
                        $priority,
                        is_string( $callback_data['function'] ) ? $callback_data['function'] : 'Closure'
                    ) );
                }
            }
        }
    }
}
```

### Hook Conflict Detection

**Detect Hook Conflicts:**
```php
add_action( 'all', 'detect_hook_conflicts', 1 );

function detect_hook_conflicts( $hook ) {
    global $wp_filter;

    if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
        if ( isset( $wp_filter[ $hook ] ) ) {
            $hook_obj = $wp_filter[ $hook ];
            $callback_count = 0;

            foreach ( $hook_obj->callbacks as $priority => $callbacks ) {
                $callback_count += count( $callbacks );
            }

            if ( $callback_count > 10 ) {
                error_log( sprintf(
                    'Potential hook conflict: %s has %d callbacks',
                    $hook,
                    $callback_count
                ) );
            }
        }
    }
}
```

---

## 5. Best Practices

### Conditional Debugging

**Only Debug When Needed:**
```php
if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
    // Debug code here
}
```

### Remove Debug Hooks

**Clean Up After Debugging:**
```php
// Remove debug hooks when done
remove_action( 'init', 'debug_init', 999 );
remove_filter( 'the_content', 'debug_the_content', 999 );
```

### Performance Considerations

**Avoid Expensive Operations:**
```php
// ❌ BAD - Expensive operation in hook
add_action( 'all', function( $hook ) {
    $all_posts = get_posts(); // Unbounded query!
} );

// ✅ GOOD - Lightweight logging
add_action( 'all', function( $hook ) {
    if ( in_array( $hook, $important_hooks, true ) ) {
        error_log( 'Hook: ' . $hook );
    }
} );
```

---

## Exam Tips

### Key Points to Remember

1. **Debug Callbacks:**
   - Add to actions for side effects
   - Add to filters for data inspection
   - Use high priority (999) to run last
   - Use low priority (1) to run first

2. **Data Capture:**
   - Log hook arguments
   - Capture filter values
   - Track execution order
   - Measure performance

3. **Override Behavior:**
   - Remove problematic hooks
   - Add debug versions
   - Test in isolation
   - Restore when done

4. **Best Practices:**
   - Only debug when WP_DEBUG enabled
   - Remove debug hooks after use
   - Avoid expensive operations
   - Use conditional logging

5. **Common Use Cases:**
   - Verify hooks firing
   - Inspect data flow
   - Identify conflicts
   - Measure performance

---

## Additional Resources

- [Plugin API - WordPress Developer Resources](https://developer.wordpress.org/plugins/hooks/)
- [Debugging in WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)
- Core Files:
  - `wp-includes/plugin.php` - Hook functions
  - `wp-includes/class-wp-hook.php` - Hook class
