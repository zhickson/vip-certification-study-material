# 4.3 Unbounded Queries - Study Notes

## Overview

Unbounded queries are database queries that have no limit on the number of results returned. These queries can severely degrade performance, especially on sites with large amounts of content.

**Key Reference:** [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)

---

## 1. Recognizing Unbounded Queries

### Common Patterns

**1. Missing `posts_per_page` Limit:**
```php
// ❌ BAD - No limit, gets ALL posts
$query = new WP_Query( array(
	'post_type' => 'post',
) );

// ✅ GOOD - Limited to 10 posts
$query = new WP_Query( array(
	'post_type' => 'post',
	'posts_per_page' => 10,
) );
```

**2. Using `-1` for Unlimited:**
```php
// ❌ BAD - Gets all posts
$posts = get_posts( array(
	'posts_per_page' => -1,
) );

// ✅ GOOD - Use reasonable limit
$posts = get_posts( array(
	'posts_per_page' => 100,
) );
```

**3. Unbounded Meta Queries:**
```php
// ❌ BAD - No limit on meta query
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'featured',
			'value' => 'yes',
		),
	),
) );

// ✅ GOOD - Add limit
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'featured',
			'value' => 'yes',
		),
	),
	'posts_per_page' => 20,
) );
```

**4. Unbounded Taxonomy Queries:**
```php
// ❌ BAD - Gets all posts in category
$query = new WP_Query( array(
	'category_name' => 'news',
) );

// ✅ GOOD - Limited results
$query = new WP_Query( array(
	'category_name' => 'news',
	'posts_per_page' => 20,
) );
```

---

## 2. Performance Impact

### Memory Usage

**Problem:**
```php
// Loading 10,000 posts into memory
$posts = get_posts( array( 'posts_per_page' => -1 ) );
// Memory usage: ~50MB+ for post objects
```

**Impact:**
- PHP memory limit exceeded
- Server slowdown
- Potential crashes

### Database Load

**Problem:**
```php
// Query without limit
SELECT * FROM wp_posts WHERE post_type = 'product' AND post_status = 'publish'
// Returns 50,000 rows
```

**Impact:**
- Long query execution time
- Database connection locks
- Slows down other queries

### Query Execution Time

**Measurement:**
```php
// Enable query logging
define( 'SAVEQUERIES', true );

// After query execution
global $wpdb;
foreach ( $wpdb->queries as $query ) {
	if ( $query[1] > 0.1 ) { // Queries over 100ms
		error_log( "Slow query: {$query[0]} - {$query[1]}s" );
	}
}
```

---

## 3. Applying Pagination

### WordPress Pagination

**Standard Pagination:**
```php
$paged = get_query_var( 'paged' ) ? get_query_var( 'paged' ) : 1;

$query = new WP_Query( array(
	'post_type' => 'post',
	'posts_per_page' => 10,
	'paged' => $paged,
) );

// Display pagination
the_posts_pagination();
```

**Archive Pagination:**
```php
$query = new WP_Query( array(
	'post_type' => 'product',
	'posts_per_archive_page' => 20, // For archive pages
) );
```

### Custom Pagination

**Offset-Based (Not Recommended):**
```php
// ❌ BAD - Offset becomes slow with large datasets
$query = new WP_Query( array(
	'posts_per_page' => 10,
	'offset' => 100, // Slow on large tables
) );
```

**Cursor-Based (Better for Large Datasets):**
```php
// ✅ GOOD - Cursor-based pagination
$last_id = isset( $_GET['after'] ) ? intval( $_GET['after'] ) : 0;

$query = new WP_Query( array(
	'posts_per_page' => 10,
	'meta_key' => 'id',
	'meta_value' => $last_id,
	'meta_compare' => '>',
	'orderby' => 'meta_value_num',
	'order' => 'ASC',
) );
```

---

## 4. Batching Strategies

### Process in Batches

**Batch Processing:**
```php
function process_posts_in_batches( $batch_size = 100 ) {
	$offset = 0;

	while ( true ) {
		$posts = get_posts( array(
			'post_type' => 'post',
			'posts_per_page' => $batch_size,
			'offset' => $offset,
			'fields' => 'ids', // Only get IDs to save memory
		) );

		if ( empty( $posts ) ) {
			break;
		}

		// Process batch
		foreach ( $posts as $post_id ) {
			process_post( $post_id );
		}

		$offset += $batch_size;

		// Prevent timeout
		if ( function_exists( 'set_time_limit' ) ) {
			set_time_limit( 30 );
		}
	}
}
```

### WP-CLI Batch Processing

**WP-CLI Command:**
```php
// wp-cli command for batch processing
WP_CLI::add_command( 'process-batch', function( $args, $assoc_args ) {
	$batch_size = isset( $assoc_args['batch-size'] ) ? intval( $assoc_args['batch-size'] ) : 100;
	$offset = isset( $assoc_args['offset'] ) ? intval( $assoc_args['offset'] ) : 0;

	$posts = get_posts( array(
		'posts_per_page' => $batch_size,
		'offset' => $offset,
		'fields' => 'ids',
	) );

	foreach ( $posts as $post_id ) {
		process_post( $post_id );
		WP_CLI::line( "Processed post {$post_id}" );
	}
} );
```

### Background Processing

**WP-Cron Batch Processing:**
```php
// Schedule batch processing
function schedule_batch_processing() {
	if ( ! wp_next_scheduled( 'process_posts_batch' ) ) {
		wp_schedule_event( time(), 'hourly', 'process_posts_batch' );
	}
}
add_action( 'wp', 'schedule_batch_processing' );

// Process one batch per cron run
add_action( 'process_posts_batch', function() {
	$offset = get_option( 'batch_processing_offset', 0 );
	$batch_size = 100;

	$posts = get_posts( array(
		'posts_per_page' => $batch_size,
		'offset' => $offset,
		'fields' => 'ids',
	) );

	if ( ! empty( $posts ) ) {
		foreach ( $posts as $post_id ) {
			process_post( $post_id );
		}

		update_option( 'batch_processing_offset', $offset + $batch_size );
	} else {
		// Reset when done
		delete_option( 'batch_processing_offset' );
		wp_clear_scheduled_hook( 'process_posts_batch' );
	}
} );
```

---

## 5. Optimizing Query Patterns

### Use Specific Fields

**Get Only What You Need:**
```php
// ❌ BAD - Gets full post objects
$posts = get_posts( array(
	'posts_per_page' => 1000,
) );

// ✅ GOOD - Only get IDs
$post_ids = get_posts( array(
	'posts_per_page' => 1000,
	'fields' => 'ids', // Only IDs, not full objects
) );

// Then load specific posts when needed
foreach ( $post_ids as $post_id ) {
	$post = get_post( $post_id );
	// Process post
}
```

### Skip Found Rows

**For Non-Paginated Queries:**
```php
// ✅ GOOD - Skip pagination count
$query = new WP_Query( array(
	'posts_per_page' => 10,
	'no_found_rows' => true, // Don't count total posts
) );
```

### Use Specific Post Statuses

**Limit by Status:**
```php
// ✅ GOOD - Only get published posts
$query = new WP_Query( array(
	'post_status' => 'publish',
	'posts_per_page' => 10,
) );
```

### Add Date Constraints

**Limit by Date:**
```php
// ✅ GOOD - Only recent posts
$query = new WP_Query( array(
	'date_query' => array(
		array(
			'after' => '1 month ago',
		),
	),
	'posts_per_page' => 10,
) );
```

---

## 6. Detecting Unbounded Queries

### Query Monitor Plugin

**Features:**
- Shows all queries on a page
- Displays query execution time
- Highlights slow queries
- Shows query results count

### Custom Detection

**Log Unbounded Queries:**
```php
add_filter( 'posts_request', function( $sql, $query ) {
	// Check for missing LIMIT
	if ( stripos( $sql, 'LIMIT' ) === false ) {
		// Check if it's a SELECT query
		if ( stripos( $sql, 'SELECT' ) === 0 ) {
			error_log( "Potential unbounded query: " . substr( $sql, 0, 200 ) );
		}
	}
	return $sql;
}, 10, 2 );
```

### Database Monitoring

**MySQL Slow Query Log:**
```ini
# my.cnf
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 1
```

**Analyze Slow Queries:**
```sql
-- Find queries without LIMIT
SELECT * FROM mysql.slow_log
WHERE sql_text NOT LIKE '%LIMIT%'
AND sql_text LIKE 'SELECT%';
```

---

## Exam Tips

### Key Points to Remember

1. **Always Set Limits:**
   - Use `posts_per_page` or `posts_per_archive_page`
   - Never use `-1` for unlimited
   - Set reasonable limits (10-100 typically)

2. **Use Pagination:**
   - Implement pagination for large result sets
   - Use cursor-based pagination for very large datasets
   - Avoid offset-based pagination on large tables

3. **Batch Processing:**
   - Process large datasets in batches
   - Use WP-Cron for background processing
   - Process only IDs when possible

4. **Optimize Queries:**
   - Use `fields => 'ids'` when possible
   - Set `no_found_rows => true` for non-paginated queries
   - Add appropriate constraints (status, date, etc.)

5. **Monitor Queries:**
   - Use Query Monitor plugin
   - Enable slow query logging
   - Check for missing LIMIT clauses

---

## Additional Resources

- [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)
- [Query Monitor Plugin](https://wordpress.org/plugins/query-monitor/)
- [MySQL Slow Query Log](https://dev.mysql.com/doc/refman/8.0/en/slow-query-log.html)
- Core Files:
  - `wp-includes/class-wp-query.php` - Query class
  - `wp-includes/query.php` - Query functions
