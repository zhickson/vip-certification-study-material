# 4.9 Auto-Loaded Options - Study Notes

## Overview

Autoloaded options are loaded on every page request and can significantly impact page load time. Understanding how to identify, limit, and optimize autoloaded options is crucial for WordPress performance.

**Key Reference:** [Options API - WordPress Developer Resources](https://developer.wordpress.org/reference/functions/get_option/)

---

## 1. How Autoloaded Options Affect Page Load

### What are Autoloaded Options?

**Autoloaded Options:**
- Loaded automatically via `wp_load_alloptions()`
- Stored in `alloptions` cache
- Available immediately without database query
- Loaded on every page request

**Core Implementation:**
```601:707:wordpress/wp-includes/option.php
function wp_load_alloptions( $force_cache = false ) {
	global $wpdb;

	/**
	 * Filters the array of alloptions before it is populated.
	 *
	 * Returning an array from the filter will effectively short circuit
	 * wp_load_alloptions(), returning that value instead.
	 *
	 * @since 6.2.0
	 *
	 * @param array|null $alloptions  An array of alloptions. Default null.
	 * @param bool       $force_cache Whether to force an update of the local cache from the persistent cache. Default false.
	 */
	$alloptions = apply_filters( 'pre_wp_load_alloptions', null, $force_cache );
	if ( is_array( $alloptions ) ) {
		return $alloptions;
	}

	if ( ! wp_installing() || ! is_multisite() ) {
		$alloptions = wp_cache_get( 'alloptions', 'options', $force_cache );
	} else {
		$alloptions = false;
	}

	if ( ! $alloptions ) {
		$suppress      = $wpdb->suppress_errors();
		$alloptions_db = $wpdb->get_results( "SELECT option_name, option_value FROM $wpdb->options WHERE autoload IN ( '" . implode( "', '", esc_sql( wp_autoload_values_to_autoload() ) ) . "' )" );

		if ( ! $alloptions_db ) {
			$alloptions_db = $wpdb->get_results( "SELECT option_name, option_value FROM $wpdb->options" );
		}
		$wpdb->suppress_errors( $suppress );

		$alloptions = array();
		foreach ( (array) $alloptions_db as $o ) {
			$alloptions[ $o->option_name ] = $o->option_value;
		}

		if ( ! wp_installing() || ! is_multisite() ) {
			/**
			 * Filters all options before caching them.
			 *
			 * @since 4.9.0
			 *
			 * @param array $alloptions Array with all options.
			 */
			$alloptions = apply_filters( 'pre_cache_alloptions', $alloptions );

			wp_cache_add( 'alloptions', $alloptions, 'options' );
		}
	}

	/**
	 * Filters all options after retrieving them.
	 *
	 * @since 2.1.0
	 *
	 * @param array $alloptions Array with all options.
	 */
	return apply_filters( 'alloptions', $alloptions );
}
```

### Performance Impact

**Problems:**
1. **Memory Usage:** All autoloaded options loaded into memory
2. **Database Query:** Single large query on every request
3. **Cache Size:** Large `alloptions` cache entry
4. **Serialization:** Large serialized arrays increase processing time

**Example Impact:**
```php
// If you have 500 autoloaded options averaging 2KB each:
// Total: 1MB loaded on every request
// Memory: 1MB per request
// Database: 1MB query result
// Cache: 1MB cache entry
```

---

## 2. Identifying Unnecessary Autoloaded Options

### Check Autoloaded Options

**Query Database:**
```sql
-- List all autoloaded options
SELECT
	option_name,
	LENGTH(option_value) AS size,
	autoload
FROM wp_options
WHERE autoload IN ('yes', 'on', 'auto-on', 'auto')
ORDER BY size DESC;
```

**WordPress Function:**
```php
// Get all autoloaded options
$alloptions = wp_load_alloptions();

// Check size
$total_size = 0;
foreach ( $alloptions as $name => $value ) {
	$total_size += strlen( $value );
}

error_log( "Autoloaded options: " . count( $alloptions ) . " options, " . size_format( $total_size ) . " total" );
```

### Site Health Check

**WordPress 6.6+ Site Health:**
```2637:2688:wordpress/wp-admin/includes/class-wp-site-health.php
	/**
	 * Tests if autoloaded options are within acceptable limits.
	 *
	 * @since 6.6.0
	 *
	 * @return array The test results.
	 */
	public function get_test_autoloaded_options() {
		$autoloaded_options_size  = $this->get_autoloaded_options_size();
		$autoloaded_options_count = count( wp_load_alloptions() );

		$base_description = __( 'Autoloaded options are configuration settings for plugins and themes that are automatically loaded with every page load in WordPress. Having too many autoloaded options can slow down your site.' );

		$result = array(
			'label'       => __( 'Autoloaded options are acceptable' ),
			'status'      => 'good',
			'badge'       => array(
				'label' => __( 'Performance' ),
				'color' => 'blue',
			),
			'description' => sprintf(
				/* translators: 1: Number of autoloaded options, 2: Autoloaded options size. */
				'<p>' . esc_html( $base_description ) . ' ' . __( 'Your site has %1$s autoloaded options (size: %2$s) in the options table, which is acceptable.' ) . '</p>',
				$autoloaded_options_count,
				size_format( $autoloaded_options_size )
			),
			'actions'     => '',
			'test'        => 'autoloaded_options',
		);

		/**
		 * Filters max bytes threshold to trigger warning in Site Health.
		 *
		 * @since 6.6.0
		 *
		 * @param int $limit Autoloaded options threshold size. Default 800000.
		 */
		$limit = apply_filters( 'site_status_autoloaded_options_size_limit', 800000 );

		if ( $autoloaded_options_size < $limit ) {
			return $result;
		}

		$result['status']      = 'critical';
		$result['label']       = __( 'Autoloaded options could affect performance' );
		$result['description'] = sprintf(
			/* translators: 1: Number of autoloaded options, 2: Autoloaded options size. */
			'<p>' . esc_html( $base_description ) . ' ' . __( 'Your site has %1$s autoloaded options (size: %2$s) in the options table, which could cause your site to be slow. You can review the options being autoloaded in your database and remove any options that are no longer needed by your site.' ) . '</p>',
			$autoloaded_options_count,
			size_format( $autoloaded_options_size )
		);
```

**Threshold:** 800KB (default)

### Identify Large Options

**Find Large Autoloaded Options:**
```php
function find_large_autoloaded_options() {
	global $wpdb;

	$large_options = $wpdb->get_results(
		"SELECT option_name, LENGTH(option_value) AS size
		FROM {$wpdb->options}
		WHERE autoload IN ('yes', 'on', 'auto-on', 'auto')
		AND LENGTH(option_value) > 1024
		ORDER BY size DESC
		LIMIT 20"
	);

	foreach ( $large_options as $option ) {
		error_log( sprintf(
			"Large autoloaded option: %s (%s)",
			$option->option_name,
			size_format( $option->size )
		) );
	}
}
```

---

## 3. Limiting Size and Number

### Set Options to Non-Autoload

**Change Autoload Status:**
```php
// Change single option
wp_set_option_autoload( 'my_plugin_large_data', false );

// Change multiple options
wp_set_options_autoload( array(
	'my_plugin_export_data',
	'my_plugin_backup_data',
	'my_plugin_log_data',
), false );

// Set different values
wp_set_option_autoload_values( array(
	'option1' => true,  // Autoload
	'option2' => false, // Don't autoload
) );
```

**Core Functions:**
```379:477:wordpress/wp-includes/option.php
/**
 * Sets the autoload values for multiple options in the database.
 *
 * Autoloading too many options can lead to performance problems, especially if the options are not frequently used.
 * This function allows modifying the autoload value for multiple options without changing the actual option value.
 *
 * This is particularly useful for plugins that register many options which are generally autoloaded can be set to not autoload when the plugin is inactive.
 *
 * @since 6.7.0 The autoload values 'yes' and 'no' are deprecated.
 *
 * @param array $options Associative array of option names and their autoload values to set. The option names are
 *                       expected to not be SQL-escaped. The autoload values should be boolean values. For backward
 *                       compatibility, string values 'on'/'off', 'yes'/'no' are also accepted, but deprecated.
 * @return array Associative array of all provided $options as keys and boolean values for whether their autoload value
 *              was successfully updated.
 */
function wp_set_option_autoload_values( array $options ) {
```

### Plugin Activation/Deactivation

**On Plugin Deactivation:**
```php
register_deactivation_hook( __FILE__, function() {
	// Disable autoload for plugin options when deactivated
	global $wpdb;

	$options = $wpdb->get_col( $wpdb->prepare(
		"SELECT option_name FROM {$wpdb->options} WHERE option_name LIKE %s",
		'my_plugin_%'
	) );

	if ( ! empty( $options ) ) {
		wp_set_options_autoload( $options, false );
	}
} );
```

**On Plugin Activation:**
```php
register_activation_hook( __FILE__, function() {
	// Enable autoload for frequently used options
	wp_set_option_autoload_values( array(
		'my_plugin_active' => true,
		'my_plugin_version' => true,
		'my_plugin_settings' => false, // Large settings, don't autoload
	) );
} );
```

### Best Practices

**Autoload (true) - Use for:**
- Small values (< 1KB)
- Frequently accessed
- Used on most page loads
- Core settings (siteurl, home, etc.)

**Don't Autoload (false) - Use for:**
- Large values (> 1KB)
- Rarely accessed
- Admin-only settings
- Temporary/cached data
- Export/backup data

---

## 4. Optimizing Options Usage During Initialization

### Lazy Load Options

**Load Only When Needed:**
```php
// ❌ BAD - Autoloading large option
add_option( 'my_plugin_all_data', $huge_array, '', true );

// ✅ GOOD - Non-autoloaded, load when needed
add_option( 'my_plugin_all_data', $huge_array, '', false );

// Load only in admin
if ( is_admin() ) {
	$data = get_option( 'my_plugin_all_data' );
}
```

### Split Large Options

**Instead of One Large Option:**
```php
// ❌ BAD - One massive option
update_option( 'my_plugin_all_settings', array(
	'general' => array( /* 100 items */ ),
	'advanced' => array( /* 100 items */ ),
	'display' => array( /* 100 items */ ),
) );
```

**Split into Smaller Options:**
```php
// ✅ GOOD - Split into logical groups
update_option( 'my_plugin_general_settings', $settings['general'], false );
update_option( 'my_plugin_advanced_settings', $settings['advanced'], false );
update_option( 'my_plugin_display_settings', $settings['display'], false );

// Load only what's needed
if ( is_admin_page( 'general' ) ) {
	$settings = get_option( 'my_plugin_general_settings' );
}
```

### Use Transients for Temporary Data

**Instead of Autoloaded Options:**
```php
// ❌ BAD - Autoloaded temporary data
update_option( 'my_plugin_api_cache', $api_data );
update_option( 'my_plugin_api_cache_time', time() );

// ✅ GOOD - Use transients
set_transient( 'my_plugin_api_cache', $api_data, HOUR_IN_SECONDS );
```

### Prime Options Cache

**Load Multiple Options Efficiently:**
```php
// ❌ BAD - Multiple individual queries
$option1 = get_option( 'my_plugin_option1' );
$option2 = get_option( 'my_plugin_option2' );
$option3 = get_option( 'my_plugin_option3' );

// ✅ GOOD - Prime cache with single query
wp_prime_option_caches( array(
	'my_plugin_option1',
	'my_plugin_option2',
	'my_plugin_option3',
) );

$option1 = get_option( 'my_plugin_option1' ); // From cache
$option2 = get_option( 'my_plugin_option2' ); // From cache
$option3 = get_option( 'my_plugin_option3' ); // From cache
```

---

## 5. Monitoring and Maintenance

### Regular Audits

**Check Autoloaded Options:**
```php
function audit_autoloaded_options() {
	global $wpdb;

	$autoloaded = $wpdb->get_results(
		"SELECT
			option_name,
			LENGTH(option_value) AS size,
			autoload
		FROM {$wpdb->options}
		WHERE autoload IN ('yes', 'on', 'auto-on', 'auto')
		ORDER BY size DESC"
	);

	$total_size = 0;
	$large_options = array();

	foreach ( $autoloaded as $option ) {
		$total_size += $option->size;

		if ( $option->size > 1024 ) {
			$large_options[] = $option;
		}
	}

	return array(
		'count' => count( $autoloaded ),
		'total_size' => $total_size,
		'large_options' => $large_options,
	);
}
```

### Clean Up Unused Options

**Remove Old Options:**
```php
function cleanup_unused_options() {
	global $wpdb;

	// Find options from deactivated plugins
	$unused = $wpdb->get_col(
		"SELECT option_name FROM {$wpdb->options}
		WHERE option_name LIKE 'old_plugin_%'
		AND autoload IN ('yes', 'on', 'auto-on', 'auto')"
	);

	foreach ( $unused as $option_name ) {
		delete_option( $option_name );
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Autoload Impact:**
   - Loaded on every page request
   - Increases memory usage
   - Large database query
   - Affects cache size

2. **Identification:**
   - Check Site Health (800KB threshold)
   - Query database for large options
   - Monitor autoloaded options count
   - Find options > 1KB

3. **Optimization:**
   - Set large options to non-autoload
   - Split large options
   - Use transients for temporary data
   - Load only when needed

4. **Best Practices:**
   - Autoload small, frequent options
   - Don't autoload large, rare options
   - Clean up on plugin deactivation
   - Regular audits

5. **WordPress Functions:**
   - `wp_set_option_autoload()` - Change single option
   - `wp_set_options_autoload()` - Change multiple options
   - `wp_set_option_autoload_values()` - Set different values
   - `wp_load_alloptions()` - Get all autoloaded options

---

## Additional Resources

- [Options API - WordPress Developer Resources](https://developer.wordpress.org/reference/functions/get_option/)
- [Site Health - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_site_health/)
- Core Files:
  - `wp-includes/option.php` - Options API implementation
  - `wp-admin/includes/class-wp-site-health.php` - Site Health checks
