# 4.2 Full Page Caching Strategies in WordPress - Study Notes

## Overview

Full page caching stores complete HTML responses to serve subsequent requests without regenerating pages. Understanding when and how to use page caching is essential for scaling WordPress sites.

**Key Reference:** [Caching - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/performance/caching/)

---

## 1. Types of Page Caching

### Plugin-Level Caching

**Examples:** WP Super Cache, W3 Total Cache, WP Rocket

**How It Works:**
- Generates static HTML files
- Serves cached files via PHP or `.htaccess` rewrite rules
- Handles cache invalidation on content updates

**Advantages:**
- Easy to configure
- Works on shared hosting
- Good for small to medium sites

**Disadvantages:**
- PHP overhead (if serving via PHP)
- File I/O on disk
- Limited scalability

**Example - WP Super Cache:**
```php
// Cache is generated automatically
// Served via .htaccess rewrite rules or PHP
// Cache invalidation on post save
add_action( 'save_post', 'wp_cache_post_change' );
```

### Server-Level Caching

**Examples:** Varnish, Nginx FastCGI Cache, Apache mod_cache

**How It Works:**
- Reverse proxy caches responses
- Serves cached content before hitting PHP
- Very fast response times

**Advantages:**
- Extremely fast (served from memory)
- Reduces PHP load
- Scales well

**Disadvantages:**
- Requires server configuration
- More complex cache invalidation
- May need ESI for dynamic content

**Example - Varnish Configuration:**
```vcl
sub vcl_recv {
    if (req.url ~ "^/(wp-admin|wp-login|wp-cron)") {
        return (pass);
    }
    return (hash);
}

sub vcl_backend_response {
    if (bereq.url !~ "^/(wp-admin|wp-login)") {
        set beresp.ttl = 1h;
    }
}
```

### CDN Caching

**Examples:** Cloudflare, Fastly, AWS CloudFront

**How It Works:**
- Caches content at edge locations
- Serves from geographically close servers
- Reduces origin server load

**Advantages:**
- Global distribution
- DDoS protection
- Bandwidth savings

**Disadvantages:**
- Cache invalidation can be slow
- May cache user-specific content incorrectly
- Cost for high traffic

---

## 2. Cache Invalidation

### When to Invalidate

**Content Updates:**
- Post/page save
- Comment submission
- Menu updates
- Widget changes

**Configuration Changes:**
- Theme activation
- Plugin activation/deactivation
- Settings updates

### Plugin-Level Invalidation

**WP Super Cache:**
```php
// Clear cache on post save
add_action( 'save_post', 'wp_cache_post_change' );

// Clear specific post cache
wp_cache_post_change( $post_id );

// Clear all cache
wp_cache_clear_cache();
```

**W3 Total Cache:**
```php
// Clear page cache
w3tc_flush_post( $post_id );

// Clear all caches
w3tc_flush_all();
```

### Server-Level Invalidation

**Varnish Cache Purging:**
```php
// Send PURGE request to Varnish
function purge_varnish_cache( $url ) {
	wp_remote_request( $url, array(
		'method' => 'PURGE',
		'headers' => array(
			'Host' => parse_url( $url, PHP_URL_HOST ),
		),
	) );
}

// Purge on post save
add_action( 'save_post', function( $post_id ) {
	$url = get_permalink( $post_id );
	purge_varnish_cache( $url );

	// Also purge archive pages
	purge_varnish_cache( get_post_type_archive_link( get_post_type( $post_id ) ) );
} );
```

**Nginx FastCGI Cache Purging:**
```php
// Send cache purge request
function purge_nginx_cache( $url ) {
	$purge_url = str_replace( home_url(), 'http://127.0.0.1', $url );
	wp_remote_request( $purge_url, array(
		'method' => 'PURGE',
	) );
}
```

### CDN Cache Invalidation

**Cloudflare:**
```php
// Purge Cloudflare cache via API
function purge_cloudflare_cache( $urls ) {
	$zone_id = get_option( 'cloudflare_zone_id' );
	$api_key = get_option( 'cloudflare_api_key' );
	$email = get_option( 'cloudflare_email' );

	wp_remote_request( "https://api.cloudflare.com/client/v4/zones/{$zone_id}/purge_cache", array(
		'method' => 'POST',
		'headers' => array(
			'X-Auth-Email' => $email,
			'X-Auth-Key' => $api_key,
			'Content-Type' => 'application/json',
		),
		'body' => json_encode( array(
			'files' => $urls,
		) ),
	) );
}
```

---

## 3. Measuring and Validating Cache Effectiveness

### Cache Hit Rate

**Measure Cache Performance:**
```php
// Add cache status header
function add_cache_status_header() {
	if ( function_exists( 'wp_cache_get' ) ) {
		$cache_key = 'page_' . md5( $_SERVER['REQUEST_URI'] );
		$cached = wp_cache_get( $cache_key );

		header( 'X-Cache-Status: ' . ( $cached ? 'HIT' : 'MISS' ) );
	}
}
add_action( 'send_headers', 'add_cache_status_header' );
```

### Response Headers

**Check Cache Headers:**
```bash
# Check cache headers
curl -I https://example.com/page/

# Look for:
# X-Cache: HIT/MISS
# Cache-Control: max-age=3600
# Age: 123
```

**WordPress Cache Headers:**
```php
// Set cache control headers
function set_cache_headers() {
	if ( ! is_user_logged_in() && ! is_admin() ) {
		header( 'Cache-Control: public, max-age=3600' );
		header( 'Expires: ' . gmdate( 'D, d M Y H:i:s', time() + 3600 ) . ' GMT' );
	}
}
add_action( 'send_headers', 'set_cache_headers' );
```

### Cache Testing

**Test Cache Functionality:**
```php
// Add cache test endpoint
add_action( 'rest_api_init', function() {
	register_rest_route( 'cache-test/v1', '/status', array(
		'methods' => 'GET',
		'callback' => function() {
			$cache_key = 'test_' . time();
			wp_cache_set( $cache_key, 'test_value', '', 60 );
			$cached = wp_cache_get( $cache_key );

			return array(
				'cache_working' => ( $cached === 'test_value' ),
				'object_cache' => wp_using_ext_object_cache(),
			);
		},
	) );
} );
```

---

## 4. Cache Exclusion Strategies

### Exclude by User State

**Don't Cache for Logged-In Users:**
```php
// Exclude logged-in users from cache
function exclude_logged_in_from_cache() {
	if ( is_user_logged_in() ) {
		header( 'Cache-Control: private, no-cache, no-store, must-revalidate' );
		header( 'Pragma: no-cache' );
		header( 'Expires: 0' );
	}
}
add_action( 'send_headers', 'exclude_logged_in_from_cache' );
```

### Exclude by URL Pattern

**Exclude Admin and Login:**
```php
// Don't cache admin or login pages
function should_cache_page() {
	$excluded = array(
		'/wp-admin/',
		'/wp-login.php',
		'/wp-cron.php',
		'/wp-json/',
	);

	foreach ( $excluded as $pattern ) {
		if ( strpos( $_SERVER['REQUEST_URI'], $pattern ) !== false ) {
			return false;
		}
	}

	return true;
}
```

### Exclude by Cookie

**Varnish Configuration:**
```vcl
sub vcl_recv {
    // Don't cache if logged in
    if (req.http.Cookie ~ "wordpress_logged_in") {
        return (pass);
    }

    // Don't cache commenter cookies
    if (req.http.Cookie ~ "comment_author") {
        return (pass);
    }
}
```

---

## 5. Edge Side Includes (ESI)

### What is ESI?

ESI allows caching most of a page while including dynamic fragments.

**Use Cases:**
- User-specific widgets
- Shopping cart contents
- Recent comments
- Personalized content

### Implementing ESI

**Varnish ESI Example:**
```vcl
// Main page (cacheable)
sub vcl_backend_response {
    set beresp.do_esi = true;
}

// PHP generates ESI include
echo '<esi:include src="/user-widget.php" />';
```

**WordPress ESI Implementation:**
```php
// Generate ESI include for dynamic content
function render_esi_widget( $widget_id ) {
	if ( isset( $_SERVER['HTTP_X_ESI'] ) ) {
		// Render widget content
		the_widget( $widget_id );
		exit;
	} else {
		// Output ESI tag
		echo '<esi:include src="' . esc_url( add_query_arg( 'esi', $widget_id, home_url( '/esi-widget.php' ) ) ) . '" />';
	}
}
```

---

## 6. Cache Warming

### Pre-Generate Cache

**Warm Cache After Deployment:**
```php
// WP-CLI command to warm cache
function warm_cache() {
	$urls = array(
		home_url(),
		home_url( '/blog/' ),
		home_url( '/about/' ),
	);

	foreach ( $urls as $url ) {
		wp_remote_get( $url, array(
			'timeout' => 5,
			'blocking' => false,
		) );
	}
}
```

**Sitemap-Based Warming:**
```php
// Warm cache from sitemap
function warm_cache_from_sitemap() {
	$sitemap_url = home_url( '/sitemap.xml' );
	$response = wp_remote_get( $sitemap_url );

	if ( ! is_wp_error( $response ) ) {
		$xml = simplexml_load_string( wp_remote_retrieve_body( $response ) );
		foreach ( $xml->url as $url ) {
			wp_remote_get( (string) $url->loc, array( 'blocking' => false ) );
		}
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Cache Types:**
   - Plugin-level: Easy, file-based
   - Server-level: Fast, memory-based
   - CDN: Global, edge-based

2. **Cache Invalidation:**
   - Invalidate on content updates
   - Use appropriate purge methods
   - Consider cache warming

3. **Cache Exclusion:**
   - Exclude logged-in users
   - Exclude admin/login pages
   - Use ESI for dynamic fragments

4. **Measurement:**
   - Monitor cache hit rates
   - Check response headers
   - Test cache functionality

5. **Best Practices:**
   - Set appropriate TTLs
   - Use cache tags for granular invalidation
   - Monitor cache performance

---

## Additional Resources

- [Caching - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/performance/caching/)
- [WP Super Cache Plugin](https://wordpress.org/plugins/wp-super-cache/)
- [Varnish Cache Documentation](https://varnish-cache.org/docs/)
- [Cloudflare Cache API](https://developers.cloudflare.com/api/operations/zone-purge-files-by-url)
- Core Files:
  - `wp-includes/cache.php` - Object cache API
  - `wp-includes/class-wp-object-cache.php` - Cache implementation
