# 4.6 Using LIKE - Study Notes

## Overview

LIKE queries in MySQL can be very slow, especially when used with wildcards. Understanding why LIKE is inefficient and knowing how to optimize or avoid it is crucial for WordPress performance.

**Key Reference:** [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)

---

## 1. Why LIKE Queries are Slow

### Performance Issues

**1. Leading Wildcard Problem:**
```sql
-- ❌ VERY SLOW - Leading wildcard prevents index use
SELECT * FROM wp_posts WHERE post_title LIKE '%word%';
-- Full table scan required
```

**2. No Index Usage:**
- Leading wildcards prevent index usage
- Requires full table scan
- Gets slower as table grows

**3. Pattern Matching Overhead:**
- Pattern matching is CPU-intensive
- Each row must be checked
- No early termination possible

### Core Implementation

**WordPress Uses LIKE for Meta Queries:**
```753:756:wordpress/wp-includes/class-wp-meta-query.php
				case 'LIKE':
				case 'NOT LIKE':
					$meta_value = '%' . $wpdb->esc_like( $meta_value ) . '%';
					$where      = $wpdb->prepare( '%s', $meta_value );
```

**Performance Impact:**
- Meta queries with LIKE are slow
- Can't use indexes efficiently
- Full table scan on meta_value

---

## 2. Recognizing Inefficiencies in Post Meta Queries

### Common Problem Patterns

**1. Wildcard Meta Queries:**
```php
// ❌ BAD - LIKE query on meta
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'description',
			'value' => 'search',
			'compare' => 'LIKE',
		),
	),
) );
```

**2. Leading Wildcard:**
```sql
-- ❌ BAD - Leading % prevents index
SELECT * FROM wp_postmeta
WHERE meta_value LIKE '%search%';
```

**3. Multiple LIKE Conditions:**
```php
// ❌ BAD - Multiple LIKE queries
$query = new WP_Query( array(
	'meta_query' => array(
		'relation' => 'OR',
		array(
			'key' => 'field1',
			'value' => 'search',
			'compare' => 'LIKE',
		),
		array(
			'key' => 'field2',
			'value' => 'search',
			'compare' => 'LIKE',
		),
	),
) );
```

---

## 3. Using Exact Key/Value Matches

### Replace LIKE with Exact Match

**Instead of LIKE:**
```php
// ❌ BAD
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'status',
			'value' => 'active',
			'compare' => 'LIKE',
		),
	),
) );
```

**Use Exact Match:**
```php
// ✅ GOOD - Exact match uses index
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'status',
			'value' => 'active',
			'compare' => '=',
		),
	),
) );
```

### Normalize Data Structure

**Store Searchable Data Differently:**
```php
// ❌ BAD - Storing searchable text in meta
update_post_meta( $post_id, 'description', 'Long description text here...' );

// Then searching with LIKE
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'description',
			'value' => 'search term',
			'compare' => 'LIKE',
		),
	),
) );
```

**Better Approach:**
```php
// ✅ GOOD - Store in post content or use taxonomy
// Option 1: Use post content
wp_update_post( array(
	'ID' => $post_id,
	'post_content' => 'Long description text here...',
) );

// Then use WordPress search
$query = new WP_Query( array(
	's' => 'search term',
) );

// Option 2: Use taxonomy for categories
wp_set_object_terms( $post_id, array( 'active', 'featured' ), 'product_status' );

// Then query by taxonomy
$query = new WP_Query( array(
	'tax_query' => array(
		array(
			'taxonomy' => 'product_status',
			'field' => 'slug',
			'terms' => 'active',
		),
	),
) );
```

---

## 4. Applying Indexing to Improve Pattern Matching

### Full-Text Indexes

**For Text Search:**
```sql
-- Create full-text index
ALTER TABLE wp_posts ADD FULLTEXT INDEX ft_post_content (post_content, post_title);

-- Use MATCH...AGAINST instead of LIKE
SELECT * FROM wp_posts
WHERE MATCH(post_content, post_title) AGAINST('search term' IN NATURAL LANGUAGE MODE);
```

**WordPress Full-Text Search:**
```php
// WordPress uses full-text search for 's' parameter
$query = new WP_Query( array(
	's' => 'search term',
) );

// Generates MATCH...AGAINST query
```

### Partial Indexes

**For Prefix Searches:**
```sql
-- ✅ GOOD - Trailing wildcard can use index
SELECT * FROM wp_posts WHERE post_title LIKE 'search%';
-- Can use index on post_title

-- ❌ BAD - Leading wildcard can't use index
SELECT * FROM wp_posts WHERE post_title LIKE '%search';
-- Full table scan
```

**Index on Meta Value:**
```sql
-- Add index on meta_value for prefix searches
CREATE INDEX idx_meta_value_prefix ON wp_postmeta(meta_value(50));

-- Now trailing wildcard can use index
SELECT * FROM wp_postmeta
WHERE meta_value LIKE 'prefix%';
```

### Composite Indexes for Meta

**Optimize Meta Queries:**
```sql
-- Composite index for meta queries
CREATE INDEX idx_meta_key_value ON wp_postmeta(meta_key(50), meta_value(50));

-- Helps with exact matches
SELECT * FROM wp_postmeta
WHERE meta_key = 'status' AND meta_value = 'active';
```

---

## 5. Alternative Search Strategies

### Use WordPress Search

**Instead of Meta LIKE:**
```php
// ❌ BAD - LIKE on meta
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'description',
			'value' => 'search',
			'compare' => 'LIKE',
		),
	),
) );
```

**Use WordPress Search:**
```php
// ✅ GOOD - WordPress search uses full-text
$query = new WP_Query( array(
	's' => 'search term',
	'post_type' => 'product',
) );
```

### Use Taxonomies

**For Categorization:**
```php
// ❌ BAD - LIKE on meta for categories
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'category',
			'value' => 'electronics',
			'compare' => 'LIKE',
		),
	),
) );
```

**Use Taxonomy:**
```php
// ✅ GOOD - Use taxonomy
$query = new WP_Query( array(
	'tax_query' => array(
		array(
			'taxonomy' => 'product_category',
			'field' => 'slug',
			'terms' => 'electronics',
		),
	),
) );
```

### Use Custom Tables

**For Complex Search:**
```php
// ✅ GOOD - Custom table with proper indexes
global $wpdb;

$results = $wpdb->get_results( $wpdb->prepare(
	"SELECT post_id FROM {$wpdb->prefix}product_search
	WHERE MATCH(title, description) AGAINST(%s IN NATURAL LANGUAGE MODE)",
	$search_term
) );
```

---

## 6. Optimizing Existing LIKE Queries

### When You Must Use LIKE

**1. Use Trailing Wildcard:**
```php
// ✅ GOOD - Trailing wildcard can use index
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'sku',
			'value' => 'PROD-',
			'compare' => 'LIKE',
		),
	),
) );

// Generates: WHERE meta_value LIKE 'PROD-%'
// Can use index if meta_value is indexed
```

**2. Limit Results:**
```php
// ✅ GOOD - Limit results
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'description',
			'value' => 'search',
			'compare' => 'LIKE',
		),
	),
	'posts_per_page' => 20, // Limit results
) );
```

**3. Add Indexes:**
```sql
-- Add index for LIKE queries
CREATE INDEX idx_meta_value_prefix ON wp_postmeta(meta_value(100));

-- Helps with trailing wildcard searches
SELECT * FROM wp_postmeta
WHERE meta_value LIKE 'prefix%';
```

### Escaping LIKE Values

**WordPress esc_like():**
```1768:1793:wordpress/wp-includes/class-wpdb.php
	/**
	 * First half of escaping for `LIKE` special characters `%` and `_` before preparing for SQL.
	 *
	 * Use this only before wpdb::prepare() or esc_sql(). Reversing the order is very bad for security.
	 *
	 * Example Prepared Statement:
	 *
	 *     $wild = '%';
	 *     $find = 'only 43% of planets';
	 *     $like = $wild . $wpdb->esc_like( $find ) . $wild;
	 *     $sql  = $wpdb->prepare( "SELECT * FROM $wpdb->posts WHERE post_content LIKE %s", $like );
	 *
	 * Example Escape Chain:
	 *
	 *     $sql  = esc_sql( $wpdb->esc_like( $input ) );
	 *
	 * @since 4.0.0
	 *
	 * @param string $text The raw text to be escaped. The input typed by the user
	 *                     should have no extra or deleted slashes.
	 * @return string Text in the form of a LIKE phrase. The output is not SQL safe.
	 *                Call wpdb::prepare() or wpdb::_real_escape() next.
	 */
	public function esc_like( $text ) {
		return addcslashes( $text, '_%\\' );
	}
```

**Correct Usage:**
```php
// ✅ GOOD - Escape LIKE values
global $wpdb;

$search = $wpdb->esc_like( $_GET['search'] );
$query = $wpdb->prepare(
	"SELECT * FROM {$wpdb->posts} WHERE post_title LIKE %s",
	'%' . $search . '%'
);
```

---

## 7. Real-World Examples

### Product Search

**Problem:**
```php
// ❌ BAD - LIKE on product name
$query = new WP_Query( array(
	'post_type' => 'product',
	'meta_query' => array(
		array(
			'key' => 'product_name',
			'value' => $search_term,
			'compare' => 'LIKE',
		),
	),
) );
```

**Solution:**
```php
// ✅ GOOD - Use post title and WordPress search
$query = new WP_Query( array(
	'post_type' => 'product',
	's' => $search_term, // Uses full-text search
) );
```

### Tag Matching

**Problem:**
```php
// ❌ BAD - LIKE on tags
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'tags',
			'value' => 'featured',
			'compare' => 'LIKE',
		),
	),
) );
```

**Solution:**
```php
// ✅ GOOD - Use taxonomy
$query = new WP_Query( array(
	'tag' => 'featured',
) );
```

---

## Exam Tips

### Key Points to Remember

1. **LIKE Performance:**
   - Leading wildcard (`%term`) prevents index use
   - Trailing wildcard (`term%`) can use index
   - Full wildcard (`%term%`) requires full scan

2. **Alternatives:**
   - Use exact matches when possible
   - Use WordPress search for text
   - Use taxonomies for categorization
   - Use full-text indexes for search

3. **Optimization:**
   - Add indexes for trailing wildcard searches
   - Limit result sets
   - Use full-text indexes for text search
   - Normalize data structure

4. **WordPress Specific:**
   - WordPress search uses full-text
   - Meta LIKE queries are slow
   - Use taxonomies instead of meta for categories
   - Always escape LIKE values with `esc_like()`

5. **Best Practices:**
   - Avoid LIKE when possible
   - Use exact matches
   - Store searchable data in post content
   - Use proper indexes

---

## Additional Resources

- [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)
- [MySQL LIKE Optimization](https://dev.mysql.com/doc/refman/8.0/en/pattern-matching.html)
- [Full-Text Search - MySQL Documentation](https://dev.mysql.com/doc/refman/8.0/en/fulltext-search.html)
- Core Files:
  - `wp-includes/class-wp-meta-query.php` - Meta query handling
  - `wp-includes/class-wpdb.php` - Database class with esc_like()
