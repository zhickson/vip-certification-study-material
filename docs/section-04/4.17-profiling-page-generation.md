# 4.17 Profiling Page Generation and Hook Execution - Study Notes

## Overview

Profiling helps identify bottlenecks in WordPress execution. Understanding how to benchmark WordPress and identify slow operations is essential for performance optimization.

**Key Reference:** [Debugging in WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)

---

## 1. Using Query Monitor

### Query Monitor Plugin

**Features:**
- Shows all database queries
- Displays query execution time
- Shows HTTP requests
- Lists hooks and execution time
- Displays enqueued assets

**Installation:**
```bash
wp plugin install query-monitor --activate
```

**Usage:**
- View in admin toolbar
- Shows queries, hooks, HTTP requests
- Identifies slow operations
- Suggests optimizations

---

## 2. Custom Timing Code

### WordPress Timer

**Basic Timing:**
```php
// Start timer
timer_start();

// Your code
$query = new WP_Query( $args );

// Get elapsed time
$elapsed = timer_stop();
error_log( "Query time: {$elapsed} seconds" );
```

### Custom Profiling

**Function Profiling:**
```php
function profile_function( $function_name, $callback ) {
	$start = microtime( true );
	$result = call_user_func( $callback );
	$end = microtime( true );

	error_log( sprintf(
		"%s: %.4f seconds",
		$function_name,
		$end - $start
	) );

	return $result;
}

// Usage
$result = profile_function( 'my_function', function() {
	return expensive_operation();
} );
```

### Hook Profiling

**Profile Hook Execution:**
```php
// Profile all hooks
add_action( 'all', function( $hook ) {
	static $hooks = array();

	$start = microtime( true );

	// Hook will execute

	$end = microtime( true );
	$hooks[ $hook ][] = $end - $start;

	// Log slow hooks
	if ( $end - $start > 0.1 ) {
		error_log( "Slow hook: {$hook} - " . ( $end - $start ) . "s" );
	}
} );
```

---

## 3. Profiling Actions, Filters, and Template Loading

### Profile Actions

**Track Action Execution:**
```php
// Profile specific action
add_action( 'save_post', function( $post_id ) {
	$start = microtime( true );

	// Action code

	$end = microtime( true );
	error_log( "save_post took: " . ( $end - $start ) . "s" );
} );
```

### Profile Filters

**Track Filter Execution:**
```php
// Profile filter
add_filter( 'the_content', function( $content ) {
	$start = microtime( true );

	// Filter code
	$modified = process_content( $content );

	$end = microtime( true );
	error_log( "the_content filter took: " . ( $end - $start ) . "s" );

	return $modified;
} );
```

### Profile Template Loading

**Track Template:**
```php
// Profile template loading
add_filter( 'template_include', function( $template ) {
	$start = microtime( true );

	// Template will load

	$end = microtime( true );
	error_log( "Template {$template} loaded in: " . ( $end - $start ) . "s" );

	return $template;
} );
```

---

## 4. Tracing Slow Plugin/Theme Operations

### Identify Slow Plugins

**Plugin Performance:**
```php
// Track plugin load time
add_action( 'plugins_loaded', function() {
	$start = microtime( true );
}, 1 );

add_action( 'plugins_loaded', function() {
	$end = microtime( true );
	error_log( "Plugins loaded in: " . ( $end - $start ) . "s" );
}, 999 );
```

### Identify Slow Themes

**Theme Performance:**
```php
// Track theme functions
add_action( 'after_setup_theme', function() {
	$start = microtime( true );

	// Theme setup

	$end = microtime( true );
	error_log( "Theme setup took: " . ( $end - $start ) . "s" );
} );
```

---

## Exam Tips

### Key Points to Remember

1. **Profiling Tools:**
   - Query Monitor plugin
   - Custom timing code
   - WordPress timer functions

2. **What to Profile:**
   - Database queries
   - Hook execution
   - Template loading
   - Plugin/theme operations

3. **Best Practices:**
   - Use Query Monitor
   - Profile slow operations
   - Track execution time
   - Identify bottlenecks

4. **WordPress Functions:**
   - `timer_start()` - Start timer
   - `timer_stop()` - Get elapsed time
   - `microtime( true )` - High precision timing

---

## Additional Resources

- [Query Monitor Plugin](https://wordpress.org/plugins/query-monitor/)
- [Debugging in WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)
- Core Files:
  - `wp-includes/functions.php` - Timer functions
