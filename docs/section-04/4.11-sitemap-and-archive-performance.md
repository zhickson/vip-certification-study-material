# 4.11 Sitemap and Archive Performance - Study Notes

## Overview

Sitemaps and archive pages can generate many database queries when crawled by search engines. Understanding how to limit queries and optimize for SEO crawlers without overloading the database is crucial for performance.

**Key Reference:** [Sitemaps - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_sitemaps/)

---

## 1. Understanding Sitemap and Archive Query Limits

### WordPress Sitemaps

**Default Sitemap Structure:**
- Posts sitemap: Up to 50,000 URLs per sitemap
- Sitemap index: Lists all sitemaps
- Pagination: 2000 URLs per sitemap page

**Core Implementation:**
```php
// WordPress sitemap limits
const SITEMAP_MAX_URLS = 2000;
const SITEMAP_MAX_ENTRIES = 50000;
```

**Query Pattern:**
```php
// WordPress generates queries like:
$query = new WP_Query( array(
	'post_type' => 'post',
	'post_status' => 'publish',
	'posts_per_page' => 2000, // Per sitemap page
	'orderby' => 'modified',
	'order' => 'DESC',
) );
```

### Archive Pages

**Archive Query Pattern:**
```php
// Main query for archive
$query = new WP_Query( array(
	'post_type' => 'post',
	'posts_per_page' => get_option( 'posts_per_page', 10 ),
) );
```

**Issues:**
- Can generate many queries
- No limit on total posts
- Can be slow with large datasets

---

## 2. Applying Pagination or Query Restrictions

### Limit Sitemap Queries

**Custom Sitemap Limits:**
```php
// Limit sitemap entries
add_filter( 'wp_sitemaps_max_urls', function( $max_urls ) {
	return 1000; // Reduce from default 2000
} );

// Limit sitemap posts
add_filter( 'wp_sitemaps_posts_query_args', function( $args ) {
	$args['posts_per_page'] = 1000;
	$args['date_query'] = array(
		array(
			'after' => '1 year ago', // Only recent posts
		),
	);
	return $args;
} );
```

### Limit Archive Queries

**Restrict Archive Results:**
```php
// Limit archive posts
add_action( 'pre_get_posts', function( $query ) {
	if ( ! is_admin() && $query->is_main_query() ) {
		if ( is_archive() ) {
			$query->set( 'posts_per_page', 20 ); // Limit results
			$query->set( 'no_found_rows', true ); // Skip count if not needed
		}
	}
} );
```

### Date-Based Restrictions

**Limit by Date:**
```php
// Only show recent posts in archives
add_action( 'pre_get_posts', function( $query ) {
	if ( ! is_admin() && $query->is_main_query() && is_archive() ) {
		$query->set( 'date_query', array(
			array(
				'after' => '6 months ago',
			),
		) );
	}
} );
```

---

## 3. Optimizing for SEO Crawlers

### Cache Sitemaps

**Cache Sitemap Generation:**
```php
// Cache sitemap output
add_filter( 'wp_sitemaps_posts_query_args', function( $args ) {
	$cache_key = 'sitemap_posts_' . md5( serialize( $args ) );
	$cached = get_transient( $cache_key );

	if ( false !== $cached ) {
		// Return cached post IDs
		$args['post__in'] = $cached;
		$args['orderby'] = 'post__in';
	} else {
		// Generate and cache
		$query = new WP_Query( $args );
		$post_ids = wp_list_pluck( $query->posts, 'ID' );
		set_transient( $cache_key, $post_ids, DAY_IN_SECONDS );
	}

	return $args;
} );
```

### Optimize Sitemap Queries

**Use Specific Fields:**
```php
// Only get needed data
add_filter( 'wp_sitemaps_posts_query_args', function( $args ) {
	$args['fields'] = 'ids'; // Only IDs, not full objects
	return $args;
} );
```

**Limit Post Types:**
```php
// Exclude post types from sitemap
add_filter( 'wp_sitemaps_post_types', function( $post_types ) {
	unset( $post_types['attachment'] ); // Exclude attachments
	return $post_types;
} );
```

### Rate Limiting

**Limit Crawler Requests:**
```php
// Rate limit sitemap requests
add_action( 'template_redirect', function() {
	if ( is_sitemap() ) {
		$ip = $_SERVER['REMOTE_ADDR'];
		$cache_key = 'sitemap_rate_limit_' . $ip;

		$requests = get_transient( $cache_key );
		if ( false === $requests ) {
			$requests = 0;
		}

		if ( $requests > 10 ) { // Max 10 requests per hour
			wp_die( 'Rate limit exceeded', 'Rate Limit', array( 'response' => 429 ) );
		}

		set_transient( $cache_key, $requests + 1, HOUR_IN_SECONDS );
	}
} );
```

---

## 4. Optimizing Archive Performance

### Cache Archive Queries

**Cache Archive Results:**
```php
// Cache archive queries
add_action( 'pre_get_posts', function( $query ) {
	if ( ! is_admin() && $query->is_main_query() && is_archive() ) {
		$cache_key = 'archive_' . get_query_var( 'post_type' ) . '_' . get_query_var( 'paged' );
		$cached = wp_cache_get( $cache_key );

		if ( false !== $cached ) {
			// Use cached query args
			foreach ( $cached as $key => $value ) {
				$query->set( $key, $value );
			}
		}
	}
} );
```

### Optimize Archive Queries

**Use Indexes:**
```sql
-- Ensure indexes exist for archive queries
CREATE INDEX idx_type_status_date ON wp_posts(post_type, post_status, post_date);
```

**Limit Meta Queries:**
```php
// Avoid meta queries in archives
add_action( 'pre_get_posts', function( $query ) {
	if ( ! is_admin() && $query->is_main_query() && is_archive() ) {
		// Don't add meta queries unless necessary
		if ( ! isset( $_GET['filter'] ) ) {
			$query->set( 'meta_query', array() );
		}
	}
} );
```

### Pagination Optimization

**Skip Found Rows:**
```php
// Skip pagination count if not needed
add_action( 'pre_get_posts', function( $query ) {
	if ( ! is_admin() && $query->is_main_query() && is_archive() ) {
		// Skip count if not showing pagination
		if ( ! is_paged() ) {
			$query->set( 'no_found_rows', true );
		}
	}
} );
```

---

## 5. Monitoring and Debugging

### Track Sitemap Requests

**Log Sitemap Access:**
```php
// Log sitemap requests
add_action( 'template_redirect', function() {
	if ( is_sitemap() ) {
		error_log( sprintf(
			'Sitemap request: %s from %s',
			$_SERVER['REQUEST_URI'],
			$_SERVER['REMOTE_ADDR']
		) );
	}
} );
```

### Monitor Query Performance

**Use Query Monitor:**
- Shows queries on sitemap pages
- Identifies slow queries
- Suggests optimizations

**Custom Monitoring:**
```php
// Monitor sitemap query performance
add_filter( 'wp_sitemaps_posts_query_args', function( $args ) {
	if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
		$start = microtime( true );

		// Query will execute

		$end = microtime( true );
		error_log( 'Sitemap query time: ' . ( $end - $start ) . 's' );
	}

	return $args;
} );
```

---

## Exam Tips

### Key Points to Remember

1. **Sitemap Limits:**
   - Default: 2000 URLs per sitemap page
   - Max: 50,000 URLs per sitemap
   - Can be customized with filters

2. **Optimization:**
   - Cache sitemap generation
   - Limit by date
   - Use specific fields
   - Exclude unnecessary post types

3. **Archive Performance:**
   - Limit posts per page
   - Skip found rows when possible
   - Cache archive queries
   - Use proper indexes

4. **SEO Crawlers:**
   - Rate limit requests
   - Cache responses
   - Optimize queries
   - Monitor performance

5. **Best Practices:**
   - Limit query results
   - Use pagination
   - Cache expensive operations
   - Monitor query performance

---

## Additional Resources

- [Sitemaps - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_sitemaps/)
- [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)
- Core Files:
  - `wp-includes/sitemaps/` - Sitemap classes
  - `wp-includes/class-wp-query.php` - Query handling
