# 4.12 External HTTP Requests - Study Notes

## Overview

External HTTP requests can significantly impact page load performance when made synchronously during page generation. Understanding how to identify, cache, and defer external requests is crucial for WordPress performance.

**Key Reference:** [HTTP API - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/http/)

---

## 1. Identifying Blocking Requests

### WordPress HTTP Functions

**Common Functions:**
- `wp_remote_get()` - GET request
- `wp_remote_post()` - POST request
- `wp_remote_request()` - Generic request

**Blocking Behavior:**
```php
// ❌ BAD - Blocking request
$response = wp_remote_get( 'https://api.example.com/data' );
$data = json_decode( wp_remote_retrieve_body( $response ), true );
// Page waits for API response
```

**Performance Impact:**
- Adds latency to page load
- Blocks page generation
- Can timeout and cause errors
- Increases server load

### Identifying Blocking Requests

**Check Request Timing:**
```php
// Measure request time
$start = microtime( true );
$response = wp_remote_get( 'https://api.example.com/data' );
$end = microtime( true );

error_log( 'Request time: ' . ( $end - $start ) . 's' );
```

**Query Monitor:**
- Shows HTTP requests
- Displays request duration
- Identifies slow requests

---

## 2. Caching Responses

### Using Transients

**Cache API Responses:**
```php
// ✅ GOOD - Cache API response
function get_api_data() {
	$cache_key = 'api_data';
	$data = get_transient( $cache_key );

	if ( false === $data ) {
		$response = wp_remote_get( 'https://api.example.com/data', array(
			'timeout' => 5,
		) );

		if ( ! is_wp_error( $response ) ) {
			$data = json_decode( wp_remote_retrieve_body( $response ), true );
			set_transient( $cache_key, $data, HOUR_IN_SECONDS );
		}
	}

	return $data;
}
```

### Using Object Cache

**Cache with Object Cache:**
```php
// ✅ GOOD - Use object cache
function get_api_data() {
	$cache_key = 'api_data';
	$data = wp_cache_get( $cache_key );

	if ( false === $data ) {
		$response = wp_remote_get( 'https://api.example.com/data' );

		if ( ! is_wp_error( $response ) ) {
			$data = json_decode( wp_remote_retrieve_body( $response ), true );
			wp_cache_set( $cache_key, $data, '', 3600 );
		}
	}

	return $data;
}
```

### Cache Invalidation

**Invalidate on Update:**
```php
// Invalidate cache when needed
function update_api_data() {
	// Update data
	$response = wp_remote_get( 'https://api.example.com/data' );
	$data = json_decode( wp_remote_retrieve_body( $response ), true );

	// Update cache
	set_transient( 'api_data', $data, HOUR_IN_SECONDS );

	// Or delete to force refresh
	delete_transient( 'api_data' );
}
```

---

## 3. Offloading or Deferring Requests

### Defer to Background

**WP-Cron:**
```php
// ✅ GOOD - Schedule background request
function schedule_api_update() {
	if ( ! wp_next_scheduled( 'update_api_data' ) ) {
		wp_schedule_event( time(), 'hourly', 'update_api_data' );
	}
}
add_action( 'wp', 'schedule_api_update' );

// Background update
add_action( 'update_api_data', function() {
	$response = wp_remote_get( 'https://api.example.com/data' );
	$data = json_decode( wp_remote_retrieve_body( $response ), true );
	set_transient( 'api_data', $data, HOUR_IN_SECONDS );
} );

// Use cached data
function get_api_data() {
	return get_transient( 'api_data' );
}
```

### AJAX Requests

**Client-Side Request:**
```php
// ✅ GOOD - Load via AJAX
function enqueue_api_script() {
	wp_enqueue_script( 'api-loader', get_template_directory_uri() . '/api-loader.js', array( 'jquery' ), '1.0', true );
	wp_localize_script( 'api-loader', 'apiData', array(
		'ajaxurl' => admin_url( 'admin-ajax.php' ),
		'nonce' => wp_create_nonce( 'api_nonce' ),
	) );
}
add_action( 'wp_enqueue_scripts', 'enqueue_api_script' );

// AJAX handler
add_action( 'wp_ajax_load_api_data', 'load_api_data' );
add_action( 'wp_ajax_nopriv_load_api_data', 'load_api_data' );
function load_api_data() {
	check_ajax_referer( 'api_nonce', 'nonce' );

	$data = get_transient( 'api_data' );
	if ( false === $data ) {
		$response = wp_remote_get( 'https://api.example.com/data' );
		$data = json_decode( wp_remote_retrieve_body( $response ), true );
		set_transient( 'api_data', $data, HOUR_IN_SECONDS );
	}

	wp_send_json_success( $data );
}
```

### Shutdown Hook

**Defer to Shutdown:**
```php
// ✅ GOOD - Defer to shutdown
add_action( 'shutdown', function() {
	// Non-blocking request after page sent
	wp_remote_get( 'https://api.example.com/analytics', array(
		'blocking' => false,
		'timeout' => 0.01,
	) );
} );
```

---

## 4. Best Practices

### Set Timeouts

**Reasonable Timeouts:**
```php
// ✅ GOOD - Set timeout
$response = wp_remote_get( 'https://api.example.com/data', array(
	'timeout' => 5, // 5 seconds
) );
```

### Error Handling

**Handle Errors:**
```php
// ✅ GOOD - Error handling
$response = wp_remote_get( 'https://api.example.com/data', array(
	'timeout' => 5,
) );

if ( is_wp_error( $response ) ) {
	error_log( 'API Error: ' . $response->get_error_message() );
	// Use cached data or default
	$data = get_transient( 'api_data' );
	if ( false === $data ) {
		$data = array(); // Default
	}
} else {
	$data = json_decode( wp_remote_retrieve_body( $response ), true );
	set_transient( 'api_data', $data, HOUR_IN_SECONDS );
}
```

### Non-Blocking Requests

**For Non-Critical Data:**
```php
// ✅ GOOD - Non-blocking
wp_remote_get( 'https://api.example.com/analytics', array(
	'blocking' => false,
	'timeout' => 0.01,
) );
```

---

## Exam Tips

### Key Points to Remember

1. **Blocking Requests:**
   - Add latency to page load
   - Block page generation
   - Can cause timeouts

2. **Caching:**
   - Use transients for temporary data
   - Use object cache for frequently accessed data
   - Set appropriate expiration times

3. **Deferring:**
   - Use WP-Cron for background updates
   - Use AJAX for client-side loading
   - Use shutdown hook for non-critical requests

4. **Best Practices:**
   - Set reasonable timeouts
   - Handle errors gracefully
   - Use non-blocking for non-critical requests
   - Cache responses

5. **WordPress Functions:**
   - `wp_remote_get()` - GET request
   - `wp_remote_post()` - POST request
   - `wp_remote_request()` - Generic request
   - `is_wp_error()` - Check for errors

---

## Additional Resources

- [HTTP API - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/http/)
- [Transients API - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/transients/)
- Core Files:
  - `wp-includes/http.php` - HTTP functions
  - `wp-includes/class-wp-http.php` - HTTP class
