# 5.9 Environment-Specific Configuration - Study Notes

## Overview

Separating configuration between development, staging, and production environments prevents misconfigurations and ensures each environment has appropriate settings. This is critical for security and reliability.

**Key Reference:** [WordPress Configuration - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/wp-config/)

---

## 1. Using Environment Variables

### wp-config.php with Environment Variables

```php
// wp-config.php
<?php
// Load environment variables
$env_file = dirname( __FILE__ ) . '/.env';
if ( file_exists( $env_file ) ) {
	$lines = file( $env_file, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES );
	foreach ( $lines as $line ) {
		if ( strpos( trim( $line ), '#' ) === 0 ) {
			continue;
		}
		list( $name, $value ) = explode( '=', $line, 2 );
		$_ENV[ trim( $name ) ] = trim( $value );
	}
}

// Database configuration
define( 'DB_NAME', $_ENV['DB_NAME'] ?? 'wordpress' );
define( 'DB_USER', $_ENV['DB_USER'] ?? 'root' );
define( 'DB_PASSWORD', $_ENV['DB_PASSWORD'] ?? '' );
define( 'DB_HOST', $_ENV['DB_HOST'] ?? 'localhost' );

// WordPress configuration
define( 'WP_DEBUG', filter_var( $_ENV['WP_DEBUG'] ?? 'false', FILTER_VALIDATE_BOOLEAN ) );
define( 'WP_DEBUG_LOG', filter_var( $_ENV['WP_DEBUG_LOG'] ?? 'false', FILTER_VALIDATE_BOOLEAN ) );
define( 'WP_DEBUG_DISPLAY', filter_var( $_ENV['WP_DEBUG_DISPLAY'] ?? 'false', FILTER_VALIDATE_BOOLEAN ) );

// Security keys
define( 'AUTH_KEY', $_ENV['AUTH_KEY'] ?? 'put your unique phrase here' );
define( 'SECURE_AUTH_KEY', $_ENV['SECURE_AUTH_KEY'] ?? 'put your unique phrase here' );
// ... other keys
```

### Environment Files

```bash
# .env.development
DB_NAME=wordpress_dev
DB_USER=wp_user
DB_PASSWORD=dev_password
DB_HOST=localhost
WP_DEBUG=true
WP_DEBUG_LOG=true
WP_DEBUG_DISPLAY=true
WP_ENVIRONMENT_TYPE=development

# .env.staging
DB_NAME=wordpress_staging
DB_USER=wp_user
DB_PASSWORD=staging_password
DB_HOST=staging-db.example.com
WP_DEBUG=true
WP_DEBUG_LOG=true
WP_DEBUG_DISPLAY=false
WP_ENVIRONMENT_TYPE=staging

# .env.production
DB_NAME=wordpress_prod
DB_USER=wp_user
DB_PASSWORD=secure_production_password
DB_HOST=prod-db.example.com
WP_DEBUG=false
WP_DEBUG_LOG=false
WP_DEBUG_DISPLAY=false
WP_ENVIRONMENT_TYPE=production
```

### Loading Environment-Specific Files

```php
// wp-config.php
$environment = getenv( 'WP_ENVIRONMENT_TYPE' ) ?: 'production';

switch ( $environment ) {
	case 'development':
		$env_file = '.env.development';
		break;
	case 'staging':
		$env_file = '.env.staging';
		break;
	case 'production':
	default:
		$env_file = '.env.production';
		break;
}

$env_path = dirname( __FILE__ ) . '/' . $env_file;
if ( file_exists( $env_path ) ) {
	// Load environment variables
}
```

---

## 2. Preventing Cross-Environment Misconfigurations

### Environment Detection

```php
// wp-config.php
function get_environment() {
	// Check environment variable first
	if ( defined( 'WP_ENVIRONMENT_TYPE' ) ) {
		return WP_ENVIRONMENT_TYPE;
	}

	// Check server hostname
	$hostname = gethostname();
	if ( strpos( $hostname, 'dev' ) !== false || strpos( $hostname, 'local' ) !== false ) {
		return 'development';
	}
	if ( strpos( $hostname, 'staging' ) !== false || strpos( $hostname, 'stage' ) !== false ) {
		return 'staging';
	}

	// Default to production
	return 'production';
}

$environment = get_environment();
define( 'WP_ENVIRONMENT_TYPE', $environment );
```

### Environment Guards

```php
// Prevent production code in development
if ( WP_ENVIRONMENT_TYPE === 'production' && WP_DEBUG ) {
	die( 'ERROR: Debug mode cannot be enabled in production!' );
}

// Prevent development URLs in production
if ( WP_ENVIRONMENT_TYPE === 'production' ) {
	$site_url = get_option( 'siteurl' );
	if ( strpos( $site_url, 'localhost' ) !== false || strpos( $site_url, 'dev' ) !== false ) {
		die( 'ERROR: Invalid site URL for production environment!' );
	}
}
```

### Configuration Validation

```php
// wp-config.php
function validate_environment_config() {
	$errors = array();

	if ( WP_ENVIRONMENT_TYPE === 'production' ) {
		if ( WP_DEBUG ) {
			$errors[] = 'WP_DEBUG must be false in production';
		}
		if ( ! defined( 'DISALLOW_FILE_EDIT' ) || ! DISALLOW_FILE_EDIT ) {
			$errors[] = 'DISALLOW_FILE_EDIT must be true in production';
		}
		if ( empty( $_ENV['DB_PASSWORD'] ) || $_ENV['DB_PASSWORD'] === 'password' ) {
			$errors[] = 'Weak database password detected';
		}
	}

	if ( ! empty( $errors ) ) {
		die( 'Configuration errors: ' . implode( ', ', $errors ) );
	}
}

validate_environment_config();
```

---

## 3. Configuring Environment-Aware Plugins/Themes

### Plugin Configuration

```php
// my-plugin.php
class My_Plugin {

	public function __construct() {
		$environment = $this->get_environment();

		// Environment-specific hooks
		if ( $environment === 'development' ) {
			add_action( 'wp_footer', array( $this, 'debug_info' ) );
		}

		// Environment-specific API endpoints
		$api_url = $this->get_api_url( $environment );
		$this->api_client = new API_Client( $api_url );
	}

	private function get_environment() {
		if ( defined( 'WP_ENVIRONMENT_TYPE' ) ) {
			return WP_ENVIRONMENT_TYPE;
		}
		return 'production';
	}

	private function get_api_url( $environment ) {
		$urls = array(
			'development' => 'https://api-dev.example.com',
			'staging' => 'https://api-staging.example.com',
			'production' => 'https://api.example.com',
		);
		return $urls[ $environment ] ?? $urls['production'];
	}
}
```

### Theme Configuration

```php
// functions.php
$environment = defined( 'WP_ENVIRONMENT_TYPE' ) ? WP_ENVIRONMENT_TYPE : 'production';

// Load environment-specific assets
if ( $environment === 'development' ) {
	wp_enqueue_script( 'dev-tools', get_template_directory_uri() . '/js/dev-tools.js', array(), '1.0.0', true );
}

// Environment-specific analytics
if ( $environment === 'production' ) {
	// Production analytics code
	add_action( 'wp_head', 'add_production_analytics' );
} else {
	// Development/staging analytics (or none)
	add_action( 'wp_head', 'add_dev_analytics' );
}
```

### Conditional Feature Loading

```php
// Load features based on environment
$environment = defined( 'WP_ENVIRONMENT_TYPE' ) ? WP_ENVIRONMENT_TYPE : 'production';

if ( $environment === 'development' ) {
	require_once get_template_directory() . '/inc/dev-features.php';
}

if ( $environment !== 'production' ) {
	require_once get_template_directory() . '/inc/staging-features.php';
}
```

---

## 4. Storing Sensitive Data Securely

### Secrets Management

```php
// wp-config.php
// Never commit secrets to version control
// Use environment variables or secret management services

// Option 1: Environment variables (recommended)
define( 'DB_PASSWORD', getenv( 'DB_PASSWORD' ) );

// Option 2: External secrets file (not in repo)
$secrets_file = dirname( __FILE__ ) . '/secrets.php';
if ( file_exists( $secrets_file ) ) {
	require_once $secrets_file;
} else {
	die( 'Secrets file not found!' );
}
```

### Secrets File Structure

```php
// secrets.php (NOT in version control)
<?php
// This file should be excluded from Git
// .gitignore: secrets.php

return array(
	'db_password' => 'secure_password_here',
	'api_key' => 'api_key_here',
	'auth_keys' => array(
		'auth_key' => 'unique_phrase_here',
		'secure_auth_key' => 'unique_phrase_here',
		// ... other keys
	),
);
```

### Using Secret Management Services

```php
// wp-config.php
// Example: AWS Secrets Manager
if ( class_exists( 'Aws\SecretsManager\SecretsManagerClient' ) ) {
	$client = new Aws\SecretsManager\SecretsManagerClient([
		'version' => 'latest',
		'region' => 'us-east-1',
	]);

	$secret = $client->getSecretValue([
		'SecretId' => 'wordpress/production',
	]);

	$secrets = json_decode( $secret['SecretString'], true );

	define( 'DB_PASSWORD', $secrets['db_password'] );
	define( 'API_KEY', $secrets['api_key'] );
}
```

---

## 5. Environment-Specific Constants

### Development Constants

```php
// wp-config.php
if ( WP_ENVIRONMENT_TYPE === 'development' ) {
	define( 'WP_DEBUG', true );
	define( 'WP_DEBUG_LOG', true );
	define( 'WP_DEBUG_DISPLAY', true );
	define( 'SCRIPT_DEBUG', true );
	define( 'SAVEQUERIES', true );
	define( 'WP_LOCAL_DEV', true );
	@ini_set( 'display_errors', 1 );
}
```

### Staging Constants

```php
// wp-config.php
if ( WP_ENVIRONMENT_TYPE === 'staging' ) {
	define( 'WP_DEBUG', true );
	define( 'WP_DEBUG_LOG', true );
	define( 'WP_DEBUG_DISPLAY', false );
	define( 'SCRIPT_DEBUG', false );
	define( 'DISALLOW_INDEXING', true ); // Prevent search engine indexing
}
```

### Production Constants

```php
// wp-config.php
if ( WP_ENVIRONMENT_TYPE === 'production' ) {
	define( 'WP_DEBUG', false );
	define( 'WP_DEBUG_LOG', false );
	define( 'WP_DEBUG_DISPLAY', false );
	define( 'SCRIPT_DEBUG', false );
	define( 'DISALLOW_FILE_EDIT', true );
	define( 'DISALLOW_FILE_MODS', false );
	define( 'AUTOMATIC_UPDATER_DISABLED', false );
	define( 'WP_AUTO_UPDATE_CORE', 'minor' ); // Auto-update for security
}
```

---

## 6. Best Practices

### .gitignore Configuration

```gitignore
# Environment files
.env
.env.*
!.env.example
secrets.php
wp-config-local.php

# But keep example files
.env.example
wp-config-sample.php
```

### Environment Example File

```bash
# .env.example (committed to repo)
DB_NAME=wordpress
DB_USER=wp_user
DB_PASSWORD=your_password_here
DB_HOST=localhost
WP_DEBUG=false
WP_DEBUG_LOG=false
WP_ENVIRONMENT_TYPE=production
```

### Documentation

```markdown
# Environment Setup

## Development
1. Copy `.env.example` to `.env.development`
2. Update values for local development
3. Set `WP_ENVIRONMENT_TYPE=development`

## Staging
1. Copy `.env.example` to `.env.staging`
2. Update values for staging server
3. Set `WP_ENVIRONMENT_TYPE=staging`

## Production
1. Use environment variables on server
2. Never commit production secrets
3. Set `WP_ENVIRONMENT_TYPE=production`
```

---

## Exam Tips

### Key Points to Remember

1. **Environment Variables:**
   - Use `.env` files for local development
   - Use system environment variables for servers
   - Never commit secrets to version control

2. **Environment Detection:**
   - Use `WP_ENVIRONMENT_TYPE` constant
   - Fallback to hostname detection
   - Validate environment configuration

3. **Security:**
   - Different passwords per environment
   - Debug mode off in production
   - File editing disabled in production

4. **Configuration:**
   - Environment-specific constants
   - Conditional feature loading
   - Environment-aware plugins/themes

5. **Best Practices:**
   - Use `.env.example` as template
   - Exclude secrets from Git
   - Document environment setup
   - Validate configuration on load

---

## Additional Resources

- [WordPress Configuration - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/wp-config/)
- [Environment Variables - PHP Documentation](https://www.php.net/manual/en/reserved.variables.environment.php)
- [12-Factor App - Config](https://12factor.net/config)
