# 5.2 Writing and Running Unit Tests with PHPUnit - Study Notes

## Overview

PHPUnit is the standard testing framework for PHP and WordPress. Understanding how to set up, write, and run unit tests is essential for WordPress development.

**Key Reference:** [PHPUnit - Official Documentation](https://phpunit.de/)

---

## 1. Setting Up PHPUnit in WordPress Environment

### Installation via Composer

```json
// composer.json
{
	"require-dev": {
		"phpunit/phpunit": "^9.5",
		"yoast/phpunit-polyfills": "^1.0"
	},
	"autoload-dev": {
		"psr-4": {
			"MyPlugin\\Tests\\": "tests/"
		}
	}
}
```

```bash
composer install
```

### WordPress Test Library Setup

WordPress provides a test library for integration testing:

```bash
# Download WordPress test library
svn co https://develop.svn.wordpress.org/trunk/tests/phpunit/includes/ tests/phpunit/includes
svn co https://develop.svn.wordpress.org/trunk/tests/phpunit/data/ tests/phpunit/data
```

### PHPUnit Configuration

```xml
<!-- phpunit.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<phpunit
	bootstrap="tests/phpunit/bootstrap.php"
	colors="true"
	backupGlobals="false"
	convertErrorsToExceptions="true"
	convertNoticesToExceptions="true"
	convertWarningsToExceptions="true"
	processIsolation="false"
	stopOnFailure="false">
	<testsuites>
		<testsuite name="Unit">
			<directory>tests/phpunit/unit</directory>
		</testsuite>
		<testsuite name="Integration">
			<directory>tests/phpunit/integration</directory>
		</testsuite>
	</testsuites>
	<filter>
		<whitelist>
			<directory suffix=".php">includes</directory>
			<directory suffix=".php">src</directory>
		</whitelist>
	</filter>
</phpunit>
```

### Bootstrap File

```php
// tests/phpunit/bootstrap.php
<?php
/**
 * PHPUnit bootstrap file
 */

// Load Composer autoloader
require_once dirname( __DIR__ ) . '/vendor/autoload.php';

// Load WordPress test library
require_once dirname( __DIR__ ) . '/tests/phpunit/includes/functions.php';

// Load test configuration
tests_add_filter( 'muplugins_loaded', function() {
	require dirname( __DIR__ ) . '/my-plugin.php';
} );

// Load WordPress test environment
require dirname( __DIR__ ) . '/tests/phpunit/includes/bootstrap.php';
```

---

## 2. Writing Test Cases

### Basic Test Structure

```php
// tests/phpunit/unit/class-calculator-test.php
<?php

use PHPUnit\Framework\TestCase;

class Calculator_Test extends TestCase {

	public function test_add_returns_correct_sum() {
		$calculator = new Calculator();
		$result = $calculator->add( 2, 3 );
		$this->assertEquals( 5, $result );
	}

	public function test_subtract_returns_correct_difference() {
		$calculator = new Calculator();
		$result = $calculator->subtract( 5, 3 );
		$this->assertEquals( 2, $result );
	}
}
```

### Test Class Structure

```php
class My_Plugin_Test extends TestCase {

	/**
	 * Set up before each test
	 */
	public function setUp(): void {
		parent::setUp();
		// Initialize test data
	}

	/**
	 * Tear down after each test
	 */
	public function tearDown(): void {
		parent::tearDown();
		// Clean up test data
	}

	/**
	 * Test method - must start with "test"
	 */
	public function test_something() {
		// Test implementation
	}

	/**
	 * Data provider test
	 *
	 * @dataProvider addition_provider
	 */
	public function test_addition( $a, $b, $expected ) {
		$this->assertEquals( $expected, $a + $b );
	}

	public function addition_provider() {
		return array(
			array( 0, 0, 0 ),
			array( 0, 1, 1 ),
			array( 1, 0, 1 ),
			array( 1, 1, 2 ),
		);
	}
}
```

### Assertions

```php
// Equality assertions
$this->assertEquals( $expected, $actual );
$this->assertNotEquals( $expected, $actual );
$this->assertSame( $expected, $actual ); // Strict comparison
$this->assertNotSame( $expected, $actual );

// Type assertions
$this->assertIsArray( $value );
$this->assertIsString( $value );
$this->assertIsInt( $value );
$this->assertIsBool( $value );

// Boolean assertions
$this->assertTrue( $condition );
$this->assertFalse( $condition );

// Null assertions
$this->assertNull( $value );
$this->assertNotNull( $value );

// Contains assertions
$this->assertContains( $needle, $haystack );
$this->assertNotContains( $needle, $haystack );
$this->assertStringContainsString( $needle, $haystack );

// Count assertions
$this->assertCount( $expected_count, $array );

// Empty assertions
$this->assertEmpty( $value );
$this->assertNotEmpty( $value );

// Exception assertions
$this->expectException( InvalidArgumentException::class );
$this->expectExceptionMessage( 'Invalid value' );
```

---

## 3. Mocking Dependencies

### Mock Objects

```php
class Order_Processor_Test extends TestCase {

	public function test_process_order_calls_payment_gateway() {
		// Create mock
		$payment_gateway = $this->createMock( Payment_Gateway::class );

		// Configure mock expectations
		$payment_gateway->expects( $this->once() )
			->method( 'charge' )
			->with( $this->equalTo( 100.00 ) )
			->willReturn( true );

		$processor = new Order_Processor( $payment_gateway );
		$result = $processor->process( 100.00 );

		$this->assertTrue( $result );
	}
}
```

### Mock WordPress Functions

```php
class Post_Helper_Test extends TestCase {

	public function test_get_post_title_returns_title() {
		// Mock WordPress function
		$mock = \Mockery::mock( 'alias:WP_Post' );
		$mock->shouldReceive( 'get_post' )
			->once()
			->andReturn( (object) array( 'post_title' => 'Test Post' ) );

		$helper = new Post_Helper();
		$title = $helper->get_post_title( 1 );

		$this->assertEquals( 'Test Post', $title );
	}
}
```

### Using Test Doubles

```php
class Email_Service_Test extends TestCase {

	public function test_send_email_calls_wp_mail() {
		// Create test double
		$mailer = $this->createMock( Mailer::class );
		$mailer->expects( $this->once() )
			->method( 'send' )
			->with( 'user@example.com', 'Subject', 'Body' );

		$service = new Email_Service( $mailer );
		$service->send_notification( 'user@example.com' );
	}
}
```

---

## 4. WordPress-Specific Testing

### Testing WordPress Functions (Integration)

For WordPress functions, use integration tests with `WP_UnitTestCase`:

```php
// tests/phpunit/integration/class-post-helper-test.php
class Post_Helper_Integration_Test extends WP_UnitTestCase {

	public function test_get_post_meta_retrieves_value() {
		$post_id = self::factory()->post->create();
		update_post_meta( $post_id, 'custom_field', 'test_value' );

		$helper = new Post_Helper();
		$value = $helper->get_custom_field( $post_id );

		$this->assertEquals( 'test_value', $value );
	}
}
```

### Testing Hooks

```php
class Hook_Test extends WP_UnitTestCase {

	public function test_action_fires() {
		$fired = false;

		add_action( 'my_custom_action', function() use ( &$fired ) {
			$fired = true;
		} );

		do_action( 'my_custom_action' );

		$this->assertTrue( $fired );
	}

	public function test_filter_modifies_value() {
		add_filter( 'my_custom_filter', function( $value ) {
			return $value . '_modified';
		} );

		$result = apply_filters( 'my_custom_filter', 'original' );

		$this->assertEquals( 'original_modified', $result );
	}
}
```

---

## 5. Running Tests

### Command Line

```bash
# Run all tests
./vendor/bin/phpunit

# Run specific test suite
./vendor/bin/phpunit --testsuite Unit

# Run specific test file
./vendor/bin/phpunit tests/phpunit/unit/Calculator_Test.php

# Run specific test method
./vendor/bin/phpunit --filter test_add_returns_correct_sum

# Run with coverage
./vendor/bin/phpunit --coverage-html coverage/

# Run with verbose output
./vendor/bin/phpunit --verbose
```

### IDE Integration

Most IDEs support PHPUnit:

- **PhpStorm:** Built-in PHPUnit support
- **VS Code:** PHPUnit Test Explorer extension
- **NetBeans:** Built-in test runner

### Continuous Integration

```yaml
# .github/workflows/tests.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      - name: Install dependencies
        run: composer install

      - name: Run tests
        run: ./vendor/bin/phpunit
```

---

## 6. Best Practices

### Test Naming

```php
// ✅ GOOD - Descriptive names
public function test_calculate_total_includes_tax() {}
public function test_get_user_returns_null_for_invalid_id() {}

// ❌ BAD - Vague names
public function test_calculate() {}
public function test_user() {}
```

### One Assertion Per Test (When Possible)

```php
// ✅ GOOD - Single responsibility
public function test_add_positive_numbers() {
	$this->assertEquals( 5, add( 2, 3 ) );
}

public function test_add_negative_numbers() {
	$this->assertEquals( -5, add( -2, -3 ) );
}

// ❌ BAD - Multiple concerns
public function test_add() {
	$this->assertEquals( 5, add( 2, 3 ) );
	$this->assertEquals( -5, add( -2, -3 ) );
	$this->assertEquals( 0, add( 0, 0 ) );
}
```

### Arrange-Act-Assert Pattern

```php
public function test_process_order() {
	// Arrange - Set up test data
	$order = new Order( 100.00 );
	$processor = new Order_Processor();

	// Act - Execute the code being tested
	$result = $processor->process( $order );

	// Assert - Verify the result
	$this->assertTrue( $result );
	$this->assertEquals( 'processed', $order->get_status() );
}
```

### Test Isolation

```php
class Isolated_Test extends TestCase {

	private $calculator;

	public function setUp(): void {
		parent::setUp();
		// Each test gets a fresh instance
		$this->calculator = new Calculator();
	}

	public function tearDown(): void {
		// Clean up after each test
		$this->calculator = null;
		parent::tearDown();
	}
}
```

---

## 7. Common Patterns

### Testing Exceptions

```php
public function test_divide_by_zero_throws_exception() {
	$this->expectException( DivisionByZeroError::class );
	$this->expectExceptionMessage( 'Cannot divide by zero' );

	$calculator = new Calculator();
	$calculator->divide( 10, 0 );
}
```

### Testing Private Methods

```php
// Use reflection to test private methods
public function test_private_method() {
	$object = new My_Class();
	$reflection = new ReflectionClass( $object );
	$method = $reflection->getMethod( 'private_method' );
	$method->setAccessible( true );

	$result = $method->invoke( $object, 'arg' );
	$this->assertEquals( 'expected', $result );
}
```

### Data Providers

```php
/**
 * @dataProvider email_provider
 */
public function test_validate_email( $email, $expected ) {
	$validator = new Email_Validator();
	$result = $validator->validate( $email );
	$this->assertEquals( $expected, $result );
}

public function email_provider() {
	return array(
		'valid email' => array( 'user@example.com', true ),
		'invalid email' => array( 'invalid-email', false ),
		'empty string' => array( '', false ),
		'null value' => array( null, false ),
	);
}
```

---

## Exam Tips

### Key Points to Remember

1. **Setup:**
   - Install PHPUnit via Composer
   - Configure `phpunit.xml`
   - Create bootstrap file

2. **Test Structure:**
   - Extend `TestCase` or `WP_UnitTestCase`
   - Use `setUp()` and `tearDown()`
   - Test methods start with "test"

3. **Assertions:**
   - Use appropriate assertion methods
   - `assertEquals()` vs `assertSame()` (loose vs strict)
   - Test both positive and negative cases

4. **Mocking:**
   - Mock external dependencies
   - Use mocks for WordPress functions in unit tests
   - Use real WordPress environment for integration tests

5. **Running Tests:**
   - Command line: `./vendor/bin/phpunit`
   - Filter by suite, file, or method
   - Generate coverage reports

6. **Best Practices:**
   - Descriptive test names
   - One assertion per test (when possible)
   - Arrange-Act-Assert pattern
   - Test isolation

---

## Additional Resources

- [PHPUnit - Official Documentation](https://phpunit.de/)
- [PHPUnit Manual - Writing Tests](https://phpunit.de/manual/current/en/writing-tests-for-phpunit.html)
- [WordPress Test Library](https://make.wordpress.org/core/handbook/testing/automated-testing/phpunit/)
- [PHPUnit Best Practices](https://phpunit.de/manual/current/en/appendixes/best-practices.html)
