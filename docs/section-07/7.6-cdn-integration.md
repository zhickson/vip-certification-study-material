# 7.6 CDN Integration - Study Notes

## Overview

Content Delivery Networks (CDNs) offload traffic from origin servers and improve global performance by serving content from geographically distributed edge locations. Understanding CDN integration is essential for high-traffic WordPress sites.

**Key Reference:** [CDN Integration - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/performance/caching/)

---

## 1. Integrating CDNs (Cloudflare, Akamai, Fastly)

### CDN Basics

**What is a CDN:**
- Network of distributed servers
- Serves content from locations closest to users
- Reduces latency and origin server load
- Caches static and dynamic content

**Popular CDNs:**
- Cloudflare: Easy setup, DDoS protection
- Akamai: Enterprise-grade, global network
- Fastly: Real-time purging, edge computing
- AWS CloudFront: Integrated with AWS services
- KeyCDN: Cost-effective, simple setup

### Cloudflare Integration

**DNS Configuration:**
```
1. Add site to Cloudflare
2. Update nameservers to Cloudflare
3. Configure DNS records (A, CNAME)
4. Enable proxy (orange cloud)
```

**WordPress Configuration:**
```php
// Detect Cloudflare and get real IP
if ( isset( $_SERVER['HTTP_CF_CONNECTING_IP'] ) ) {
	$_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_CF_CONNECTING_IP'];
}

// Trust Cloudflare IPs
add_filter( 'wp_http_remote_request_args', function( $args ) {
	$args['headers']['CF-Connecting-IP'] = $_SERVER['HTTP_CF_CONNECTING_IP'] ?? '';
	return $args;
} );
```

**Cloudflare Plugin:**
```php
// Use Cloudflare plugin or API
// Automatically handles:
// - Real IP detection
// - Cache purging
// - SSL/TLS
// - DDoS protection
```

### Fastly Integration

**VCL Configuration:**
```vcl
# Fastly VCL for WordPress
sub vcl_recv {
	# Don't cache admin or logged-in users
	if (req.url ~ "^/(wp-admin|wp-login)" || req.http.Cookie ~ "wordpress_logged_in") {
		return (pass);
	}

	# Cache everything else
	return (lookup);
}

sub vcl_backend_response {
	# Set cache TTL
	if (bereq.url !~ "^/(wp-admin|wp-login)") {
		set beresp.ttl = 1h;
		set beresp.http.Cache-Control = "public, max-age=3600";
	}
}

sub vcl_deliver {
	# Add cache status header
	if (obj.hits > 0) {
		set resp.http.X-Cache = "HIT";
	} else {
		set resp.http.X-Cache = "MISS";
	}
}
```

**Fastly API Purging:**
```php
function purge_fastly_cache( $urls ) {
	$fastly_api_key = get_option( 'fastly_api_key' );
	$service_id = get_option( 'fastly_service_id' );

	foreach ( $urls as $url ) {
		wp_remote_request(
			"https://api.fastly.com/service/{$service_id}/purge/{$url}",
			array(
				'method' => 'POST',
				'headers' => array(
					'Fastly-Key' => $fastly_api_key,
					'Accept' => 'application/json',
				),
			)
		);
	}
}

// Purge on post update
add_action( 'save_post', function( $post_id ) {
	$urls = array(
		get_permalink( $post_id ),
		home_url(),
	);
	purge_fastly_cache( $urls );
} );
```

### AWS CloudFront Integration

**CloudFront Distribution Setup:**
```
1. Create CloudFront distribution
2. Set origin to WordPress server
3. Configure caching behaviors
4. Set up SSL certificate
5. Update DNS to CloudFront domain
```

**WordPress Configuration:**
```php
// Serve static assets from CloudFront
function cloudfront_url( $url ) {
	$cdn_domain = 'https://d1234567890.cloudfront.net';
	$upload_dir = wp_upload_dir();

	if ( strpos( $url, $upload_dir['baseurl'] ) !== false ) {
		$url = str_replace( home_url(), $cdn_domain, $url );
	}

	return $url;
}

add_filter( 'wp_get_attachment_url', 'cloudfront_url' );
add_filter( 'wp_calculate_image_srcset', function( $sources ) {
	foreach ( $sources as &$source ) {
		$source['url'] = cloudfront_url( $source['url'] );
	}
	return $sources;
} );
```

---

## 2. Configuring Caching for Static Assets

### Static Asset Caching

**Cache Static Files:**
```php
// Serve static assets with long cache headers
add_action( 'template_redirect', function() {
	if ( is_admin() ) {
		return;
	}

	// CSS and JS files
	if ( preg_match( '/\.(css|js)$/', $_SERVER['REQUEST_URI'] ) ) {
		header( 'Cache-Control: public, max-age=31536000, immutable' );
		header( 'Expires: ' . gmdate( 'D, d M Y H:i:s', time() + 31536000 ) . ' GMT' );
	}

	// Images
	if ( preg_match( '/\.(jpg|jpeg|png|gif|webp|svg)$/', $_SERVER['REQUEST_URI'] ) ) {
		header( 'Cache-Control: public, max-age=31536000, immutable' );
	}
} );
```

**Version Static Assets:**
```php
// Add version to asset URLs for cache busting
function enqueue_versioned_assets() {
	wp_enqueue_style(
		'theme-style',
		get_stylesheet_uri(),
		array(),
		filemtime( get_stylesheet_directory() . '/style.css' )
	);

	wp_enqueue_script(
		'theme-script',
		get_template_directory_uri() . '/js/script.js',
		array(),
		filemtime( get_template_directory() . '/js/script.js' ),
		true
	);
}
add_action( 'wp_enqueue_scripts', 'enqueue_versioned_assets' );
```

### CDN Cache Rules

**Cloudflare Page Rules:**
```
Rule 1: *.example.com/wp-content/*
- Cache Level: Cache Everything
- Edge Cache TTL: 1 month
- Browser Cache TTL: Respect Existing Headers

Rule 2: *.example.com/wp-admin/*
- Cache Level: Bypass
- Always Online: Off

Rule 3: *.example.com/*
- Cache Level: Standard
- Edge Cache TTL: 2 hours
```

**Fastly Cache Rules:**
```vcl
# Cache static assets aggressively
if (req.url ~ "\.(css|js|jpg|jpeg|png|gif|webp|svg|woff|woff2|ttf|eot)$") {
	set beresp.ttl = 31536000s; # 1 year
	set beresp.http.Cache-Control = "public, max-age=31536000, immutable";
}
```

---

## 3. Optimising DNS and Routing Through CDN

### DNS Configuration

**CDN DNS Setup:**
```
# Cloudflare DNS
Type: A
Name: @
Content: 192.0.2.1 (origin IP)
Proxy: Proxied (orange cloud)

Type: CNAME
Name: www
Content: example.com
Proxy: Proxied

Type: CNAME
Name: cdn
Content: example.com
Proxy: Proxied
```

**DNS Propagation:**
- TTL settings affect propagation speed
- Lower TTL (300s) for faster changes
- Higher TTL (3600s) for stability

### Routing Configuration

**Origin Server Configuration:**
```nginx
# Allow CDN IPs only
set_real_ip_from 103.21.244.0/22; # Cloudflare
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
# ... more Cloudflare IPs
real_ip_header CF-Connecting-IP;

# Or use Cloudflare IP list
include /etc/nginx/cloudflare-ips.conf;
```

**WordPress Real IP Detection:**
```php
// Get real client IP from CDN headers
function get_real_ip() {
	$ip_keys = array(
		'HTTP_CF_CONNECTING_IP', // Cloudflare
		'HTTP_X_REAL_IP', // Nginx
		'HTTP_X_FORWARDED_FOR',
		'REMOTE_ADDR',
	);

	foreach ( $ip_keys as $key ) {
		if ( ! empty( $_SERVER[ $key ] ) ) {
			$ip = $_SERVER[ $key ];
			if ( strpos( $ip, ',' ) !== false ) {
				$ip = explode( ',', $ip )[0];
			}
			$ip = trim( $ip );
			if ( filter_var( $ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE ) ) {
				return $ip;
			}
		}
	}

	return $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';
}

// Use real IP for logging
add_filter( 'wp_remote_request_args', function( $args ) {
	$args['headers']['X-Real-IP'] = get_real_ip();
	return $args;
} );
```

---

## 4. Tuning Cache Behaviours to Reduce Origin Load

### Cache TTL Configuration

**Different TTLs for Different Content:**
```php
// Set cache headers based on content type
add_action( 'template_redirect', function() {
	if ( is_admin() || is_user_logged_in() ) {
		return;
	}

	// Homepage: 1 hour
	if ( is_front_page() ) {
		header( 'Cache-Control: public, max-age=3600' );
		header( 'X-Cache-TTL: 3600' );
	}

	// Posts: 30 minutes
	if ( is_single() ) {
		header( 'Cache-Control: public, max-age=1800' );
		header( 'X-Cache-TTL: 1800' );
	}

	// Archives: 1 hour
	if ( is_archive() ) {
		header( 'Cache-Control: public, max-age=3600' );
		header( 'X-Cache-TTL: 3600' );
	}

	// Static assets: 1 year
	if ( preg_match( '/\.(css|js|jpg|jpeg|png|gif|webp|svg)$/', $_SERVER['REQUEST_URI'] ) ) {
		header( 'Cache-Control: public, max-age=31536000, immutable' );
	}
} );
```

### Cache Purging Strategy

**Selective Cache Purging:**
```php
function purge_cdn_cache( $urls, $patterns = array() ) {
	$cdn_type = get_option( 'cdn_type' ); // 'cloudflare', 'fastly', 'cloudfront'

	switch ( $cdn_type ) {
		case 'cloudflare':
			purge_cloudflare_cache( $urls, $patterns );
			break;
		case 'fastly':
			purge_fastly_cache( $urls );
			break;
		case 'cloudfront':
			purge_cloudfront_cache( $patterns );
			break;
	}
}

// Purge on post update
add_action( 'save_post', function( $post_id ) {
	$urls = array(
		get_permalink( $post_id ),
		home_url(),
		get_post_type_archive_link( get_post_type( $post_id ) ),
	);

	$patterns = array(
		home_url( '/category/*' ),
		home_url( '/tag/*' ),
	);

	purge_cdn_cache( $urls, $patterns );
} );

// Purge on term update
add_action( 'edited_term', function( $term_id, $tt_id, $taxonomy ) {
	$term = get_term( $term_id, $taxonomy );
	$urls = array(
		get_term_link( $term ),
		home_url(),
	);
	purge_cdn_cache( $urls );
}, 10, 3 );
```

### Cache Warming

**Pre-populate CDN Cache:**
```php
function warm_cdn_cache( $urls ) {
	foreach ( $urls as $url ) {
		wp_remote_get( $url, array(
			'timeout' => 5,
			'blocking' => false, // Don't wait for response
		) );
	}
}

// Warm cache for popular pages
add_action( 'wp_loaded', function() {
	if ( ! wp_next_scheduled( 'warm_cdn_cache' ) ) {
		wp_schedule_event( time(), 'hourly', 'warm_cdn_cache' );
	}
} );

add_action( 'warm_cdn_cache', function() {
	$popular_urls = array(
		home_url(),
		home_url( '/blog/' ),
		home_url( '/about/' ),
		// Add more popular URLs
	);
	warm_cdn_cache( $popular_urls );
} );
```

---

## Exam Tips

### Key Points to Remember

1. **CDN Integration:**
   - Configure DNS to point to CDN
   - Set up origin server
   - Configure cache rules
   - Handle real IP detection

2. **Static Asset Caching:**
   - Cache CSS/JS/images aggressively (1 year)
   - Use versioning for cache busting
   - Set appropriate cache headers
   - Serve from CDN domain

3. **DNS and Routing:**
   - Configure DNS records correctly
   - Set appropriate TTL values
   - Handle real IP from CDN headers
   - Allow CDN IPs on origin server

4. **Cache Tuning:**
   - Different TTLs for different content
   - Purge cache on content updates
   - Use cache warming for popular pages
   - Monitor cache hit rates

5. **Origin Load Reduction:**
   - Cache static assets at edge
   - Use long TTLs for static content
   - Implement cache purging strategy
   - Monitor origin server load

---

## Additional Resources

- [CDN Integration - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/performance/caching/)
- [Cloudflare Documentation](https://developers.cloudflare.com/)
- [Fastly Documentation](https://docs.fastly.com/)
- [AWS CloudFront Documentation](https://docs.aws.amazon.com/cloudfront/)
