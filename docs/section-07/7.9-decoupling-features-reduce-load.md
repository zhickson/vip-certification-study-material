# 7.9 Decoupling Features to Reduce Load - Study Notes

## Overview

Decoupling resource-intensive features from the main web tier reduces server load and improves scalability. Moving analytics, search, reporting, and other heavy operations to separate services or background processes ensures the main WordPress application remains responsive.

**Key Reference:** [Background Processing - WordPress Developer Resources](https://developer.wordpress.org/plugin/handbook/background-processing/)

---

## 1. Moving Analytics, Search, or Reporting into Separate Services

### Why Decouple?

**Benefits:**
- Reduces main server load
- Improves response times
- Enables independent scaling
- Better fault isolation
- Allows use of specialised tools

**What to Decouple:**
- Analytics tracking
- Search functionality
- Reporting and data aggregation
- Image processing
- Email sending
- Social media integration

### Analytics Decoupling

**Move Analytics to External Service:**
```php
// ❌ BAD - Track analytics synchronously
add_action( 'wp_footer', function() {
	// Heavy analytics processing blocks page load
	track_page_view( array(
		'url' => $_SERVER['REQUEST_URI'],
		'timestamp' => time(),
		'user_id' => get_current_user_id(),
		// ... heavy processing
	) );
} );

// ✅ GOOD - Send to queue for background processing
add_action( 'wp_footer', function() {
	// Add to queue, don't block
	wp_queue_push( 'analytics', array(
		'url' => $_SERVER['REQUEST_URI'],
		'timestamp' => time(),
		'user_id' => get_current_user_id(),
	) );
} );
```

**External Analytics Service:**
```php
class Analytics_Service {
	private $api_endpoint = 'https://analytics.example.com/api/track';

	public function track( $event, $data ) {
		// Send to external service asynchronously
		wp_remote_post( $this->api_endpoint, array(
			'body' => json_encode( array(
				'event' => $event,
				'data' => $data,
				'timestamp' => time(),
			) ),
			'headers' => array(
				'Content-Type' => 'application/json',
				'Authorization' => 'Bearer ' . get_option( 'analytics_api_key' ),
			),
			'timeout' => 5,
			'blocking' => false, // Don't wait for response
		) );
	}
}

// Usage
$analytics = new Analytics_Service();
$analytics->track( 'page_view', array(
	'url' => $_SERVER['REQUEST_URI'],
	'user_id' => get_current_user_id(),
) );
```

### Search Service Decoupling

**Move Search to Elasticsearch:**
```php
// Search handled by separate Elasticsearch service
// See 7.8 for full implementation

// WordPress only handles search UI
// Actual search happens on Elasticsearch server
function handle_search_request() {
	$query = get_search_query();

	// Call external search service
	$response = wp_remote_get(
		'https://search.example.com/api/search',
		array(
			'body' => array(
				'q' => $query,
				'page' => get_query_var( 'paged', 1 ),
			),
		)
	);

	$results = json_decode( wp_remote_retrieve_body( $response ), true );
	return $results;
}
```

### Reporting Service

**Move Reporting to Separate Service:**
```php
// ❌ BAD - Generate reports on main server
function generate_sales_report() {
	// Heavy database queries block server
	$orders = $wpdb->get_results( "
		SELECT * FROM wp_orders
		WHERE date >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		ORDER BY date DESC
	" );
	// ... heavy processing
	return $report;
}

// ✅ GOOD - Offload to reporting service
function request_sales_report( $date_range ) {
	// Send request to reporting service
	wp_remote_post( 'https://reports.example.com/api/generate', array(
		'body' => json_encode( array(
			'type' => 'sales',
			'date_range' => $date_range,
		) ),
		'headers' => array(
			'Content-Type' => 'application/json',
			'Authorization' => 'Bearer ' . get_option( 'reports_api_key' ),
		),
		'blocking' => false,
	) );

	// Return job ID for status checking
	return array( 'job_id' => uniqid() );
}
```

---

## 2. Implementing Background Processing with Queues

### WordPress Background Processing

**Using Action Scheduler:**
```php
// Install: composer require woocommerce/action-scheduler

// Schedule background task
function schedule_background_task( $data ) {
	as_schedule_single_action(
		time(), // Run now
		'process_background_task',
		array( $data ),
		'background-processing'
	);
}

// Process task
add_action( 'process_background_task', function( $data ) {
	// Heavy processing that doesn't block main request
	process_heavy_operation( $data );
} );

// Usage
add_action( 'save_post', function( $post_id ) {
	schedule_background_task( array(
		'post_id' => $post_id,
		'action' => 'index',
	) );
} );
```

### Custom Queue System

**Simple Queue Implementation:**
```php
class Background_Queue {
	private $table_name;

	public function __construct() {
		global $wpdb;
		$this->table_name = $wpdb->prefix . 'background_queue';
		$this->create_table();
	}

	private function create_table() {
		global $wpdb;

		$charset_collate = $wpdb->get_charset_collate();

		$sql = "CREATE TABLE IF NOT EXISTS {$this->table_name} (
			id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
			job_type VARCHAR(50) NOT NULL,
			job_data LONGTEXT NOT NULL,
			status VARCHAR(20) DEFAULT 'pending',
			created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
			processed_at DATETIME NULL,
			PRIMARY KEY (id),
			KEY status (status),
			KEY created_at (created_at)
		) $charset_collate;";

		require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
		dbDelta( $sql );
	}

	public function add( $job_type, $job_data ) {
		global $wpdb;

		$wpdb->insert(
			$this->table_name,
			array(
				'job_type' => $job_type,
				'job_data' => json_encode( $job_data ),
				'status' => 'pending',
			),
			array( '%s', '%s', '%s' )
		);

		return $wpdb->insert_id;
	}

	public function process( $limit = 10 ) {
		global $wpdb;

		$jobs = $wpdb->get_results( $wpdb->prepare(
			"SELECT * FROM {$this->table_name}
			WHERE status = 'pending'
			ORDER BY created_at ASC
			LIMIT %d",
			$limit
		) );

		foreach ( $jobs as $job ) {
			$this->process_job( $job );
		}
	}

	private function process_job( $job ) {
		global $wpdb;

		// Mark as processing
		$wpdb->update(
			$this->table_name,
			array( 'status' => 'processing' ),
			array( 'id' => $job->id ),
			array( '%s' ),
			array( '%d' )
		);

		$job_data = json_decode( $job->job_data, true );

		// Process job
		do_action( 'process_background_job_' . $job->job_type, $job_data );

		// Mark as completed
		$wpdb->update(
			$this->table_name,
			array(
				'status' => 'completed',
				'processed_at' => current_time( 'mysql' ),
			),
			array( 'id' => $job->id ),
			array( '%s', '%s' ),
			array( '%d' )
		);
	}
}

// Register job handlers
add_action( 'process_background_job_send_email', function( $data ) {
	wp_mail( $data['to'], $data['subject'], $data['message'] );
} );

add_action( 'process_background_job_generate_report', function( $data ) {
	generate_report( $data['report_type'], $data['params'] );
} );

// Process queue via cron
add_action( 'wp_loaded', function() {
	if ( ! wp_next_scheduled( 'process_background_queue' ) ) {
		wp_schedule_event( time(), 'every_5_minutes', 'process_background_queue' );
	}
} );

add_action( 'process_background_queue', function() {
	$queue = new Background_Queue();
	$queue->process( 10 ); // Process 10 jobs at a time
} );
```

### Using External Queue Services

**Redis Queue:**
```php
// Use Redis for distributed queue
class Redis_Queue {
	private $redis;

	public function __construct() {
		$this->redis = new Redis();
		$this->redis->connect( 'redis', 6379 );
	}

	public function push( $queue_name, $job_data ) {
		$this->redis->lpush( "queue:{$queue_name}", json_encode( $job_data ) );
	}

	public function pop( $queue_name ) {
		$data = $this->redis->brpop( "queue:{$queue_name}", 10 );
		if ( $data ) {
			return json_decode( $data[1], true );
		}
		return null;
	}
}

// Worker process (separate PHP script)
$queue = new Redis_Queue();
while ( true ) {
	$job = $queue->pop( 'background_jobs' );
	if ( $job ) {
		process_job( $job );
	}
}
```

**AWS SQS:**
```php
// Use AWS SQS for managed queue
require 'vendor/autoload.php';
use Aws\Sqs\SqsClient;

class SQS_Queue {
	private $client;
	private $queue_url;

	public function __construct() {
		$this->client = new SqsClient( array(
			'region' => 'us-east-1',
			'version' => 'latest',
		) );
		$this->queue_url = get_option( 'sqs_queue_url' );
	}

	public function send( $message ) {
		$this->client->sendMessage( array(
			'QueueUrl' => $this->queue_url,
			'MessageBody' => json_encode( $message ),
		) );
	}

	public function receive() {
		$result = $this->client->receiveMessage( array(
			'QueueUrl' => $this->queue_url,
			'MaxNumberOfMessages' => 1,
			'WaitTimeSeconds' => 20, // Long polling
		) );

		if ( isset( $result['Messages'] ) ) {
			return json_decode( $result['Messages'][0]['Body'], true );
		}

		return null;
	}
}
```

---

## 3. Using Microservices for Non-Critical Workloads

### Microservices Architecture

**What are Microservices:**
- Small, independent services
- Each handles specific functionality
- Communicate via APIs
- Can be scaled independently

**When to Use:**
- Non-critical features
- Resource-intensive operations
- Features that need different tech stack
- Services that change frequently

### Example Microservices

**Image Processing Service:**
```php
// WordPress sends image to microservice
function process_image( $image_url, $operations ) {
	$response = wp_remote_post( 'https://images.example.com/api/process', array(
		'body' => json_encode( array(
			'image_url' => $image_url,
			'operations' => $operations, // resize, crop, filter, etc.
		) ),
		'headers' => array(
			'Content-Type' => 'application/json',
			'Authorization' => 'Bearer ' . get_option( 'image_service_key' ),
		),
		'timeout' => 30,
	) );

	$result = json_decode( wp_remote_retrieve_body( $response ), true );
	return $result['processed_url'];
}

// Usage
add_action( 'wp_handle_upload', function( $file ) {
	// Send to image processing service
	$processed = process_image( $file['url'], array(
		'resize' => array( 'width' => 1200, 'height' => 1200 ),
		'optimize' => true,
	) );

	// Update attachment with processed URL
	update_post_meta( $file['post_id'], '_processed_image_url', $processed );
} );
```

**Email Service:**
```php
// Use external email service (SendGrid, Mailgun, etc.)
function send_email_via_service( $to, $subject, $message ) {
	wp_remote_post( 'https://api.sendgrid.com/v3/mail/send', array(
		'body' => json_encode( array(
			'personalizations' => array(
				array(
					'to' => array( array( 'email' => $to ) ),
				),
			),
			'from' => array( 'email' => 'noreply@example.com' ),
			'subject' => $subject,
			'content' => array(
				array(
					'type' => 'text/html',
					'value' => $message,
				),
			),
		) ),
		'headers' => array(
			'Authorization' => 'Bearer ' . get_option( 'sendgrid_api_key' ),
			'Content-Type' => 'application/json',
		),
		'blocking' => false, // Don't wait
	) );
}

// Replace wp_mail
add_filter( 'wp_mail', function( $args ) {
	send_email_via_service( $args['to'], $args['subject'], $args['message'] );
	return false; // Prevent default wp_mail
} );
```

**Notification Service:**
```php
// Push notifications via external service
function send_notification( $user_id, $message, $data = array() ) {
	$user = get_userdata( $user_id );
	$device_tokens = get_user_meta( $user_id, 'device_tokens', true );

	if ( empty( $device_tokens ) ) {
		return;
	}

	wp_remote_post( 'https://notifications.example.com/api/push', array(
		'body' => json_encode( array(
			'tokens' => $device_tokens,
			'message' => $message,
			'data' => $data,
		) ),
		'headers' => array(
			'Content-Type' => 'application/json',
			'Authorization' => 'Bearer ' . get_option( 'notification_service_key' ),
		),
		'blocking' => false,
	) );
}
```

---

## 4. Decoupling Strategy

### Identify Candidates for Decoupling

**High Resource Usage:**
- Heavy database queries
- Image processing
- File generation
- External API calls

**Non-Critical Features:**
- Analytics
- Logging
- Reporting
- Social media integration

**Independent Scaling Needs:**
- Search
- Email
- Notifications
- Background jobs

### Implementation Steps

**1. Identify Feature:**
```php
// Find resource-intensive operations
// Profile code to identify bottlenecks
```

**2. Create Service Interface:**
```php
// Define interface for service
interface Analytics_Service_Interface {
	public function track( $event, $data );
	public function get_stats( $params );
}
```

**3. Implement Service:**
```php
// Create microservice or use external service
class External_Analytics_Service implements Analytics_Service_Interface {
	// Implementation
}
```

**4. Replace in WordPress:**
```php
// Replace direct calls with service calls
$analytics = new External_Analytics_Service();
$analytics->track( 'page_view', $data );
```

**5. Monitor and Optimise:**
```php
// Monitor service performance
// Optimise as needed
```

---

## Exam Tips

### Key Points to Remember

1. **Why Decouple:**
   - Reduce main server load
   - Improve response times
   - Enable independent scaling
   - Better fault isolation

2. **What to Decouple:**
   - Analytics tracking
   - Search functionality
   - Reporting
   - Image processing
   - Email sending

3. **Background Processing:**
   - Use queues for async processing
   - Process jobs via cron or workers
   - Don't block main requests
   - Handle failures gracefully

4. **Microservices:**
   - Small, independent services
   - Communicate via APIs
   - Scale independently
   - Use for non-critical workloads

5. **Implementation:**
   - Identify resource-intensive features
   - Create service interfaces
   - Replace direct calls
   - Monitor performance

---

## Additional Resources

- [Background Processing - WordPress Developer Resources](https://developer.wordpress.org/plugin/handbook/background-processing/)
- [Action Scheduler](https://actionscheduler.org/)
- [WP Background Processing](https://github.com/A5hleyRich/wp-background-processing)
- [Microservices Architecture](https://microservices.io/)
