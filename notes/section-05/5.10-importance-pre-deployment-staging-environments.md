# 5.10 Importance of Pre-Deployment Staging Environments - Study Notes

## Overview

Staging environments replicate production conditions to test deployments and changes safely before going live. They are essential for catching issues, validating functionality, and building confidence in deployments.

**Key Reference:** [Staging Environments - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/deployment/)

---

## 1. How Staging Protects Production

### Risk Mitigation

Staging environments prevent:
- **Broken Deployments:** Catch issues before production
- **Data Loss:** Test database migrations safely
- **Security Vulnerabilities:** Test security updates
- **Performance Issues:** Identify performance problems
- **User Impact:** Zero impact on live users

### Testing Workflow

```
Development → Staging → Production
     ↓           ↓          ↓
   Local      Testing    Live Users
```

---

## 2. Replicating Production Conditions

### Server Configuration

```bash
# Staging should match production:
# - PHP version
# - MySQL version
# - Web server (Apache/Nginx)
# - PHP extensions
# - Server resources (CPU, RAM)
# - Operating system
```

### WordPress Configuration

```php
// Staging wp-config.php should mirror production
// Same plugins, themes, and settings
// Same database structure
// Same file permissions
```

### Database Replication

```bash
# Copy production database to staging
wp db export production.sql
wp db import production.sql --url=staging.example.com

# Sanitize sensitive data
wp search-replace production.example.com staging.example.com
wp search-replace 'production@example.com' 'staging@example.com'
```

### Content Synchronization

```bash
# Sync media files
rsync -avz /var/www/production/wp-content/uploads/ \
  /var/www/staging/wp-content/uploads/

# Sync plugins and themes
rsync -avz /var/www/production/wp-content/plugins/ \
  /var/www/staging/wp-content/plugins/
```

---

## 3. Testing Deployments Safely

### Deployment Testing Process

```bash
#!/bin/bash
# test-deployment.sh

echo "Testing deployment on staging..."

# 1. Backup staging
wp db export staging-backup-$(date +%Y%m%d).sql --url=staging.example.com

# 2. Deploy to staging
git checkout feature-branch
rsync -avz ./ staging.example.com:/var/www/staging/

# 3. Run database migrations
ssh staging.example.com "cd /var/www/staging && wp db migrate"

# 4. Clear cache
ssh staging.example.com "cd /var/www/staging && wp cache flush"

# 5. Run tests
./vendor/bin/phpunit --testsuite=Integration

# 6. Health check
curl -f https://staging.example.com/health || exit 1

echo "Staging deployment successful!"
```

### Testing Database Migrations

```php
// Test migration on staging first
function test_migration_on_staging() {
	// Run migration
	wp db migrate --url=staging.example.com

	// Verify migration
	global $wpdb;
	$table_exists = $wpdb->get_var( "SHOW TABLES LIKE '{$wpdb->prefix}new_table'" );

	if ( ! $table_exists ) {
		die( 'Migration failed on staging!' );
	}

	// Test rollback
	wp db migrate --rollback --url=staging.example.com
}
```

### Testing Plugin Updates

```bash
# Test plugin update on staging
wp plugin update plugin-name --url=staging.example.com

# Test functionality
curl -f https://staging.example.com/test-endpoint

# If successful, proceed to production
```

---

## 4. Validating Changes Before Going Live

### Functional Testing

```markdown
# Staging Test Checklist

## Pre-Deployment
- [ ] Code reviewed and approved
- [ ] Tests passing
- [ ] Staging environment updated

## Functional Tests
- [ ] User registration works
- [ ] Login/logout works
- [ ] Content creation works
- [ ] Search functionality works
- [ ] Payment processing works (if applicable)
- [ ] Email sending works
- [ ] API endpoints work

## Browser Testing
- [ ] Chrome (latest)
- [ ] Firefox (latest)
- [ ] Safari (latest)
- [ ] Edge (latest)
- [ ] Mobile browsers

## Performance Tests
- [ ] Page load times acceptable
- [ ] Database queries optimized
- [ ] No memory leaks
- [ ] Cache working correctly
```

### User Acceptance Testing

```markdown
# UAT on Staging

## Test Scenarios
1. Complete user registration flow
2. Purchase workflow (if e-commerce)
3. Content publishing workflow
4. Admin functionality
5. Search and navigation

## Stakeholder Sign-off
- [ ] Product owner approval
- [ ] QA team approval
- [ ] Business stakeholder approval
```

### Performance Validation

```bash
# Test performance on staging
# Should match or exceed production performance

# Load testing
ab -n 1000 -c 10 https://staging.example.com/

# Database query analysis
wp db query "SHOW PROCESSLIST" --url=staging.example.com

# Memory usage
wp eval 'echo memory_get_peak_usage(true);' --url=staging.example.com
```

---

## 5. Integrating Staging with CI/CD Pipelines

### Automated Staging Deployment

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches:
      - develop  # Auto-deploy to staging

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to staging
        run: |
          rsync -avz ./ user@staging:/var/www/staging/
          ssh user@staging "cd /var/www/staging && wp cache flush"

      - name: Run tests on staging
        run: |
          curl -f https://staging.example.com/health
          ./vendor/bin/phpunit --url=staging.example.com

      - name: Notify team
        uses: 8398a7/action-slack@v3
        with:
          text: 'Deployed to staging: ${{ github.sha }}'
```

### Staging Test Automation

```yaml
# .github/workflows/staging-tests.yml
name: Staging Tests

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM

jobs:
  test-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run smoke tests
        run: |
          curl -f https://staging.example.com/
          curl -f https://staging.example.com/wp-admin/
          curl -f https://staging.example.com/wp-json/

      - name: Run integration tests
        run: |
          ./vendor/bin/phpunit --testsuite=Integration --url=staging.example.com

      - name: Performance test
        run: |
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://staging.example.com/)
          if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
            echo "Response time too slow: $RESPONSE_TIME"
            exit 1
          fi
```

---

## 6. Staging Environment Best Practices

### Data Privacy

```php
// Sanitize production data in staging
function sanitize_staging_data() {
	// Replace real emails with test emails
	wp search-replace '@example.com' '@staging-test.com' --url=staging.example.com

	// Replace real phone numbers
	wp search-replace '/\d{3}-\d{3}-\d{4}/' '555-000-0000' --url=staging.example.com

	// Anonymize user data
	wp db query "UPDATE wp_users SET user_email = CONCAT('user', ID, '@staging-test.com')" --url=staging.example.com
}
```

### Access Control

```php
// Restrict staging access
// .htaccess or Nginx config
# Staging environment - require authentication
AuthType Basic
AuthName "Staging Environment"
AuthUserFile /path/to/.htpasswd
Require valid-user
```

### Search Engine Blocking

```php
// Prevent search engine indexing
// wp-config.php for staging
if ( WP_ENVIRONMENT_TYPE === 'staging' ) {
	define( 'DISALLOW_INDEXING', true );

	// Add robots.txt
	add_action( 'init', function() {
		if ( ! is_admin() ) {
			header( 'X-Robots-Tag: noindex, nofollow' );
		}
	} );
}
```

### Monitoring

```php
// Monitor staging separately from production
// Different error logging
if ( WP_ENVIRONMENT_TYPE === 'staging' ) {
	ini_set( 'error_log', '/var/log/staging-errors.log' );

	// Different monitoring endpoint
	add_action( 'rest_api_init', function() {
		register_rest_route( 'staging/v1', '/health', array(
			'methods' => 'GET',
			'callback' => 'staging_health_check',
		) );
	} );
}
```

---

## Exam Tips

### Key Points to Remember

1. **Purpose:**
   - Test deployments safely
   - Validate changes before production
   - Catch issues early

2. **Replication:**
   - Match production server config
   - Mirror production database
   - Sync content and media

3. **Testing:**
   - Functional testing
   - Performance testing
   - User acceptance testing

4. **Integration:**
   - Automated staging deployments
   - CI/CD pipeline integration
   - Automated testing

5. **Best Practices:**
   - Sanitize sensitive data
   - Restrict access
   - Block search engines
   - Monitor separately

---

## Additional Resources

- [Staging Environments - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/deployment/)
- [Deployment Best Practices](https://www.digitalocean.com/community/tutorials/deployment-best-practices)
- [Staging Environment Setup](https://wordpress.org/support/article/creating-a-staging-site/)
