# 5.8 Configuring CI/CD Systems for WordPress Deployment - Study Notes

## Overview

Setting up CI/CD systems (GitHub Actions, GitLab CI, Jenkins, etc.) for WordPress deployment automates the build, test, and deployment process, ensuring consistent and reliable releases.

**Key Reference:** [CI/CD Best Practices](https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment)

---

## 1. GitHub Actions for WordPress

### Basic Workflow

```yaml
# .github/workflows/deploy.yml
name: Deploy WordPress

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      - name: Install dependencies
        run: composer install --no-dev

      - name: Deploy to server
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          SOURCE: ./
          TARGET: /var/www/html
```

### Multi-Environment Deployment

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches:
      - develop   # Staging
      - main      # Production

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to staging
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY_STAGING }}
          REMOTE_HOST: ${{ secrets.STAGING_HOST }}
          REMOTE_USER: ${{ secrets.STAGING_USER }}
          TARGET: /var/www/staging

  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [test]  # Wait for tests
    environment: production
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to production
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY_PRODUCTION }}
          REMOTE_HOST: ${{ secrets.PRODUCTION_HOST }}
          REMOTE_USER: ${{ secrets.PRODUCTION_USER }}
          TARGET: /var/www/production
```

### Complete WordPress Deployment Workflow

```yaml
# .github/workflows/wordpress-deploy.yml
name: WordPress Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      - name: Install dependencies
        run: composer install

      - name: Run tests
        run: ./vendor/bin/phpunit

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy files
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/html/

      - name: Run WordPress commands
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            cd /var/www/html
            wp core update-db
            wp cache flush
            wp rewrite flush
          EOF

      - name: Health check
        run: |
          sleep 5
          curl -f https://${{ secrets.DEPLOY_HOST }}/health || exit 1
```

---

## 2. GitLab CI for WordPress

### Basic Configuration

```yaml
# .gitlab-ci.yml
stages:
  - test
  - deploy

variables:
  DEPLOY_PATH: "/var/www/html"

before_script:
  - apt-get update -qq
  - apt-get install -y -qq git curl unzip

test:
  stage: test
  image: php:8.0
  script:
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install
    - ./vendor/bin/phpunit

deploy:staging:
  stage: deploy
  only:
    - develop
  script:
    - rsync -avz --delete ./ user@staging:/var/www/staging/
    - ssh user@staging "cd /var/www/staging && wp cache flush"

deploy:production:
  stage: deploy
  only:
    - main
  when: manual
  script:
    - rsync -avz --delete ./ user@production:/var/www/production/
    - ssh user@production "cd /var/www/production && wp cache flush"
```

### Advanced GitLab CI

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: wordpress_test

services:
  - mysql:8.0

build:
  stage: build
  script:
    - composer install --no-dev --optimize-autoloader
  artifacts:
    paths:
      - vendor/
    expire_in: 1 hour

test:unit:
  stage: test
  image: php:8.0
  dependencies:
    - build
  script:
    - ./vendor/bin/phpunit --testsuite=Unit

test:integration:
  stage: test
  image: php:8.0
  services:
    - mysql:8.0
  dependencies:
    - build
  script:
    - bash bin/install-wp-tests.sh wordpress_test root root mysql latest
    - ./vendor/bin/phpunit --testsuite=Integration

deploy:staging:
  stage: deploy
  only:
    - develop
  dependencies:
    - build
  script:
    - |
      rsync -avz --delete \
        -e "ssh -i $SSH_KEY" \
        --exclude='.git' \
        ./ $DEPLOY_USER@$STAGING_HOST:$DEPLOY_PATH/
    - |
      ssh -i $SSH_KEY $DEPLOY_USER@$STAGING_HOST << 'EOF'
        cd $DEPLOY_PATH
        wp core update-db
        wp cache flush
      EOF
  environment:
    name: staging
    url: https://staging.example.com

deploy:production:
  stage: deploy
  only:
    - main
  when: manual
  dependencies:
    - build
  script:
    - |
      rsync -avz --delete \
        -e "ssh -i $SSH_KEY" \
        --exclude='.git' \
        ./ $DEPLOY_USER@$PRODUCTION_HOST:$DEPLOY_PATH/
    - |
      ssh -i $SSH_KEY $DEPLOY_USER@$PRODUCTION_HOST << 'EOF'
        cd $DEPLOY_PATH
        wp core update-db
        wp cache flush
      EOF
  environment:
    name: production
    url: https://example.com
```

---

## 3. Jenkins Pipeline

### Jenkinsfile

```groovy
// Jenkinsfile
pipeline {
    agent any

    environment {
        DEPLOY_PATH = '/var/www/html'
        SSH_KEY = credentials('ssh-private-key')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                sh 'composer install --no-dev --optimize-autoloader'
            }
        }

        stage('Test') {
            steps {
                sh './vendor/bin/phpunit'
            }
        }

        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                sh '''
                    rsync -avz --delete \
                        -e "ssh -i $SSH_KEY" \
                        ./ user@staging:/var/www/staging/
                    ssh -i $SSH_KEY user@staging \
                        "cd /var/www/staging && wp cache flush"
                '''
            }
        }

        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to production?', ok: 'Deploy'
                sh '''
                    rsync -avz --delete \
                        -e "ssh -i $SSH_KEY" \
                        ./ user@production:/var/www/production/
                    ssh -i $SSH_KEY user@production \
                        "cd /var/www/production && wp cache flush"
                '''
            }
        }
    }

    post {
        success {
            emailext (
                subject: "Deployment Successful: ${env.JOB_NAME}",
                body: "Deployment completed successfully",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
        failure {
            emailext (
                subject: "Deployment Failed: ${env.JOB_NAME}",
                body: "Deployment failed. Please check logs.",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
    }
}
```

---

## 4. Writing Build and Deployment Scripts

### Build Script

```bash
#!/bin/bash
# build.sh

set -e

echo "Building WordPress project..."

# Install dependencies
composer install --no-dev --optimize-autoloader

# Build assets (if using build tools)
npm install
npm run build

# Create deployment package
tar -czf deploy.tar.gz \
    --exclude='.git' \
    --exclude='node_modules' \
    --exclude='.env' \
    --exclude='tests' \
    .

echo "Build complete: deploy.tar.gz"
```

### Deployment Script

```bash
#!/bin/bash
# deploy.sh

set -e

ENVIRONMENT=$1
if [ -z "$ENVIRONMENT" ]; then
    echo "Usage: ./deploy.sh <environment>"
    exit 1
fi

# Load environment configuration
source "config/$ENVIRONMENT.sh"

echo "Deploying to $ENVIRONMENT..."

# Upload files
rsync -avz --delete \
    -e "ssh -i $SSH_KEY" \
    --exclude='.git' \
    --exclude='.env' \
    ./ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/

# Run WordPress commands
ssh -i $SSH_KEY $DEPLOY_USER@$DEPLOY_HOST << EOF
    cd $DEPLOY_PATH
    wp core update-db
    wp cache flush
    wp rewrite flush
EOF

echo "Deployment complete!"
```

---

## 5. Securing Workflows with Credentials

### GitHub Secrets

Store secrets in GitHub repository settings:

1. Go to Settings → Secrets and variables → Actions
2. Add secrets:
   - `SSH_PRIVATE_KEY`
   - `DEPLOY_HOST`
   - `DEPLOY_USER`
   - `DB_PASSWORD`

### GitLab CI Variables

Store in GitLab CI/CD settings:

1. Go to Settings → CI/CD → Variables
2. Add variables:
   - `SSH_KEY` (file type)
   - `DEPLOY_HOST`
   - `DEPLOY_USER`

### Jenkins Credentials

Store in Jenkins credentials:

1. Go to Manage Jenkins → Credentials
2. Add credentials:
   - SSH Username with private key
   - Secret text for passwords

### Using Secrets in Scripts

```yaml
# GitHub Actions
- name: Deploy
  env:
    SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
    DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  run: |
    echo "$SSH_KEY" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    # Use in deployment
```

---

## 6. Controlling Access to Environments

### Environment Protection Rules

```yaml
# GitHub Actions - Protect production
deploy:production:
  environment: production
  environment:
    protection_rules:
      - type: required_reviewers
        reviewers: [team-lead, tech-lead]
      - type: wait_timer
        minutes: 5
```

### Manual Approval Gates

```yaml
# GitLab CI
deploy:production:
  when: manual
  only:
    - main
  environment:
    name: production
    url: https://example.com
```

### Role-Based Access

```groovy
// Jenkins
stage('Deploy to Production') {
    when {
        anyOf {
            branch 'main'
            expression { env.CHANGE_AUTHOR == 'admin' }
        }
    }
    steps {
        // Deployment steps
    }
}
```

---

## Exam Tips

### Key Points to Remember

1. **GitHub Actions:**
   - YAML workflow files
   - Use actions marketplace
   - Environment protection rules

2. **GitLab CI:**
   - `.gitlab-ci.yml` configuration
   - Stages and jobs
   - Manual deployment gates

3. **Jenkins:**
   - Jenkinsfile (Groovy)
   - Pipeline syntax
   - Credentials management

4. **Security:**
   - Store secrets securely
   - Use SSH keys for deployment
   - Protect production environments

5. **Best Practices:**
   - Test before deploy
   - Use environment-specific configs
   - Implement approval gates
   - Monitor deployments

---

## Additional Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GitLab CI/CD Documentation](https://docs.gitlab.com/ee/ci/)
- [Jenkins Pipeline Documentation](https://www.jenkins.io/doc/book/pipeline/)
- [CI/CD Best Practices](https://www.atlassian.com/continuous-delivery/principles)
