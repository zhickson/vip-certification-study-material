# 5.15 Rolling Back Failed Deployments - Study Notes

## Overview

Rolling back failed deployments quickly and safely minimizes downtime and prevents further issues. Understanding Git-based rollbacks, WP-CLI rollbacks, and maintaining deployment history is essential for reliable WordPress management.

**Key Reference:** [WordPress Deployment - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/deployment/)

---

## 1. Git-Based Rollbacks

### Rollback to Previous Commit

```bash
# Identify the problematic commit
git log --oneline -10

# Rollback to previous commit
git checkout <previous-commit-hash>

# Or rollback to previous tag
git checkout v1.2.2

# Create rollback branch
git checkout -b rollback-$(date +%Y%m%d) <previous-commit-hash>
```

### Rollback to Previous Tag

```bash
# List tags
git tag -l

# Checkout previous release
git checkout v1.2.2

# Deploy this version
./deploy.sh v1.2.2
```

### Revert Specific Commits

```bash
# Revert last commit (creates new commit)
git revert HEAD

# Revert specific commit
git revert <commit-hash>

# Revert merge commit
git revert -m 1 <merge-commit-hash>

# Push revert
git push origin main
```

### Complete Rollback Process

```bash
#!/bin/bash
# rollback.sh

PREVIOUS_VERSION=$1
if [ -z "$PREVIOUS_VERSION" ]; then
	echo "Usage: ./rollback.sh <version-or-commit>"
	exit 1
fi

echo "Rolling back to $PREVIOUS_VERSION..."

# 1. Backup current state
wp db export backup-before-rollback-$(date +%Y%m%d-%H%M%S).sql

# 2. Checkout previous version
git checkout "$PREVIOUS_VERSION"

# 3. Deploy previous version
./deploy.sh "$PREVIOUS_VERSION"

# 4. Verify deployment
curl -f https://example.com/health || exit 1

echo "Rollback complete!"
```

---

## 2. Rolling Back Plugins/Themes with WP-CLI

### Plugin Rollback

```bash
# List installed plugins
wp plugin list

# Rollback to previous version
wp plugin install plugin-name --version=1.2.2 --force

# Or deactivate and remove
wp plugin deactivate plugin-name
wp plugin delete plugin-name
wp plugin install plugin-name --version=1.2.2
wp plugin activate plugin-name
```

### Theme Rollback

```bash
# List installed themes
wp theme list

# Switch to previous theme
wp theme activate previous-theme

# Or rollback current theme
wp theme install theme-name --version=1.2.2 --force
```

### WordPress Core Rollback

```bash
# Rollback WordPress core
wp core download --version=6.1 --force

# Update database if needed
wp core update-db
```

### Automated Rollback Script

```bash
#!/bin/bash
# wp-rollback.sh

PLUGIN=$1
VERSION=$2

if [ -z "$PLUGIN" ] || [ -z "$VERSION" ]; then
	echo "Usage: ./wp-rollback.sh <plugin-name> <version>"
	exit 1
fi

echo "Rolling back $PLUGIN to version $VERSION..."

# Backup database
wp db export backup-$(date +%Y%m%d).sql

# Deactivate plugin
wp plugin deactivate "$PLUGIN"

# Remove current version
wp plugin delete "$PLUGIN"

# Install previous version
wp plugin install "$PLUGIN" --version="$VERSION" --force

# Activate plugin
wp plugin activate "$PLUGIN"

# Clear cache
wp cache flush

echo "Rollback complete!"
```

---

## 3. Maintaining Deployment Version History

### Version Tracking

```bash
# Store deployment history
echo "$(date): Deployed version $(git describe --tags)" >> deployment.log

# Or use Git tags
git tag -a "deploy-$(date +%Y%m%d-%H%M%S)" -m "Deployment at $(date)"

# List deployment tags
git tag -l "deploy-*"
```

### Deployment Log

```bash
#!/bin/bash
# log-deployment.sh

VERSION=$(git describe --tags)
DATE=$(date +%Y-%m-%d\ %H:%M:%S)
COMMIT=$(git rev-parse HEAD)
AUTHOR=$(git log -1 --format='%an')

echo "$DATE|$VERSION|$COMMIT|$AUTHOR" >> /var/log/deployments.log
```

### Database Version Tracking

```php
// Store version in database
update_option( 'deployment_version', '1.2.3' );
update_option( 'deployment_date', current_time( 'mysql' ) );
update_option( 'deployment_commit', 'abc123' );

// Check current version
$current_version = get_option( 'deployment_version' );
```

---

## 4. Minimizing Downtime During Rollback

### Blue-Green Rollback

```bash
# Switch to previous environment
# Current: /var/www/blue (broken)
# Previous: /var/www/green (working)

# Quick switch
ln -sfn /var/www/green /var/www/current

# Restart services
systemctl reload php-fpm
```

### Atomic Rollback

```bash
# Use symlinks for atomic rollback
/var/www/releases/
├── 20240115120000/  # Previous (working)
├── 20240115130000/  # Current (broken)
└── current -> 20240115130000

# Atomic switch
ln -sfn /var/www/releases/20240115120000 /var/www/current
```

### Health Check Before Rollback

```bash
# Verify previous version works
git checkout v1.2.2
./vendor/bin/phpunit
curl -f http://localhost/health

# If healthy, proceed with rollback
```

---

## 5. Rollback Strategies

### Immediate Rollback

```bash
# For critical issues
# 1. Identify issue
# 2. Immediately rollback
git checkout v1.2.2
./deploy.sh v1.2.2

# 3. Investigate later
```

### Partial Rollback

```bash
# Rollback specific component
# Rollback only plugin
wp plugin install plugin-name --version=1.2.2 --force

# Keep other changes
```

### Database Rollback

```bash
# If database changes caused issues
# Restore from backup
wp db import backup-20240115.sql

# Or rollback specific migration
wp db migrate --rollback
```

---

## 6. Rollback Best Practices

### Pre-Rollback Checklist

```markdown
# Rollback Checklist

- [ ] Issue identified and confirmed
- [ ] Previous version verified working
- [ ] Backup created
- [ ] Rollback plan documented
- [ ] Team notified
- [ ] Monitoring in place
```

### Post-Rollback

```bash
# After rollback
# 1. Verify site is working
curl -f https://example.com/health

# 2. Check error logs
tail -f /var/log/php-errors.log

# 3. Monitor performance
# Check response times, error rates

# 4. Document rollback
echo "$(date): Rolled back to v1.2.2 due to [reason]" >> rollback.log

# 5. Investigate root cause
# Fix issue in development
# Test thoroughly
# Plan re-deployment
```

### Rollback Communication

```markdown
# Rollback Notification Template

## Rollback Notice

**Time:** 2024-01-15 14:30 UTC
**Version:** Rolled back from 1.2.3 to 1.2.2
**Reason:** Critical bug in user authentication
**Impact:** Minimal - site restored within 5 minutes
**Next Steps:** Issue being fixed, will redeploy after testing
```

---

## 7. Automated Rollback

### CI/CD Rollback

```yaml
# .github/workflows/rollback.yml
name: Rollback

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback to'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Checkout previous version
        run: git checkout ${{ github.event.inputs.version }}

      - name: Backup database
        run: |
          ssh user@server "cd /var/www/html && wp db export backup-$(date +%Y%m%d).sql"

      - name: Deploy previous version
        run: |
          rsync -avz ./ user@server:/var/www/html/
          ssh user@server "cd /var/www/html && wp cache flush"

      - name: Health check
        run: |
          sleep 5
          curl -f https://example.com/health || exit 1
```

### Monitoring-Based Rollback

```yaml
# Auto-rollback on errors
- name: Monitor deployment
  run: |
    sleep 30
    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://example.com/)
    if [ "$RESPONSE" != "200" ]; then
      echo "Deployment failed, rolling back..."
      git checkout v1.2.2
      ./deploy.sh v1.2.2
      exit 1
    fi
```

---

## Exam Tips

### Key Points to Remember

1. **Git Rollback:**
   - Checkout previous commit/tag
   - Use `git revert` for safe rollback
   - Create rollback branch

2. **WP-CLI Rollback:**
   - Plugin: `wp plugin install --version=X --force`
   - Theme: `wp theme install --version=X --force`
   - Core: `wp core download --version=X --force`

3. **Version History:**
   - Tag deployments
   - Log deployments
   - Track in database

4. **Minimize Downtime:**
   - Use symlinks for atomic rollback
   - Blue-green deployment
   - Health checks before rollback

5. **Best Practices:**
   - Always backup before rollback
   - Verify previous version works
   - Document rollback reason
   - Investigate root cause

---

## Additional Resources

- [WordPress Deployment - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/deployment/)
- [WP-CLI Commands](https://wp-cli.org/commands/)
- [Git Revert](https://git-scm.com/docs/git-revert)
- [Rollback Strategies](https://www.digitalocean.com/community/tutorials/deployment-best-practices)
