# 5.17 Backup and Restore as Part of Deployment - Study Notes

## Overview

Backup and restore procedures are critical components of deployment workflows. Automated backups before deployment and tested restore procedures ensure quick recovery from deployment failures or data corruption.

**Key Reference:** [WordPress Backups - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/backup/)

---

## 1. Setting Up Automated File and Database Backups

### Database Backup Script

```bash
#!/bin/bash
# backup-database.sh

BACKUP_DIR="/var/backups/wordpress"
DATE=$(date +%Y%m%d-%H%M%S)
DB_NAME=$(wp config get DB_NAME)
BACKUP_FILE="$BACKUP_DIR/db-$DATE.sql"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup database
wp db export "$BACKUP_FILE"

# Compress backup
gzip "$BACKUP_FILE"

# Keep only last 30 days
find "$BACKUP_DIR" -name "db-*.sql.gz" -mtime +30 -delete

echo "Database backup created: $BACKUP_FILE.gz"
```

### File Backup Script

```bash
#!/bin/bash
# backup-files.sh

BACKUP_DIR="/var/backups/wordpress"
DATE=$(date +%Y%m%d-%H%M%S)
SITE_PATH="/var/www/html"
BACKUP_FILE="$BACKUP_DIR/files-$DATE.tar.gz"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup files (exclude cache, logs)
tar -czf "$BACKUP_FILE" \
  --exclude='wp-content/cache' \
  --exclude='wp-content/upgrade' \
  --exclude='*.log' \
  -C "$SITE_PATH" .

# Keep only last 30 days
find "$BACKUP_DIR" -name "files-*.tar.gz" -mtime +30 -delete

echo "File backup created: $BACKUP_FILE"
```

### Complete Backup Script

```bash
#!/bin/bash
# backup-complete.sh

BACKUP_DIR="/var/backups/wordpress"
DATE=$(date +%Y%m%d-%H%M%S)
SITE_PATH="/var/www/html"
BACKUP_PREFIX="$BACKUP_DIR/backup-$DATE"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup database
wp db export "$BACKUP_PREFIX-db.sql"
gzip "$BACKUP_PREFIX-db.sql"

# Backup files
tar -czf "$BACKUP_PREFIX-files.tar.gz" \
  --exclude='wp-content/cache' \
  --exclude='wp-content/upgrade' \
  --exclude='*.log' \
  -C "$SITE_PATH" .

# Create backup manifest
cat > "$BACKUP_PREFIX-manifest.txt" << EOF
Backup Date: $(date)
WordPress Version: $(wp core version)
Database: $(wp config get DB_NAME)
Site URL: $(wp option get siteurl)
EOF

echo "Complete backup created: $BACKUP_PREFIX-*"
```

### Automated Backup Schedule

```bash
# Crontab entry
# Daily backup at 2 AM
0 2 * * * /usr/local/bin/backup-complete.sh

# Or use WP-CLI cron
wp cron event schedule backup-daily $(date +%s) daily
```

---

## 2. Testing Restores in Staging Environments

### Restore Test Script

```bash
#!/bin/bash
# test-restore.sh

BACKUP_FILE=$1
STAGING_PATH="/var/www/staging"

if [ -z "$BACKUP_FILE" ]; then
	echo "Usage: ./test-restore.sh <backup-file>"
	exit 1
fi

echo "Testing restore of $BACKUP_FILE..."

# Extract backup
BACKUP_DIR=$(mktemp -d)
tar -xzf "$BACKUP_FILE" -C "$BACKUP_DIR"

# Restore database
wp db import "$BACKUP_DIR/db.sql" --url=staging.example.com

# Restore files
rsync -avz "$BACKUP_DIR/files/" "$STAGING_PATH/"

# Update URLs
wp search-replace production.example.com staging.example.com --url=staging.example.com

# Verify restore
wp core verify-checksums --url=staging.example.com
curl -f https://staging.example.com/health || exit 1

echo "Restore test successful!"
```

### Staging Restore Workflow

```bash
# 1. Create staging backup
./backup-complete.sh

# 2. Test restore on staging
./test-restore.sh /var/backups/wordpress/backup-20240115-020000.tar.gz

# 3. Verify functionality
# - Test login
# - Test content creation
# - Test plugins
# - Check error logs

# 4. Document results
echo "Restore test completed successfully" >> restore-tests.log
```

---

## 3. Restoring Partial or Full Backups

### Full Restore

```bash
#!/bin/bash
# restore-full.sh

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
	echo "Usage: ./restore-full.sh <backup-file>"
	exit 1
fi

echo "WARNING: This will overwrite current site!"
read -p "Continue? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
	echo "Restore cancelled"
	exit 1
fi

# Extract backup
BACKUP_DIR=$(mktemp -d)
tar -xzf "$BACKUP_FILE" -C "$BACKUP_DIR"

# Backup current state first
./backup-complete.sh

# Restore database
wp db import "$BACKUP_DIR/db.sql"

# Restore files
rsync -avz --delete "$BACKUP_DIR/files/" /var/www/html/

# Clear cache
wp cache flush

echo "Full restore complete!"
```

### Partial Restore - Database Only

```bash
#!/bin/bash
# restore-database.sh

DB_BACKUP=$1

if [ -z "$DB_BACKUP" ]; then
	echo "Usage: ./restore-database.sh <db-backup-file>"
	exit 1
fi

# Backup current database
wp db export backup-before-restore-$(date +%Y%m%d).sql

# Restore database
if [[ "$DB_BACKUP" == *.gz ]]; then
	gunzip -c "$DB_BACKUP" | wp db import -
else
	wp db import "$DB_BACKUP"
fi

# Update URLs if needed
# wp search-replace old-url.com new-url.com

echo "Database restore complete!"
```

### Partial Restore - Files Only

```bash
#!/bin/bash
# restore-files.sh

FILES_BACKUP=$1

if [ -z "$FILES_BACKUP" ]; then
	echo "Usage: ./restore-files.sh <files-backup>"
	exit 1
fi

# Backup current files
tar -czf backup-files-before-$(date +%Y%m%d).tar.gz /var/www/html/wp-content/

# Restore files
tar -xzf "$FILES_BACKUP" -C /var/www/html/

# Fix permissions
chown -R www-data:www-data /var/www/html/wp-content/

echo "Files restore complete!"
```

### Selective Restore

```bash
# Restore specific table
wp db import backup.sql --tables=wp_posts

# Restore specific directory
tar -xzf backup.tar.gz wp-content/uploads/

# Restore specific plugin
tar -xzf backup.tar.gz wp-content/plugins/my-plugin/
```

---

## 4. Minimizing Downtime During Restore

### Zero-Downtime Restore

```bash
#!/bin/bash
# restore-zero-downtime.sh

BACKUP_FILE=$1

# 1. Restore to temporary location
TEMP_PATH="/var/www/restore-$(date +%Y%m%d)"
mkdir -p "$TEMP_PATH"
tar -xzf "$BACKUP_FILE" -C "$TEMP_PATH"

# 2. Restore database
wp db import "$TEMP_PATH/db.sql"

# 3. Restore files to temp location
rsync -avz "$TEMP_PATH/files/" "$TEMP_PATH/"

# 4. Switch atomically
ln -sfn "$TEMP_PATH" /var/www/html-restored

# 5. Quick switch
mv /var/www/html /var/www/html-old
mv /var/www/html-restored /var/www/html

# 6. Restart services
systemctl reload php-fpm

# 7. Verify
curl -f https://example.com/health || {
	# Rollback if failed
	mv /var/www/html /var/www/html-failed
	mv /var/www/html-old /var/www/html
	systemctl reload php-fpm
	exit 1
}

echo "Zero-downtime restore complete!"
```

### Maintenance Mode During Restore

```bash
# Enable maintenance mode
wp maintenance-mode activate

# Perform restore
./restore-full.sh backup.tar.gz

# Disable maintenance mode
wp maintenance-mode deactivate
```

---

## 5. Integrating Backup Routines into Deployment Workflows

### Pre-Deployment Backup

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Backup before deployment
        run: |
          ssh user@server "cd /var/www/html && wp db export /var/backups/pre-deploy-$(date +%Y%m%d).sql"
          ssh user@server "tar -czf /var/backups/pre-deploy-$(date +%Y%m%d).tar.gz /var/www/html/wp-content/"

      - name: Deploy
        run: |
          rsync -avz ./ user@server:/var/www/html/

      - name: Health check
        run: |
          sleep 5
          curl -f https://example.com/health || {
            echo "Deployment failed, restoring backup..."
            ssh user@server "./restore-backup.sh /var/backups/pre-deploy-$(date +%Y%m%d).sql"
            exit 1
          }
```

### Automated Backup on Deployment

```bash
#!/bin/bash
# deploy-with-backup.sh

# 1. Create backup
./backup-complete.sh
BACKUP_FILE=$(ls -t /var/backups/wordpress/backup-*.tar.gz | head -1)

# 2. Deploy
./deploy.sh

# 3. Verify deployment
if ! curl -f https://example.com/health; then
	echo "Deployment failed, restoring backup..."
	./restore-full.sh "$BACKUP_FILE"
	exit 1
fi

echo "Deployment successful, backup saved: $BACKUP_FILE"
```

### Backup Retention Policy

```bash
#!/bin/bash
# cleanup-old-backups.sh

BACKUP_DIR="/var/backups/wordpress"

# Keep daily backups for 7 days
find "$BACKUP_DIR" -name "backup-*-*.tar.gz" -mtime +7 -mtime -30 -delete

# Keep weekly backups for 3 months
find "$BACKUP_DIR" -name "backup-*-*.tar.gz" -mtime +30 -mtime -90 -delete

# Keep monthly backups for 1 year
find "$BACKUP_DIR" -name "backup-*-*.tar.gz" -mtime +90 -mtime -365 -delete

# Delete backups older than 1 year
find "$BACKUP_DIR" -name "backup-*-*.tar.gz" -mtime +365 -delete
```

---

## 6. Backup Best Practices

### Backup Checklist

```markdown
# Backup Checklist

## Before Deployment
- [ ] Full backup created
- [ ] Backup verified
- [ ] Backup stored off-site
- [ ] Restore procedure tested

## Backup Contents
- [ ] Database
- [ ] wp-content directory
- [ ] wp-config.php (if custom)
- [ ] .htaccess (if custom)

## Backup Storage
- [ ] Local storage
- [ ] Remote storage (S3, etc.)
- [ ] Encrypted backups
- [ ] Access controls
```

### Backup Verification

```bash
# Verify backup integrity
tar -tzf backup.tar.gz > /dev/null && echo "Backup OK" || echo "Backup corrupted"

# Verify database backup
wp db check < backup.sql && echo "Database backup OK" || echo "Database backup corrupted"

# Test restore on staging
./test-restore.sh backup.tar.gz
```

---

## Exam Tips

### Key Points to Remember

1. **Automated Backups:**
   - Database backups
   - File backups
   - Scheduled backups
   - Retention policies

2. **Testing Restores:**
   - Test on staging
   - Verify functionality
   - Document results
   - Regular testing

3. **Restore Procedures:**
   - Full restore
   - Partial restore
   - Selective restore
   - Zero-downtime restore

4. **Deployment Integration:**
   - Pre-deployment backup
   - Post-deployment verification
   - Automatic rollback on failure
   - Backup retention

5. **Best Practices:**
   - Regular backups
   - Off-site storage
   - Encrypted backups
   - Tested restore procedures

---

## Additional Resources

- [WordPress Backups - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/backup/)
- [WP-CLI Backup Commands](https://wp-cli.org/commands/db/export/)
- [Backup Best Practices](https://wordpress.org/support/article/wordpress-backups/)
