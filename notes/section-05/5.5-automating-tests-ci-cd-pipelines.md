# 5.5 Automating Tests in CI/CD Pipelines - Study Notes

## Overview

Integrating automated testing into CI/CD pipelines ensures code quality and prevents regressions before deployment. Tests run automatically on every code change, providing fast feedback to developers.

**Key Reference:** [Continuous Integration - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/development-tools/)

---

## 1. CI/CD Pipeline Integration

### Benefits of Automated Testing

- **Early Detection:** Catch bugs before deployment
- **Consistent Testing:** Same tests run every time
- **Fast Feedback:** Developers get immediate results
- **Quality Gates:** Prevent broken code from deploying
- **Documentation:** Tests serve as living documentation

### Pipeline Stages

Typical CI/CD pipeline stages:

1. **Source:** Code is committed/pushed
2. **Build:** Dependencies installed, code compiled
3. **Test:** Automated tests run
4. **Deploy:** If tests pass, deploy to staging/production

---

## 2. Configuring Pipelines to Run Tests

### GitHub Actions

```yaml
# .github/workflows/tests.yml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: mbstring, xml, mysql, mysqli

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Setup WordPress test environment
        run: |
          bash bin/install-wp-tests.sh wordpress_test root root localhost latest

      - name: Run unit tests
        run: ./vendor/bin/phpunit --testsuite=Unit

      - name: Run integration tests
        run: ./vendor/bin/phpunit --testsuite=Integration

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
```

### GitLab CI

```yaml
# .gitlab-ci.yml
stages:
  - test

variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: wordpress_test

services:
  - mysql:8.0

test:unit:
  stage: test
  image: php:8.0
  before_script:
    - apt-get update -y
    - apt-get install -y mysql-client
    - docker-php-ext-install mysqli pdo_mysql
    - composer install
    - bash bin/install-wp-tests.sh wordpress_test root root mysql latest
  script:
    - ./vendor/bin/phpunit --testsuite=Unit
  coverage: '/Lines:\s+\d+.\d+\%/'

test:integration:
  stage: test
  image: php:8.0
  before_script:
    - apt-get update -y
    - apt-get install -y mysql-client
    - docker-php-ext-install mysqli pdo_mysql
    - composer install
    - bash bin/install-wp-tests.sh wordpress_test root root mysql latest
  script:
    - ./vendor/bin/phpunit --testsuite=Integration
```

### Jenkins Pipeline

```groovy
// Jenkinsfile
pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'composer install'
            }
        }

        stage('Setup Test Environment') {
            steps {
                sh 'bash bin/install-wp-tests.sh wordpress_test root root localhost latest'
            }
        }

        stage('Run Tests') {
            steps {
                sh './vendor/bin/phpunit'
            }
        }
    }

    post {
        always {
            junit 'tests/results/*.xml'
            publishHTML([
                reportDir: 'coverage',
                reportFiles: 'index.html',
                reportName: 'Coverage Report'
            ])
        }
        failure {
            emailext (
                subject: "Tests Failed: ${env.JOB_NAME}",
                body: "Tests failed in build ${env.BUILD_NUMBER}",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
    }
}
```

---

## 3. Ensuring Tests Run in Isolated Environments

### Database Isolation

Each test run should use a fresh database:

```bash
#!/bin/bash
# bin/install-wp-tests.sh

DB_NAME=wordpress_test
DB_USER=root
DB_PASS=root
DB_HOST=localhost
WP_VERSION=latest

# Create database
mysql -u$DB_USER -p$DB_PASS -e "DROP DATABASE IF EXISTS $DB_NAME"
mysql -u$DB_USER -p$DB_PASS -e "CREATE DATABASE $DB_NAME"

# Download WordPress test library
if [ ! -d /tmp/wordpress-tests-lib ]; then
    svn co https://develop.svn.wordpress.org/trunk/tests/phpunit/includes/ /tmp/wordpress-tests-lib/includes
    svn co https://develop.svn.wordpress.org/trunk/tests/phpunit/data/ /tmp/wordpress-tests-lib/data
fi

# Copy test configuration
cp tests/phpunit/includes/bootstrap.php /tmp/wordpress-tests-lib/
```

### Environment Variables

Use environment variables for configuration:

```yaml
# .github/workflows/tests.yml
env:
  DB_NAME: wordpress_test
  DB_USER: root
  DB_PASS: root
  DB_HOST: localhost
  WP_TESTS_DB_NAME: wordpress_test
  WP_TESTS_DB_USER: root
  WP_TESTS_DB_PASSWORD: root
  WP_TESTS_DB_HOST: localhost
```

### Docker Containers

Isolate tests in containers:

```yaml
# .github/workflows/tests.yml
services:
  mysql:
    image: mysql:8.0
    env:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: wordpress_test
    ports:
      - 3306:3306
    options: --health-cmd="mysqladmin ping" --health-interval=10s
```

---

## 4. Automating Unit and Integration Testing

### Separate Test Suites

```xml
<!-- phpunit.xml -->
<phpunit>
    <testsuites>
        <testsuite name="Unit">
            <directory>tests/phpunit/unit</directory>
        </testsuite>
        <testsuite name="Integration">
            <directory>tests/phpunit/integration</directory>
        </testsuite>
    </testsuites>
</phpunit>
```

### Running Different Test Types

```yaml
# .github/workflows/tests.yml
- name: Run unit tests
  run: ./vendor/bin/phpunit --testsuite=Unit

- name: Run integration tests
  run: ./vendor/bin/phpunit --testsuite=Integration

- name: Run all tests
  run: ./vendor/bin/phpunit
```

### Parallel Test Execution

```yaml
# Run tests in parallel for faster execution
- name: Run unit tests
  run: ./vendor/bin/phpunit --testsuite=Unit --processes=4

- name: Run integration tests
  run: ./vendor/bin/phpunit --testsuite=Integration --processes=2
```

---

## 5. Enforcing Test Coverage Requirements

### Coverage Configuration

```xml
<!-- phpunit.xml -->
<phpunit>
    <filter>
        <whitelist>
            <directory suffix=".php">includes</directory>
            <directory suffix=".php">src</directory>
        </whitelist>
    </filter>
    <logging>
        <log type="coverage-clover" target="coverage.xml"/>
        <log type="coverage-html" target="coverage/"/>
    </logging>
</phpunit>
```

### Coverage Thresholds

```yaml
# .github/workflows/tests.yml
- name: Run tests with coverage
  run: ./vendor/bin/phpunit --coverage-clover=coverage.xml

- name: Check coverage threshold
  run: |
    COVERAGE=$(php scripts/check-coverage.php)
    if [ "$COVERAGE" -lt 80 ]; then
      echo "Coverage is below 80%"
      exit 1
    fi
```

### Coverage Reporting

```yaml
# Upload coverage to service
- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v3
  with:
    files: ./coverage.xml
    flags: unittests
    name: codecov-umbrella

- name: Comment PR with coverage
  uses: py-cov-action/python-coverage-comment-action@v2
  with:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## 6. Test Execution on Push/Pull Requests

### Trigger on Push

```yaml
# .github/workflows/tests.yml
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'composer.json'
```

### Trigger on Pull Requests

```yaml
# .github/workflows/tests.yml
on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
```

### Conditional Execution

```yaml
# Only run tests if code changed
- name: Check if tests needed
  id: check
  run: |
    if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(php|js)$'; then
      echo "needs_tests=true" >> $GITHUB_OUTPUT
    fi

- name: Run tests
  if: steps.check.outputs.needs_tests == 'true'
  run: ./vendor/bin/phpunit
```

---

## 7. Best Practices

### Fast Feedback

- Run quick unit tests first
- Run slower integration tests after
- Fail fast on critical errors

### Caching

```yaml
# Cache dependencies
- name: Cache Composer dependencies
  uses: actions/cache@v3
  with:
    path: vendor
    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

- name: Cache WordPress test library
  uses: actions/cache@v3
  with:
    path: /tmp/wordpress-tests-lib
    key: wordpress-tests-${{ matrix.wp-version }}
```

### Matrix Testing

```yaml
# Test against multiple PHP/WordPress versions
strategy:
  matrix:
    php: [7.4, 8.0, 8.1, 8.2]
    wp: [latest, 6.0, 6.1]
    exclude:
      - php: 7.4
        wp: 6.2
```

### Notifications

```yaml
# Notify on failure
- name: Notify on failure
  if: failure()
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    text: 'Tests failed!'
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

---

## Exam Tips

### Key Points to Remember

1. **CI/CD Integration:**
   - Tests run automatically on push/PR
   - Fast feedback to developers
   - Quality gates prevent bad deployments

2. **Isolated Environments:**
   - Each test run uses fresh database
   - Use environment variables
   - Docker containers for isolation

3. **Test Automation:**
   - Separate unit and integration tests
   - Run tests in parallel when possible
   - Use test suites for organization

4. **Coverage Requirements:**
   - Set minimum coverage thresholds
   - Generate coverage reports
   - Track coverage over time

5. **Best Practices:**
   - Cache dependencies
   - Matrix testing for compatibility
   - Fast feedback loops
   - Notifications on failure

---

## Additional Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GitLab CI/CD Documentation](https://docs.gitlab.com/ee/ci/)
- [Jenkins Pipeline Documentation](https://www.jenkins.io/doc/book/pipeline/)
- [PHPUnit CI Integration](https://phpunit.de/manual/current/en/appendixes.ci.html)
