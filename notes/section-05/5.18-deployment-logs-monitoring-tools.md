# 5.18 Deployment Logs and Monitoring Tools - Study Notes

## Overview

Deployment logs and monitoring tools track deployments, diagnose failures, and detect regressions early. Understanding how to read logs, identify issues, and monitor post-deployment behavior is essential for reliable WordPress deployments.

**Key Reference:** [WordPress Debugging - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)

---

## 1. Reading and Interpreting Deployment Logs

### Deployment Log Format

```bash
# Deployment log entry
2024-01-15 14:30:00 | DEPLOY | v1.2.3 | abc123 | user@example.com | SUCCESS
2024-01-15 14:25:00 | DEPLOY | v1.2.2 | def456 | user@example.com | FAILED | Database migration error
```

### Log Structure

```bash
# Structured log format
TIMESTAMP | ACTION | VERSION | COMMIT | USER | STATUS | MESSAGE

# Example
2024-01-15 14:30:00 | DEPLOY | 1.2.3 | abc123 | deploy-user | SUCCESS | Deployment completed in 45s
2024-01-15 14:30:05 | HEALTH | 1.2.3 | abc123 | system | SUCCESS | Health check passed
2024-01-15 14:35:00 | MONITOR | 1.2.3 | abc123 | system | WARNING | Response time increased by 200ms
```

### Logging Deployment Events

```bash
#!/bin/bash
# log-deployment.sh

log_deployment() {
	local status=$1
	local message=$2
	local timestamp=$(date +%Y-%m-%d\ %H:%M:%S)
	local version=$(git describe --tags)
	local commit=$(git rev-parse --short HEAD)
	local user=$(whoami)

	echo "$timestamp | DEPLOY | $version | $commit | $user | $status | $message" >> /var/log/deployments.log
}

# Usage
log_deployment "SUCCESS" "Deployment completed successfully"
log_deployment "FAILED" "Database migration failed"
```

### Parsing Deployment Logs

```bash
# View recent deployments
tail -n 50 /var/log/deployments.log

# Filter failed deployments
grep "FAILED" /var/log/deployments.log

# Count deployments by status
grep -c "SUCCESS" /var/log/deployments.log
grep -c "FAILED" /var/log/deployments.log

# Find deployments by version
grep "v1.2.3" /var/log/deployments.log
```

---

## 2. Identifying and Fixing Failed Processes

### Common Deployment Failures

```bash
# Database connection failure
ERROR: Database connection failed
# Fix: Check credentials, network, database server

# File permission errors
ERROR: Permission denied: /var/www/html/wp-content/
# Fix: chown -R www-data:www-data /var/www/html/

# Memory limit exceeded
Fatal error: Allowed memory size exhausted
# Fix: Increase PHP memory_limit

# Syntax errors
Parse error: syntax error in file.php
# Fix: Check syntax, validate code

# Missing dependencies
ERROR: Class 'SomeClass' not found
# Fix: Install dependencies, check autoloader
```

### Error Log Analysis

```bash
# WordPress error log
tail -f /var/www/html/wp-content/debug.log

# PHP error log
tail -f /var/log/php-errors.log

# Web server error log
tail -f /var/log/nginx/error.log
# or
tail -f /var/log/apache2/error.log

# System log
journalctl -u php-fpm -f
```

### Deployment Failure Detection

```bash
#!/bin/bash
# detect-deployment-failure.sh

DEPLOYMENT_LOG="/var/log/deployments.log"
ERROR_THRESHOLD=5  # errors per minute

# Check error rate
ERROR_COUNT=$(tail -n 100 "$DEPLOYMENT_LOG" | grep -c "ERROR")

if [ "$ERROR_COUNT" -gt "$ERROR_THRESHOLD" ]; then
	echo "ALERT: High error rate detected: $ERROR_COUNT errors"
	# Send notification
	# Trigger rollback
	exit 1
fi
```

---

## 3. Monitoring Application Behavior Post-Deploy

### Health Checks

```php
// health-check.php
<?php
header( 'Content-Type: application/json' );

$health = array(
	'status' => 'ok',
	'timestamp' => time(),
	'checks' => array(),
);

// Database check
global $wpdb;
$db_ok = (bool) $wpdb->get_var( 'SELECT 1' );
$health['checks']['database'] = $db_ok ? 'ok' : 'error';

// Cache check
$cache_ok = wp_cache_get( 'health_check' ) !== false;
$health['checks']['cache'] = $cache_ok ? 'ok' : 'error';

// File system check
$fs_ok = is_writable( WP_CONTENT_DIR );
$health['checks']['filesystem'] = $fs_ok ? 'ok' : 'error';

// Overall status
if ( ! $db_ok || ! $cache_ok || ! $fs_ok ) {
	$health['status'] = 'error';
	http_response_code( 503 );
}

echo json_encode( $health, JSON_PRETTY_PRINT );
```

### Response Time Monitoring

```bash
#!/bin/bash
# monitor-response-time.sh

URL="https://example.com"
THRESHOLD=2.0  # seconds

RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$URL")

if (( $(echo "$RESPONSE_TIME > $THRESHOLD" | bc -l) )); then
	echo "WARNING: Response time $RESPONSE_TIME exceeds threshold $THRESHOLD"
	# Log to monitoring system
	# Send alert
fi

echo "$(date): Response time: $RESPONSE_TIME" >> /var/log/response-times.log
```

### Error Rate Monitoring

```php
// Monitor error rate
function track_error_rate() {
	$error_log = WP_CONTENT_DIR . '/debug.log';
	$errors = file( $error_log );
	$recent_errors = array_slice( $errors, -100 ); // Last 100 lines

	$error_count = 0;
	$time_window = 300; // 5 minutes
	$cutoff = time() - $time_window;

	foreach ( $recent_errors as $error ) {
		if ( preg_match( '/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/', $error, $matches ) ) {
			$error_time = strtotime( $matches[1] );
			if ( $error_time > $cutoff ) {
				$error_count++;
			}
		}
	}

	if ( $error_count > 10 ) {
		// Alert: High error rate
		error_log( "ALERT: High error rate: $error_count errors in last 5 minutes" );
	}
}
```

---

## 4. Detecting Regressions Early

### Automated Regression Testing

```yaml
# .github/workflows/post-deploy-tests.yml
name: Post-Deploy Tests

on:
  workflow_run:
    workflows: ["Deploy"]
    types:
      - completed

jobs:
  regression-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run smoke tests
        run: |
          curl -f https://example.com/
          curl -f https://example.com/wp-admin/
          curl -f https://example.com/wp-json/

      - name: Run critical path tests
        run: |
          ./vendor/bin/phpunit --testsuite=Critical

      - name: Check error logs
        run: |
          ERROR_COUNT=$(ssh user@server "tail -n 100 /var/log/errors.log | grep -c ERROR")
          if [ "$ERROR_COUNT" -gt 5 ]; then
            echo "High error count detected: $ERROR_COUNT"
            exit 1
          fi
```

### Performance Regression Detection

```bash
#!/bin/bash
# detect-performance-regression.sh

BASELINE_RESPONSE_TIME=1.5  # seconds
CURRENT_RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://example.com/)

PERFORMANCE_DEGRADATION=$(echo "$CURRENT_RESPONSE_TIME - $BASELINE_RESPONSE_TIME" | bc)

if (( $(echo "$PERFORMANCE_DEGRADATION > 0.5" | bc -l) )); then
	echo "ALERT: Performance regression detected"
	echo "Baseline: $BASELINE_RESPONSE_TIME, Current: $CURRENT_RESPONSE_TIME"
	echo "Degradation: $PERFORMANCE_DEGRADATION seconds"
	# Trigger investigation
	exit 1
fi
```

### Functional Regression Detection

```php
// Automated functional tests
function test_critical_functionality() {
	$tests = array(
		'user_login' => test_user_login(),
		'content_creation' => test_content_creation(),
		'search' => test_search(),
		'api_endpoints' => test_api_endpoints(),
	);

	$failures = array();
	foreach ( $tests as $test_name => $result ) {
		if ( ! $result ) {
			$failures[] = $test_name;
		}
	}

	if ( ! empty( $failures ) ) {
		error_log( 'REGRESSION: Failed tests: ' . implode( ', ', $failures ) );
		return false;
	}

	return true;
}
```

---

## 5. Monitoring Tools

### Application Performance Monitoring (APM)

```php
// New Relic integration
if ( function_exists( 'newrelic_set_appname' ) ) {
	newrelic_set_appname( 'WordPress Site' );
}

// Custom metrics
newrelic_custom_metric( 'WordPress/PageLoad', $page_load_time );
newrelic_custom_metric( 'WordPress/QueryCount', $query_count );
```

### Log Aggregation

```bash
# Send logs to centralized system
# Using rsyslog
*.* @@log-server.example.com:514

# Using logstash
input {
	file {
		path => "/var/log/deployments.log"
		type => "deployment"
	}
}

output {
	elasticsearch {
		hosts => ["elasticsearch:9200"]
	}
}
```

### Real-Time Monitoring

```bash
# Watch deployment logs in real-time
tail -f /var/log/deployments.log | grep --color=always "ERROR\|FAILED\|SUCCESS"

# Monitor multiple logs
multitail /var/log/deployments.log /var/log/php-errors.log /var/log/nginx/error.log
```

---

## 6. Alerting and Notifications

### Deployment Alerts

```bash
#!/bin/bash
# send-deployment-alert.sh

STATUS=$1
MESSAGE=$2

# Send to Slack
curl -X POST -H 'Content-type: application/json' \
  --data "{\"text\":\"Deployment $STATUS: $MESSAGE\"}" \
  "$SLACK_WEBHOOK_URL"

# Send email
echo "$MESSAGE" | mail -s "Deployment $STATUS" admin@example.com

# Send SMS (using Twilio, etc.)
# curl -X POST ... (SMS API call)
```

### Error Alerts

```php
// Alert on high error rate
function alert_on_errors() {
	$error_count = get_transient( 'error_count' );
	if ( $error_count > 10 ) {
		wp_mail(
			'admin@example.com',
			'High Error Rate Alert',
			"Error count: $error_count in the last 5 minutes"
		);
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Deployment Logs:**
   - Structured format
   - Timestamp, version, status
   - Parse and analyze logs
   - Track deployment history

2. **Identifying Failures:**
   - Common error patterns
   - Log analysis
   - Error rate monitoring
   - Failure detection

3. **Post-Deploy Monitoring:**
   - Health checks
   - Response time monitoring
   - Error rate tracking
   - Performance metrics

4. **Regression Detection:**
   - Automated testing
   - Performance baselines
   - Functional tests
   - Early detection

5. **Monitoring Tools:**
   - APM tools
   - Log aggregation
   - Real-time monitoring
   - Alerting systems

---

## Additional Resources

- [WordPress Debugging - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)
- [Log Management Best Practices](https://www.elastic.co/guide/en/elasticsearch/reference/current/logging.html)
- [Application Monitoring](https://www.newrelic.com/)
