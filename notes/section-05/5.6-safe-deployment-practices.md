# 5.6 Safe Deployment Practices - Study Notes

## Overview

Safe deployment practices ensure WordPress updates are deployed reliably, securely, and with minimal downtime. Following these practices prevents data loss, security breaches, and service interruptions.

**Key Reference:** [WordPress Deployment - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/deployment/)

---

## 1. Atomic Deployments

### What is Atomic Deployment?

Atomic deployment means the entire deployment succeeds or fails as a single unit. There's no partial state where some files are updated and others are not.

### Benefits

- **Consistency:** All files updated together
- **Rollback:** Easy to revert entire deployment
- **No Partial State:** Avoids broken intermediate states

### Implementation

```bash
#!/bin/bash
# deploy.sh - Atomic deployment script

# Create new release directory
RELEASE_DIR="/var/www/releases/$(date +%Y%m%d%H%M%S)"
mkdir -p "$RELEASE_DIR"

# Clone/copy code to release directory
git clone https://github.com/user/repo.git "$RELEASE_DIR"

# Install dependencies
cd "$RELEASE_DIR"
composer install --no-dev --optimize-autoloader

# Run database migrations
wp db migrate --path="$RELEASE_DIR"

# Create symlink atomically
ln -sfn "$RELEASE_DIR" /var/www/current

# Restart services if needed
systemctl reload php-fpm
```

### Symlink Pattern

```bash
# Directory structure
/var/www/
├── releases/
│   ├── 20240115120000/
│   ├── 20240115130000/
│   └── 20240115140000/
└── current -> releases/20240115140000/

# Atomic switch
ln -sfn /var/www/releases/20240115140000 /var/www/current
```

---

## 2. Zero-Downtime Deployments

### Blue-Green Deployment

Deploy to a separate environment, then switch traffic:

```bash
# Blue environment (current)
/var/www/blue/

# Green environment (new)
/var/www/green/

# Switch traffic
ln -sfn /var/www/green /var/www/current
```

### Rolling Deployments

Update servers one at a time:

```bash
# Update server 1
ssh server1 "cd /var/www && git pull && wp cache flush"

# Wait for health check
curl -f https://server1.example.com/health || exit 1

# Update server 2
ssh server2 "cd /var/www && git pull && wp cache flush"
```

### Health Checks

```php
// health-check.php
<?php
// Simple health check endpoint
header( 'Content-Type: application/json' );

$health = array(
	'status' => 'ok',
	'timestamp' => time(),
	'database' => check_database(),
	'cache' => check_cache(),
);

if ( $health['database'] && $health['cache'] ) {
	http_response_code( 200 );
} else {
	http_response_code( 503 );
	$health['status'] = 'error';
}

echo json_encode( $health );

function check_database() {
	global $wpdb;
	return (bool) $wpdb->get_var( 'SELECT 1' );
}

function check_cache() {
	return wp_cache_get( 'health_check' ) !== false;
}
```

---

## 3. Separating Configuration from Code

### Environment Variables

```php
// wp-config.php
define( 'DB_NAME', getenv( 'DB_NAME' ) ?: 'wordpress' );
define( 'DB_USER', getenv( 'DB_USER' ) ?: 'root' );
define( 'DB_PASSWORD', getenv( 'DB_PASSWORD' ) ?: '' );
define( 'DB_HOST', getenv( 'DB_HOST' ) ?: 'localhost' );

define( 'WP_DEBUG', getenv( 'WP_DEBUG' ) === 'true' );
define( 'WP_DEBUG_LOG', getenv( 'WP_DEBUG_LOG' ) === 'true' );
```

### Configuration Files

```bash
# .env.production
DB_NAME=production_db
DB_USER=wp_user
DB_PASSWORD=secure_password
DB_HOST=db.example.com
WP_DEBUG=false

# .env.staging
DB_NAME=staging_db
DB_USER=wp_user
DB_PASSWORD=staging_password
DB_HOST=staging-db.example.com
WP_DEBUG=true
```

### Secrets Management

```yaml
# Use secrets in CI/CD
- name: Deploy
  env:
    DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    API_KEY: ${{ secrets.API_KEY }}
  run: |
    echo "DB_PASSWORD=$DB_PASSWORD" >> .env
    echo "API_KEY=$API_KEY" >> .env
```

---

## 4. Repeatable Deployments

### Version Control

All code changes tracked in Git:

```bash
# Tag releases
git tag -a v1.2.3 -m "Release version 1.2.3"
git push origin v1.2.3

# Deploy specific version
git checkout v1.2.3
```

### Deployment Scripts

Automated, repeatable deployment:

```bash
#!/bin/bash
# deploy.sh

set -e  # Exit on error

VERSION=$1
if [ -z "$VERSION" ]; then
	echo "Usage: ./deploy.sh <version>"
	exit 1
fi

# Checkout version
git fetch --tags
git checkout "$VERSION"

# Install dependencies
composer install --no-dev --optimize-autoloader

# Run migrations
wp db migrate

# Clear cache
wp cache flush

# Restart services
systemctl reload php-fpm
```

### Database Migrations

Version-controlled database changes:

```php
// migrations/001_add_custom_table.php
function migration_001_add_custom_table() {
	global $wpdb;

	$table_name = $wpdb->prefix . 'custom_data';

	$charset_collate = $wpdb->get_charset_collate();

	$sql = "CREATE TABLE $table_name (
		id bigint(20) NOT NULL AUTO_INCREMENT,
		data text NOT NULL,
		created_at datetime DEFAULT CURRENT_TIMESTAMP,
		PRIMARY KEY (id)
	) $charset_collate;";

	require_once ABSPATH . 'wp-admin/includes/upgrade.php';
	dbDelta( $sql );

	update_option( 'db_version', '001' );
}
```

---

## 5. Reversible Deployments

### Git-Based Rollback

```bash
# Rollback to previous version
PREVIOUS_VERSION=$(git describe --tags --abbrev=0 HEAD^)
git checkout "$PREVIOUS_VERSION"
./deploy.sh "$PREVIOUS_VERSION"
```

### Database Rollback

```php
// Keep migration history
function rollback_migration( $version ) {
	$migrations = get_option( 'db_migrations', array() );

	if ( isset( $migrations[ $version ] ) ) {
		// Execute rollback SQL
		global $wpdb;
		$wpdb->query( $migrations[ $version ]['rollback_sql'] );

		// Remove from history
		unset( $migrations[ $version ] );
		update_option( 'db_migrations', $migrations );
	}
}
```

### File Rollback

```bash
# Keep previous releases
/var/www/releases/
├── 20240115120000/  # Previous
├── 20240115130000/  # Current
└── current -> 20240115130000/

# Quick rollback
ln -sfn /var/www/releases/20240115120000 /var/www/current
```

---

## 6. Minimizing Downtime

### Maintenance Mode

```php
// Enable maintenance mode during deployment
function enable_maintenance_mode() {
	$file = ABSPATH . '.maintenance';
	file_put_contents( $file, '<?php $upgrading = ' . time() . ';' );
}

function disable_maintenance_mode() {
	$file = ABSPATH . '.maintenance';
	if ( file_exists( $file ) ) {
		unlink( $file );
	}
}
```

### Deployment Windows

- Schedule during low-traffic periods
- Notify users in advance
- Use maintenance mode page

### Staged Rollouts

```bash
# Deploy to 10% of servers first
for server in server1; do
	ssh "$server" "./deploy.sh"
done

# Monitor for issues
sleep 300

# Deploy to remaining servers
for server in server2 server3 server4; do
	ssh "$server" "./deploy.sh"
done
```

---

## 7. Best Practices

### Pre-Deployment Checklist

- [ ] All tests passing
- [ ] Code reviewed and approved
- [ ] Database backup created
- [ ] Configuration verified
- [ ] Rollback plan prepared
- [ ] Team notified

### Deployment Process

1. **Backup:** Create full backup
2. **Test:** Run tests in staging
3. **Deploy:** Execute deployment
4. **Verify:** Check health endpoints
5. **Monitor:** Watch for errors
6. **Rollback:** If issues, revert immediately

### Post-Deployment

- Monitor error logs
- Check performance metrics
- Verify functionality
- Update documentation
- Communicate success/failure

---

## Exam Tips

### Key Points to Remember

1. **Atomic Deployments:**
   - All files updated together
   - Use symlinks for atomic switching
   - Easy rollback

2. **Zero-Downtime:**
   - Blue-green deployments
   - Rolling deployments
   - Health checks

3. **Configuration:**
   - Separate from code
   - Use environment variables
   - Secure secrets management

4. **Repeatable:**
   - Version control everything
   - Automated scripts
   - Database migrations

5. **Reversible:**
   - Git-based rollback
   - Keep previous releases
   - Database rollback scripts

6. **Minimize Downtime:**
   - Maintenance mode
   - Deployment windows
   - Staged rollouts

---

## Additional Resources

- [WordPress Deployment - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/deployment/)
- [Deployment Best Practices](https://www.digitalocean.com/community/tutorials/deployment-best-practices)
- [Zero-Downtime Deployments](https://martinfowler.com/bliki/BlueGreenDeployment.html)
