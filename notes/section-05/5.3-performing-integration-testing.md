# 5.3 Performing Integration Testing - Study Notes

## Overview

Integration testing validates that multiple components work together correctly in a real WordPress environment. Unlike unit tests, integration tests use actual WordPress functionality, database, and hooks.

**Key Reference:** [WordPress Test Library](https://make.wordpress.org/core/handbook/testing/automated-testing/phpunit/)

---

## 1. Integration Testing in WordPress

### What Integration Tests Cover

- **Database Operations:** CRUD operations, queries, transactions
- **Hook Interactions:** Actions and filters working together
- **Plugin Interactions:** Multiple plugins working together
- **Theme Integration:** Theme functionality with plugins
- **API Integration:** REST API, AJAX endpoints
- **WordPress Core Integration:** Custom code with core functionality

### Difference from Unit Tests

| Aspect | Unit Tests | Integration Tests |
|--------|------------|-------------------|
| **Environment** | Isolated | Real WordPress |
| **Database** | Mocked | Test database |
| **Dependencies** | Mocked | Real dependencies |
| **Speed** | Fast | Slower |
| **Scope** | Single component | Multiple components |

---

## 2. Using WP_UnitTestCase

### Basic Structure

```php
// tests/integration/class-post-meta-test.php
class Post_Meta_Integration_Test extends WP_UnitTestCase {

	public function setUp(): void {
		parent::setUp();
		// Set up test data
	}

	public function tearDown(): void {
		// Clean up
		parent::tearDown();
	}

	public function test_post_meta_operations() {
		// Test with real WordPress functions
	}
}
```

### Test Factory

WordPress provides a factory for creating test data:

```php
class Post_Factory_Test extends WP_UnitTestCase {

	public function test_create_post() {
		$post_id = self::factory()->post->create( array(
			'post_title' => 'Test Post',
			'post_content' => 'Test content',
			'post_status' => 'publish',
		) );

		$this->assertIsInt( $post_id );
		$this->assertGreaterThan( 0, $post_id );

		$post = get_post( $post_id );
		$this->assertEquals( 'Test Post', $post->post_title );
	}

	public function test_create_user() {
		$user_id = self::factory()->user->create( array(
			'user_login' => 'testuser',
			'user_email' => 'test@example.com',
			'role' => 'subscriber',
		) );

		$user = get_userdata( $user_id );
		$this->assertEquals( 'testuser', $user->user_login );
	}

	public function test_create_term() {
		$term_id = self::factory()->term->create( array(
			'taxonomy' => 'category',
			'name' => 'Test Category',
		) );

		$term = get_term( $term_id );
		$this->assertEquals( 'Test Category', $term->name );
	}
}
```

---

## 3. Testing Database Operations

### Post Meta Operations

```php
class Post_Meta_Test extends WP_UnitTestCase {

	public function test_update_post_meta_creates_entry() {
		$post_id = self::factory()->post->create();

		update_post_meta( $post_id, 'custom_field', 'test_value' );

		$value = get_post_meta( $post_id, 'custom_field', true );
		$this->assertEquals( 'test_value', $value );
	}

	public function test_delete_post_meta_removes_entry() {
		$post_id = self::factory()->post->create();
		update_post_meta( $post_id, 'custom_field', 'test_value' );

		delete_post_meta( $post_id, 'custom_field' );

		$value = get_post_meta( $post_id, 'custom_field', true );
		$this->assertEquals( '', $value );
	}

	public function test_get_post_meta_returns_array_when_single_false() {
		$post_id = self::factory()->post->create();
		update_post_meta( $post_id, 'multi_field', 'value1' );
		update_post_meta( $post_id, 'multi_field', 'value2' );

		$values = get_post_meta( $post_id, 'multi_field', false );
		$this->assertIsArray( $values );
		$this->assertCount( 2, $values );
	}
}
```

### Options API

```php
class Options_Test extends WP_UnitTestCase {

	public function test_update_option_stores_value() {
		update_option( 'test_option', 'test_value' );

		$value = get_option( 'test_option' );
		$this->assertEquals( 'test_value', $value );
	}

	public function test_delete_option_removes_value() {
		update_option( 'test_option', 'test_value' );
		delete_option( 'test_option' );

		$value = get_option( 'test_option' );
		$this->assertFalse( $value );
	}
}
```

### Custom Queries

```php
class WP_Query_Test extends WP_UnitTestCase {

	public function test_custom_query_returns_posts() {
		$post_ids = self::factory()->post->create_many( 5, array(
			'post_status' => 'publish',
		) );

		$query = new WP_Query( array(
			'post_type' => 'post',
			'posts_per_page' => 10,
		) );

		$this->assertCount( 5, $query->posts );
	}

	public function test_meta_query_filters_posts() {
		$post1 = self::factory()->post->create();
		$post2 = self::factory()->post->create();

		update_post_meta( $post1, 'featured', 'yes' );
		update_post_meta( $post2, 'featured', 'no' );

		$query = new WP_Query( array(
			'meta_key' => 'featured',
			'meta_value' => 'yes',
		) );

		$this->assertCount( 1, $query->posts );
		$this->assertEquals( $post1, $query->posts[0]->ID );
	}
}
```

---

## 4. Testing Hook Interactions

### Action Hooks

```php
class Action_Hook_Test extends WP_UnitTestCase {

	public function test_save_post_action_fires() {
		$fired = false;
		$post_id_captured = null;

		add_action( 'save_post', function( $post_id ) use ( &$fired, &$post_id_captured ) {
			$fired = true;
			$post_id_captured = $post_id;
		}, 10, 1 );

		$post_id = self::factory()->post->create();

		$this->assertTrue( $fired );
		$this->assertEquals( $post_id, $post_id_captured );
	}

	public function test_multiple_actions_execute_in_order() {
		$execution_order = array();

		add_action( 'my_action', function() use ( &$execution_order ) {
			$execution_order[] = 'first';
		}, 10 );

		add_action( 'my_action', function() use ( &$execution_order ) {
			$execution_order[] = 'second';
		}, 20 );

		do_action( 'my_action' );

		$this->assertEquals( array( 'first', 'second' ), $execution_order );
	}
}
```

### Filter Hooks

```php
class Filter_Hook_Test extends WP_UnitTestCase {

	public function test_filter_modifies_value() {
		add_filter( 'the_content', function( $content ) {
			return $content . ' [Modified]';
		} );

		$post_id = self::factory()->post->create( array(
			'post_content' => 'Original content',
		) );

		$post = get_post( $post_id );
		$content = apply_filters( 'the_content', $post->post_content );

		$this->assertStringContainsString( '[Modified]', $content );
	}

	public function test_multiple_filters_chain() {
		add_filter( 'my_filter', function( $value ) {
			return $value . '_first';
		} );

		add_filter( 'my_filter', function( $value ) {
			return $value . '_second';
		} );

		$result = apply_filters( 'my_filter', 'original' );

		$this->assertEquals( 'original_first_second', $result );
	}
}
```

---

## 5. Testing Plugin Interactions

### Multiple Plugins

```php
class Plugin_Interaction_Test extends WP_UnitTestCase {

	public function test_plugin_a_and_b_work_together() {
		// Simulate Plugin A functionality
		add_action( 'plugin_a_save', function( $data ) {
			update_option( 'plugin_a_data', $data );
		} );

		// Simulate Plugin B hooking into Plugin A
		add_action( 'plugin_a_save', function( $data ) {
			$existing = get_option( 'plugin_b_data', array() );
			$existing[] = $data;
			update_option( 'plugin_b_data', $existing );
		}, 20 );

		do_action( 'plugin_a_save', 'test_data' );

		$this->assertEquals( 'test_data', get_option( 'plugin_a_data' ) );
		$this->assertContains( 'test_data', get_option( 'plugin_b_data' ) );
	}
}
```

### Custom Post Types

```php
class CPT_Integration_Test extends WP_UnitTestCase {

	public function setUp(): void {
		parent::setUp();

		register_post_type( 'product', array(
			'public' => true,
			'has_archive' => true,
		) );
	}

	public function test_custom_post_type_registration() {
		$post_types = get_post_types();
		$this->assertContains( 'product', $post_types );
	}

	public function test_create_custom_post_type() {
		$product_id = self::factory()->post->create( array(
			'post_type' => 'product',
			'post_title' => 'Test Product',
		) );

		$product = get_post( $product_id );
		$this->assertEquals( 'product', $product->post_type );
	}
}
```

---

## 6. Testing REST API Endpoints

### Custom REST Routes

```php
class REST_API_Test extends WP_UnitTestCase {

	public function setUp(): void {
		parent::setUp();

		// Register custom REST route
		add_action( 'rest_api_init', function() {
			register_rest_route( 'myplugin/v1', '/test', array(
				'methods' => 'GET',
				'callback' => function( $request ) {
					return new WP_REST_Response( array( 'message' => 'Success' ), 200 );
				},
				'permission_callback' => '__return_true',
			) );
		} );

		do_action( 'rest_api_init' );
	}

	public function test_rest_endpoint_returns_data() {
		$request = new WP_REST_Request( 'GET', '/myplugin/v1/test' );
		$response = rest_do_request( $request );

		$this->assertEquals( 200, $response->get_status() );
		$data = $response->get_data();
		$this->assertEquals( 'Success', $data['message'] );
	}
}
```

---

## 7. Isolating Integration Concerns

### Test Isolation

Each test should be independent:

```php
class Isolated_Integration_Test extends WP_UnitTestCase {

	private $test_post_id;

	public function setUp(): void {
		parent::setUp();
		// Each test gets fresh data
		$this->test_post_id = self::factory()->post->create();
	}

	public function tearDown(): void {
		// Clean up
		wp_delete_post( $this->test_post_id, true );
		parent::tearDown();
	}

	public function test_one() {
		// Uses $this->test_post_id
		$this->assertIsInt( $this->test_post_id );
	}

	public function test_two() {
		// Also uses $this->test_post_id, but it's a fresh instance
		$this->assertIsInt( $this->test_post_id );
	}
}
```

### Cleaning Up Hooks

```php
class Hook_Cleanup_Test extends WP_UnitTestCase {

	public function tearDown(): void {
		// Remove hooks added during tests
		remove_all_actions( 'my_custom_action' );
		remove_all_filters( 'my_custom_filter' );

		parent::tearDown();
	}
}
```

---

## 8. Validating Real-World Behaviour

### End-to-End Scenarios

```php
class E2E_Scenario_Test extends WP_UnitTestCase {

	public function test_user_registration_workflow() {
		// 1. Create user
		$user_id = self::factory()->user->create( array(
			'user_email' => 'newuser@example.com',
		) );

		// 2. User logs in
		wp_set_current_user( $user_id );

		// 3. User creates post
		$post_id = self::factory()->post->create( array(
			'post_author' => $user_id,
			'post_status' => 'draft',
		) );

		// 4. Verify post belongs to user
		$post = get_post( $post_id );
		$this->assertEquals( $user_id, $post->post_author );

		// 5. User publishes post
		wp_update_post( array(
			'ID' => $post_id,
			'post_status' => 'publish',
		) );

		// 6. Verify post is published
		$updated_post = get_post( $post_id );
		$this->assertEquals( 'publish', $updated_post->post_status );
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Integration vs Unit:**
   - Integration tests use real WordPress environment
   - Unit tests mock dependencies
   - Integration tests are slower but more realistic

2. **WP_UnitTestCase:**
   - Extend `WP_UnitTestCase` for integration tests
   - Use `self::factory()` to create test data
   - Database is reset between tests

3. **Testing Areas:**
   - Database operations (post meta, options, queries)
   - Hook interactions (actions and filters)
   - Plugin/theme interactions
   - REST API endpoints
   - Custom post types and taxonomies

4. **Isolation:**
   - Each test should be independent
   - Clean up in `tearDown()`
   - Remove hooks after tests

5. **Real-World Validation:**
   - Test complete workflows
   - Verify component interactions
   - Test edge cases with real data

---

## Additional Resources

- [WordPress Test Library](https://make.wordpress.org/core/handbook/testing/automated-testing/phpunit/)
- [WP_UnitTestCase Reference](https://make.wordpress.org/core/handbook/testing/automated-testing/phpunit/test-doubles/)
- [Testing Best Practices](https://make.wordpress.org/core/handbook/testing/automated-testing/best-practices/)
