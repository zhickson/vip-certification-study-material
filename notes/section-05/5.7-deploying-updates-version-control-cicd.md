# 5.7 Deploying Updates with Version Control and CI/CD - Study Notes

## Overview

Integrating Git workflows with automated CI/CD pipelines enables reliable, automated WordPress deployments. This ensures consistent deployments and reduces manual errors.

**Key Reference:** [Git Workflows - Git Documentation](https://git-scm.com/doc)

---

## 1. Integrating Git with Deployment Tools

### Git-Based Deployment

```bash
#!/bin/bash
# deploy-from-git.sh

REPO_URL="https://github.com/user/wordpress-site.git"
DEPLOY_PATH="/var/www/html"
BRANCH="main"

# Pull latest changes
cd "$DEPLOY_PATH"
git fetch origin
git checkout "$BRANCH"
git pull origin "$BRANCH"

# Install/update dependencies
composer install --no-dev --optimize-autoloader

# Run WordPress updates
wp core update-db
wp plugin update --all
wp theme update --all

# Clear cache
wp cache flush
```

### Deployment Hooks

```bash
# .git/hooks/post-receive (on server)
#!/bin/bash
while read oldrev newrev refname; do
	branch=$(git rev-parse --symbolic --abbrev-ref $refname)
	if [ "$branch" = "main" ]; then
		cd /var/www/html
		git pull origin main
		composer install --no-dev
		wp cache flush
	fi
done
```

---

## 2. Triggering Builds on Branches/Tags

### GitHub Actions - Branch-Based

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches:
      - main      # Deploy to production
      - develop   # Deploy to staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to staging
        if: github.ref == 'refs/heads/develop'
        run: |
          rsync -avz --exclude='.git' ./ user@staging:/var/www/html/
          ssh user@staging "cd /var/www/html && wp cache flush"

      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        run: |
          rsync -avz --exclude='.git' ./ user@production:/var/www/html/
          ssh user@production "cd /var/www/html && wp cache flush"
```

### Tag-Based Deployment

```yaml
# .github/workflows/deploy.yml
on:
  push:
    tags:
      - 'v*'  # Deploy on version tags

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Deploy version
        run: |
          echo "Deploying version ${{ steps.version.outputs.VERSION }}"
          # Deployment commands
```

### GitLab CI - Branch Strategy

```yaml
# .gitlab-ci.yml
stages:
  - deploy

deploy:staging:
  stage: deploy
  only:
    - develop
  script:
    - rsync -avz ./ user@staging:/var/www/html/
    - ssh user@staging "cd /var/www/html && wp cache flush"

deploy:production:
  stage: deploy
  only:
    - main
  when: manual
  script:
    - rsync -avz ./ user@production:/var/www/html/
    - ssh user@production "cd /var/www/html && wp cache flush"
```

---

## 3. Managing Secrets and Environment Variables

### GitHub Secrets

```yaml
# .github/workflows/deploy.yml
- name: Deploy
  env:
    DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    API_KEY: ${{ secrets.API_KEY }}
    SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  run: |
    echo "$SSH_KEY" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    rsync -avz -e ssh ./ user@server:/var/www/html/
```

### Environment-Specific Configuration

```bash
# deploy.sh
ENVIRONMENT=$1

case $ENVIRONMENT in
  staging)
    DB_HOST="staging-db.example.com"
    DB_NAME="staging_db"
    ;;
  production)
    DB_HOST="prod-db.example.com"
    DB_NAME="production_db"
    ;;
esac

# Update wp-config.php
sed -i "s/DB_HOST.*/define('DB_HOST', '$DB_HOST');/" wp-config.php
sed -i "s/DB_NAME.*/define('DB_NAME', '$DB_NAME');/" wp-config.php
```

### Secure Secret Storage

```yaml
# Use secret management services
- name: Get secrets from Vault
  uses: hashicorp/vault-action@v2
  with:
    url: https://vault.example.com
    method: approle
    roleId: ${{ secrets.VAULT_ROLE_ID }}
    secretId: ${{ secrets.VAULT_SECRET_ID }}
    secrets: |
      secret/data/wordpress DB_PASSWORD;
      secret/data/wordpress API_KEY;
```

---

## 4. Automating WordPress Updates with CI/CD

### Core Updates

```yaml
# .github/workflows/update-wordpress.yml
name: Update WordPress

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday
  workflow_dispatch:  # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup WP-CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp

      - name: Update WordPress core
        run: |
          ssh user@server "cd /var/www/html && wp core update"
          ssh user@server "cd /var/www/html && wp core update-db"
```

### Plugin Updates

```yaml
- name: Update plugins
  run: |
    ssh user@server "cd /var/www/html && wp plugin update --all --dry-run"
    # Review output, then:
    ssh user@server "cd /var/www/html && wp plugin update --all"
```

### Theme Updates

```yaml
- name: Update themes
  run: |
    ssh user@server "cd /var/www/html && wp theme update --all"
```

### Automated Update Workflow

```yaml
# .github/workflows/auto-update.yml
name: Auto Update

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for updates
        id: check
        run: |
          UPDATES=$(ssh user@server "cd /var/www/html && wp core check-update --format=count")
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Create backup
        if: steps.check.outputs.updates > 0
        run: |
          ssh user@server "cd /var/www/html && wp db export backup-$(date +%Y%m%d).sql"

      - name: Apply updates
        if: steps.check.outputs.updates > 0
        run: |
          ssh user@server "cd /var/www/html && wp core update"
          ssh user@server "cd /var/www/html && wp plugin update --all"
          ssh user@server "cd /var/www/html && wp theme update --all"

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'WordPress update failed!'
```

---

## 5. Git Workflow Integration

### Feature Branch Workflow

```bash
# Create feature branch
git checkout -b feature/new-feature

# Make changes and commit
git add .
git commit -m "Add new feature"

# Push to remote
git push origin feature/new-feature

# Create pull request
# After merge, CI/CD deploys to staging
```

### Release Workflow

```bash
# Create release branch
git checkout -b release/1.2.0

# Final testing and fixes
git commit -m "Fix bug in release"

# Tag release
git tag -a v1.2.0 -m "Release version 1.2.0"
git push origin v1.2.0

# CI/CD deploys to production
```

### Hotfix Workflow

```bash
# Create hotfix from main
git checkout -b hotfix/critical-bug main

# Fix and commit
git commit -m "Fix critical bug"

# Tag and merge
git tag -a v1.2.1 -m "Hotfix version 1.2.1"
git checkout main
git merge hotfix/critical-bug
git push origin main --tags

# CI/CD deploys immediately
```

---

## 6. Deployment Scripts

### Comprehensive Deployment Script

```bash
#!/bin/bash
# deploy.sh

set -e  # Exit on error

ENVIRONMENT=$1
BRANCH=$2

if [ -z "$ENVIRONMENT" ] || [ -z "$BRANCH" ]; then
	echo "Usage: ./deploy.sh <environment> <branch>"
	exit 1
fi

# Configuration
case $ENVIRONMENT in
	staging)
		DEPLOY_PATH="/var/www/staging"
		DB_NAME="staging_db"
		;;
	production)
		DEPLOY_PATH="/var/www/production"
		DB_NAME="production_db"
		;;
	*)
		echo "Invalid environment"
		exit 1
		;;
esac

# Clone/update repository
if [ -d "$DEPLOY_PATH" ]; then
	cd "$DEPLOY_PATH"
	git fetch origin
	git checkout "$BRANCH"
	git pull origin "$BRANCH"
else
	git clone -b "$BRANCH" https://github.com/user/repo.git "$DEPLOY_PATH"
	cd "$DEPLOY_PATH"
fi

# Install dependencies
composer install --no-dev --optimize-autoloader

# Update WordPress
wp core update-db --path="$DEPLOY_PATH"

# Clear cache
wp cache flush --path="$DEPLOY_PATH"

# Run health check
curl -f https://$ENVIRONMENT.example.com/health || exit 1

echo "Deployment successful!"
```

---

## Exam Tips

### Key Points to Remember

1. **Git Integration:**
   - Use Git for version control
   - Deploy from specific branches/tags
   - Use hooks for automation

2. **CI/CD Triggers:**
   - Branch-based deployments
   - Tag-based releases
   - Manual triggers for production

3. **Secrets Management:**
   - Use CI/CD secret storage
   - Never commit secrets
   - Rotate secrets regularly

4. **WordPress Updates:**
   - Automate core updates
   - Automate plugin/theme updates
   - Create backups before updates

5. **Workflows:**
   - Feature branches → staging
   - Release tags → production
   - Hotfixes for urgent fixes

---

## Additional Resources

- [Git Workflows - Git Documentation](https://git-scm.com/doc)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GitLab CI/CD Documentation](https://docs.gitlab.com/ee/ci/)
- [WP-CLI Commands](https://wp-cli.org/commands/)
