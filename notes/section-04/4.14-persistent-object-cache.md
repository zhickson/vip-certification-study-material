# 4.14 Persistent Object Cache - Study Notes

## Overview

Persistent object caching stores WordPress object cache data in memory (Redis, Memcached) instead of only in-process memory. Understanding the role of persistent caching and how to implement it is crucial for high-performance WordPress sites.

**Key Reference:** [Object Cache - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_object_cache/)

---

## 1. Differentiating Persistent and Non-Persistent Caching

### Non-Persistent Cache (Default)

**WordPress Default:**
- In-process memory only
- Lost on each request
- No sharing between processes
- Limited to single PHP process

**Core Implementation:**
```1:99:wordpress/wp-includes/class-wp-object-cache.php
<?php
/**
 * Object Cache API: WP_Object_Cache class
 *
 * @package WordPress
 * @subpackage Cache
 * @since 5.4.0
 */

/**
 * Core class that implements an object cache.
 *
 * The WordPress Object Cache is used to save on trips to the database. The
 * Object Cache stores all of the cache data to memory and makes the cache
 * contents available by using a key, which is used to name and later retrieve
 * the cache contents.
 *
 * The Object Cache can be replaced by other caching mechanisms by placing files
 * in the wp-content folder which is looked at in wp-settings. If that file
 * exists, then this file will not be included.
 *
 * @since 2.0.0
 */
#[AllowDynamicProperties]
class WP_Object_Cache {

	/**
	 * Holds the cached objects.
	 *
	 * @since 2.0.0
	 * @var array
	 */
	private $cache = array();

	/**
	 * The amount of times the cache data was already stored in the cache.
	 *
	 * @since 2.5.0
	 * @var int
	 */
	public $cache_hits = 0;

	/**
	 * Amount of times the cache did not have the request in cache.
	 *
	 * @since 2.0.0
	 * @var int
	 */
	public $cache_misses = 0;

	/**
	 * List of global cache groups.
	 *
	 * @since 3.0.0
	 * @var string[]
	 */
	protected $global_groups = array();

	/**
	 * The blog prefix to prepend to keys in non-global groups.
	 *
	 * @since 3.0.0
	 * @var int
	 */
	private $blog_prefix;

	/**
	 * Holds the value of is_multisite().
	 *
	 * @since 3.5.0
	 * @var bool
	 */
	private $multisite;

	/**
	 * Sets up object properties.
	 *
	 * @since 2.0.8
	 */
	public function __construct() {
		$this->multisite   = is_multisite();
		$this->blog_prefix = $this->multisite ? get_current_blog_id() . ':' : '';
	}

	/**
	 * Makes private properties readable for backward compatibility.
	 *
	 * @since 4.0.0
	 *
	 * @param string $name Property to get.
	 * @return mixed Property.
	 */
	public function __get( $name ) {
		return $this->$name;
	}

	/**
	 * Makes private properties settable for backward compatibility.
```

**Limitations:**
- Cache doesn't persist between requests
- Each PHP process has its own cache
- No cache sharing on multi-server setups

### Persistent Cache

**With Redis/Memcached:**
- Shared across all PHP processes
- Persists between requests
- Works on multi-server setups
- Much faster than database

**Benefits:**
- Reduced database load
- Faster response times
- Better scalability
- Shared cache across servers

---

## 2. Implementing Redis or Memcached via Drop-Ins

### Drop-In Mechanism

**WordPress looks for:**
- `wp-content/object-cache.php`
- If exists, uses it instead of default cache
- Must implement `WP_Object_Cache` interface

### Redis Implementation

**Install Redis Drop-In:**
```bash
# Download Redis object cache drop-in
# Place in wp-content/object-cache.php
```

**Configuration:**
```php
// wp-config.php
define( 'WP_REDIS_HOST', '127.0.0.1' );
define( 'WP_REDIS_PORT', 6379 );
define( 'WP_REDIS_DATABASE', 0 );
define( 'WP_REDIS_PASSWORD', '' );
```

**Check if Using:**
```php
// Check if persistent cache is active
if ( wp_using_ext_object_cache() ) {
	// Using Redis/Memcached
} else {
	// Using default cache
}
```

### Memcached Implementation

**Install Memcached Drop-In:**
```bash
# Download Memcached object cache drop-in
# Place in wp-content/object-cache.php
```

**Configuration:**
```php
// wp-config.php
$memcached_servers = array(
	array( '127.0.0.1', 11211 ),
);
```

### Available Drop-Ins

**Popular Options:**
- Redis Object Cache (plugin)
- Memcached Object Cache (plugin)
- Custom drop-ins

---

## 3. Understanding Cache Invalidation

### Cache Groups

**WordPress Cache Groups:**
- `posts` - Post cache
- `post_meta` - Post meta cache
- `terms` - Term cache
- `users` - User cache
- `options` - Options cache

**Group-Based Invalidation:**
```php
// Invalidate entire group
wp_cache_flush_group( 'posts' );

// Invalidate specific key in group
wp_cache_delete( $post_id, 'posts' );
```

### Cache Invalidation Patterns

**On Post Update:**
```php
// WordPress automatically invalidates
add_action( 'save_post', function( $post_id ) {
	// WordPress clears post cache
	clean_post_cache( $post_id );
} );
```

**Manual Invalidation:**
```php
// Clear specific cache
wp_cache_delete( 'my_cache_key', 'my_group' );

// Clear group
wp_cache_flush_group( 'my_group' );

// Clear all cache
wp_cache_flush();
```

### Cache Keys

**Best Practices:**
```php
// ✅ GOOD - Descriptive keys
$cache_key = 'product_' . $product_id;
$cache_key = 'user_posts_' . $user_id;

// ❌ BAD - Generic keys
$cache_key = 'data';
$cache_key = 'cache';
```

---

## 4. Cache Performance

### Monitoring Cache

**Check Cache Stats:**
```php
global $wp_object_cache;

echo "Cache Hits: " . $wp_object_cache->cache_hits . "\n";
echo "Cache Misses: " . $wp_object_cache->cache_misses . "\n";
echo "Hit Rate: " . ( $wp_object_cache->cache_hits / ( $wp_object_cache->cache_hits + $wp_object_cache->cache_misses ) * 100 ) . "%\n";
```

### Cache Hit Rate

**Good Hit Rate:**
- > 80% is excellent
- > 60% is good
- < 40% needs optimization

**Improving Hit Rate:**
- Cache expensive operations
- Use appropriate TTLs
- Invalidate only when needed
- Prime caches

---

## Exam Tips

### Key Points to Remember

1. **Persistent vs Non-Persistent:**
   - Non-persistent: In-process only, lost on request
   - Persistent: Shared across processes, persists

2. **Implementation:**
   - Drop-in: `wp-content/object-cache.php`
   - Redis or Memcached
   - Check with `wp_using_ext_object_cache()`

3. **Cache Invalidation:**
   - Group-based invalidation
   - Automatic on content updates
   - Manual invalidation available

4. **Best Practices:**
   - Use descriptive cache keys
   - Set appropriate TTLs
   - Monitor cache hit rate
   - Invalidate only when needed

5. **WordPress Functions:**
   - `wp_cache_get()` - Get from cache
   - `wp_cache_set()` - Set cache
   - `wp_cache_delete()` - Delete cache
   - `wp_cache_flush()` - Clear all cache

---

## Additional Resources

- [Object Cache - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_object_cache/)
- [Redis Object Cache Plugin](https://wordpress.org/plugins/redis-cache/)
- [Memcached Documentation](https://memcached.org/)
- Core Files:
  - `wp-includes/class-wp-object-cache.php` - Default cache implementation
  - `wp-includes/cache.php` - Cache functions
