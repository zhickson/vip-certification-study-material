# 4.16 Shutdown Hook - Study Notes

## Overview

The shutdown hook executes after the response is sent to the browser, making it ideal for post-response tasks that don't impact page load time.

**Key Reference:** [Plugin API - WordPress Developer Resources](https://developer.wordpress.org/plugins/hooks/)

---

## 1. Understanding the Shutdown Hook

### When It Fires

**Shutdown Hook:**
- Fires after response is sent
- Last hook in WordPress execution
- Doesn't block page load
- Good for cleanup and logging

**Core Implementation:**
```1302:1311:wordpress/wp-includes/load.php
function shutdown_action_hook() {
	/**
	 * Fires just before PHP shuts down execution.
	 *
	 * @since 1.2.0
	 */
	do_action( 'shutdown' );

	wp_cache_close();
}
```

**Registration:**
```php
// Registered early in WordPress bootstrap
register_shutdown_function( 'shutdown_action_hook' );
```

---

## 2. Executing Actions After Response Delivery

### Use Cases

**1. Logging:**
```php
// ✅ GOOD - Log after response sent
add_action( 'shutdown', function() {
	error_log( 'Page loaded: ' . $_SERVER['REQUEST_URI'] );
} );
```

**2. Cleanup:**
```php
// ✅ GOOD - Cleanup after response
add_action( 'shutdown', function() {
	// Clean up temporary files
	$temp_files = glob( sys_get_temp_dir() . '/wp_*' );
	foreach ( $temp_files as $file ) {
		@unlink( $file );
	}
} );
```

**3. Analytics:**
```php
// ✅ GOOD - Send analytics after response
add_action( 'shutdown', function() {
	wp_remote_post( 'https://analytics.example.com/track', array(
		'blocking' => false,
		'timeout' => 0.01,
		'body' => array(
			'page' => $_SERVER['REQUEST_URI'],
			'time' => time(),
		),
	) );
} );
```

---

## 3. Deferring Logging, Cleanup, or Async Tasks

### Defer Expensive Operations

**Example - Logging:**
```php
// ❌ BAD - Blocks page load
add_action( 'wp', function() {
	error_log( 'Expensive logging operation' );
	// Blocks page generation
} );

// ✅ GOOD - Defer to shutdown
add_action( 'shutdown', function() {
	error_log( 'Expensive logging operation' );
	// Doesn't block page load
} );
```

### Background Tasks

**Non-Blocking Requests:**
```php
// ✅ GOOD - Non-blocking request on shutdown
add_action( 'shutdown', function() {
	wp_remote_get( 'https://api.example.com/webhook', array(
		'blocking' => false,
		'timeout' => 0.01,
	) );
} );
```

### Cleanup Tasks

**Cleanup After Response:**
```php
// ✅ GOOD - Cleanup on shutdown
add_action( 'shutdown', function() {
	// Clean up session data
	// Delete temporary files
	// Close connections
} );
```

---

## 4. Avoiding Performance Impact

### Best Practices

**1. Keep Operations Fast:**
```php
// ✅ GOOD - Fast operation
add_action( 'shutdown', function() {
	// Quick logging
	error_log( 'Page loaded' );
} );

// ❌ BAD - Slow operation
add_action( 'shutdown', function() {
	// Expensive operation still impacts server
	process_large_dataset();
} );
```

**2. Use Non-Blocking:**
```php
// ✅ GOOD - Non-blocking
add_action( 'shutdown', function() {
	wp_remote_get( 'https://api.example.com/webhook', array(
		'blocking' => false,
	) );
} );
```

**3. Error Handling:**
```php
// ✅ GOOD - Handle errors
add_action( 'shutdown', function() {
	try {
		// Operation
	} catch ( Exception $e ) {
		error_log( 'Shutdown error: ' . $e->getMessage() );
	}
} );
```

---

## Exam Tips

### Key Points to Remember

1. **Shutdown Hook:**
   - Fires after response sent
   - Doesn't block page load
   - Last hook in execution
   - Good for cleanup/logging

2. **Use Cases:**
   - Logging
   - Cleanup
   - Analytics
   - Non-blocking requests

3. **Best Practices:**
   - Keep operations fast
   - Use non-blocking requests
   - Handle errors
   - Don't do expensive operations

4. **WordPress Function:**
   - `add_action( 'shutdown', $callback )`
   - Fires after response
   - Last chance to execute code

---

## Additional Resources

- [Plugin API - WordPress Developer Resources](https://developer.wordpress.org/plugins/hooks/)
- Core Files:
  - `wp-includes/load.php` - Shutdown hook registration
