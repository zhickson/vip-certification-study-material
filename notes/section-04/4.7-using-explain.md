# 4.7 Using EXPLAIN - Study Notes

## Overview

EXPLAIN is a MySQL command that shows how MySQL executes a query. Understanding EXPLAIN output is essential for diagnosing query performance issues and optimizing database queries in WordPress.

**Key Reference:** [EXPLAIN Output Format - MySQL Documentation](https://dev.mysql.com/doc/refman/8.0/en/explain-output.html)

---

## 1. Understanding EXPLAIN

### What is EXPLAIN?

EXPLAIN shows the execution plan MySQL uses to execute a query. It reveals:
- Which indexes are used
- How tables are joined
- How many rows are examined
- Whether full table scans occur

**Basic Usage:**
```sql
EXPLAIN SELECT * FROM wp_posts WHERE post_type = 'post';
```

**WordPress Query:**
```php
// Get the SQL from WP_Query
$query = new WP_Query( array(
	'post_type' => 'post',
	'posts_per_page' => 10,
) );

// Get the SQL
global $wpdb;
$sql = $wpdb->last_query;

// Explain it
$explain = $wpdb->get_results( "EXPLAIN $sql" );
```

---

## 2. Interpreting EXPLAIN Output

### Key Columns

**1. id:**
- Sequential number for each SELECT
- Same id = executed together
- Different id = executed in order

**2. select_type:**
- `SIMPLE`: Simple SELECT (most common)
- `PRIMARY`: Outermost SELECT
- `SUBQUERY`: Subquery in SELECT
- `DERIVED`: Derived table (FROM subquery)
- `UNION`: Second SELECT in UNION

**3. table:**
- Table name being accessed
- `<derivedN>`: Derived table
- `<unionM,N>`: Union result

**4. type (Most Important):**
- `ALL`: Full table scan (worst)
- `index`: Full index scan
- `range`: Index range scan
- `ref`: Index lookup
- `eq_ref`: Unique index lookup
- `const`: Single row lookup (best)

**5. possible_keys:**
- Indexes MySQL considered using
- NULL = no indexes considered

**6. key:**
- Index actually used
- NULL = no index used

**7. key_len:**
- Length of index used
- Shorter is better (uses less of index)

**8. ref:**
- Columns compared to index
- Shows what's being matched

**9. rows:**
- Estimated rows examined
- Lower is better

**10. Extra:**
- Additional information
- `Using index`: Index-only scan (best)
- `Using where`: Filtering after index
- `Using filesort`: Sorting without index (bad)
- `Using temporary`: Temporary table (bad)

---

## 3. Common EXPLAIN Patterns

### Good Query (Index Used)

```sql
EXPLAIN SELECT * FROM wp_posts WHERE ID = 123;
```

**Output:**
```
id: 1
select_type: SIMPLE
table: wp_posts
type: const
possible_keys: PRIMARY
key: PRIMARY
key_len: 8
ref: const
rows: 1
Extra:
```

**Analysis:**
- `type: const` - Best possible
- `key: PRIMARY` - Using primary key
- `rows: 1` - Examining 1 row
- Excellent performance

### Bad Query (Full Table Scan)

```sql
EXPLAIN SELECT * FROM wp_posts WHERE post_title = 'test';
```

**Output (without index):**
```
id: 1
select_type: SIMPLE
table: wp_posts
type: ALL
possible_keys: NULL
key: NULL
key_len: NULL
ref: NULL
rows: 10000
Extra: Using where
```

**Analysis:**
- `type: ALL` - Full table scan (bad)
- `key: NULL` - No index used
- `rows: 10000` - Examining all rows
- Very slow

**After Adding Index:**
```sql
CREATE INDEX idx_post_title ON wp_posts(post_title);
EXPLAIN SELECT * FROM wp_posts WHERE post_title = 'test';
```

**Output:**
```
id: 1
select_type: SIMPLE
table: wp_posts
type: ref
possible_keys: idx_post_title
key: idx_post_title
key_len: 767
ref: const
rows: 1
Extra: Using where
```

**Analysis:**
- `type: ref` - Index lookup (good)
- `key: idx_post_title` - Using index
- `rows: 1` - Examining 1 row
- Much faster

### JOIN Query

```sql
EXPLAIN
SELECT p.* FROM wp_posts p
INNER JOIN wp_postmeta pm ON p.ID = pm.post_id
WHERE pm.meta_key = 'featured' AND pm.meta_value = 'yes';
```

**Output:**
```
id: 1
select_type: SIMPLE
table: pm
type: ref
possible_keys: post_id,meta_key
key: meta_key
key_len: 767
ref: const
rows: 1000
Extra: Using where

id: 1
select_type: SIMPLE
table: p
type: eq_ref
possible_keys: PRIMARY
key: PRIMARY
key_len: 8
ref: wordpress.pm.post_id
rows: 1
Extra:
```

**Analysis:**
- First row: Using index on meta_key
- Second row: Using primary key lookup
- `type: eq_ref` - Unique lookup (best for JOIN)
- Good performance

---

## 4. Diagnosing Unintended Index Usage

### Wrong Index Used

**Problem:**
```sql
EXPLAIN SELECT * FROM wp_posts
WHERE post_type = 'post' AND post_status = 'publish';
```

**Output:**
```
type: ALL
key: NULL
rows: 10000
```

**Issue:** No index used, full table scan

**Solution:**
```sql
-- Add composite index
CREATE INDEX idx_type_status ON wp_posts(post_type, post_status);

-- Re-explain
EXPLAIN SELECT * FROM wp_posts
WHERE post_type = 'post' AND post_status = 'publish';
```

**New Output:**
```
type: ref
key: idx_type_status
rows: 500
```

### Index Not Used

**Problem:**
```sql
-- Index exists but not used
CREATE INDEX idx_post_date ON wp_posts(post_date);
EXPLAIN SELECT * FROM wp_posts WHERE YEAR(post_date) = 2023;
```

**Output:**
```
type: ALL
key: NULL
```

**Issue:** Function on column prevents index use

**Solution:**
```sql
-- Use range instead
EXPLAIN SELECT * FROM wp_posts
WHERE post_date >= '2023-01-01' AND post_date < '2024-01-01';
```

**New Output:**
```
type: range
key: idx_post_date
rows: 1000
```

### Filesort Issue

**Problem:**
```sql
EXPLAIN SELECT * FROM wp_posts
WHERE post_type = 'post'
ORDER BY post_date DESC;
```

**Output:**
```
type: ref
key: idx_type_status
Extra: Using filesort
```

**Issue:** Sorting without index

**Solution:**
```sql
-- Add composite index with sort column
CREATE INDEX idx_type_date ON wp_posts(post_type, post_date);

-- Re-explain
EXPLAIN SELECT * FROM wp_posts
WHERE post_type = 'post'
ORDER BY post_date DESC;
```

**New Output:**
```
type: ref
key: idx_type_date
Extra: Using where
```

---

## 5. Adjusting Queries Based on EXPLAIN

### Adding Missing Indexes

**Identify Missing Index:**
```sql
EXPLAIN SELECT * FROM wp_posts WHERE post_author = 1;

-- Shows:
-- type: ALL
-- key: NULL
```

**Add Index:**
```sql
CREATE INDEX idx_post_author ON wp_posts(post_author);

-- Re-check
EXPLAIN SELECT * FROM wp_posts WHERE post_author = 1;
-- Now shows: type: ref, key: idx_post_author
```

### Rewriting Queries

**Inefficient Query:**
```sql
EXPLAIN SELECT * FROM wp_posts
WHERE post_title LIKE '%search%';
-- type: ALL (full table scan)
```

**Optimized Query:**
```sql
-- Use full-text search instead
EXPLAIN SELECT * FROM wp_posts
WHERE MATCH(post_title) AGAINST('search' IN NATURAL LANGUAGE MODE);
-- type: fulltext (uses full-text index)
```

### Optimizing JOINs

**Inefficient JOIN:**
```sql
EXPLAIN
SELECT p.* FROM wp_posts p
LEFT JOIN wp_postmeta pm ON p.ID = pm.post_id
WHERE pm.meta_value = 'value';
-- type: ALL on both tables
```

**Optimized JOIN:**
```sql
-- Add index on join column and WHERE column
CREATE INDEX idx_meta_value ON wp_postmeta(meta_value(50));

EXPLAIN
SELECT p.* FROM wp_posts p
INNER JOIN wp_postmeta pm ON p.ID = pm.post_id
WHERE pm.meta_value = 'value';
-- Now uses indexes
```

---

## 6. WordPress-Specific EXPLAIN Usage

### Analyzing WP_Query

**Get Query SQL:**
```php
// Enable query logging
define( 'SAVEQUERIES', true );

// Run query
$query = new WP_Query( array(
	'post_type' => 'product',
	'meta_query' => array(
		array(
			'key' => 'price',
			'value' => 100,
			'compare' => '>',
		),
	),
) );

// Get SQL
global $wpdb;
$sql = $wpdb->queries[ count( $wpdb->queries ) - 1 ][0];

// Explain it
$explain = $wpdb->get_results( "EXPLAIN $sql" );
print_r( $explain );
```

### Query Monitor Integration

**Query Monitor shows:**
- Query execution time
- Suggests missing indexes
- Shows EXPLAIN-like information
- Highlights slow queries

### Common WordPress Queries

**Main Query:**
```sql
EXPLAIN SELECT SQL_CALC_FOUND_ROWS wp_posts.ID
FROM wp_posts
WHERE 1=1 AND wp_posts.post_type = 'post'
AND (wp_posts.post_status = 'publish')
ORDER BY wp_posts.post_date DESC
LIMIT 0, 10;
```

**Check for:**
- Index on `post_type`
- Index on `post_status`
- Index on `post_date`
- Composite index: `(post_type, post_status, post_date)`

**Meta Query:**
```sql
EXPLAIN
SELECT wp_posts.ID
FROM wp_posts
INNER JOIN wp_postmeta ON (wp_posts.ID = wp_postmeta.post_id)
WHERE 1=1
AND wp_posts.post_type = 'product'
AND (wp_postmeta.meta_key = 'price' AND wp_postmeta.meta_value > '100')
GROUP BY wp_posts.ID
ORDER BY wp_posts.post_date DESC;
```

**Check for:**
- Index on `post_id` in postmeta
- Index on `meta_key`
- Composite index: `(meta_key, meta_value)`

---

## 7. Tools for EXPLAIN Analysis

### MySQL Workbench

**Features:**
- Visual EXPLAIN
- Index suggestions
- Performance insights
- Query optimization

### phpMyAdmin

**Features:**
- EXPLAIN output
- Index management
- Query profiling
- Slow query log

### Query Monitor (WordPress)

**Features:**
- Shows all queries
- Execution time
- Index suggestions
- EXPLAIN integration

### Custom WordPress Tool

**Create EXPLAIN Endpoint:**
```php
add_action( 'rest_api_init', function() {
	register_rest_route( 'debug/v1', '/explain', array(
		'methods' => 'POST',
		'callback' => function( $request ) {
			global $wpdb;

			$sql = $request->get_param( 'sql' );
			if ( ! $sql ) {
				return new WP_Error( 'no_sql', 'SQL required' );
			}

			// Sanitize (basic)
			if ( stripos( $sql, 'SELECT' ) !== 0 ) {
				return new WP_Error( 'invalid_sql', 'Only SELECT allowed' );
			}

			$explain = $wpdb->get_results( "EXPLAIN $sql" );

			return $explain;
		},
		'permission_callback' => function() {
			return current_user_can( 'manage_options' );
		},
	) );
} );
```

---

## Exam Tips

### Key Points to Remember

1. **EXPLAIN Columns:**
   - `type`: Most important (ALL = bad, const = best)
   - `key`: Index used (NULL = no index)
   - `rows`: Rows examined (lower is better)
   - `Extra`: Additional info (Using filesort = bad)

2. **Type Values (Best to Worst):**
   - `const`: Single row lookup
   - `eq_ref`: Unique index lookup
   - `ref`: Index lookup
   - `range`: Index range scan
   - `index`: Full index scan
   - `ALL`: Full table scan (worst)

3. **Common Issues:**
   - `type: ALL` = missing index
   - `Using filesort` = add index to ORDER BY
   - `Using temporary` = optimize query
   - NULL in `key` = no index used

4. **Optimization Steps:**
   - Run EXPLAIN on slow queries
   - Identify missing indexes
   - Add appropriate indexes
   - Rewrite queries if needed
   - Re-check with EXPLAIN

5. **WordPress Specific:**
   - Use Query Monitor for EXPLAIN
   - Check main query performance
   - Optimize meta queries with indexes
   - Monitor slow query log

---

## Additional Resources

- [EXPLAIN Output Format - MySQL Documentation](https://dev.mysql.com/doc/refman/8.0/en/explain-output.html)
- [Optimizing Queries with EXPLAIN - MySQL Documentation](https://dev.mysql.com/doc/refman/8.0/en/using-explain.html)
- [Query Monitor Plugin](https://wordpress.org/plugins/query-monitor/)
- Core Files:
  - `wp-includes/class-wp-query.php` - Query generation
  - `wp-includes/class-wp-meta-query.php` - Meta query handling
