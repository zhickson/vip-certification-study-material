# 4.4 Using NOT IN - Study Notes

## Overview

The `NOT IN` operator in MySQL queries can have significant performance penalties, especially with large datasets. Understanding why `NOT IN` is slow and knowing alternative strategies is crucial for optimizing WordPress queries.

**Key Reference:** [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)

---

## 1. Performance Penalties of NOT IN

### Why NOT IN is Slow

**1. Subquery Execution:**
```sql
-- NOT IN requires subquery
SELECT * FROM wp_posts
WHERE ID NOT IN (
    SELECT post_id FROM wp_postmeta WHERE meta_key = 'excluded'
);
```

**Problems:**
- Subquery executes for each row
- Can't use indexes efficiently
- Often results in full table scans

**2. NULL Handling:**
```sql
-- NOT IN with NULLs returns no results
SELECT * FROM wp_posts
WHERE ID NOT IN (1, 2, NULL);
-- Returns nothing because NULL comparison is unknown
```

**3. Large Value Lists:**
```sql
-- NOT IN with large list is slow
SELECT * FROM wp_posts
WHERE ID NOT IN (1, 2, 3, ..., 10000);
-- MySQL must check each value
```

### Core Implementation

**WordPress Uses NOT IN for Taxonomies:**
```434:446:wordpress/wp-includes/class-wp-tax-query.php
		} elseif ( 'NOT IN' === $operator ) {

			if ( empty( $terms ) ) {
				return $sql;
			}

			$terms = implode( ',', $terms );

			$where = "$this->primary_table.$this->primary_id_column NOT IN (
				SELECT object_id
				FROM $wpdb->term_relationships
				WHERE term_taxonomy_id IN ($terms)
			)";
```

**Performance Impact:**
- Subquery executes for each post
- Can't use indexes on the subquery efficiently
- Gets slower as taxonomy grows

---

## 2. Alternative Query Strategies

### Use LEFT JOIN with NULL Check

**Instead of NOT IN:**
```php
// ❌ BAD - Uses NOT IN
$query = new WP_Query( array(
	'tax_query' => array(
		array(
			'taxonomy' => 'category',
			'terms' => array( 5, 6 ),
			'operator' => 'NOT IN',
		),
	),
) );
```

**Better Approach:**
```php
// ✅ GOOD - Use LEFT JOIN
add_filter( 'posts_join', function( $join, $query ) {
	global $wpdb;

	if ( $query->get( 'exclude_category' ) ) {
		$join .= " LEFT JOIN {$wpdb->term_relationships} tr_exclude
			ON {$wpdb->posts}.ID = tr_exclude.object_id
			AND tr_exclude.term_taxonomy_id IN (" . implode( ',', array_map( 'intval', $query->get( 'exclude_category' ) ) ) . ")";
	}

	return $join;
}, 10, 2 );

add_filter( 'posts_where', function( $where, $query ) {
	global $wpdb;

	if ( $query->get( 'exclude_category' ) ) {
		$where .= " AND tr_exclude.object_id IS NULL";
	}

	return $where;
}, 10, 2 );

$query = new WP_Query( array(
	'exclude_category' => array( 5, 6 ),
) );
```

### Use NOT EXISTS

**NOT EXISTS is Often Faster:**
```sql
-- ✅ GOOD - NOT EXISTS
SELECT * FROM wp_posts p
WHERE NOT EXISTS (
    SELECT 1 FROM wp_term_relationships tr
    WHERE tr.object_id = p.ID
    AND tr.term_taxonomy_id IN (5, 6)
);
```

**WordPress Implementation:**
```php
// Use NOT EXISTS operator
$query = new WP_Query( array(
	'tax_query' => array(
		array(
			'taxonomy' => 'category',
			'terms' => array( 5, 6 ),
			'operator' => 'NOT EXISTS', // Better than NOT IN
		),
	),
) );
```

**Core Support:**
```465:475:wordpress/wp-includes/class-wp-tax-query.php
		} elseif ( 'NOT EXISTS' === $operator || 'EXISTS' === $operator ) {

			$where = $wpdb->prepare(
				"$operator (
					SELECT 1
					FROM $wpdb->term_relationships
					INNER JOIN $wpdb->term_taxonomy ON $wpdb->term_relationships.term_taxonomy_id = $wpdb->term_taxonomy.term_taxonomy_id
					WHERE $wpdb->term_relationships.object_id = $this->primary_table.$this->primary_id_column
					AND $wpdb->term_taxonomy.taxonomy = %s
				)",
				$clause['taxonomy']
			);
```

### Use Post Status Instead

**For Excluding Published Posts:**
```php
// ❌ BAD - NOT IN with post IDs
$excluded_ids = array( 1, 2, 3, 1000 );
$query = new WP_Query( array(
	'post__not_in' => $excluded_ids, // Uses NOT IN
) );

// ✅ GOOD - Use post_status
$query = new WP_Query( array(
	'post_status' => 'publish',
	// Exclude specific posts differently
) );
```

### Filter Results in PHP

**For Small Datasets:**
```php
// ✅ GOOD - Get all, filter in PHP (only if small)
$all_posts = get_posts( array(
	'posts_per_page' => 100, // Reasonable limit
	'fields' => 'ids',
) );

$excluded_ids = array( 1, 2, 3 );
$filtered = array_diff( $all_posts, $excluded_ids );
```

**Warning:** Only use this for small result sets.

---

## 3. Optimizing NOT IN When Necessary

### When You Must Use NOT IN

**If NOT IN is Required:**

**1. Limit the Subquery:**
```sql
-- ✅ GOOD - Limit subquery results
SELECT * FROM wp_posts
WHERE ID NOT IN (
    SELECT post_id FROM wp_postmeta
    WHERE meta_key = 'excluded'
    LIMIT 1000
);
```

**2. Use Indexes:**
```sql
-- Ensure indexes exist
CREATE INDEX idx_meta_key ON wp_postmeta(meta_key);
CREATE INDEX idx_post_id ON wp_posts(ID);
```

**3. Use Small Value Lists:**
```php
// ✅ GOOD - Small exclusion list
$excluded = array( 1, 2, 3, 4, 5 ); // Small list
$query = new WP_Query( array(
	'post__not_in' => $excluded,
) );

// ❌ BAD - Large exclusion list
$excluded = range( 1, 10000 ); // Too large
```

### WordPress post__not_in

**How WordPress Handles It:**
```php
// WordPress converts to NOT IN
$query = new WP_Query( array(
	'post__not_in' => array( 1, 2, 3 ),
) );

// Generates SQL like:
// WHERE ID NOT IN (1, 2, 3)
```

**Performance Considerations:**
- Works well for small lists (< 100 IDs)
- Gets slow with large lists
- Consider alternatives for large exclusions

---

## 4. Real-World Examples

### Excluding Categories

**Problem:**
```php
// ❌ BAD - NOT IN with taxonomy
$query = new WP_Query( array(
	'tax_query' => array(
		array(
			'taxonomy' => 'category',
			'terms' => array( 5, 6, 7 ),
			'operator' => 'NOT IN',
		),
	),
) );
```

**Solution:**
```php
// ✅ GOOD - Use custom query with LEFT JOIN
function exclude_categories_query( $query ) {
	if ( ! is_admin() && $query->is_main_query() ) {
		global $wpdb;

		$excluded_cats = array( 5, 6, 7 );
		$cat_ids = implode( ',', array_map( 'intval', $excluded_cats ) );

		$query->set( 'meta_query', array() );

		add_filter( 'posts_join', function( $join ) use ( $cat_ids ) {
			global $wpdb;
			$join .= " LEFT JOIN {$wpdb->term_relationships} tr_exclude
				ON {$wpdb->posts}.ID = tr_exclude.object_id
				AND tr_exclude.term_taxonomy_id IN ({$cat_ids})";
			return $join;
		} );

		add_filter( 'posts_where', function( $where ) {
			global $wpdb;
			$where .= " AND tr_exclude.object_id IS NULL";
			return $where;
		} );
	}
}
add_action( 'pre_get_posts', 'exclude_categories_query' );
```

### Excluding Post Meta

**Problem:**
```php
// ❌ BAD - NOT IN with meta
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'featured',
			'compare' => 'NOT EXISTS',
		),
	),
) );
```

**Solution:**
```php
// ✅ GOOD - Use NOT EXISTS (already optimized)
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'featured',
			'compare' => 'NOT EXISTS', // Better than NOT IN
		),
	),
) );
```

---

## 5. Measuring Performance Impact

### Query Analysis

**Use EXPLAIN:**
```sql
-- Analyze NOT IN query
EXPLAIN SELECT * FROM wp_posts
WHERE ID NOT IN (
    SELECT post_id FROM wp_postmeta WHERE meta_key = 'excluded'
);

-- Look for:
-- - type: ALL (full table scan)
-- - Extra: Using where
```

**Compare with Alternative:**
```sql
-- Analyze LEFT JOIN alternative
EXPLAIN SELECT p.* FROM wp_posts p
LEFT JOIN wp_postmeta pm ON p.ID = pm.post_id AND pm.meta_key = 'excluded'
WHERE pm.post_id IS NULL;

-- Should show better index usage
```

### WordPress Query Monitor

**Check Query Performance:**
- Query Monitor shows execution time
- Compare NOT IN vs alternatives
- Monitor slow queries

---

## Exam Tips

### Key Points to Remember

1. **NOT IN Performance:**
   - Often requires subqueries
   - Can't use indexes efficiently
   - Gets slower with larger datasets

2. **Alternatives:**
   - Use LEFT JOIN with NULL check
   - Use NOT EXISTS when possible
   - Filter in PHP for small datasets

3. **When to Use NOT IN:**
   - Small exclusion lists (< 100 items)
   - When alternatives aren't feasible
   - With proper indexes

4. **Optimization:**
   - Limit subquery results
   - Ensure indexes exist
   - Consider caching results

5. **WordPress Specific:**
   - `post__not_in` uses NOT IN
   - `operator => 'NOT EXISTS'` is better for taxonomies
   - Consider custom queries for complex exclusions

---

## Additional Resources

- [WP_Query - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)
- [MySQL NOT IN Performance](https://dev.mysql.com/doc/refman/8.0/en/optimizing-subqueries.html)
- [Query Monitor Plugin](https://wordpress.org/plugins/query-monitor/)
- Core Files:
  - `wp-includes/class-wp-tax-query.php` - Taxonomy query handling
  - `wp-includes/class-wp-query.php` - Main query class
