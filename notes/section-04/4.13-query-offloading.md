# 4.13 Query Offloading (e.g., Elasticsearch) - Study Notes

## Overview

Query offloading moves complex or heavy database queries to external search systems like Elasticsearch. Understanding when MySQL is sufficient and when to use external search is crucial for scalable WordPress sites.

**Key Reference:** [Search - WordPress Developer Resources](https://developer.wordpress.org/reference/classes/wp_query/)

---

## 1. Identifying Queries Too Complex for MySQL

### Complex Query Patterns

**1. Full-Text Search:**
```php
// ❌ BAD - MySQL full-text search limitations
$query = new WP_Query( array(
	's' => 'search term',
	'meta_query' => array(
		array(
			'key' => 'description',
			'value' => 'term',
			'compare' => 'LIKE',
		),
	),
	'tax_query' => array(
		array(
			'taxonomy' => 'category',
			'terms' => array( 1, 2, 3 ),
		),
	),
) );
```

**Issues:**
- MySQL full-text search is limited
- Multiple LIKE queries are slow
- Complex queries don't scale

**2. Faceted Search:**
```php
// Complex faceted search
$query = new WP_Query( array(
	'post_type' => 'product',
	'meta_query' => array(
		'relation' => 'AND',
		array( 'key' => 'price', 'value' => 100, 'compare' => '>=' ),
		array( 'key' => 'color', 'value' => 'red' ),
		array( 'key' => 'size', 'value' => 'large' ),
	),
	'tax_query' => array(
		array( 'taxonomy' => 'category', 'terms' => array( 1, 2 ) ),
	),
) );
```

**Issues:**
- Multiple JOINs
- Slow on large datasets
- Hard to optimize

**3. Aggregations:**
```sql
-- Complex aggregations
SELECT
	category,
	AVG(price) as avg_price,
	COUNT(*) as count
FROM wp_posts p
INNER JOIN wp_postmeta pm ON p.ID = pm.post_id
WHERE pm.meta_key = 'price'
GROUP BY category;
```

**Issues:**
- MySQL aggregations are slow
- Complex GROUP BY queries
- Doesn't scale well

---

## 2. Understanding When MySQL is Sufficient

### Simple Queries

**MySQL is Sufficient For:**
- Simple post queries
- Basic meta queries
- Taxonomy queries
- Paginated results
- Small to medium datasets (< 100K posts)

**Example:**
```php
// ✅ GOOD - MySQL is sufficient
$query = new WP_Query( array(
	'post_type' => 'post',
	'posts_per_page' => 10,
	'meta_query' => array(
		array(
			'key' => 'featured',
			'value' => 'yes',
		),
	),
) );
```

### When to Stay with MySQL

**Stay with MySQL If:**
- Dataset is small (< 100K posts)
- Queries are simple
- Performance is acceptable
- No complex search requirements
- Budget constraints

---

## 3. Integrating Elasticsearch

### WordPress Elasticsearch Integration

**Plugin Options:**
- ElasticPress
- SearchWP
- Relevanssi (can use Elasticsearch)

**ElasticPress Example:**
```php
// ElasticPress automatically indexes content
// Queries use Elasticsearch instead of MySQL

$query = new WP_Query( array(
	's' => 'search term',
	'ep_integrate' => true, // Use Elasticsearch
) );
```

### Custom Integration

**Basic Integration:**
```php
// Check if Elasticsearch is available
function use_elasticsearch( $query_args ) {
	if ( ! class_exists( 'Elasticsearch_Client' ) ) {
		return false;
	}

	// Use Elasticsearch for complex queries
	if ( isset( $query_args['s'] ) && ! empty( $query_args['s'] ) ) {
		return true;
	}

	return false;
}

// Route queries
add_filter( 'posts_request', function( $sql, $query ) {
	if ( use_elasticsearch( $query->query_vars ) ) {
		// Use Elasticsearch instead
		$results = search_elasticsearch( $query->query_vars );
		// Modify query to use results
		return "SELECT * FROM wp_posts WHERE ID IN (" . implode( ',', $results ) . ")";
	}
	return $sql;
}, 10, 2 );
```

### Indexing Content

**Index Posts:**
```php
// Index post on save
add_action( 'save_post', function( $post_id ) {
	$post = get_post( $post_id );

	$document = array(
		'id' => $post_id,
		'title' => $post->post_title,
		'content' => $post->post_content,
		'post_type' => $post->post_type,
		'post_status' => $post->post_status,
	);

	// Add meta
	$meta = get_post_meta( $post_id );
	foreach ( $meta as $key => $value ) {
		$document[ 'meta_' . $key ] = $value;
	}

	// Add taxonomies
	$taxonomies = get_object_taxonomies( $post->post_type );
	foreach ( $taxonomies as $taxonomy ) {
		$terms = wp_get_post_terms( $post_id, $taxonomy );
		$document[ 'tax_' . $taxonomy ] = wp_list_pluck( $terms, 'name' );
	}

	index_to_elasticsearch( $document );
} );
```

---

## 4. Alternative Search Solutions

### Solr

**Apache Solr:**
- Similar to Elasticsearch
- Full-text search engine
- Faceted search support
- WordPress plugins available

### Algolia

**Algolia:**
- Hosted search service
- Fast search API
- Easy integration
- WordPress plugins available

### Custom Search Tables

**For Specific Use Cases:**
```php
// Create search table
function create_search_table() {
	global $wpdb;

	$table_name = $wpdb->prefix . 'post_search';

	$sql = "CREATE TABLE $table_name (
		post_id bigint(20) NOT NULL,
		search_text text NOT NULL,
		PRIMARY KEY (post_id),
		FULLTEXT KEY search_text (search_text)
	) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;";

	require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
	dbDelta( $sql );
}

// Index content
function index_post_for_search( $post_id ) {
	global $wpdb;

	$post = get_post( $post_id );
	$search_text = $post->post_title . ' ' . $post->post_content;

	$wpdb->replace(
		$wpdb->prefix . 'post_search',
		array(
			'post_id' => $post_id,
			'search_text' => $search_text,
		)
	);
}
```

---

## 5. Performance Considerations

### When to Offload

**Offload When:**
- Dataset > 100K posts
- Complex search requirements
- Faceted search needed
- Full-text search on multiple fields
- Aggregations required
- MySQL queries are slow

### Hybrid Approach

**Use Both:**
```php
// Simple queries use MySQL
function get_posts_query( $args ) {
	if ( is_simple_query( $args ) ) {
		return new WP_Query( $args ); // MySQL
	} else {
		return search_elasticsearch( $args ); // Elasticsearch
	}
}

function is_simple_query( $args ) {
	// Simple if:
	// - No search term
	// - Single meta query
	// - Single taxonomy
	return ! isset( $args['s'] )
		&& count( $args['meta_query'] ?? array() ) <= 1
		&& count( $args['tax_query'] ?? array() ) <= 1;
}
```

---

## Exam Tips

### Key Points to Remember

1. **When to Offload:**
   - Complex full-text search
   - Faceted search
   - Large datasets (> 100K)
   - Aggregations needed
   - MySQL queries too slow

2. **When MySQL is Sufficient:**
   - Simple queries
   - Small datasets
   - Basic search
   - Performance acceptable

3. **Integration:**
   - Use plugins (ElasticPress, SearchWP)
   - Custom integration possible
   - Index content on save
   - Route queries appropriately

4. **Alternatives:**
   - Solr
   - Algolia
   - Custom search tables
   - Hybrid approach

5. **Best Practices:**
   - Index content on save
   - Keep MySQL for simple queries
   - Use external search for complex queries
   - Monitor performance

---

## Additional Resources

- [ElasticPress Plugin](https://wordpress.org/plugins/elasticpress/)
- [SearchWP Plugin](https://searchwp.com/)
- [Elasticsearch Documentation](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)
- Core Files:
  - `wp-includes/class-wp-query.php` - Query handling
