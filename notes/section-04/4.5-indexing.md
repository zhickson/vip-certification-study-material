# 4.5 Indexing - Study Notes

## Overview

Database indexes are crucial for query performance. Understanding when to use indexes, what types to use, and how to diagnose index usage is essential for optimizing WordPress database queries.

**Key Reference:** [MySQL Indexes - MySQL Documentation](https://dev.mysql.com/doc/refman/8.0/en/mysql-indexes.html)

---

## 1. Understanding Indexes

### What are Indexes?

Indexes are data structures that improve the speed of data retrieval operations. They work like a book's index, allowing the database to find data without scanning the entire table.

**Without Index:**
```sql
-- Full table scan (slow)
SELECT * FROM wp_posts WHERE post_title = 'Hello World';
-- Scans all rows: O(n)
```

**With Index:**
```sql
-- Index lookup (fast)
SELECT * FROM wp_posts WHERE post_title = 'Hello World';
-- Uses index: O(log n)
```

### Types of Indexes

**1. Primary Index:**
- Automatically created on primary key
- Unique and not null
- One per table

**2. Secondary Index:**
- Created on non-primary key columns
- Can be multiple per table
- Improves query performance

**3. Composite Index:**
- Index on multiple columns
- Order matters
- Useful for multi-column queries

**4. Unique Index:**
- Ensures uniqueness
- Can be on single or multiple columns

---

## 2. Spotting Missing Indexes

### After Imports/Migrations

**Common Issues:**
- Large data imports without indexes
- Missing indexes on foreign keys
- No indexes on frequently queried columns

**Check Existing Indexes:**
```sql
-- Show indexes on a table
SHOW INDEXES FROM wp_posts;

-- Show index usage statistics
SHOW INDEX FROM wp_posts;
```

**WordPress Core Indexes:**
```sql
-- WordPress creates indexes on:
-- wp_posts: PRIMARY (ID), post_name, type_status_date, post_parent, post_author
-- wp_postmeta: PRIMARY (meta_id), post_id, meta_key
-- wp_users: PRIMARY (ID), user_login, user_nicename, user_email
```

### Identifying Missing Indexes

**1. Slow Query Log:**
```sql
-- Enable slow query log
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;

-- Analyze slow queries
SELECT * FROM mysql.slow_log
WHERE sql_text LIKE '%SELECT%'
ORDER BY query_time DESC;
```

**2. EXPLAIN Analysis:**
```sql
-- Check if index is used
EXPLAIN SELECT * FROM wp_posts WHERE post_title = 'test';

-- Look for:
-- type: ALL = no index used (bad)
-- type: ref, range, index = index used (good)
-- key: shows which index is used
```

**3. Query Monitor Plugin:**
- Shows slow queries
- Indicates missing indexes
- Suggests index improvements

---

## 3. When to Use Different Index Types

### Primary Index

**Automatic:**
```sql
-- WordPress automatically creates primary index
CREATE TABLE wp_posts (
    ID bigint(20) NOT NULL AUTO_INCREMENT,
    PRIMARY KEY (ID)
);
```

**Best Practices:**
- Always have a primary key
- Use auto-increment for sequential IDs
- Keep primary key small

### Secondary Index

**Single Column:**
```sql
-- Index on frequently queried column
CREATE INDEX idx_post_title ON wp_posts(post_title);

-- Useful for:
SELECT * FROM wp_posts WHERE post_title = 'value';
```

**When to Create:**
- Column used in WHERE clauses
- Column used in JOIN conditions
- Column used in ORDER BY

### Composite Index

**Multiple Columns:**
```sql
-- Composite index (order matters!)
CREATE INDEX idx_type_status_date ON wp_posts(post_type, post_status, post_date);

-- Useful for queries like:
SELECT * FROM wp_posts
WHERE post_type = 'post'
AND post_status = 'publish'
ORDER BY post_date DESC;
```

**Column Order Matters:**
```sql
-- ✅ GOOD - Leftmost prefix used
CREATE INDEX idx_type_status ON wp_posts(post_type, post_status);
-- Can use for: WHERE post_type = 'post'
-- Can use for: WHERE post_type = 'post' AND post_status = 'publish'

-- ❌ BAD - Can't use for post_type alone
CREATE INDEX idx_status_type ON wp_posts(post_status, post_type);
-- Can't use for: WHERE post_type = 'post' (status not in WHERE)
```

**WordPress Example:**
```sql
-- WordPress uses composite index
CREATE INDEX type_status_date ON wp_posts(post_type, post_status, post_date);
```

### Unique Index

**Ensure Uniqueness:**
```sql
-- Unique index
CREATE UNIQUE INDEX idx_user_email ON wp_users(user_email);

-- Prevents duplicate emails
INSERT INTO wp_users (user_email) VALUES ('test@example.com');
INSERT INTO wp_users (user_email) VALUES ('test@example.com'); -- Error!
```

---

## 4. Diagnosing Index Usage

### Using EXPLAIN

**Basic EXPLAIN:**
```sql
EXPLAIN SELECT * FROM wp_posts
WHERE post_type = 'post'
AND post_status = 'publish';
```

**Key Columns to Check:**

**1. type:**
- `ALL`: Full table scan (bad, no index)
- `index`: Full index scan (better than ALL)
- `range`: Index range scan (good)
- `ref`: Index lookup (very good)
- `eq_ref`: Unique index lookup (best)

**2. key:**
- Shows which index is used
- NULL means no index used

**3. rows:**
- Estimated rows examined
- Lower is better

**4. Extra:**
- `Using index`: Index-only scan (best)
- `Using where`: Filtering after index
- `Using filesort`: Sorting without index (bad)

**Example Analysis:**
```sql
EXPLAIN SELECT * FROM wp_posts WHERE post_title = 'test';

-- Good result:
-- type: ref
-- key: post_title
-- rows: 1
-- Extra: Using where

-- Bad result:
-- type: ALL
-- key: NULL
-- rows: 10000
-- Extra: Using where
```

### Query Analysis Tools

**1. MySQL Workbench:**
- Visual EXPLAIN
- Index suggestions
- Performance insights

**2. phpMyAdmin:**
- EXPLAIN output
- Index management
- Query profiling

**3. Query Monitor (WordPress):**
- Shows query execution time
- Indicates index usage
- Suggests optimizations

---

## 5. Creating Indexes in WordPress

### Custom Post Type Indexes

**After Registering CPT:**
```php
// Create index after CPT registration
register_post_type( 'product', $args );

// Add index on custom field
function add_product_indexes() {
	global $wpdb;

	// Check if index exists
	$indexes = $wpdb->get_results( "SHOW INDEXES FROM {$wpdb->posts} WHERE Key_name = 'idx_product_sku'" );

	if ( empty( $indexes ) ) {
		$wpdb->query( "CREATE INDEX idx_product_sku ON {$wpdb->posts}(post_name) WHERE post_type = 'product'" );
	}
}
add_action( 'init', 'add_product_indexes', 20 );
```

### Meta Table Indexes

**Post Meta Indexes:**
```sql
-- WordPress creates these automatically:
-- PRIMARY KEY (meta_id)
-- KEY post_id (post_id)
-- KEY meta_key (meta_key(191))

-- Add composite index for common queries
CREATE INDEX idx_post_meta_key_value ON wp_postmeta(post_id, meta_key(50), meta_value(50));
```

**Custom Meta Index:**
```php
function add_custom_meta_index() {
	global $wpdb;

	$index_name = 'idx_featured_products';
	$indexes = $wpdb->get_results( $wpdb->prepare(
		"SHOW INDEXES FROM {$wpdb->postmeta} WHERE Key_name = %s",
		$index_name
	) );

	if ( empty( $indexes ) ) {
		$wpdb->query( "CREATE INDEX {$index_name} ON {$wpdb->postmeta}(meta_key, meta_value(50)) WHERE meta_key = 'featured'" );
	}
}
```

### Taxonomy Indexes

**Term Relationships:**
```sql
-- WordPress indexes:
-- PRIMARY KEY (object_id, term_taxonomy_id)
-- KEY term_taxonomy_id (term_taxonomy_id)

-- Usually sufficient, but can add:
CREATE INDEX idx_object_term ON wp_term_relationships(object_id, term_taxonomy_id);
```

---

## 6. Index Maintenance

### Monitoring Index Usage

**Check Index Usage:**
```sql
-- MySQL 5.7+
SELECT
    object_schema,
    object_name,
    index_name,
    count_read,
    count_write
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE object_schema = 'wordpress'
ORDER BY count_read DESC;
```

### Rebuilding Indexes

**When to Rebuild:**
- After large data imports
- After deleting many rows
- When index becomes fragmented

**Rebuild Index:**
```sql
-- Rebuild index
ALTER TABLE wp_posts DROP INDEX idx_post_title;
CREATE INDEX idx_post_title ON wp_posts(post_title);

-- Or optimize table (rebuilds all indexes)
OPTIMIZE TABLE wp_posts;
```

### Index Overhead

**Trade-offs:**
- Indexes speed up SELECT queries
- Indexes slow down INSERT/UPDATE/DELETE
- Indexes use disk space

**Best Practices:**
- Don't over-index
- Index only frequently queried columns
- Monitor index usage
- Remove unused indexes

---

## 7. WordPress-Specific Index Considerations

### Options Table

**Autoloaded Options:**
```sql
-- WordPress loads all autoloaded options
-- Index on autoload helps
CREATE INDEX idx_autoload ON wp_options(autoload);
```

### Post Meta Queries

**Common Query Pattern:**
```php
// This query benefits from composite index
$query = new WP_Query( array(
	'meta_query' => array(
		array(
			'key' => 'price',
			'value' => 100,
			'compare' => '>',
		),
	),
) );
```

**Optimal Index:**
```sql
-- Composite index for meta queries
CREATE INDEX idx_meta_key_value ON wp_postmeta(meta_key(50), meta_value(50));
```

### User Meta

**User Meta Indexes:**
```sql
-- WordPress creates:
-- KEY user_id (user_id)
-- KEY meta_key (meta_key(191))

-- Can add composite for common queries
CREATE INDEX idx_user_meta_key_value ON wp_usermeta(user_id, meta_key(50), meta_value(50));
```

---

## Exam Tips

### Key Points to Remember

1. **Index Types:**
   - Primary: Automatic, unique, one per table
   - Secondary: On non-primary columns
   - Composite: Multiple columns, order matters
   - Unique: Ensures uniqueness

2. **When to Index:**
   - Columns in WHERE clauses
   - Columns in JOIN conditions
   - Columns in ORDER BY
   - Foreign key columns

3. **Diagnosing:**
   - Use EXPLAIN to check index usage
   - Look for type: ALL (bad) vs ref (good)
   - Check key column for index name
   - Monitor slow query log

4. **Best Practices:**
   - Don't over-index
   - Composite index column order matters
   - Rebuild indexes after large imports
   - Monitor index usage

5. **WordPress Specific:**
   - Core tables have indexes
   - Add indexes for custom queries
   - Meta tables benefit from composite indexes
   - Options table autoload index helps

---

## Additional Resources

- [MySQL Indexes - MySQL Documentation](https://dev.mysql.com/doc/refman/8.0/en/mysql-indexes.html)
- [EXPLAIN Output Format - MySQL Documentation](https://dev.mysql.com/doc/refman/8.0/en/explain-output.html)
- [Query Monitor Plugin](https://wordpress.org/plugins/query-monitor/)
- Core Files:
  - `wp-admin/includes/schema.php` - Database schema definitions
