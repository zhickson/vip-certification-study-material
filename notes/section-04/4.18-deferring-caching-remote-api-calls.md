# 4.18 Deferring or Caching Remote API Calls - Study Notes

## Overview

Remote API calls can add significant latency to page loads. Understanding strategies to reduce latency through caching and deferring is crucial for WordPress performance.

**Key Reference:** [HTTP API - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/http/)

---

## 1. Caching Responses with Transients

### Basic Caching

**Cache API Response:**
```php
function get_api_data() {
	$cache_key = 'api_data';
	$data = get_transient( $cache_key );

	if ( false === $data ) {
		$response = wp_remote_get( 'https://api.example.com/data' );

		if ( ! is_wp_error( $response ) ) {
			$data = json_decode( wp_remote_retrieve_body( $response ), true );
			set_transient( $cache_key, $data, HOUR_IN_SECONDS );
		}
	}

	return $data;
}
```

### Cache with Object Cache

**Use Object Cache:**
```php
function get_api_data() {
	$cache_key = 'api_data';
	$data = wp_cache_get( $cache_key );

	if ( false === $data ) {
		$response = wp_remote_get( 'https://api.example.com/data' );

		if ( ! is_wp_error( $response ) ) {
			$data = json_decode( wp_remote_retrieve_body( $response ), true );
			wp_cache_set( $cache_key, $data, '', 3600 );
		}
	}

	return $data;
}
```

---

## 2. Prefetching or Scheduling Calls

### WP-Cron Scheduling

**Background Updates:**
```php
// Schedule API update
function schedule_api_update() {
	if ( ! wp_next_scheduled( 'update_api_data' ) ) {
		wp_schedule_event( time(), 'hourly', 'update_api_data' );
	}
}
add_action( 'wp', 'schedule_api_update' );

// Background update
add_action( 'update_api_data', function() {
	$response = wp_remote_get( 'https://api.example.com/data' );
	$data = json_decode( wp_remote_retrieve_body( $response ), true );
	set_transient( 'api_data', $data, HOUR_IN_SECONDS );
} );
```

### Prefetching

**Prefetch on Low Traffic:**
```php
// Prefetch during low traffic
add_action( 'wp', function() {
	// Only prefetch during off-peak hours
	$hour = (int) date( 'G' );
	if ( $hour >= 2 && $hour <= 5 ) {
		// Prefetch API data
		$response = wp_remote_get( 'https://api.example.com/data', array(
			'timeout' => 30,
		) );

		if ( ! is_wp_error( $response ) ) {
			$data = json_decode( wp_remote_retrieve_body( $response ), true );
			set_transient( 'api_data', $data, HOUR_IN_SECONDS );
		}
	}
} );
```

---

## 3. Avoiding Blocking User-Facing Requests

### Defer to Shutdown

**Non-Blocking:**
```php
// âœ… GOOD - Defer to shutdown
add_action( 'shutdown', function() {
	wp_remote_get( 'https://api.example.com/analytics', array(
		'blocking' => false,
		'timeout' => 0.01,
	) );
} );
```

### AJAX Loading

**Client-Side:**
```php
// Load via AJAX
add_action( 'wp_ajax_load_api_data', 'load_api_data' );
add_action( 'wp_ajax_nopriv_load_api_data', 'load_api_data' );

function load_api_data() {
	$data = get_transient( 'api_data' );

	if ( false === $data ) {
		$response = wp_remote_get( 'https://api.example.com/data' );
		$data = json_decode( wp_remote_retrieve_body( $response ), true );
		set_transient( 'api_data', $data, HOUR_IN_SECONDS );
	}

	wp_send_json_success( $data );
}
```

---

## Exam Tips

### Key Points to Remember

1. **Caching:**
   - Use transients for temporary data
   - Use object cache for frequently accessed data
   - Set appropriate expiration times

2. **Deferring:**
   - Use WP-Cron for background updates
   - Use shutdown hook for non-critical requests
   - Use AJAX for client-side loading

3. **Best Practices:**
   - Cache API responses
   - Prefetch during low traffic
   - Avoid blocking requests
   - Handle errors gracefully

---

## Additional Resources

- [HTTP API - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/http/)
- [Transients API - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/transients/)
