# 1.10 Roles and Capabilities - Study Notes

## Overview

WordPress uses a role-based access control (RBAC) system where users are assigned roles, and roles have capabilities. Capabilities define what actions a user can perform. Understanding how to create custom roles, assign capabilities, and use least-privilege principles is essential for secure WordPress development.

**Key Reference:** [Roles and Capabilities - WordPress Developer Resources](https://developer.wordpress.org/plugins/users/roles-and-capabilities/)

---

## 1. Create Custom Roles and Capabilities Programmatically

### Adding Custom Roles

**Function:** `add_role( $role, $display_name, $capabilities = array() )`

**Core Implementation:**
```1135:1141:wordpress/wp-includes/capabilities.php
function add_role( $role, $display_name, $capabilities = array() ) {
	if ( empty( $role ) ) {
		return;
	}

	return wp_roles()->add_role( $role, $display_name, $capabilities );
}
```

**Example:**
```php
add_action( 'init', 'my_plugin_add_custom_role' );
function my_plugin_add_custom_role() {
	add_role(
		'content_manager',
		__( 'Content Manager' ),
		array(
			'read'         => true,
			'edit_posts'   => true,
			'publish_posts' => true,
			'delete_posts' => true,
			'edit_others_posts' => true,
			'manage_categories' => true,
		)
	);
}
```

### Adding Capabilities to Existing Roles

**Function:** `get_role( $role )->add_cap( $cap, $grant = true )`

**Core Implementation:**
```59:62:wordpress/wp-includes/class-wp-role.php
	public function add_cap( $cap, $grant = true ) {
		$this->capabilities[ $cap ] = $grant;
		wp_roles()->add_cap( $this->name, $cap, $grant );
	}
```

**Example:**
```php
add_action( 'init', 'my_plugin_add_capabilities' );
function my_plugin_add_capabilities() {
	$editor = get_role( 'editor' );
	if ( $editor ) {
		$editor->add_cap( 'manage_products' );
		$editor->add_cap( 'edit_products' );
	}
}
```

### Removing Capabilities

```php
$role = get_role( 'editor' );
if ( $role ) {
	$role->remove_cap( 'manage_products' );
}
```

### Removing Roles

**Function:** `remove_role( $role )`

```php
register_deactivation_hook( __FILE__, 'my_plugin_remove_role' );
function my_plugin_remove_role() {
	remove_role( 'content_manager' );
}
```

---

## 2. Restrict Access via Capabilities Instead of Roles

### Why Use Capabilities?

- **Flexibility:** Mix and match capabilities
- **Granular Control:** Check specific permissions
- **Future-Proof:** Works with custom roles
- **Best Practice:** Follows least-privilege principle

### Checking Capabilities

**Function:** `current_user_can( $capability, ...$args )`

**Example:**
```php
// ✅ GOOD - Check capability
if ( current_user_can( 'edit_posts' ) ) {
	// Allow editing
}

// ❌ BAD - Check role
if ( current_user_can( 'editor' ) ) {
	// This actually checks if user has 'editor' capability, not role!
}
```

**With Arguments:**
```php
// Check if user can edit specific post
if ( current_user_can( 'edit_post', $post_id ) ) {
	// User can edit this post
}

// Check if user can edit specific user
if ( current_user_can( 'edit_user', $user_id ) ) {
	// User can edit this user
}
```

### User-Specific Capabilities

```php
// Add capability to specific user
$user = new WP_User( $user_id );
$user->add_cap( 'special_permission' );

// Remove capability from user
$user->remove_cap( 'special_permission' );
```

---

## 3. Avoid Storing Critical Security Logic in the Database

### Why Avoid Database Storage?

- **Performance:** Database queries are slower
- **Security:** Can be modified by plugins/themes
- **Reliability:** Database can be corrupted
- **Best Practice:** Logic should be in code

### Good Practices

**1. Check Capabilities in Code:**
```php
// ✅ GOOD - Check in code
add_action( 'admin_menu', 'my_plugin_add_menu' );
function my_plugin_add_menu() {
	if ( current_user_can( 'manage_options' ) ) {
		add_menu_page( 'Settings', 'Settings', 'manage_options', 'settings' );
	}
}
```

**2. Use Capability Maps:**
```php
// ✅ GOOD - Define in code
add_filter( 'map_meta_cap', 'my_plugin_map_caps', 10, 4 );
function my_plugin_map_caps( $caps, $cap, $user_id, $args ) {
	if ( 'edit_product' === $cap ) {
		$post = get_post( $args[0] );
		if ( $post && 'product' === $post->post_type ) {
			$caps = array( 'edit_products' );
		}
	}
	return $caps;
}
```

**3. Don't Store Permissions in Options:**
```php
// ❌ BAD - Storing in database
update_option( 'allowed_users', array( 1, 2, 3 ) );

// ✅ GOOD - Check capability
if ( current_user_can( 'manage_products' ) ) {
	// Allow access
}
```

---

## 4. Use Least-Privilege Principles When Designing Roles

### Least-Privilege Principle

Users should have the minimum permissions necessary to perform their tasks.

### Best Practices

**1. Create Specific Roles:**
```php
// ✅ GOOD - Specific role with minimal permissions
add_role(
	'content_editor',
	__( 'Content Editor' ),
	array(
		'read' => true,
		'edit_posts' => true,
		'publish_posts' => true,
		// No delete, no manage options
	)
);

// ❌ BAD - Too many permissions
add_role(
	'content_editor',
	__( 'Content Editor' ),
	array(
		'read' => true,
		'edit_posts' => true,
		'publish_posts' => true,
		'delete_posts' => true, // Not needed
		'manage_options' => true, // Definitely not needed!
	)
);
```

**2. Use Capability Checks:**
```php
// ✅ GOOD - Check specific capability
if ( current_user_can( 'edit_published_posts' ) ) {
	// Allow editing
}

// ❌ BAD - Check admin role
if ( current_user_can( 'administrator' ) ) {
	// Too broad
}
```

**3. Map Meta Capabilities:**
```php
add_filter( 'map_meta_cap', 'my_plugin_map_product_caps', 10, 4 );
function my_plugin_map_product_caps( $caps, $cap, $user_id, $args ) {
	// Map edit_product to edit_products capability
	if ( 'edit_product' === $cap ) {
		$caps = array( 'edit_products' );
	}
	return $caps;
}
```

### Default WordPress Capabilities

**Administrator:**
- `manage_options` - Manage settings
- `activate_plugins` - Activate plugins
- `edit_users` - Edit users
- All other capabilities

**Editor:**
- `moderate_comments` - Moderate comments
- `manage_categories` - Manage categories
- `publish_pages` - Publish pages
- `delete_others_posts` - Delete others' posts

**Author:**
- `publish_posts` - Publish posts
- `delete_published_posts` - Delete own posts
- `upload_files` - Upload files

**Contributor:**
- `edit_posts` - Edit posts
- `delete_posts` - Delete own posts

**Subscriber:**
- `read` - Read posts

---

## Exam Tips

### Key Points to Remember

1. **Roles vs Capabilities:**
   - Roles are collections of capabilities
   - Always check capabilities, not roles
   - Capabilities are more flexible

2. **Creating Roles:**
   - Use `add_role()` on init
   - Remove on deactivation
   - Follow least-privilege principle

3. **Security:**
   - Don't store security logic in database
   - Use `map_meta_cap` for custom post types
   - Check capabilities in code

4. **Best Practices:**
   - Use specific capabilities
   - Avoid checking roles directly
   - Follow least-privilege principle

---

## Additional Resources

- [Roles and Capabilities - WordPress Developer Resources](https://developer.wordpress.org/plugins/users/roles-and-capabilities/)
- [Function Reference: add_role](https://developer.wordpress.org/reference/functions/add_role/)
- [Function Reference: current_user_can](https://developer.wordpress.org/reference/functions/current_user_can/)
- Core Files:
  - `wp-includes/capabilities.php` - Role and capability functions
  - `wp-includes/class-wp-role.php` - WP_Role class
  - `wp-includes/class-wp-roles.php` - WP_Roles class
