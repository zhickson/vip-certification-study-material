# 1.14 Block Editor Basic Architecture - Study Notes

## Overview

The Block Editor (Gutenberg) is WordPress's modern content editing experience. Blocks are the fundamental units of content, and understanding how to register blocks, define attributes, and implement save/render functions is essential for modern WordPress development.

**Key Reference:** [Block Editor Handbook - WordPress Developer Resources](https://developer.wordpress.org/block-editor/)

---

## 1. Register Blocks with registerBlockType

### JavaScript Registration

**Function:** `registerBlockType( blockNameOrMetadata, settings )`

**Core Implementation:**
```6885:6910:wordpress/wp-includes/js/dist/blocks.js
function registerBlockType(blockNameOrMetadata, settings) {
  const name = isObject(blockNameOrMetadata) ? blockNameOrMetadata.name : blockNameOrMetadata;
  if (typeof name !== "string") {
    external_wp_warning_default()("Block names must be strings.");
    return;
  }
  if (!/^[a-z][a-z0-9-]*\/[a-z][a-z0-9-]*$/.test(name)) {
    external_wp_warning_default()(
      "Block names must contain a namespace prefix, include only lowercase alphanumeric characters or dashes, and start with a letter. Example: my-plugin/my-custom-block"
    );
    return;
  }
  if ((0,external_wp_data_namespaceObject.select)(store).getBlockType(name)) {
    external_wp_warning_default()('Block "' + name + '" is already registered.');
    return;
  }
  const { addBootstrappedBlockType, addUnprocessedBlockType } = unlock(
    (0,external_wp_data_namespaceObject.dispatch)(store)
  );
  if (isObject(blockNameOrMetadata)) {
    const metadata = getBlockSettingsFromMetadata(blockNameOrMetadata);
    addBootstrappedBlockType(name, metadata);
  }
  addUnprocessedBlockType(name, settings);
  return (0,external_wp_data_namespaceObject.select)(store).getBlockType(name);
}
```

**Example:**
```javascript
import { registerBlockType } from '@wordpress/blocks';

registerBlockType( 'my-plugin/my-block', {
	title: 'My Block',
	icon: 'smiley',
	category: 'common',
	edit: () => <p>Edit mode</p>,
	save: () => <p>Saved content</p>,
} );
```

### PHP Registration

**Function:** `register_block_type( $block_type, $args = array() )`

**Core Implementation:**
```783:789:wordpress/wp-includes/blocks.php
function register_block_type( $block_type, $args = array() ) {
	if ( is_string( $block_type ) && file_exists( $block_type ) ) {
		return register_block_type_from_metadata( $block_type, $args );
	}

	return WP_Block_Type_Registry::get_instance()->register( $block_type, $args );
}
```

**Example:**
```php
add_action( 'init', 'register_my_block' );
function register_my_block() {
	register_block_type( __DIR__ . '/blocks/my-block' );
}
```

---

## 2. Use block.json for Block Metadata

### block.json Structure

**Example:**
```1:31:wordpress/wp-includes/blocks/block/block.json
{
	"$schema": "https://schemas.wp.org/trunk/block.json",
	"apiVersion": 3,
	"name": "core/block",
	"title": "Pattern",
	"category": "reusable",
	"description": "Reuse this design across your site.",
	"keywords": [ "reusable" ],
	"textdomain": "default",
	"attributes": {
		"ref": {
			"type": "number"
		},
		"content": {
			"type": "object",
			"default": {}
		}
	},
	"providesContext": {
		"pattern/overrides": "content"
	},
	"supports": {
		"customClassName": false,
		"html": false,
		"inserter": false,
		"renaming": false,
		"interactivity": {
			"clientNavigation": true
		}
	}
}
```

**Key Fields:**
- `name` - Block name (namespace/block-name)
- `title` - Human-readable title
- `category` - Block category
- `attributes` - Block attributes
- `editorScript` - Editor JavaScript
- `editorStyle` - Editor CSS
- `style` - Front-end CSS
- `viewScript` - Front-end JavaScript
- `supports` - Block supports

### Registering from block.json

**Function:** `register_block_type_from_metadata( $file_or_folder, $args = array() )`

**Core Implementation:**
```461:763:wordpress/wp-includes/blocks.php
function register_block_type_from_metadata( $file_or_folder, $args = array() ) {
	/*
	 * Get an array of metadata from a PHP file.
	 * This improves performance for core blocks as it's only necessary to read a single PHP file
	 * instead of reading a JSON file per-block, and then decoding from JSON to PHP.
	 * Using a static variable ensures that the metadata is only read once per request.
	 */
```

**Example:**
```php
register_block_type_from_metadata( __DIR__ . '/blocks/my-block' );
```

---

## 3. Define Block Attributes and Implement Save/Render Functions

### Block Attributes

Attributes define the data structure of a block:

```javascript
attributes: {
	title: {
		type: 'string',
		source: 'attribute',
		selector: 'h2',
		attribute: 'data-title',
	},
	count: {
		type: 'number',
		default: 0,
	},
	isActive: {
		type: 'boolean',
		default: false,
	},
	items: {
		type: 'array',
		default: [],
	},
}
```

**Attribute Types:**
- `string` - Text value
- `number` - Numeric value
- `boolean` - True/false
- `array` - Array of values
- `object` - Object value

### Edit Function

The `edit` function renders the block in the editor:

```javascript
edit: ( { attributes, setAttributes } ) => {
	return (
		<div>
			<input
				value={ attributes.title }
				onChange={ ( value ) => setAttributes( { title: value } ) }
			/>
		</div>
	);
},
```

### Save Function

The `save` function defines how the block is saved:

```javascript
save: ( { attributes } ) => {
	return (
		<div>
			<h2>{ attributes.title }</h2>
		</div>
	);
},
```

**Dynamic Blocks:**
For dynamic blocks, return `null` from save and use PHP render callback:

```javascript
save: () => null,
```

```php
register_block_type( 'my-plugin/my-block', array(
	'render_callback' => 'render_my_block',
) );

function render_my_block( $attributes, $content ) {
	return '<div>' . esc_html( $attributes['title'] ) . '</div>';
}
```

---

## 4. Connect JavaScript (Editor) with PHP (Server-Side)

### Server-Side Rendering

**1. Register Block with PHP:**
```php
register_block_type( 'my-plugin/my-block', array(
	'render_callback' => 'render_my_block',
	'attributes' => array(
		'title' => array(
			'type' => 'string',
			'default' => '',
		),
	),
) );
```

**2. Render Function:**
```php
function render_my_block( $attributes, $content, $block ) {
	$title = isset( $attributes['title'] ) ? $attributes['title'] : '';

	ob_start();
	?>
	<div class="my-block">
		<h2><?php echo esc_html( $title ); ?></h2>
		<?php echo $content; ?>
	</div>
	<?php
	return ob_get_clean();
}
```

### Passing Data from PHP to JavaScript

**1. Use wp_localize_script:**
```php
wp_localize_script( 'my-block-editor', 'myBlockData', array(
	'apiUrl' => rest_url( 'wp/v2/posts' ),
	'nonce' => wp_create_nonce( 'wp_rest' ),
) );
```

**2. Use block.json:**
```json
{
	"editorScript": "file:./index.js",
	"editorStyle": "file:./index.css"
}
```

### Server-Side Block Registration

```php
add_action( 'init', 'register_my_blocks' );
function register_my_blocks() {
	// Register from block.json
	register_block_type_from_metadata( __DIR__ . '/blocks/my-block' );

	// Or register manually
	register_block_type( 'my-plugin/my-block', array(
		'editor_script' => 'my-block-editor',
		'editor_style' => 'my-block-editor-style',
		'style' => 'my-block-style',
		'render_callback' => 'render_my_block',
	) );
}
```

---

## Exam Tips

### Key Points to Remember

1. **Block Registration:**
   - Use `registerBlockType()` in JavaScript
   - Use `register_block_type()` in PHP
   - Block names must be `namespace/block-name`

2. **block.json:**
   - Modern way to define block metadata
   - Contains attributes, supports, scripts, styles
   - Used by `register_block_type_from_metadata()`

3. **Attributes:**
   - Define block data structure
   - Types: string, number, boolean, array, object
   - Can have default values

4. **Save vs Render:**
   - `save()` for static blocks
   - `render_callback` for dynamic blocks
   - Return `null` from save for dynamic blocks

---

## Additional Resources

- [Block Editor Handbook - WordPress Developer Resources](https://developer.wordpress.org/block-editor/)
- [Block API - WordPress Developer Resources](https://developer.wordpress.org/block-editor/reference-guides/block-api/)
- Core Files:
  - `wp-includes/blocks.php` - Block registration functions
  - `wp-includes/js/dist/blocks.js` - JavaScript block API
