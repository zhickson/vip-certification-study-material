# 1.8 Permalinks and Rewrite Rules - Study Notes

## Overview

WordPress uses a rewrite system to convert clean URLs into query strings that WordPress can understand. The rewrite API allows you to create custom URL structures for post types, taxonomies, and custom endpoints. Understanding how to register, flush, and troubleshoot rewrite rules is essential for custom WordPress development.

**Key Reference:** [Rewrite API - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/rewrite/)

---

## 1. Register Custom Rewrite Rules for CPTs/Taxonomies

### Custom Post Type Rewrite Rules

When registering a custom post type, you can define custom permalink structures:

```php
register_post_type( 'product', array(
	'public'      => true,
	'has_archive' => true,
	'rewrite'     => array(
		'slug'       => 'products',
		'with_front' => false,
		'feeds'      => true,
		'pages'      => true,
	),
) );
```

**Rewrite Arguments:**
- `slug` - URL slug (default: post type name)
- `with_front` - Whether to prepend front base (default: true)
- `feeds` - Whether to add feed rewrite rules (default: true)
- `pages` - Whether to add pagination support (default: true)
- `ep_mask` - Endpoint mask (default: EP_PERMALINK)

### Custom Taxonomy Rewrite Rules

```php
register_taxonomy( 'product_category', 'product', array(
	'public'  => true,
	'rewrite' => array(
		'slug'         => 'product-category',
		'with_front'   => false,
		'hierarchical' => true,
	),
) );
```

**Rewrite Arguments:**
- `slug` - URL slug (default: taxonomy name)
- `with_front` - Whether to prepend front base (default: true)
- `hierarchical` - Whether to use hierarchical URLs (default: false)
- `ep_mask` - Endpoint mask

### Adding Custom Rewrite Rules

**Function:** `add_rewrite_rule( $regex, $query, $after = 'bottom' )`

**Core Implementation:**
```140:144:wordpress/wp-includes/rewrite.php
function add_rewrite_rule( $regex, $query, $after = 'bottom' ) {
	global $wp_rewrite;

	$wp_rewrite->add_rule( $regex, $query, $after );
}
```

**Example:**
```php
add_action( 'init', 'my_plugin_add_rewrite_rules' );
function my_plugin_add_rewrite_rules() {
	add_rewrite_rule(
		'^products/([^/]+)/reviews/?$',
		'index.php?product=$matches[1]&reviews=1',
		'top'
	);
}
```

**Parameters:**
- `$regex` - Regular expression to match URL
- `$query` - Query string or array of query vars
- `$after` - 'top' or 'bottom' (priority)

### Adding Rewrite Tags

**Function:** `add_rewrite_tag( $tag, $regex, $query = '' )`

Creates custom rewrite tags (like %postname%):

**Core Implementation:**
```162:177:wordpress/wp-includes/rewrite.php
function add_rewrite_tag( $tag, $regex, $query = '' ) {
	// Validate the tag's name.
	if ( strlen( $tag ) < 3 || '%' !== $tag[0] || '%' !== $tag[ strlen( $tag ) - 1 ] ) {
		return;
	}

	global $wp_rewrite, $wp;

	if ( empty( $query ) ) {
		$qv = trim( $tag, '%' );
		$wp->add_query_var( $qv );
		$query = $qv . '=';
	}

	$wp_rewrite->add_rewrite_tag( $tag, $regex, $query );
}
```

**Example:**
```php
add_action( 'init', 'my_plugin_add_rewrite_tags' );
function my_plugin_add_rewrite_tags() {
	// Add custom tag %year%
	add_rewrite_tag( '%year%', '([0-9]{4})', 'year=' );

	// Use in permalink structure
	add_permastruct( 'product', 'products/%year%/%productname%', array(
		'with_front' => false,
	) );
}
```

### Adding Query Vars

Custom rewrite rules need corresponding query vars:

```php
add_filter( 'query_vars', 'my_plugin_add_query_vars' );
function my_plugin_add_query_vars( $vars ) {
	$vars[] = 'reviews';
	$vars[] = 'year';
	return $vars;
}
```

---

## 2. Flush Rewrite Rules Correctly and Avoid Unnecessary Flushes

### When to Flush Rewrite Rules

Rewrite rules should be flushed when:
- Registering new post types or taxonomies
- Changing rewrite structures
- Adding custom rewrite rules
- On plugin activation/deactivation

### Flush Methods

**Function:** `flush_rewrite_rules( $hard = true )`

**Core Implementation:**
```278:284:wordpress/wp-includes/rewrite.php
function flush_rewrite_rules( $hard = true ) {
	global $wp_rewrite;

	if ( is_callable( array( $wp_rewrite, 'flush_rules' ) ) ) {
		$wp_rewrite->flush_rules( $hard );
	}
}
```

**Hard vs Soft Flush:**
- **Hard flush** (`$hard = true`): Updates `.htaccess` file (Apache) or `web.config` (IIS)
- **Soft flush** (`$hard = false`): Only updates `rewrite_rules` option in database

### Best Practices

**1. Flush on Activation Only:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );
function my_plugin_activate() {
	// Register post types/taxonomies
	my_plugin_register_post_types();

	// Flush rewrite rules
	flush_rewrite_rules();
}

register_deactivation_hook( __FILE__, 'my_plugin_deactivate' );
function my_plugin_deactivate() {
	flush_rewrite_rules();
}
```

**2. Avoid Flushing on Every Request:**

```php
// ❌ BAD - Flushes on every page load
add_action( 'init', 'my_plugin_bad_flush' );
function my_plugin_bad_flush() {
	flush_rewrite_rules(); // Very expensive!
}

// ✅ GOOD - Flush only when needed
add_action( 'init', 'my_plugin_good_init' );
function my_plugin_good_init() {
	// Just register, don't flush
	my_plugin_register_post_types();
}
```

**3. Use Transient to Track Changes:**

```php
add_action( 'init', 'my_plugin_maybe_flush' );
function my_plugin_maybe_flush() {
	$version = get_option( 'my_plugin_rewrite_version', '1.0' );

	if ( version_compare( $version, '1.1', '<' ) ) {
		flush_rewrite_rules();
		update_option( 'my_plugin_rewrite_version', '1.1' );
	}
}
```

**4. Flush After Rule Registration:**

```php
add_action( 'init', 'my_plugin_register_rules' );
function my_plugin_register_rules() {
	// Register rules
	add_rewrite_rule( '^custom/([^/]+)/?$', 'index.php?custom=$matches[1]', 'top' );

	// Don't flush here - wait for activation or manual flush
}

// Flush on settings save
add_action( 'admin_init', 'my_plugin_save_settings' );
function my_plugin_save_settings() {
	if ( isset( $_POST['my_plugin_flush_rules'] ) ) {
		flush_rewrite_rules();
	}
}
```

### Core Flush Implementation

**Core Implementation:**
```1873:1908:wordpress/wp-includes/class-wp-rewrite.php
	public function flush_rules( $hard = true ) {
		static $do_hard_later = null;

		// Prevent this action from running before everyone has registered their rewrites.
		if ( ! did_action( 'wp_loaded' ) ) {
			add_action( 'wp_loaded', array( $this, 'flush_rules' ) );
			$do_hard_later = ( isset( $do_hard_later ) ) ? $do_hard_later || $hard : $hard;
			return;
		}

		if ( isset( $do_hard_later ) ) {
			$hard = $do_hard_later;
			unset( $do_hard_later );
		}

		$this->refresh_rewrite_rules();

		/**
		 * Filters whether a "hard" rewrite rule flush should be performed when requested.
		 *
		 * @since 3.7.0
		 *
		 * @param bool $hard Whether to flush rewrite rules "hard". Default true.
		 */
		if ( ! $hard || ! apply_filters( 'flush_rewrite_rules_hard', true ) ) {
			return;
		}
		if ( function_exists( 'save_mod_rewrite_rules' ) ) {
			save_mod_rewrite_rules();
		}
		if ( function_exists( 'iis7_save_url_rewrite_rules' ) ) {
			iis7_save_url_rewrite_rules();
		}
	}
```

**Important:** WordPress automatically defers flushing if called before `wp_loaded` hook.

---

## 3. Troubleshoot Common Permalink Issues

### Common Issues and Solutions

#### 1. 404 Errors on Custom URLs

**Problem:** Custom rewrite rules return 404.

**Solutions:**
- Flush rewrite rules: Settings → Permalinks → Save Changes
- Check rule priority (use 'top' for custom rules)
- Verify regex pattern matches URL structure
- Check query vars are registered

```php
// Debug rewrite rules
add_action( 'init', 'debug_rewrite_rules' );
function debug_rewrite_rules() {
	if ( ! current_user_can( 'manage_options' ) ) {
		return;
	}

	global $wp_rewrite;
	error_log( print_r( $wp_rewrite->rules, true ) );
}
```

#### 2. Rules Not Taking Effect

**Problem:** Changes to rewrite rules don't work.

**Solutions:**
- Flush rewrite rules after changes
- Check rule is registered before flush
- Verify rule regex is correct
- Check for conflicting rules

#### 3. Pagination Not Working

**Problem:** Pagination links return 404.

**Solutions:**
- Ensure `'pages' => true` in rewrite args
- Check pagination base matches permalink structure
- Verify rewrite rules include pagination

```php
register_post_type( 'product', array(
	'rewrite' => array(
		'slug'  => 'products',
		'pages' => true, // Enable pagination
	),
) );
```

#### 4. Hierarchical URLs Not Working

**Problem:** Taxonomy hierarchical URLs don't work.

**Solutions:**
- Set `'hierarchical' => true` in rewrite args
- Flush rewrite rules
- Check parent term slugs are correct

```php
register_taxonomy( 'category', 'product', array(
	'rewrite' => array(
		'hierarchical' => true, // Enable hierarchical URLs
	),
) );
```

### Debugging Tools

#### 1. Check Registered Rules

```php
global $wp_rewrite;
print_r( $wp_rewrite->rules );
```

#### 2. Check Query Vars

```php
global $wp;
print_r( $wp->public_query_vars );
```

#### 3. Use Rewrite Rules Inspector Plugin

Install "Rewrite Rules Inspector" plugin to view all registered rules.

#### 4. Test URL Matching

```php
add_action( 'template_redirect', 'test_rewrite_match' );
function test_rewrite_match() {
	if ( ! current_user_can( 'manage_options' ) ) {
		return;
	}

	global $wp;
	error_log( 'Matched query vars: ' . print_r( $wp->query_vars, true ) );
}
```

---

## 4. Handle Multilingual or Complex Permalink Structures

### Multilingual Permalinks

For multilingual sites, prefix URLs with language codes:

```php
add_action( 'init', 'add_language_rewrite_rules' );
function add_language_rewrite_rules() {
	$languages = array( 'en', 'fr', 'de' );

	foreach ( $languages as $lang ) {
		add_rewrite_rule(
			"^{$lang}/products/([^/]+)/?$",
			'index.php?product=$matches[1]&lang=' . $lang,
			'top'
		);
	}
}

// Add language query var
add_filter( 'query_vars', 'add_language_query_var' );
function add_language_query_var( $vars ) {
	$vars[] = 'lang';
	return $vars;
}
```

### Complex Permalink Structures

**Example: Date-based product URLs:**

```php
add_action( 'init', 'register_product_permastruct' );
function register_product_permastruct() {
	// Add rewrite tags
	add_rewrite_tag( '%product_year%', '([0-9]{4})' );
	add_rewrite_tag( '%product_month%', '([0-9]{2})' );
	add_rewrite_tag( '%product_name%', '([^/]+)' );

	// Add permalink structure
	add_permastruct( 'product', 'products/%product_year%/%product_month%/%product_name%', array(
		'with_front' => false,
	) );
}

// Generate permalink
add_filter( 'post_type_link', 'product_permalink', 10, 2 );
function product_permalink( $post_link, $post ) {
	if ( 'product' !== $post->post_type ) {
		return $post_link;
	}

	$year = get_the_date( 'Y', $post->ID );
	$month = get_the_date( 'm', $post->ID );
	$name = $post->post_name;

	$post_link = str_replace( '%product_year%', $year, $post_link );
	$post_link = str_replace( '%product_month%', $month, $post_link );
	$post_link = str_replace( '%product_name%', $name, $post_link );

	return $post_link;
}
```

### Custom Endpoints

Add custom endpoints to existing URLs:

```php
add_action( 'init', 'add_product_endpoints' );
function add_product_endpoints() {
	add_rewrite_endpoint( 'reviews', EP_PERMALINK | EP_PAGES );
	add_rewrite_endpoint( 'specifications', EP_PERMALINK );
}

// Access endpoint
add_action( 'template_redirect', 'handle_product_endpoints' );
function handle_product_endpoints() {
	global $wp_query;

	if ( isset( $wp_query->query_vars['reviews'] ) ) {
		// Load reviews template
		include get_template_directory() . '/product-reviews.php';
		exit;
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Rewrite Rule Registration:**
   - Register on `init` hook
   - Use `add_rewrite_rule()` for custom rules
   - Add corresponding query vars
   - Flush rules after registration

2. **Flushing Rules:**
   - Only flush on activation/deactivation
   - Never flush on every request
   - Use hard flush for .htaccess updates
   - WordPress defers flush if called before `wp_loaded`

3. **Common Issues:**
   - 404 errors: Flush rules, check regex, verify query vars
   - Rules not working: Check priority, verify registration order
   - Pagination: Enable `pages` in rewrite args

4. **Best Practices:**
   - Use 'top' priority for custom rules
   - Test regex patterns carefully
   - Register query vars before using them
   - Avoid unnecessary flushes

---

## Additional Resources

- [Rewrite API - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/rewrite/)
- [Function Reference: add_rewrite_rule](https://developer.wordpress.org/reference/functions/add_rewrite_rule/)
- [Function Reference: flush_rewrite_rules](https://developer.wordpress.org/reference/functions/flush_rewrite_rules/)
- Core Files:
  - `wp-includes/rewrite.php` - Rewrite API functions
  - `wp-includes/class-wp-rewrite.php` - WP_Rewrite class
