# 1.15 Custom Post Types (CPTs) - Study Notes

## Overview

Custom Post Types (CPTs) allow you to create new content types beyond the default posts and pages. Understanding when and how to implement CPTs effectively, including integration with taxonomies, rewrite rules, and capabilities, is essential for WordPress development.

**Key Reference:** [Post Types - WordPress Developer Resources](https://developer.wordpress.org/plugins/post-types/)

---

## 1. Register CPTs with register_post_type

### Registering Custom Post Types

**Function:** `register_post_type( $post_type, $args = array() )`

**Core Implementation:**
```1815:1869:wordpress/wp-includes/post.php
function register_post_type( $post_type, $args = array() ) {
	global $wp_post_types;

	if ( ! is_array( $wp_post_types ) ) {
		$wp_post_types = array();
	}

	// Sanitize post type name.
	$post_type = sanitize_key( $post_type );

	if ( empty( $post_type ) || strlen( $post_type ) > 20 ) {
		_doing_it_wrong( __FUNCTION__, __( 'Post type names must be between 1 and 20 characters in length.' ), '4.2.0' );
		return new WP_Error( 'post_type_length_invalid', __( 'Post type names must be between 1 and 20 characters in length.' ) );
	}

	$post_type_object = new WP_Post_Type( $post_type, $args );
	$post_type_object->add_supports();
	$post_type_object->add_rewrite_rules();
	$post_type_object->register_meta_boxes();

	$wp_post_types[ $post_type ] = $post_type_object;

	$post_type_object->add_hooks();
	$post_type_object->register_taxonomies();

	/**
	 * Fires after a post type is registered.
	 *
	 * @since 3.3.0
	 * @since 4.6.0 Converted the `$post_type` parameter to accept a `WP_Post_Type` object.
	 *
	 * @param string       $post_type        Post type.
	 * @param WP_Post_Type $post_type_object Arguments used to register the post type.
	 */
	do_action( 'registered_post_type', $post_type, $post_type_object );

	/**
	 * Fires after a specific post type is registered.
	 *
	 * The dynamic portion of the filter name, `$post_type`, refers to the post type key.
	 *
	 * Possible hook names include:
	 *
	 *  - `registered_post_type_post`
	 *  - `registered_post_type_page`
	 *
	 * @since 6.0.0
	 *
	 * @param string       $post_type        Post type.
	 * @param WP_Post_Type $post_type_object Arguments used to register the post type.
	 */
	do_action( "registered_post_type_{$post_type}", $post_type_object );

	return $post_type_object;
}
```

**Example:**
```php
add_action( 'init', 'register_product_post_type' );
function register_product_post_type() {
	register_post_type( 'product', array(
		'labels' => array(
			'name' => __( 'Products' ),
			'singular_name' => __( 'Product' ),
			'add_new' => __( 'Add New' ),
			'add_new_item' => __( 'Add New Product' ),
			'edit_item' => __( 'Edit Product' ),
			'new_item' => __( 'New Product' ),
			'view_item' => __( 'View Product' ),
			'search_items' => __( 'Search Products' ),
			'not_found' => __( 'No products found' ),
			'not_found_in_trash' => __( 'No products found in Trash' ),
		),
		'public' => true,
		'has_archive' => true,
		'supports' => array( 'title', 'editor', 'thumbnail', 'excerpt' ),
		'rewrite' => array( 'slug' => 'products' ),
	) );
}
```

**Key Arguments:**
- `public` - Whether post type is publicly queryable
- `has_archive` - Enable archive page
- `supports` - Features supported (title, editor, thumbnail, etc.)
- `rewrite` - URL rewrite rules
- `capability_type` - Capability type for permissions
- `show_in_rest` - Enable REST API

---

## 2. Integrate CPTs with Custom Taxonomies

### Registering Taxonomies for CPTs

```php
add_action( 'init', 'register_product_taxonomies' );
function register_product_taxonomies() {
	// Register taxonomy
	register_taxonomy( 'product_category', 'product', array(
		'hierarchical' => true,
		'labels' => array(
			'name' => __( 'Product Categories' ),
			'singular_name' => __( 'Product Category' ),
		),
		'show_ui' => true,
		'show_admin_column' => true,
		'rewrite' => array( 'slug' => 'product-category' ),
	) );
}
```

### Querying CPTs with Taxonomies

```php
$args = array(
	'post_type' => 'product',
	'tax_query' => array(
		array(
			'taxonomy' => 'product_category',
			'field' => 'slug',
			'terms' => 'electronics',
		),
	),
);

$query = new WP_Query( $args );
```

---

## 3. Define Rewrite Rules and Capabilities for CPTs

### Rewrite Rules

```php
register_post_type( 'product', array(
	'public' => true,
	'rewrite' => array(
		'slug' => 'products',
		'with_front' => false,
		'feeds' => true,
		'pages' => true,
	),
) );
```

**Rewrite Arguments:**
- `slug` - URL slug
- `with_front` - Prepend front base
- `feeds` - Enable feed rewrite rules
- `pages` - Enable pagination

### Capabilities

```php
register_post_type( 'product', array(
	'capability_type' => 'product',
	'capabilities' => array(
		'edit_post' => 'edit_product',
		'read_post' => 'read_product',
		'delete_post' => 'delete_product',
		'edit_posts' => 'edit_products',
		'edit_others_posts' => 'edit_others_products',
		'publish_posts' => 'publish_products',
		'read_private_posts' => 'read_private_products',
	),
	'map_meta_cap' => true,
) );
```

**Using map_meta_cap:**
```php
add_filter( 'map_meta_cap', 'map_product_caps', 10, 4 );
function map_product_caps( $caps, $cap, $user_id, $args ) {
	if ( 'edit_product' === $cap ) {
		$post = get_post( $args[0] );
		if ( $post && 'product' === $post->post_type ) {
			$caps = array( 'edit_products' );
		}
	}
	return $caps;
}
```

---

## 4. Understand Appropriate Use Cases

### When to Use CPTs

**Good Use Cases:**
- Products, Events, Testimonials
- Content with distinct structure
- Need separate admin interface
- Different permissions required
- Custom archive pages needed

**Not Appropriate:**
- Simple content variations (use post formats)
- Temporary content (use custom fields)
- User-generated content (use comments/posts)

### Best Practices

1. **Use Descriptive Names:**
```php
// ✅ GOOD
register_post_type( 'product', ... );

// ❌ BAD
register_post_type( 'pt1', ... );
```

2. **Set Appropriate Supports:**
```php
'supports' => array(
	'title',
	'editor',
	'thumbnail',
	'excerpt',
	'custom-fields',
),
```

3. **Enable REST API:**
```php
'show_in_rest' => true,
'rest_base' => 'products',
```

4. **Flush Rewrite Rules:**
```php
register_activation_hook( __FILE__, 'flush_rewrite_rules' );
```

---

## Exam Tips

### Key Points to Remember

1. **Registration:**
   - Use `register_post_type()` on `init` hook
   - Post type names: 1-20 characters, lowercase
   - Always flush rewrite rules after registration

2. **Integration:**
   - Register taxonomies for CPTs
   - Use `tax_query` to filter by taxonomy
   - Set appropriate capabilities

3. **Rewrite Rules:**
   - Configure `rewrite` argument
   - Use `slug` for URL structure
   - Flush rules after changes

4. **Use Cases:**
   - Use for distinct content types
   - Not for simple variations
   - Consider permissions and structure

---

## Additional Resources

- [Post Types - WordPress Developer Resources](https://developer.wordpress.org/plugins/post-types/)
- [Function Reference: register_post_type](https://developer.wordpress.org/reference/functions/register_post_type/)
- Core Files:
  - `wp-includes/post.php` - Post type functions
  - `wp-includes/class-wp-post-type.php` - WP_Post_Type class
