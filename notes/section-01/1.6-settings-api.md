# 1.6 Settings API - Study Notes

## Overview

The Settings API provides a standardised way to create secure and extensible admin settings pages in WordPress. It handles form rendering, validation, sanitization, and saving automatically, following WordPress security best practices. The API consists of three main components: settings (options), sections (groups of fields), and fields (individual inputs).

**Key Reference:** [Settings API - WordPress Developer Resources](https://developer.wordpress.org/plugins/settings/settings-api/)

---

## 1. Register Settings, Sections, and Fields

### Registering Settings

**Function:** `register_setting( $option_group, $option_name, $args = array() )`

Registers a setting with WordPress, enabling automatic sanitization and saving.

**Core Implementation:**
```2996:3091:wordpress/wp-includes/option.php
function register_setting( $option_group, $option_name, $args = array() ) {
	global $new_allowed_options, $wp_registered_settings;

	/*
	 * In 5.5.0, the `$new_whitelist_options` global variable was renamed to `$new_allowed_options`.
	 * Please consider writing more inclusive code.
	 */
	$GLOBALS['new_whitelist_options'] = &$new_allowed_options;

	$defaults = array(
		'type'              => 'string',
		'group'             => $option_group,
		'label'             => '',
		'description'       => '',
		'sanitize_callback' => null,
		'show_in_rest'      => false,
	);

	// Back-compat: old sanitize callback is added.
	if ( is_callable( $args ) ) {
		$args = array(
			'sanitize_callback' => $args,
		);
	}

	/**
	 * Filters the registration arguments when registering a setting.
	 *
	 * @since 4.7.0
	 *
	 * @param array  $args         Array of setting registration arguments.
	 * @param array  $defaults     Array of default arguments.
	 * @param string $option_group Setting group.
	 * @param string $option_name  Setting name.
	 */
	$args = apply_filters( 'register_setting_args', $args, $defaults, $option_group, $option_name );

	$args = wp_parse_args( $args, $defaults );

	// Require an item schema when registering settings with an array type.
	if ( false !== $args['show_in_rest'] && 'array' === $args['type'] && ( ! is_array( $args['show_in_rest'] ) || ! isset( $args['show_in_rest']['schema']['items'] ) ) ) {
		_doing_it_wrong( __FUNCTION__, __( 'When registering an "array" setting to show in the REST API, you must specify the schema for each array item in "show_in_rest.schema.items".' ), '5.4.0' );
	}

	if ( ! is_array( $wp_registered_settings ) ) {
		$wp_registered_settings = array();
	}

	if ( 'misc' === $option_group ) {
		_deprecated_argument(
			__FUNCTION__,
			'3.0.0',
			sprintf(
				/* translators: %s: misc */
				__( 'The "%s" options group has been removed. Use another settings group.' ),
				'misc'
			)
		);
		$option_group = 'general';
	}

	if ( 'privacy' === $option_group ) {
		_deprecated_argument(
			__FUNCTION__,
			'3.5.0',
			sprintf(
				/* translators: %s: privacy */
				__( 'The "%s" options group has been removed. Use another settings group.' ),
				'privacy'
			)
		);
		$option_group = 'reading';
	}

	$new_allowed_options[ $option_group ][] = $option_name;

	if ( ! empty( $args['sanitize_callback'] ) ) {
		add_filter( "sanitize_option_{$option_name}", $args['sanitize_callback'] );
	}
	if ( array_key_exists( 'default', $args ) ) {
		add_filter( "default_option_{$option_name}", 'filter_default_option', 10, 3 );
	}

	/**
	 * Fires immediately before the setting is registered but after its filters are in place.
	 *
	 * @since 5.5.0
	 *
	 * @param string $option_group Setting group.
	 * @param string $option_name  Setting name.
	 * @param array  $args         Array of setting registration arguments.
	 */
	do_action( 'register_setting', $option_group, $option_name, $args );

	$wp_registered_settings[ $option_name ] = $args;
}
```

**Arguments:**
- `$option_group` - Settings group (e.g., 'my_plugin_settings')
- `$option_name` - Option name to save
- `$args` - Array with:
  - `type` - Data type: 'string', 'boolean', 'integer', 'number', 'array', 'object'
  - `sanitize_callback` - Callback function for sanitization
  - `default` - Default value
  - `show_in_rest` - Expose in REST API (boolean or array with schema)
  - `label` - Setting label
  - `description` - Setting description

**Example:**
```php
add_action( 'admin_init', 'my_plugin_register_settings' );
function my_plugin_register_settings() {
	register_setting(
		'my_plugin_settings',           // Option group
		'my_plugin_api_key',            // Option name
		array(
			'type'              => 'string',
			'sanitize_callback' => 'sanitize_text_field',
			'default'           => '',
			'show_in_rest'      => false,
		)
	);
}
```

### Adding Settings Sections

**Function:** `add_settings_section( $id, $title, $callback, $page, $args = array() )`

Adds a section to group related settings fields together.

**Core Implementation:**
```1632:1673:wordpress/wp-admin/includes/template.php
function add_settings_section( $id, $title, $callback, $page, $args = array() ) {

	global $wp_settings_sections;

	if ( 'misc' === $page ) {
		_deprecated_argument(
			__FUNCTION__,
			'3.0.0',
			sprintf(
				/* translators: %s: misc */
				__( 'The "%s" options group has been removed. Use another settings group.' ),
				'misc'
			)
		);
		$page = 'general';
	}

	if ( 'privacy' === $page ) {
		_deprecated_argument(
			__FUNCTION__,
			'3.5.0',
			sprintf(
				/* translators: %s: privacy */
				__( 'The "%s" options group has been removed. Use another settings group.' ),
				'privacy'
			)
		);
		$page = 'reading';
	}

	$defaults = array(
		'id'             => $id,
		'title'          => $title,
		'callback'       => $callback,
		'before_section' => '',
		'after_section'  => '',
		'section_class'  => '',
	);

	$section = wp_parse_args( $args, $defaults );

	if ( ! isset( $wp_settings_sections[ $page ] ) ) {
		$wp_settings_sections[ $page ] = array();
	}

	$wp_settings_sections[ $page ][ $id ] = $section;
}
```

**Example:**
```php
add_action( 'admin_init', 'my_plugin_add_settings_sections' );
function my_plugin_add_settings_sections() {
	add_settings_section(
		'my_plugin_api_section',        // Section ID
		__( 'API Settings' ),            // Section title
		'my_plugin_api_section_callback', // Callback for section description
		'my_plugin_settings'            // Settings page slug
	);
}

function my_plugin_api_section_callback( $args ) {
	echo '<p>' . esc_html__( 'Configure API connection settings.' ) . '</p>';
}
```

### Adding Settings Fields

**Function:** `add_settings_field( $id, $title, $callback, $page, $section = 'default', $args = array() )`

Adds an individual field to a settings section.

**Core Implementation:**
```1710:1745:wordpress/wp-admin/includes/template.php
function add_settings_field( $id, $title, $callback, $page, $section = 'default', $args = array() ) {


	if ( 'misc' === $page ) {
		_deprecated_argument(
			__FUNCTION__,
			'3.0.0',
			sprintf(
				/* translators: %s: misc */
				__( 'The "%s" options group has been removed. Use another settings group.' ),
				'misc'
			)
		);
		$page = 'general';
	}

	if ( 'privacy' === $page ) {
		_deprecated_argument(
			__FUNCTION__,
			'3.5.0',
			sprintf(
				/* translators: %s: privacy */
				__( 'The "%s" options group has been removed. Use another settings group.' ),
				'privacy'
			)
		);
		$page = 'reading';
	}

	$wp_settings_fields[ $page ][ $section ][ $id ] = array(
		'id'       => $id,
		'title'    => $title,
		'callback' => $callback,
		'args'     => $args,
	);
}
```

**Example:**
```php
add_action( 'admin_init', 'my_plugin_add_settings_fields' );
function my_plugin_add_settings_fields() {
	add_settings_field(
		'my_plugin_api_key',              // Field ID
		__( 'API Key' ),                   // Field title
		'my_plugin_api_key_field_callback', // Field callback
		'my_plugin_settings',             // Settings page
		'my_plugin_api_section',          // Section ID
		array(                             // Additional args
			'label_for' => 'my_plugin_api_key',
			'class'     => 'my-plugin-field',
		)
	);
}

function my_plugin_api_key_field_callback( $args ) {
	$value = get_option( 'my_plugin_api_key', '' );
	?>
	<input
		type="text"
		id="<?php echo esc_attr( $args['label_for'] ); ?>"
		name="my_plugin_api_key"
		value="<?php echo esc_attr( $value ); ?>"
		class="regular-text"
	/>
	<p class="description"><?php esc_html_e( 'Enter your API key.' ); ?></p>
	<?php
}
```

### Complete Example

```php
// 1. Create settings page
add_action( 'admin_menu', 'my_plugin_add_settings_page' );
function my_plugin_add_settings_page() {
	add_options_page(
		__( 'My Plugin Settings' ),
		__( 'My Plugin' ),
		'manage_options',
		'my-plugin-settings',
		'my_plugin_settings_page_callback'
	);
}

// 2. Register settings, sections, and fields
add_action( 'admin_init', 'my_plugin_register_settings' );
function my_plugin_register_settings() {
	// Register setting
	register_setting(
		'my_plugin_settings',
		'my_plugin_api_key',
		array(
			'type'              => 'string',
			'sanitize_callback' => 'sanitize_text_field',
			'default'           => '',
		)
	);

	// Add section
	add_settings_section(
		'my_plugin_api_section',
		__( 'API Settings' ),
		'my_plugin_section_callback',
		'my_plugin_settings'
	);

	// Add field
	add_settings_field(
		'my_plugin_api_key',
		__( 'API Key' ),
		'my_plugin_api_key_callback',
		'my_plugin_settings',
		'my_plugin_api_section',
		array( 'label_for' => 'my_plugin_api_key' )
	);
}

// 3. Section callback
function my_plugin_section_callback() {
	echo '<p>' . esc_html__( 'Configure API settings.' ) . '</p>';
}

// 4. Field callback
function my_plugin_api_key_callback( $args ) {
	$value = get_option( 'my_plugin_api_key', '' );
	?>
	<input
		type="text"
		id="<?php echo esc_attr( $args['label_for'] ); ?>"
		name="my_plugin_api_key"
		value="<?php echo esc_attr( $value ); ?>"
		class="regular-text"
	/>
	<?php
}

// 5. Settings page callback
function my_plugin_settings_page_callback() {
	if ( ! current_user_can( 'manage_options' ) ) {
		return;
	}
	?>
	<div class="wrap">
		<h1><?php echo esc_html( get_admin_page_title() ); ?></h1>
		<form action="options.php" method="post">
			<?php
			settings_fields( 'my_plugin_settings' );
			do_settings_sections( 'my_plugin_settings' );
			submit_button();
			?>
		</form>
	</div>
	<?php
}
```

---

## 2. Validate and Sanitize Settings Input

### Sanitization Callbacks

Sanitization callbacks are automatically called when settings are saved. They receive the input value and must return the sanitized value.

**Example:**
```php
register_setting(
	'my_plugin_settings',
	'my_plugin_email',
	array(
		'type'              => 'string',
		'sanitize_callback' => 'my_plugin_sanitize_email',
	)
);

function my_plugin_sanitize_email( $value ) {
	// Sanitize email
	$value = sanitize_email( $value );

	// Validate
	if ( ! is_email( $value ) ) {
		add_settings_error(
			'my_plugin_email',
			'invalid_email',
			__( 'Please enter a valid email address.' ),
			'error'
		);
		return get_option( 'my_plugin_email', '' ); // Return existing value on error
	}

	return $value;
}
```

### Common Sanitization Functions

```php
// Text fields
sanitize_text_field( $value )        // Single line text
sanitize_textarea_field( $value )    // Multi-line text
sanitize_email( $value )              // Email address
sanitize_url( $value )                // URL
sanitize_key( $value )                // Database key (lowercase, alphanumeric, dashes, underscores)
sanitize_title( $value )              // Post title slug
sanitize_file_name( $value )          // File name

// Numbers
absint( $value )                      // Positive integer
intval( $value )                       // Integer
floatval( $value )                     // Float

// HTML
wp_kses_post( $value )                // Allowed HTML tags for posts
wp_kses( $value, $allowed_html )      // Custom allowed HTML
wp_strip_all_tags( $value )           // Remove all HTML tags

// Arrays
array_map( 'sanitize_text_field', $value )  // Sanitize array of strings
```

### Validation with Settings Errors

Use `settings_errors()` to display validation messages to users.

**Function:** `add_settings_error( $setting, $code, $message, $type = 'error' )`

**Example:**
```php
function my_plugin_sanitize_api_key( $value ) {
	$value = sanitize_text_field( $value );

	// Validate length
	if ( strlen( $value ) < 20 ) {
		add_settings_error(
			'my_plugin_api_key',
			'api_key_too_short',
			__( 'API key must be at least 20 characters long.' ),
			'error'
		);
		return get_option( 'my_plugin_api_key', '' );
	}

	// Validate format
	if ( ! preg_match( '/^[a-zA-Z0-9]+$/', $value ) ) {
		add_settings_error(
			'my_plugin_api_key',
			'api_key_invalid_format',
			__( 'API key contains invalid characters.' ),
			'error'
		);
		return get_option( 'my_plugin_api_key', '' );
	}

	return $value;
}

// Display errors in settings page
function my_plugin_settings_page_callback() {
	settings_errors( 'my_plugin_api_key' );
	// ... rest of form
}
```

### Complex Data Types

For array or object settings, provide custom sanitization:

```php
register_setting(
	'my_plugin_settings',
	'my_plugin_config',
	array(
		'type'              => 'array',
		'sanitize_callback' => 'my_plugin_sanitize_config',
	)
);

function my_plugin_sanitize_config( $value ) {
	if ( ! is_array( $value ) ) {
		return array();
	}

	$sanitized = array();

	if ( isset( $value['api_key'] ) ) {
		$sanitized['api_key'] = sanitize_text_field( $value['api_key'] );
	}

	if ( isset( $value['enabled'] ) ) {
		$sanitized['enabled'] = (bool) $value['enabled'];
	}

	if ( isset( $value['endpoints'] ) && is_array( $value['endpoints'] ) ) {
		$sanitized['endpoints'] = array_map( 'esc_url_raw', $value['endpoints'] );
	}

	return $sanitized;
}
```

---

## 3. Integrate with Block-Based Settings Pages

### REST API Integration

Settings can be exposed to the REST API for block-based admin interfaces:

```php
register_setting(
	'my_plugin_settings',
	'my_plugin_api_key',
	array(
		'type'         => 'string',
		'show_in_rest' => array(
			'schema' => array(
				'type'        => 'string',
				'description' => __( 'API Key for external service.' ),
				'default'     => '',
			),
		),
		'sanitize_callback' => 'sanitize_text_field',
	)
);
```

### Accessing Settings via REST API

Once registered with `show_in_rest`, settings are available at:
- GET: `/wp-json/wp/v2/settings`
- POST: `/wp-json/wp/v2/settings` (with authentication)

**Example JavaScript:**
```javascript
// Get settings
const response = await fetch( '/wp-json/wp/v2/settings' );
const settings = await response.json();
console.log( settings.my_plugin_api_key );

// Update settings
await fetch( '/wp-json/wp/v2/settings', {
	method: 'POST',
	headers: {
		'Content-Type': 'application/json',
		'X-WP-Nonce': wpApiSettings.nonce,
	},
	body: JSON.stringify( {
		my_plugin_api_key: 'new-value',
	} ),
} );
```

---

## 4. Organise Admin UX with Tabs, Custom Pages, or Options Groups

### Custom Settings Page

Create a dedicated settings page:

```php
add_action( 'admin_menu', 'my_plugin_add_menu' );
function my_plugin_add_menu() {
	add_menu_page(
		__( 'My Plugin' ),              // Page title
		__( 'My Plugin' ),              // Menu title
		'manage_options',                // Capability
		'my-plugin',                     // Menu slug
		'my_plugin_settings_page',      // Callback
		'dashicons-admin-generic',       // Icon
		30                               // Position
	);

	// Add submenu for settings
	add_submenu_page(
		'my-plugin',
		__( 'Settings' ),
		__( 'Settings' ),
		'manage_options',
		'my-plugin',
		'my_plugin_settings_page'
	);
}
```

### Tabbed Settings Page

Organise settings into tabs:

```php
function my_plugin_settings_page() {
	$active_tab = isset( $_GET['tab'] ) ? sanitize_key( $_GET['tab'] ) : 'general';
	?>
	<div class="wrap">
		<h1><?php echo esc_html( get_admin_page_title() ); ?></h1>

		<nav class="nav-tab-wrapper">
			<a href="?page=my-plugin&tab=general"
			   class="nav-tab <?php echo $active_tab === 'general' ? 'nav-tab-active' : ''; ?>">
				<?php esc_html_e( 'General' ); ?>
			</a>
			<a href="?page=my-plugin&tab=api"
			   class="nav-tab <?php echo $active_tab === 'api' ? 'nav-tab-active' : ''; ?>">
				<?php esc_html_e( 'API' ); ?>
			</a>
		</nav>

		<form action="options.php" method="post">
			<?php
			if ( 'general' === $active_tab ) {
				settings_fields( 'my_plugin_general_settings' );
				do_settings_sections( 'my_plugin_general_settings' );
			} elseif ( 'api' === $active_tab ) {
				settings_fields( 'my_plugin_api_settings' );
				do_settings_sections( 'my_plugin_api_settings' );
			}
			submit_button();
			?>
		</form>
	</div>
	<?php
}
```

### Adding to Existing Settings Pages

Add settings to existing WordPress settings pages:

```php
// Add to General settings page
add_action( 'admin_init', 'my_plugin_add_to_general' );
function my_plugin_add_to_general() {
	register_setting( 'general', 'my_plugin_setting' );

	add_settings_section(
		'my_plugin_section',
		__( 'My Plugin' ),
		'my_plugin_section_callback',
		'general'
	);

	add_settings_field(
		'my_plugin_setting',
		__( 'My Setting' ),
		'my_plugin_field_callback',
		'general',
		'my_plugin_section'
	);
}
```

### Settings Groups

Organise related settings into groups:

```php
// Group 1: API Settings
register_setting( 'my_plugin_api_group', 'my_plugin_api_key' );
register_setting( 'my_plugin_api_group', 'my_plugin_api_secret' );

// Group 2: Display Settings
register_setting( 'my_plugin_display_group', 'my_plugin_show_widget' );
register_setting( 'my_plugin_display_group', 'my_plugin_widget_position' );

// In form
settings_fields( 'my_plugin_api_group' );
do_settings_sections( 'my_plugin_api_group' );

settings_fields( 'my_plugin_display_group' );
do_settings_sections( 'my_plugin_display_group' );
```

---

## Best Practices

### 1. Always Sanitize Input

```php
// ✅ GOOD
function my_plugin_sanitize_field( $value ) {
	return sanitize_text_field( $value );
}

// ❌ BAD
function my_plugin_sanitize_field( $value ) {
	return $value; // No sanitization!
}
```

### 2. Validate Before Saving

```php
function my_plugin_sanitize_url( $value ) {
	$value = esc_url_raw( $value );

	if ( ! filter_var( $value, FILTER_VALIDATE_URL ) ) {
		add_settings_error( 'my_plugin_url', 'invalid_url', __( 'Invalid URL.' ) );
		return get_option( 'my_plugin_url', '' );
	}

	return $value;
}
```

### 3. Use Appropriate Capabilities

```php
// ✅ GOOD - Check capability
if ( ! current_user_can( 'manage_options' ) ) {
	return;
}

// ❌ BAD - No capability check
```

### 4. Escape Output

```php
// ✅ GOOD
<input value="<?php echo esc_attr( $value ); ?>" />

// ❌ BAD
<input value="<?php echo $value; ?>" />
```

### 5. Use Nonces (Automatic with Settings API)

The Settings API automatically handles nonces via `settings_fields()`, which outputs:
- Nonce field
- Referer field
- Option group name

---

## Exam Tips

### Key Points to Remember

1. **Registration Order:**
   - Register settings first
   - Add sections second
   - Add fields third
   - All in `admin_init` hook

2. **Sanitization:**
   - Always provide `sanitize_callback`
   - Use appropriate WordPress sanitization functions
   - Return existing value on validation failure

3. **Settings Groups:**
   - Use same `$option_group` for related settings
   - Must match in `settings_fields()` call

4. **Common Mistakes:**
   - Forgetting to call `settings_fields()`
   - Not sanitizing input
   - Missing capability checks
   - Not escaping output

---

## Additional Resources

- [Settings API - WordPress Developer Resources](https://developer.wordpress.org/plugins/settings/settings-api/)
- [Function Reference: register_setting](https://developer.wordpress.org/reference/functions/register_setting/)
- [Function Reference: add_settings_section](https://developer.wordpress.org/reference/functions/add_settings_section/)
- [Function Reference: add_settings_field](https://developer.wordpress.org/reference/functions/add_settings_field/)
- Core Files:
  - `wp-includes/option.php` - `register_setting()` implementation
  - `wp-admin/includes/template.php` - Settings section/field functions
