# 7.5 Designing High-Traffic Architectures - Study Notes

## Overview

Designing WordPress architectures for high traffic requires understanding load balancing, containerisation, stateless application design, and shared asset management. Modern infrastructure patterns enable WordPress to scale to millions of page views.

**Key Reference:** [Scaling WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/performance/scaling/)

---

## 1. Using Load Balancers to Distribute Traffic

### Load Balancer Basics

**Purpose:**
- Distribute incoming requests across multiple servers
- Provide high availability
- Enable horizontal scaling
- Handle server failures gracefully

**Load Balancing Methods:**
- Round robin: Distribute evenly
- Least connections: Route to server with fewest active connections
- IP hash: Route based on client IP (sticky sessions)
- Weighted: Assign different weights to servers

### Nginx Load Balancer Configuration

**Basic Setup:**
```nginx
upstream wordpress_backend {
	least_conn;
	server 10.0.1.1:80 weight=3 max_fails=3 fail_timeout=30s;
	server 10.0.1.2:80 weight=3 max_fails=3 fail_timeout=30s;
	server 10.0.1.3:80 weight=2 max_fails=3 fail_timeout=30s backup;

	keepalive 32;
}

server {
	listen 80;
	server_name example.com;

	location / {
		proxy_pass http://wordpress_backend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# Health checks
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
		proxy_connect_timeout 60s;
		proxy_send_timeout 60s;
		proxy_read_timeout 60s;
	}
}
```

### Health Checks

**Server Health Monitoring:**
```nginx
# Health check endpoint
location /health {
	access_log off;
	return 200 "healthy\n";
	add_header Content-Type text/plain;
}
```

**Automatic Failover:**
```nginx
upstream wordpress_backend {
	server 10.0.1.1:80;
	server 10.0.1.2:80;
	server 10.0.1.3:80 backup; # Only used if others fail
}
```

### Sticky Sessions

**Session Affinity:**
```nginx
# IP-based sticky sessions
upstream wordpress_backend {
	ip_hash; # Routes same IP to same server
	server 10.0.1.1:80;
	server 10.0.1.2:80;
	server 10.0.1.3:80;
}
```

**Cookie-Based Sticky Sessions:**
```nginx
# Better for load balancing - use shared sessions instead
# Store sessions in Redis, not server-local
```

---

## 2. Deploying WordPress in Containers (Docker, Kubernetes)

### Docker Containerisation

**Dockerfile Example:**
```dockerfile
FROM wordpress:php8.1-fpm

# Install additional PHP extensions
RUN docker-php-ext-install mysqli pdo_mysql

# Copy custom configuration
COPY wp-config.php /usr/src/wordpress/
COPY .htaccess /usr/src/wordpress/

# Set permissions
RUN chown -R www-data:www-data /var/www/html

EXPOSE 9000
```

**Docker Compose Setup:**
```yaml
version: '3.8'

services:
  wordpress:
    build: .
    volumes:
      - ./wp-content:/var/www/html/wp-content
    environment:
      - WORDPRESS_DB_HOST=db
      - WORDPRESS_DB_USER=wpuser
      - WORDPRESS_DB_PASSWORD=wppass
      - WORDPRESS_DB_NAME=wordpress
    depends_on:
      - db
      - redis

  db:
    image: mysql:8.0
    environment:
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wpuser
      - MYSQL_PASSWORD=wppass
      - MYSQL_ROOT_PASSWORD=rootpass
    volumes:
      - db_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - wordpress

volumes:
  db_data:
  redis_data:
```

### Kubernetes Deployment

**Deployment YAML:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress
spec:
  replicas: 3
  selector:
    matchLabels:
      app: wordpress
  template:
    metadata:
      labels:
        app: wordpress
    spec:
      containers:
      - name: wordpress
        image: wordpress:php8.1-fpm
        env:
        - name: WORDPRESS_DB_HOST
          value: "mysql-service"
        - name: WORDPRESS_DB_USER
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: username
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: password
        volumeMounts:
        - name: wp-content
          mountPath: /var/www/html/wp-content
      volumes:
      - name: wp-content
        persistentVolumeClaim:
          claimName: wp-content-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: wordpress-service
spec:
  selector:
    app: wordpress
  ports:
  - port: 80
    targetPort: 9000
  type: LoadBalancer
```

**Horizontal Pod Autoscaling:**
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: wordpress-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: wordpress
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

---

## 3. Designing Stateless Application Layers

### Stateless Design Principles

**What is Stateless:**
- No server-local state
- Any server can handle any request
- State stored externally (database, cache, storage)

**Benefits:**
- Easy horizontal scaling
- No session affinity required
- Better fault tolerance
- Simpler load balancing

### WordPress Stateless Configuration

**Shared Sessions:**
```php
// Store sessions in Redis, not local files
ini_set( 'session.save_handler', 'redis' );
ini_set( 'session.save_path', 'tcp://redis-cluster:6379?persistent=1&weight=1&timeout=1&retry_interval=15' );

// Or use WordPress session handling
add_action( 'init', function() {
	if ( ! session_id() ) {
		session_start( array(
			'cookie_lifetime' => 86400,
			'cookie_httponly' => true,
			'cookie_secure' => is_ssl(),
		) );
	}
} );
```

**Shared File Storage:**
```php
// Use object storage (S3, Azure Blob) instead of local files
define( 'AS3CF_SETTINGS', serialize( array(
	'provider' => 'aws',
	'access-key-id' => 'YOUR_KEY',
	'secret-access-key' => 'YOUR_SECRET',
	'bucket' => 'wordpress-uploads',
	'region' => 'us-east-1',
) ) );

// Or use NFS for shared filesystem
define( 'UPLOADS', '/mnt/nfs/uploads' );
```

**Shared Object Cache:**
```php
// Redis object cache drop-in
// wp-content/object-cache.php
// Automatically uses Redis for all wp_cache_* functions

// Configuration in wp-config.php
define( 'WP_REDIS_HOST', 'redis-cluster' );
define( 'WP_REDIS_PORT', 6379 );
define( 'WP_REDIS_DATABASE', 0 );
```

### Avoiding Server-Local State

**❌ BAD - Local File Storage:**
```php
// Don't store uploads locally
$upload_dir = wp_upload_dir();
file_put_contents( $upload_dir['path'] . '/file.txt', $data );
```

**✅ GOOD - Shared Storage:**
```php
// Use object storage
$s3_client->putObject( array(
	'Bucket' => 'wordpress-uploads',
	'Key' => 'uploads/file.txt',
	'Body' => $data,
) );
```

**❌ BAD - Local Cache:**
```php
// Don't cache in local files
file_put_contents( 'cache/data.txt', $data );
```

**✅ GOOD - Shared Cache:**
```php
// Use Redis/Memcached
wp_cache_set( 'data', $data, '', 3600 );
```

---

## 4. Handling Shared Assets and Sessions

### Shared File Assets

**Object Storage Integration:**
```php
// AWS S3 integration example
function upload_to_s3( $file, $filename ) {
	$s3_client = new Aws\S3\S3Client( array(
		'version' => 'latest',
		'region' => 'us-east-1',
		'credentials' => array(
			'key' => AWS_ACCESS_KEY_ID,
			'secret' => AWS_SECRET_ACCESS_KEY,
		),
	) );

	$result = $s3_client->putObject( array(
		'Bucket' => 'wordpress-uploads',
		'Key' => 'uploads/' . $filename,
		'SourceFile' => $file,
		'ACL' => 'public-read',
	) );

	return $result['ObjectURL'];
}

// Filter upload URL
add_filter( 'wp_get_attachment_url', function( $url, $post_id ) {
	$s3_url = get_post_meta( $post_id, '_s3_url', true );
	return $s3_url ? $s3_url : $url;
}, 10, 2 );
```

**NFS for Shared Filesystem:**
```bash
# Mount NFS share
mount -t nfs nfs-server:/wordpress-uploads /var/www/html/wp-content/uploads

# In wp-config.php
define( 'UPLOADS', 'wp-content/uploads' );
// Ensure NFS is mounted before WordPress loads
```

### Shared Sessions

**Redis Session Storage:**
```php
// Configure PHP sessions to use Redis
ini_set( 'session.save_handler', 'redis' );
ini_set( 'session.save_path', 'tcp://redis:6379' );

// Or use WordPress session handling
class WP_Session_Handler {
	private $redis;

	public function __construct() {
		$this->redis = new Redis();
		$this->redis->connect( 'redis', 6379 );
	}

	public function read( $session_id ) {
		return $this->redis->get( 'session:' . $session_id );
	}

	public function write( $session_id, $data ) {
		return $this->redis->setex( 'session:' . $session_id, 3600, $data );
	}

	public function destroy( $session_id ) {
		return $this->redis->del( 'session:' . $session_id );
	}
}

$session_handler = new WP_Session_Handler();
session_set_save_handler( $session_handler, true );
```

**Memcached Session Storage:**
```php
ini_set( 'session.save_handler', 'memcached' );
ini_set( 'session.save_path', 'memcached:11211' );
```

### CDN for Static Assets

**Offload Static Assets:**
```php
// Serve static assets from CDN
function cdn_url( $url ) {
	if ( is_admin() ) {
		return $url;
	}

	$cdn_domain = 'https://cdn.example.com';
	$upload_dir = wp_upload_dir();

	if ( strpos( $url, $upload_dir['baseurl'] ) !== false ) {
		$url = str_replace( home_url(), $cdn_domain, $url );
	}

	return $url;
}

add_filter( 'wp_get_attachment_url', 'cdn_url' );
add_filter( 'the_content', function( $content ) {
	return preg_replace_callback(
		'/<img[^>]+src="([^"]+)"[^>]*>/i',
		function( $matches ) {
			return str_replace( $matches[1], cdn_url( $matches[1] ), $matches[0] );
		},
		$content
	);
} );
```

---

## 5. High-Traffic Architecture Patterns

### Typical Enterprise Architecture

```
                    Internet
                       |
                  CDN (Cloudflare)
                       |
              Load Balancer (Nginx/HAProxy)
                       |
        +---------------+---------------+
        |               |               |
   App Server 1    App Server 2    App Server 3
   (Container)      (Container)      (Container)
        |               |               |
        +---------------+---------------+
                       |
        +---------------+---------------+
        |               |               |
   Redis Cluster    MySQL Master    Object Storage
   (Cache/Sessions)  (Database)      (S3/Azure)
        |               |
   MySQL Replicas   (Read Replicas)
```

### Database Architecture

**Master-Slave Replication:**
```php
// Read from replicas, write to master
define( 'DB_HOST', 'mysql-master.example.com' );
define( 'DB_READ_HOST', 'mysql-replica.example.com' );

// Custom database class for read/write splitting
class WP_DB_Read_Write {
	private $write_db;
	private $read_db;

	public function __construct() {
		$this->write_db = new wpdb( DB_USER, DB_PASSWORD, DB_NAME, DB_HOST );
		$this->read_db = new wpdb( DB_USER, DB_PASSWORD, DB_NAME, DB_READ_HOST );
	}

	public function get_results( $query ) {
		// Use read replica for SELECT queries
		if ( preg_match( '/^\s*SELECT/i', $query ) ) {
			return $this->read_db->get_results( $query );
		}
		// Use master for writes
		return $this->write_db->get_results( $query );
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Load Balancers:**
   - Distribute traffic across servers
   - Provide high availability
   - Use health checks for failover
   - Avoid sticky sessions when possible

2. **Containers:**
   - Docker for containerisation
   - Kubernetes for orchestration
   - Enable easy scaling and deployment
   - Isolate applications

3. **Stateless Design:**
   - No server-local state
   - Store state in shared services
   - Use Redis for sessions
   - Use object storage for files

4. **Shared Assets:**
   - Object storage (S3, Azure) for uploads
   - NFS for shared filesystem
   - CDN for static assets
   - Redis/Memcached for sessions

5. **Architecture Patterns:**
   - Load balancer → App servers → Database
   - Read replicas for database scaling
   - Redis cluster for caching
   - Object storage for media

---

## Additional Resources

- [Scaling WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/performance/scaling/)
- [Docker Documentation](https://docs.docker.com/)
- [Kubernetes Documentation](https://kubernetes.io/docs/)
- [High Availability - WordPress VIP Documentation](https://docs.wpvip.com/)
