# 7.7 Edge Caching and Cache-Control Headers - Study Notes

## Overview

Edge caching pushes content closer to users by caching at CDN edge locations. Cache-Control headers control how content is cached and served, enabling fine-grained cache management for optimal performance.

**Key Reference:** [HTTP Caching - MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching)

---

## 1. Configuring Cache-Control Headers (max-age, stale-while-revalidate)

### Cache-Control Header Basics

**What is Cache-Control:**
- HTTP header that controls caching behavior
- Specifies who can cache, for how long, and when to revalidate
- Used by browsers, CDNs, and proxies

**Basic Syntax:**
```
Cache-Control: public, max-age=3600
```

### Common Cache-Control Directives

**Public vs Private:**
```php
// Public: Can be cached by any cache (CDN, browser, proxy)
header( 'Cache-Control: public, max-age=3600' );

// Private: Only browser can cache, not CDN/proxy
header( 'Cache-Control: private, max-age=3600' );

// No-cache: Must revalidate with origin
header( 'Cache-Control: no-cache' );

// No-store: Don't cache at all
header( 'Cache-Control: no-store' );
```

**Max-Age:**
```php
// Cache for 1 hour (3600 seconds)
header( 'Cache-Control: public, max-age=3600' );

// Cache for 1 day
header( 'Cache-Control: public, max-age=86400' );

// Cache for 1 year (for static assets)
header( 'Cache-Control: public, max-age=31536000' );
```

**Stale-While-Revalidate:**
```php
// Serve stale content while revalidating in background
header( 'Cache-Control: public, max-age=3600, stale-while-revalidate=86400' );

// Benefits:
// - User gets instant response (stale content)
// - CDN revalidates in background
// - Reduces origin server load
```

### WordPress Cache-Control Implementation

**Set Headers Based on Content:**
```php
add_action( 'template_redirect', function() {
	if ( is_admin() || is_user_logged_in() ) {
		header( 'Cache-Control: private, no-cache' );
		return;
	}

	// Homepage: 1 hour, allow stale for 1 day
	if ( is_front_page() ) {
		header( 'Cache-Control: public, max-age=3600, stale-while-revalidate=86400' );
	}

	// Posts: 30 minutes, allow stale for 1 hour
	if ( is_single() ) {
		header( 'Cache-Control: public, max-age=1800, stale-while-revalidate=3600' );
	}

	// Archives: 1 hour, allow stale for 6 hours
	if ( is_archive() ) {
		header( 'Cache-Control: public, max-age=3600, stale-while-revalidate=21600' );
	}

	// Static assets: 1 year, immutable
	if ( preg_match( '/\.(css|js|jpg|jpeg|png|gif|webp|svg|woff|woff2)$/', $_SERVER['REQUEST_URI'] ) ) {
		header( 'Cache-Control: public, max-age=31536000, immutable' );
	}
} );
```

---

## 2. Enabling HTML Caching at the CDN Edge

### HTML Caching Strategy

**Why Cache HTML:**
- Reduces origin server load
- Faster response times
- Better user experience
- Lower bandwidth costs

**Challenges:**
- Dynamic content (user-specific)
- Logged-in users
- Personalised content
- Real-time updates

### Conditional HTML Caching

**Cache HTML for Anonymous Users:**
```php
add_action( 'template_redirect', function() {
	// Don't cache for logged-in users
	if ( is_user_logged_in() ) {
		header( 'Cache-Control: private, no-cache' );
		header( 'X-Cache-Status: BYPASS' );
		return;
	}

	// Don't cache admin pages
	if ( is_admin() ) {
		header( 'Cache-Control: private, no-cache' );
		return;
	}

	// Cache HTML for anonymous users
	header( 'Cache-Control: public, max-age=3600, stale-while-revalidate=86400' );
	header( 'X-Cache-Status: CACHE' );
} );
```

**Vary Header for Different Content:**
```php
// Cache different versions based on headers
add_action( 'template_redirect', function() {
	// Vary cache based on Accept-Language
	header( 'Vary: Accept-Language' );

	// Vary cache based on device type
	header( 'Vary: User-Agent' );

	// Cache with appropriate TTL
	header( 'Cache-Control: public, max-age=3600' );
} );
```

### Edge-Side Includes (ESI)

**Using ESI for Dynamic Content:**
```php
// For Varnish/Fastly ESI
// Main page cached, dynamic parts via ESI

// In template
echo '<!--esi <esi:include src="/wp-content/esi/user-menu.php"/> -->';

// ESI endpoint
add_action( 'init', function() {
	if ( isset( $_GET['esi'] ) && $_GET['esi'] === 'user-menu' ) {
		// Don't cache ESI endpoint
		header( 'Cache-Control: private, no-cache' );

		// Output dynamic content
		if ( is_user_logged_in() ) {
			echo wp_nav_menu( array( 'theme_location' => 'user-menu' ) );
		} else {
			echo wp_nav_menu( array( 'theme_location' => 'guest-menu' ) );
		}
		exit;
	}
} );
```

---

## 3. Applying Edge Rules for Performance-Critical Paths

### Edge Rules Configuration

**Cloudflare Page Rules:**
```
Rule 1: example.com/wp-content/*
- Cache Level: Cache Everything
- Edge Cache TTL: 1 month
- Browser Cache TTL: Respect Existing Headers

Rule 2: example.com/wp-admin/*
- Cache Level: Bypass
- Always Online: Off

Rule 3: example.com/*
- Cache Level: Standard
- Edge Cache TTL: 2 hours
- Browser Cache TTL: 4 hours
```

**Fastly VCL Rules:**
```vcl
# Cache homepage aggressively
if (req.url == "/" || req.url == "/index.php") {
	set beresp.ttl = 1h;
	set beresp.http.Cache-Control = "public, max-age=3600, stale-while-revalidate=86400";
}

# Cache category pages
if (req.url ~ "^/category/") {
	set beresp.ttl = 30m;
	set beresp.http.Cache-Control = "public, max-age=1800";
}

# Don't cache search results
if (req.url ~ "\?s=") {
	set beresp.ttl = 0s;
	set beresp.http.Cache-Control = "no-cache";
	return (pass);
}
```

### WordPress Edge Rules Implementation

**Set Headers Based on URL Patterns:**
```php
add_action( 'template_redirect', function() {
	$request_uri = $_SERVER['REQUEST_URI'];

	// Homepage: Long cache
	if ( $request_uri === '/' || $request_uri === '/index.php' ) {
		header( 'Cache-Control: public, max-age=3600, stale-while-revalidate=86400' );
		return;
	}

	// Category pages: Medium cache
	if ( preg_match( '/^\/category\//', $request_uri ) ) {
		header( 'Cache-Control: public, max-age=1800' );
		return;
	}

	// Search results: No cache
	if ( isset( $_GET['s'] ) ) {
		header( 'Cache-Control: no-cache, must-revalidate' );
		return;
	}

	// Default: Short cache
	header( 'Cache-Control: public, max-age=300' );
} );
```

### Performance-Critical Paths

**Identify Critical Paths:**
```php
// Critical paths that need aggressive caching
$critical_paths = array(
	'/' => array(
		'max-age' => 3600,
		'stale-while-revalidate' => 86400,
	),
	'/blog/' => array(
		'max-age' => 1800,
		'stale-while-revalidate' => 3600,
	),
	'/products/' => array(
		'max-age' => 3600,
		'stale-while-revalidate' => 86400,
	),
);

add_action( 'template_redirect', function() use ( $critical_paths ) {
	$path = parse_url( $_SERVER['REQUEST_URI'], PHP_URL_PATH );

	if ( isset( $critical_paths[ $path ] ) ) {
		$config = $critical_paths[ $path ];
		$cache_control = sprintf(
			'public, max-age=%d, stale-while-revalidate=%d',
			$config['max-age'],
			$config['stale-while-revalidate']
		);
		header( 'Cache-Control: ' . $cache_control );
	}
} );
```

---

## 4. Cache Invalidation Strategies

### Purge on Content Update

**Purge Related URLs:**
```php
function purge_edge_cache( $urls ) {
	$cdn_type = get_option( 'cdn_type' );

	switch ( $cdn_type ) {
		case 'cloudflare':
			// Cloudflare API
			$api_key = get_option( 'cloudflare_api_key' );
			$zone_id = get_option( 'cloudflare_zone_id' );

			wp_remote_post(
				"https://api.cloudflare.com/client/v4/zones/{$zone_id}/purge_cache",
				array(
					'headers' => array(
						'Authorization' => 'Bearer ' . $api_key,
						'Content-Type' => 'application/json',
					),
					'body' => json_encode( array( 'files' => $urls ) ),
				)
			);
			break;

		case 'fastly':
			// Fastly API
			$service_id = get_option( 'fastly_service_id' );
			$api_key = get_option( 'fastly_api_key' );

			foreach ( $urls as $url ) {
				wp_remote_request(
					"https://api.fastly.com/service/{$service_id}/purge/{$url}",
					array(
						'method' => 'POST',
						'headers' => array(
							'Fastly-Key' => $api_key,
						),
					)
				);
			}
			break;
	}
}

// Purge on post save
add_action( 'save_post', function( $post_id ) {
	if ( wp_is_post_revision( $post_id ) || wp_is_post_autosave( $post_id ) ) {
		return;
	}

	$urls = array(
		get_permalink( $post_id ),
		home_url(),
		get_post_type_archive_link( get_post_type( $post_id ) ),
	);

	// Add category/tag archive URLs
	$terms = wp_get_post_terms( $post_id, array( 'category', 'post_tag' ) );
	foreach ( $terms as $term ) {
		$urls[] = get_term_link( $term );
	}

	purge_edge_cache( $urls );
} );
```

### Surrogate Keys

**Using Surrogate Keys for Selective Purging:**
```php
// Set surrogate key header
add_action( 'template_redirect', function() {
	$keys = array();

	if ( is_single() ) {
		$keys[] = 'post-' . get_the_ID();
		$keys[] = 'post-type-' . get_post_type();

		$terms = wp_get_post_terms( get_the_ID(), array( 'category', 'post_tag' ) );
		foreach ( $terms as $term ) {
			$keys[] = 'term-' . $term->term_id;
		}
	}

	if ( ! empty( $keys ) ) {
		header( 'Surrogate-Key: ' . implode( ' ', $keys ) );
	}
} );

// Purge by surrogate key (Fastly)
function purge_by_surrogate_key( $key ) {
	$service_id = get_option( 'fastly_service_id' );
	$api_key = get_option( 'fastly_api_key' );

	wp_remote_request(
		"https://api.fastly.com/service/{$service_id}/purge/{$key}",
		array(
			'method' => 'POST',
			'headers' => array(
				'Fastly-Key' => $api_key,
				'Surrogate-Key' => $key,
			),
		)
	);
}

// Purge all posts in category
add_action( 'edited_term', function( $term_id ) {
	purge_by_surrogate_key( 'term-' . $term_id );
} );
```

---

## 5. Monitoring Edge Cache Performance

### Cache Hit Rate Monitoring

**Track Cache Performance:**
```php
// Add cache status header
add_action( 'template_redirect', function() {
	// CDN will add this header
	// X-Cache: HIT or MISS
	// X-Cache-Hits: 1234

	// Log cache misses
	if ( isset( $_SERVER['HTTP_X_CACHE'] ) && $_SERVER['HTTP_X_CACHE'] === 'MISS' ) {
		error_log( 'Cache miss: ' . $_SERVER['REQUEST_URI'] );
	}
} );
```

**Monitor Cache Headers:**
```php
// Check cache headers in response
function check_cache_headers( $response ) {
	$headers = wp_remote_retrieve_headers( $response );

	if ( isset( $headers['x-cache'] ) ) {
		$cache_status = $headers['x-cache'];
		// Log or track cache hit rate
	}

	return $response;
}

add_filter( 'http_response', 'check_cache_headers' );
```

---

## Exam Tips

### Key Points to Remember

1. **Cache-Control Headers:**
   - `public`: Can be cached by any cache
   - `private`: Only browser can cache
   - `max-age`: Cache duration in seconds
   - `stale-while-revalidate`: Serve stale while revalidating

2. **HTML Caching:**
   - Cache for anonymous users
   - Bypass for logged-in users
   - Use Vary header for different content
   - Consider ESI for dynamic parts

3. **Edge Rules:**
   - Different rules for different paths
   - Aggressive caching for static content
   - Shorter cache for dynamic content
   - Bypass for admin/search

4. **Cache Invalidation:**
   - Purge on content updates
   - Use surrogate keys for selective purging
   - Purge related URLs
   - Monitor cache hit rates

5. **Best Practices:**
   - Use `stale-while-revalidate` for better UX
   - Set appropriate TTLs
   - Monitor cache performance
   - Implement proper invalidation

---

## Additional Resources

- [HTTP Caching - MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching)
- [Cache-Control - MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control)
- [Cloudflare Cache Rules](https://developers.cloudflare.com/rules/cache-rules/)
- [Fastly VCL Documentation](https://docs.fastly.com/vcl/)
