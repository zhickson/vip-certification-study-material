# 6.18 Custom WP-CLI Commands for Debugging - Study Notes

## Overview

Creating custom WP-CLI commands allows you to build debugging tools that expose site internals, query runtime state programmatically, and output structured debug information for WordPress troubleshooting.

**Key Reference:** [WP-CLI Commands Cookbook](https://wp-cli.org/commands-cookbook/)

---

## 1. Writing Custom CLI Commands

### Basic Command Structure

**Command Class:**
```php
<?php
/**
 * Plugin Name: My Debug Commands
 */

if ( ! defined( 'WP_CLI' ) || ! WP_CLI ) {
    return;
}

class My_Debug_Command {
    /**
     * Debug site information.
     *
     * ## EXAMPLES
     *
     *     wp my-debug info
     *
     * @when after_wp_load
     */
    public function info( $args, $assoc_args ) {
        WP_CLI::line( 'Site URL: ' . get_option( 'siteurl' ) );
        WP_CLI::line( 'Home URL: ' . get_option( 'home' ) );
        WP_CLI::line( 'WordPress Version: ' . get_bloginfo( 'version' ) );
        WP_CLI::line( 'Active Theme: ' . wp_get_theme()->get( 'Name' ) );
    }
}

WP_CLI::add_command( 'my-debug', 'My_Debug_Command' );
```

**Register Command:**
```php
WP_CLI::add_command( 'my-debug', 'My_Debug_Command' );
```

### Command Arguments

**Positional Arguments:**
```php
public function get_post( $args, $assoc_args ) {
    $post_id = isset( $args[0] ) ? $args[0] : null;

    if ( ! $post_id ) {
        WP_CLI::error( 'Post ID required' );
    }

    $post = get_post( $post_id );

    if ( ! $post ) {
        WP_CLI::error( 'Post not found' );
    }

    WP_CLI::line( 'Post Title: ' . $post->post_title );
    WP_CLI::line( 'Post Status: ' . $post->post_status );
}
```

**Associative Arguments:**
```php
public function list_posts( $args, $assoc_args ) {
    $post_type = isset( $assoc_args['post_type'] ) ? $assoc_args['post_type'] : 'post';
    $limit = isset( $assoc_args['limit'] ) ? intval( $assoc_args['limit'] ) : 10;

    $posts = get_posts( array(
        'post_type' => $post_type,
        'numberposts' => $limit,
    ) );

    foreach ( $posts as $post ) {
        WP_CLI::line( $post->ID . ': ' . $post->post_title );
    }
}
```

---

## 2. Querying Runtime State Programmatically

### Site State

**Check Site Status:**
```php
public function site_status( $args, $assoc_args ) {
    $status = array(
        'site_url' => get_option( 'siteurl' ),
        'home_url' => get_option( 'home' ),
        'wp_version' => get_bloginfo( 'version' ),
        'php_version' => PHP_VERSION,
        'memory_limit' => ini_get( 'memory_limit' ),
        'active_plugins' => count( get_option( 'active_plugins' ) ),
        'active_theme' => wp_get_theme()->get( 'Name' ),
    );

    WP_CLI::print_value( $status, $assoc_args );
}
```

**Check Database:**
```php
public function db_status( $args, $assoc_args ) {
    global $wpdb;

    $status = array(
        'db_version' => $wpdb->db_version(),
        'table_prefix' => $wpdb->prefix,
        'total_tables' => count( $wpdb->get_results( 'SHOW TABLES' ) ),
    );

    WP_CLI::print_value( $status, $assoc_args );
}
```

### Plugin State

**Check Plugins:**
```php
public function plugin_status( $args, $assoc_args ) {
    $plugins = get_plugins();
    $active_plugins = get_option( 'active_plugins' );

    foreach ( $plugins as $plugin_file => $plugin_data ) {
        $status = in_array( $plugin_file, $active_plugins ) ? 'Active' : 'Inactive';
        WP_CLI::line( sprintf(
            '%s: %s (%s)',
            $plugin_data['Name'],
            $status,
            $plugin_data['Version']
        ) );
    }
}
```

### Cache State

**Check Cache:**
```php
public function cache_status( $args, $assoc_args ) {
    $cache_enabled = wp_using_ext_object_cache();

    WP_CLI::line( 'Object Cache: ' . ( $cache_enabled ? 'Enabled' : 'Disabled' ) );

    if ( $cache_enabled ) {
        $cache_stats = wp_cache_get_stats();
        WP_CLI::print_value( $cache_stats, $assoc_args );
    }
}
```

---

## 3. Outputting Structured Debug Information

### Table Output

**Format as Table:**
```php
public function list_users( $args, $assoc_args ) {
    $users = get_users();

    $items = array();
    foreach ( $users as $user ) {
        $items[] = array(
            'ID' => $user->ID,
            'Username' => $user->user_login,
            'Email' => $user->user_email,
            'Role' => implode( ', ', $user->roles ),
        );
    }

    WP_CLI\Utils\format_items( 'table', $items, array( 'ID', 'Username', 'Email', 'Role' ) );
}
```

### JSON Output

**Format as JSON:**
```php
public function get_options( $args, $assoc_args ) {
    $options = array();

    $option_names = array( 'siteurl', 'home', 'admin_email', 'blogname' );

    foreach ( $option_names as $option_name ) {
        $options[ $option_name ] = get_option( $option_name );
    }

    WP_CLI::print_value( $options, array( 'format' => 'json' ) );
}
```

### CSV Output

**Format as CSV:**
```php
public function export_posts( $args, $assoc_args ) {
    $posts = get_posts( array( 'numberposts' => -1 ) );

    $items = array();
    foreach ( $posts as $post ) {
        $items[] = array(
            'ID' => $post->ID,
            'Title' => $post->post_title,
            'Status' => $post->post_status,
            'Date' => $post->post_date,
        );
    }

    WP_CLI\Utils\format_items( 'csv', $items, array( 'ID', 'Title', 'Status', 'Date' ) );
}
```

---

## 4. Advanced Command Features

### Progress Bars

**Show Progress:**
```php
public function process_posts( $args, $assoc_args ) {
    $posts = get_posts( array( 'numberposts' => -1 ) );
    $total = count( $posts );

    $progress = \WP_CLI\Utils\make_progress_bar( 'Processing posts', $total );

    foreach ( $posts as $post ) {
        // Process post
        $progress->tick();
    }

    $progress->finish();
    WP_CLI::success( "Processed {$total} posts" );
}
```

### Confirmation

**Require Confirmation:**
```php
public function delete_test_data( $args, $assoc_args ) {
    WP_CLI::confirm( 'Are you sure you want to delete all test data?' );

    // Delete operation
    WP_CLI::success( 'Test data deleted' );
}
```

### Error Handling

**Handle Errors:**
```php
public function risky_operation( $args, $assoc_args ) {
    try {
        // Risky operation
        WP_CLI::success( 'Operation completed' );
    } catch ( Exception $e ) {
        WP_CLI::error( 'Operation failed: ' . $e->getMessage() );
    }
}
```

---

## 5. Example Debug Commands

### Complete Example

**Full Command Class:**
```php
<?php
class Debug_Commands {
    /**
     * Show debug information.
     *
     * ## OPTIONS
     *
     * [--format=<format>]
     * : Output format (table, json, csv)
     * ---
     * default: table
     * ---
     *
     * ## EXAMPLES
     *
     *     wp debug info
     *     wp debug info --format=json
     */
    public function info( $args, $assoc_args ) {
        $format = isset( $assoc_args['format'] ) ? $assoc_args['format'] : 'table';

        $info = array(
            array(
                'Setting' => 'Site URL',
                'Value' => get_option( 'siteurl' ),
            ),
            array(
                'Setting' => 'WordPress Version',
                'Value' => get_bloginfo( 'version' ),
            ),
            array(
                'Setting' => 'PHP Version',
                'Value' => PHP_VERSION,
            ),
            array(
                'Setting' => 'Memory Limit',
                'Value' => ini_get( 'memory_limit' ),
            ),
        );

        WP_CLI\Utils\format_items( $format, $info, array( 'Setting', 'Value' ) );
    }

    /**
     * Check database queries.
     */
    public function queries( $args, $assoc_args ) {
        global $wpdb;

        $queries = $wpdb->queries;
        $total = count( $queries );
        $total_time = 0;

        foreach ( $queries as $query ) {
            $total_time += $query[1];
        }

        WP_CLI::line( "Total Queries: {$total}" );
        WP_CLI::line( "Total Time: {$total_time}s" );
    }
}

WP_CLI::add_command( 'debug', 'Debug_Commands' );
```

---

## Exam Tips

### Key Points to Remember

1. **Command Structure:**
   - Extend WP_CLI_Command or use class
   - Register with `WP_CLI::add_command()`
   - Use `@when after_wp_load`

2. **Arguments:**
   - Positional: `$args[0]`
   - Associative: `$assoc_args['key']`
   - Use WP_CLI::error() for validation

3. **Output:**
   - `WP_CLI::line()` for simple output
   - `WP_CLI::print_value()` for structured
   - `format_items()` for tables/CSV/JSON

4. **Features:**
   - Progress bars for long operations
   - Confirmation for destructive operations
   - Error handling with try/catch

5. **Best Practices:**
   - Document commands with PHPDoc
   - Provide examples
   - Handle errors gracefully
   - Use appropriate output formats

---

## Additional Resources

- [WP-CLI Commands Cookbook](https://wp-cli.org/commands-cookbook/)
- [WP-CLI API Reference](https://wp-cli.org/commands-cookbook/#api-reference)
- [Creating Custom Commands](https://make.wordpress.org/cli/handbook/guides/commands-cookbook/)
