# 3.22 Role of Static Analysis Tools - Study Notes

## Overview

Static analysis tools analyze code without executing it to find security vulnerabilities, bugs, and code quality issues. These tools are essential for maintaining secure WordPress code.

**Key Reference:** [Static Analysis - OWASP](https://owasp.org/www-community/controls/Static_Code_Analysis)

---

## 1. PHP Static Analysis Tools

### PHPStan

**Purpose:** Finds bugs in PHP code without running it.

**Installation:**
```bash
composer require --dev phpstan/phpstan
```

**Configuration (phpstan.neon):**
```yaml
parameters:
	level: 5
	paths:
		- src
		- includes
	excludePaths:
		- vendor
```

**Usage:**
```bash
./vendor/bin/phpstan analyse
```

**WordPress Integration:**
```bash
composer require --dev phpstan/extension-installer
composer require --dev szepeviktor/phpstan-wordpress
```

### Psalm

**Purpose:** Static analysis tool for finding errors in PHP.

**Installation:**
```bash
composer require --dev vimeo/psalm
```

**Configuration (psalm.xml):**
```xml
<?xml version="1.0"?>
<psalm>
	<projectFiles>
		<directory name="src" />
	</projectFiles>
	<issueHandlers>
		<SecurityIssue errorLevel="error" />
	</issueHandlers>
</psalm>
```

**Usage:**
```bash
./vendor/bin/psalm
```

---

## 2. Security-Focused Tools

### WPScan

**Purpose:** WordPress vulnerability scanner.

**Usage:**
```bash
# Scan for vulnerabilities
wpscan --url example.com

# Scan plugins
wpscan --url example.com --enumerate vp

# Scan themes
wpscan --url example.com --enumerate vt
```

### PHP Security Checker

**Purpose:** Checks Composer dependencies for known vulnerabilities.

**Installation:**
```bash
composer require --dev sensiolabs/security-checker
```

**Usage:**
```bash
./vendor/bin/security-checker security:check
```

---

## 3. Code Quality Tools

### PHP_CodeSniffer (PHPCS)

**Purpose:** Detects violations of coding standards.

**WordPress Standards:**
```bash
composer require --dev wp-coding-standards/wpcs
```

**Configuration:**
```bash
./vendor/bin/phpcs --config-set installed_paths vendor/wp-coding-standards/wpcs
./vendor/bin/phpcs --standard=WordPress plugin-file.php
```

### PHP Mess Detector (PHPMD)

**Purpose:** Detects potential problems in code.

**Installation:**
```bash
composer require --dev phpmd/phpmd
```

**Usage:**
```bash
./vendor/bin/phpmd src text codesize,unusedcode,naming
```

---

## 4. Detecting Security Issues

### SQL Injection Detection

**PHPStan:**
```php
// PHPStan will detect:
$query = "SELECT * FROM table WHERE id = " . $_GET['id'];
// Error: Potential SQL injection
```

**Psalm:**
```php
// Psalm will detect:
$wpdb->query( "SELECT * FROM table WHERE id = " . $id );
// Error: SQL injection vulnerability
```

### XSS Detection

**PHPStan:**
```php
// PHPStan will detect:
echo $_GET['content'];
// Error: Output should be escaped
```

**PHPCS:**
```php
// PHPCS will detect:
echo $user_input;
// Error: Output must be escaped
```

### Unsafe Functions

**Static analysis detects:**
- `eval()` usage
- `exec()` with user input
- `file_get_contents()` with user input
- Unsafe deserialization

---

## 5. Integration with Development

### Pre-Commit Hooks

```bash
#!/bin/sh
# .git/hooks/pre-commit

# Run PHPCS
./vendor/bin/phpcs --standard=WordPress --extensions=php src/

# Run PHPStan
./vendor/bin/phpstan analyse

# Run security checker
./vendor/bin/security-checker security:check

# Exit with error if any check fails
if [ $? -ne 0 ]; then
	echo "Pre-commit checks failed"
	exit 1
fi
```

### Editor Integration

**VS Code:**
```json
{
	"php.validate.executablePath": "/usr/bin/php",
	"php.suggest.basic": false,
	"phpcs.enable": true,
	"phpcs.standard": "WordPress"
}
```

---

## 6. CI/CD Integration

### GitHub Actions

```yaml
name: Static Analysis

on: [push, pull_request]

jobs:
	phpstan:
		runs-on: ubuntu-latest
		steps:
			- uses: actions/checkout@v2
			- uses: shivammathur/setup-php@v2
				with:
					php-version: '8.0'
			- run: composer install
			- run: ./vendor/bin/phpstan analyse

	phpcs:
		runs-on: ubuntu-latest
		steps:
			- uses: actions/checkout@v2
			- uses: shivammathur/setup-php@v2
			- run: composer install
			- run: ./vendor/bin/phpcs --standard=WordPress src/
```

---

## Exam Tips

### Key Points to Remember

1. **Static Analysis Tools:**
   - PHPStan: Bug detection
   - Psalm: Error finding
   - PHPCS: Coding standards
   - WPScan: Vulnerability scanning

2. **Security Detection:**
   - SQL injection
   - XSS vulnerabilities
   - Unsafe functions
   - Input validation issues

3. **Integration:**
   - Pre-commit hooks
   - CI/CD pipelines
   - Editor integration
   - Automated scanning

---

## Additional Resources

- [PHPStan](https://phpstan.org/)
- [Psalm](https://psalm.dev/)
- [WPScan](https://wpscan.com/)
- [Static Analysis - OWASP](https://owasp.org/www-community/controls/Static_Code_Analysis)
