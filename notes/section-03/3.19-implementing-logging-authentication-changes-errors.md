# 3.19 Implementing Logging for Authentication, Changes, and Errors - Study Notes

## Overview

Implementing comprehensive logging for authentication events, system changes, and errors is critical for security monitoring and forensics. This topic covers practical implementation of logging systems.

**Key Reference:** [WordPress Debugging - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)

---

## 1. Authentication Logging

### Successful Logins

```php
add_action( 'wp_login', function( $user_login, $user ) {
	$ip = $_SERVER['REMOTE_ADDR'];
	$user_agent = $_SERVER['HTTP_USER_AGENT'];

	error_log( sprintf(
		'[AUTH] Successful login: User "%s" (ID: %d) from IP %s',
		$user_login,
		$user->ID,
		$ip
	) );

	// Log to database
	log_to_database( array(
		'event' => 'login_success',
		'user_id' => $user->ID,
		'username' => $user_login,
		'ip' => $ip,
		'user_agent' => $user_agent,
	) );
}, 10, 2 );
```

### Failed Login Attempts

```php
add_action( 'wp_login_failed', function( $username ) {
	$ip = $_SERVER['REMOTE_ADDR'];
	$user_agent = $_SERVER['HTTP_USER_AGENT'];

	error_log( sprintf(
		'[AUTH] Failed login attempt: Username "%s" from IP %s',
		$username,
		$ip
	) );

	// Log to database
	log_to_database( array(
		'event' => 'login_failed',
		'username' => $username,
		'ip' => $ip,
		'user_agent' => $user_agent,
	) );

	// Check for brute force
	check_brute_force( $ip, $username );
} );
```

### Logout Events

```php
add_action( 'wp_logout', function() {
	$user = wp_get_current_user();
	$ip = $_SERVER['REMOTE_ADDR'];

	if ( $user->ID ) {
		error_log( sprintf(
			'[AUTH] User logout: User "%s" (ID: %d) from IP %s',
			$user->user_login,
			$user->ID,
			$ip
		) );

		log_to_database( array(
			'event' => 'logout',
			'user_id' => $user->ID,
			'username' => $user->user_login,
			'ip' => $ip,
		) );
	}
} );
```

### Password Changes

```php
add_action( 'password_reset', function( $user, $new_pass ) {
	error_log( sprintf(
		'[AUTH] Password reset: User "%s" (ID: %d)',
		$user->user_login,
		$user->ID
	) );

	log_to_database( array(
		'event' => 'password_reset',
		'user_id' => $user->ID,
		'username' => $user->user_login,
	) );
}, 10, 2 );

add_action( 'profile_update', function( $user_id, $old_user_data ) {
	$user = get_userdata( $user_id );

	// Check if password changed
	if ( isset( $_POST['pass1'] ) && ! empty( $_POST['pass1'] ) ) {
		error_log( sprintf(
			'[AUTH] Password changed: User "%s" (ID: %d)',
			$user->user_login,
			$user_id
		) );

		log_to_database( array(
			'event' => 'password_changed',
			'user_id' => $user_id,
			'username' => $user->user_login,
		) );
	}
}, 10, 2 );
```

---

## 2. Change Logging

### Post Changes

```php
add_action( 'save_post', function( $post_id, $post, $update ) {
	// Skip autosaves and revisions
	if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {
		return;
	}
	if ( wp_is_post_revision( $post_id ) ) {
		return;
	}

	$user = wp_get_current_user();
	$action = $update ? 'post_updated' : 'post_created';

	error_log( sprintf(
		'[CHANGE] %s: Post ID %d "%s" by User "%s" (ID: %d)',
		$action,
		$post_id,
		$post->post_title,
		$user->user_login,
		$user->ID
	) );

	log_to_database( array(
		'event' => $action,
		'object_type' => 'post',
		'object_id' => $post_id,
		'user_id' => $user->ID,
		'details' => array(
			'post_type' => $post->post_type,
			'post_title' => $post->post_title,
			'post_status' => $post->post_status,
		),
	) );
}, 10, 3 );

add_action( 'before_delete_post', function( $post_id ) {
	$post = get_post( $post_id );
	$user = wp_get_current_user();

	error_log( sprintf(
		'[CHANGE] Post deleted: Post ID %d "%s" by User "%s" (ID: %d)',
		$post_id,
		$post->post_title,
		$user->user_login,
		$user->ID
	) );

	log_to_database( array(
		'event' => 'post_deleted',
		'object_type' => 'post',
		'object_id' => $post_id,
		'user_id' => $user->ID,
		'details' => array(
			'post_type' => $post->post_type,
			'post_title' => $post->post_title,
		),
	) );
} );
```

### Plugin Changes

```php
add_action( 'activated_plugin', function( $plugin ) {
	$user = wp_get_current_user();

	error_log( sprintf(
		'[CHANGE] Plugin activated: "%s" by User "%s" (ID: %d)',
		$plugin,
		$user->user_login,
		$user->ID
	) );

	log_to_database( array(
		'event' => 'plugin_activated',
		'object_type' => 'plugin',
		'user_id' => $user->ID,
		'details' => array( 'plugin' => $plugin ),
	) );
} );

add_action( 'deactivated_plugin', function( $plugin ) {
	$user = wp_get_current_user();

	error_log( sprintf(
		'[CHANGE] Plugin deactivated: "%s" by User "%s" (ID: %d)',
		$plugin,
		$user->user_login,
		$user->ID
	) );

	log_to_database( array(
		'event' => 'plugin_deactivated',
		'object_type' => 'plugin',
		'user_id' => $user->ID,
		'details' => array( 'plugin' => $plugin ),
	) );
} );
```

### Theme Changes

```php
add_action( 'switch_theme', function( $new_theme ) {
	$user = wp_get_current_user();

	error_log( sprintf(
		'[CHANGE] Theme changed: "%s" by User "%s" (ID: %d)',
		$new_theme,
		$user->user_login,
		$user->ID
	) );

	log_to_database( array(
		'event' => 'theme_changed',
		'object_type' => 'theme',
		'user_id' => $user->ID,
		'details' => array( 'theme' => $new_theme ),
	) );
} );
```

### User Changes

```php
add_action( 'user_register', function( $user_id ) {
	$user = get_userdata( $user_id );
	$creator = wp_get_current_user();

	error_log( sprintf(
		'[CHANGE] User created: "%s" (ID: %d) by User "%s" (ID: %d)',
		$user->user_login,
		$user_id,
		$creator->user_login,
		$creator->ID
	) );

	log_to_database( array(
		'event' => 'user_created',
		'object_type' => 'user',
		'object_id' => $user_id,
		'user_id' => $creator->ID,
		'details' => array( 'username' => $user->user_login ),
	) );
} );

add_action( 'delete_user', function( $user_id ) {
	$user = get_userdata( $user_id );
	$deleter = wp_get_current_user();

	error_log( sprintf(
		'[CHANGE] User deleted: "%s" (ID: %d) by User "%s" (ID: %d)',
		$user->user_login,
		$user_id,
		$deleter->user_login,
		$deleter->ID
	) );

	log_to_database( array(
		'event' => 'user_deleted',
		'object_type' => 'user',
		'object_id' => $user_id,
		'user_id' => $deleter->ID,
		'details' => array( 'username' => $user->user_login ),
	) );
} );

add_action( 'set_user_role', function( $user_id, $role, $old_roles ) {
	$user = get_userdata( $user_id );
	$changer = wp_get_current_user();

	error_log( sprintf(
		'[CHANGE] User role changed: "%s" (ID: %d) from %s to %s by User "%s" (ID: %d)',
		$user->user_login,
		$user_id,
		implode( ', ', $old_roles ),
		$role,
		$changer->user_login,
		$changer->ID
	) );

	log_to_database( array(
		'event' => 'user_role_changed',
		'object_type' => 'user',
		'object_id' => $user_id,
		'user_id' => $changer->ID,
		'details' => array(
			'username' => $user->user_login,
			'old_roles' => $old_roles,
			'new_role' => $role,
		),
	) );
}, 10, 3 );
```

---

## 3. Error Logging

### PHP Errors

```php
// In wp-config.php
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
define( 'WP_DEBUG_DISPLAY', false );

// Custom error handler
function custom_error_handler( $errno, $errstr, $errfile, $errline ) {
	$error_types = array(
		E_ERROR => 'ERROR',
		E_WARNING => 'WARNING',
		E_PARSE => 'PARSE',
		E_NOTICE => 'NOTICE',
		E_CORE_ERROR => 'CORE_ERROR',
		E_CORE_WARNING => 'CORE_WARNING',
		E_COMPILE_ERROR => 'COMPILE_ERROR',
		E_COMPILE_WARNING => 'COMPILE_WARNING',
		E_USER_ERROR => 'USER_ERROR',
		E_USER_WARNING => 'USER_WARNING',
		E_USER_NOTICE => 'USER_NOTICE',
		E_STRICT => 'STRICT',
		E_RECOVERABLE_ERROR => 'RECOVERABLE_ERROR',
		E_DEPRECATED => 'DEPRECATED',
		E_USER_DEPRECATED => 'USER_DEPRECATED',
	);

	$error_type = isset( $error_types[ $errno ] ) ? $error_types[ $errno ] : 'UNKNOWN';

	error_log( sprintf(
		'[ERROR] %s: %s in %s on line %d',
		$error_type,
		$errstr,
		$errfile,
		$errline
	) );

	log_to_database( array(
		'event' => 'php_error',
		'level' => $error_type,
		'details' => array(
			'message' => $errstr,
			'file' => $errfile,
			'line' => $errline,
		),
	) );

	return false; // Continue with default error handling
}
set_error_handler( 'custom_error_handler' );
```

### Database Errors

```php
add_action( 'wpdb_error', function( $error, $query ) {
	error_log( sprintf(
		'[ERROR] Database error: %s | Query: %s',
		$error,
		$query
	) );

	log_to_database( array(
		'event' => 'database_error',
		'details' => array(
			'error' => $error,
			'query' => $query,
		),
	) );
}, 10, 2 );
```

### WordPress Errors

```php
add_action( 'wp_die_handler', function( $function ) {
	return function( $message, $title, $args ) use ( $function ) {
		error_log( sprintf(
			'[ERROR] WordPress error: %s | Title: %s',
			$message,
			$title
		) );

		log_to_database( array(
			'event' => 'wordpress_error',
			'details' => array(
				'message' => $message,
				'title' => $title,
			),
		) );

		return call_user_func( $function, $message, $title, $args );
	};
} );
```

---

## 4. Database Logging Function

```php
function log_to_database( $data ) {
	global $wpdb;

	$table_name = $wpdb->prefix . 'security_logs';

	$defaults = array(
		'event' => 'unknown',
		'user_id' => get_current_user_id(),
		'object_type' => null,
		'object_id' => null,
		'ip' => $_SERVER['REMOTE_ADDR'] ?? null,
		'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? null,
		'details' => array(),
		'timestamp' => current_time( 'mysql' ),
	);

	$data = wp_parse_args( $data, $defaults );

	$wpdb->insert(
		$table_name,
		array(
			'event' => $data['event'],
			'user_id' => $data['user_id'] ? $data['user_id'] : null,
			'object_type' => $data['object_type'],
			'object_id' => $data['object_id'],
			'ip_address' => $data['ip'],
			'user_agent' => $data['user_agent'],
			'details' => json_encode( $data['details'] ),
			'timestamp' => $data['timestamp'],
		),
		array( '%s', '%d', '%s', '%d', '%s', '%s', '%s', '%s' )
	);
}
```

---

## Exam Tips

### Key Points to Remember

1. **Authentication Logging:**
   - Successful logins
   - Failed attempts
   - Logouts
   - Password changes

2. **Change Logging:**
   - Post changes
   - Plugin/theme changes
   - User changes
   - Settings changes

3. **Error Logging:**
   - PHP errors
   - Database errors
   - WordPress errors
   - Custom error handling

4. **Implementation:**
   - Use WordPress hooks
   - Log to database and files
   - Include context (IP, user agent)
   - Structure logs for analysis

---

## Additional Resources

- [WordPress Debugging - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)
- [WordPress Hooks - WordPress Developer Resources](https://developer.wordpress.org/plugins/hooks/)
