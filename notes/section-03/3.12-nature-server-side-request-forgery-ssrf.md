# 3.12 Nature of Server-Side Request Forgery (SSRF) - Study Notes

## Overview

Server-Side Request Forgery (SSRF) is an attack where an attacker forces a server to make HTTP requests to unintended locations. In WordPress, this can occur when user-controlled input is used to make server-side HTTP requests without proper validation.

**Key Reference:** [OWASP SSRF](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery)

---

## 1. Understanding SSRF

### What is SSRF?

SSRF attacks exploit server-side functionality to make requests to:
- Internal services (localhost, 127.0.0.1)
- Private IP ranges (10.0.0.0/8, 192.168.0.0/16)
- Cloud metadata services (169.254.169.254)
- Other internal resources

### Attack Flow

1. Attacker provides malicious URL in user input
2. Application makes server-side request to that URL
3. Server requests internal resource
4. Attacker gains access to internal services

### Example Attack

```php
// Vulnerable code
$url = $_GET['url'];
$response = wp_remote_get( $url ); // Attacker controls $url

// Attacker provides:
// ?url=http://127.0.0.1:3306 (MySQL)
// ?url=http://169.254.169.254/latest/meta-data/ (AWS metadata)
// ?url=file:///etc/passwd (Local file)
```

---

## 2. SSRF Attack Vectors in WordPress

### Common Vulnerable Functions

**wp_remote_get() / wp_remote_post()**
```php
// Vulnerable if URL is user-controlled
$url = $_GET['url'];
$response = wp_remote_get( $url );
```

**file_get_contents()**
```php
// Vulnerable to SSRF
$content = file_get_contents( $_GET['url'] );
```

**cURL**
```php
// Vulnerable if URL is user-controlled
$ch = curl_init( $_GET['url'] );
curl_exec( $ch );
```

### WordPress-Specific Vectors

**Image Previews:**
```php
// Vulnerable image preview
$image_url = $_GET['image_url'];
$image_data = wp_remote_get( $image_url );
```

**Import Functions:**
```php
// Vulnerable import
$import_url = $_POST['import_url'];
$data = wp_remote_get( $import_url );
```

**Webhook Callbacks:**
```php
// Vulnerable webhook
$callback_url = $_POST['callback_url'];
wp_remote_post( $callback_url, array( 'body' => $data ) );
```

---

## 3. Internal Services at Risk

### Database Services

```php
// Attacker can probe internal database
// ?url=http://127.0.0.1:3306
// ?url=http://localhost:5432 (PostgreSQL)
```

### Application Services

```php
// Internal APIs
// ?url=http://127.0.0.1:8080/api
// ?url=http://localhost:3000/admin
```

### Cloud Metadata Services

**AWS:**
```php
// ?url=http://169.254.169.254/latest/meta-data/
// Exposes instance metadata, credentials
```

**Google Cloud:**
```php
// ?url=http://metadata.google.internal/computeMetadata/v1/
```

**Azure:**
```php
// ?url=http://169.254.169.254/metadata/instance
```

### File System Access

```php
// Local file access
// ?url=file:///etc/passwd
// ?url=file:///var/www/config.php
```

---

## 4. Impact of SSRF Attacks

### Information Disclosure

- Internal service discovery
- Metadata exposure
- Configuration file access
- Credential exposure

### Internal Network Access

- Bypass firewall restrictions
- Access internal APIs
- Interact with internal services

### Cloud Environment Risks

- Access cloud metadata
- Retrieve access credentials
- Enumerate cloud resources

### Data Exfiltration

- Read internal files
- Access internal databases
- Retrieve sensitive configuration

---

## 5. SSRF in WordPress Context

### Plugin Vulnerabilities

Many plugins make external requests:
- Social media integrations
- Image processing
- Import/export functionality
- Webhook integrations

### Theme Vulnerabilities

Themes may include:
- External asset loading
- API integrations
- Import functionality

### Core WordPress

WordPress core uses:
- `wp_remote_get()` for updates
- `wp_remote_post()` for pingbacks
- External API calls

---

## 6. Identifying SSRF Risks

### Red Flags

1. **User-Controlled URLs:**
```php
$url = $_GET['url']; // Red flag
$url = $_POST['callback']; // Red flag
```

2. **Direct URL Usage:**
```php
wp_remote_get( $user_input ); // Red flag
file_get_contents( $user_input ); // Red flag
```

3. **No URL Validation:**
```php
// No validation before request
$response = wp_remote_get( $url );
```

4. **Internal IP Ranges:**
```php
// Allowing internal IPs
// 127.0.0.1, localhost, 10.x.x.x, 192.168.x.x
```

---

## 7. Attack Examples

### Example 1: Internal Service Discovery

```php
// Vulnerable code
function fetch_data() {
	$url = $_GET['url'];
	return wp_remote_get( $url );
}

// Attacker probes:
// ?url=http://127.0.0.1:3306 (MySQL)
// ?url=http://127.0.0.1:6379 (Redis)
// ?url=http://127.0.0.1:9200 (Elasticsearch)
```

### Example 2: Metadata Access

```php
// Vulnerable code
function preview_image() {
	$image_url = $_GET['image'];
	$image = wp_remote_get( $image_url );
	// Display image
}

// Attacker accesses:
// ?image=http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

### Example 3: File Access

```php
// Vulnerable code
function import_data() {
	$import_url = $_POST['url'];
	$data = file_get_contents( $import_url );
	// Process data
}

// Attacker reads:
// url=file:///etc/passwd
// url=file:///var/www/wp-config.php
```

---

## Exam Tips

### Key Points to Remember

1. **SSRF Definition:**
   - Server makes requests to attacker-controlled URLs
   - Can access internal services
   - Bypasses firewall restrictions

2. **Common Vectors:**
   - `wp_remote_get()` / `wp_remote_post()`
   - `file_get_contents()`
   - cURL with user input

3. **At-Risk Services:**
   - Internal databases
   - Internal APIs
   - Cloud metadata services
   - Local file system

4. **Impact:**
   - Information disclosure
   - Internal network access
   - Credential exposure
   - Data exfiltration

5. **Red Flags:**
   - User-controlled URLs
   - No URL validation
   - Direct URL usage in requests
   - Allowing internal IP ranges

---

## Additional Resources

- [OWASP SSRF](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery)
- [SSRF Prevention - PortSwigger](https://portswigger.net/web-security/ssrf)
- [WordPress HTTP API - WordPress Developer Resources](https://developer.wordpress.org/plugins/http-api/)
