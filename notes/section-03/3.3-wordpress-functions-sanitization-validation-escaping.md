# 3.3 WordPress Functions for Sanitization, Validation, and Escaping - Study Notes

## Overview

WordPress provides a comprehensive set of functions for sanitization, validation, and escaping. Knowing which function to use in each context is essential for secure WordPress development.

**Key Reference:** [Data Validation - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/validation/) | [Data Sanitization/Escaping - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/security/data-sanitization-escaping/)

---

## 1. Sanitization Functions

### Text Sanitization

#### sanitize_text_field()

Sanitizes a string from user input. Removes invalid UTF-8, strips tags, removes line breaks.

```5590:5602:wordpress/wp-includes/formatting.php
function sanitize_text_field( $str ) {
	$filtered = _sanitize_text_fields( $str, false );

	/**
	 * Filters a sanitized text field string.
	 *
	 * @since 2.9.0
	 *
	 * @param string $filtered The sanitized string.
	 * @param string $str      The string prior to being sanitized.
	 */
	return apply_filters( 'sanitize_text_field', $filtered, $str );
}
```

**Usage:**
```php
$title = sanitize_text_field( $_POST['title'] );
```

#### sanitize_textarea_field()

Like `sanitize_text_field()` but preserves newlines and whitespace.

```5604:5630:wordpress/wp-includes/formatting.php
/**
 * Sanitizes a multiline string from user input or from the database.
 *
 * The function is like sanitize_text_field(), but preserves
 * new lines (\n) and other whitespace, which are legitimate
 * input in textarea elements.
 *
 * @see sanitize_text_field()
 *
 * @since 4.7.0
 *
 * @param string $str String to sanitize.
 * @return string Sanitized string.
 */
function sanitize_textarea_field( $str ) {
	$filtered = _sanitize_text_fields( $str, true );

	/**
	 * Filters a sanitized textarea field string.
	 *
	 * @since 4.7.0
	 *
	 * @param string $filtered The sanitized string.
	 * @param string $str      The string prior to being sanitized.
	 */
	return apply_filters( 'sanitize_textarea_field', $filtered, $str );
}
```

**Usage:**
```php
$description = sanitize_textarea_field( $_POST['description'] );
```

### Email Sanitization

#### sanitize_email()

Sanitizes email addresses by removing invalid characters.

```3769:3785:wordpress/wp-includes/formatting.php
function sanitize_email( $email ) {
	// Test for the minimum length the email can be.
	if ( strlen( $email ) < 6 ) {
		/**
		 * Filters a sanitized email address.
		 *
		 * This filter is evaluated under several contexts, including 'email_too_short',
		 * 'email_no_at', 'local_invalid_chars', 'domain_period_sequence', 'domain_period_limits',
		 * 'domain_no_periods', 'domain_no_valid_subs', or no context.
		 *
		 * @since 2.8.0
		 *
		 * @param string $sanitized_email The sanitized email address.
		 * @param string $email           The email address, as provided to sanitize_email().
		 * @param string|null $message    A message to pass to the user. null if email is sanitized.
		 */
		return apply_filters( 'sanitize_email', '', $email, 'email_too_short' );
	}
```

**Usage:**
```php
$email = sanitize_email( $_POST['email'] );
```

### URL Sanitization

#### esc_url_raw()

Sanitizes URL for database storage (no protocol filtering).

```php
$url = esc_url_raw( $_POST['website'] );
update_post_meta( $post_id, 'website', $url );
```

#### esc_url()

Sanitizes URL for output (filters protocols).

```php
echo '<a href="' . esc_url( $url ) . '">Link</a>';
```

### Key Sanitization

#### sanitize_key()

Sanitizes a string key (alphanumeric, dashes, underscores, lowercase).

```php
$meta_key = sanitize_key( $_GET['key'] );
```

### File Name Sanitization

#### sanitize_file_name()

Sanitizes file names for safe storage.

```php
$filename = sanitize_file_name( $_FILES['upload']['name'] );
```

### Integer Sanitization

#### absint()

Converts value to non-negative integer.

```php
$post_id = absint( $_GET['post_id'] );
```

#### intval()

Converts value to integer (can be negative).

```php
$user_id = intval( $_POST['user_id'] );
```

### HTML Sanitization

#### wp_kses_post()

Sanitizes content for allowed HTML tags for post content.

```2495:2497:wordpress/wp-includes/kses.php
function wp_kses_post( $data ) {
	return wp_kses( $data, 'post' );
}
```

**Usage:**
```php
$content = wp_kses_post( $_POST['content'] );
```

#### wp_kses()

General HTML sanitization with custom allowed tags.

```php
$allowed = array(
	'a' => array( 'href' => array() ),
	'strong' => array(),
);
$content = wp_kses( $_POST['content'], $allowed );
```

---

## 2. Validation Functions

### Email Validation

#### is_email()

Validates email address format.

```3551:3572:wordpress/wp-includes/formatting.php
function is_email( $email, $deprecated = false ) {
	if ( ! empty( $deprecated ) ) {
		_deprecated_argument( __FUNCTION__, '3.0.0' );
	}

	// Test for the minimum length the email can be.
	if ( strlen( $email ) < 6 ) {
		/**
		 * Filters whether an email address is valid.
		 *
		 * This filter is evaluated under several different contexts, such as 'email_too_short',
		 * 'email_no_at', 'local_invalid_chars', 'domain_period_sequence', 'domain_period_limits',
		 * 'domain_no_periods', 'sub_hyphen_limits', 'sub_invalid_chars', or no specific context.
		 *
		 * @since 2.8.0
		 *
		 * @param string|false $is_email The email address if successfully passed the is_email() checks, false otherwise.
		 * @param string       $email    The email address being checked.
		 * @param string       $context  Context under which the email was tested.
		 */
		return apply_filters( 'is_email', false, $email, 'email_too_short' );
	}
```

**Usage:**
```php
if ( ! is_email( $_POST['email'] ) ) {
	wp_die( 'Invalid email address' );
}
```

### File Validation

#### validate_file()

Validates file path against allowed files.

```php
$file = validate_file( $_GET['file'], array( 'allowed-file.php', 'another-file.php' ) );
if ( 0 !== $file ) {
	wp_die( 'Invalid file' );
}
```

### URL Validation

#### wp_validate_redirect()

Validates redirect URLs.

```php
$redirect = wp_validate_redirect( $_GET['redirect'], home_url() );
wp_safe_redirect( $redirect );
```

---

## 3. Escaping Functions

### HTML Context

#### esc_html()

Escapes content for HTML body.

```4689:4704:wordpress/wp-includes/formatting.php
function esc_html( $text ) {
	$safe_text = wp_check_invalid_utf8( $text );
	$safe_text = _wp_specialchars( $safe_text, ENT_QUOTES );
	/**
	 * Filters a string cleaned and escaped for output in HTML.
	 *
	 * Text passed to esc_html() is stripped of invalid or special characters
	 * before output.
	 *
	 * @since 2.8.0
	 *
	 * @param string $safe_text The text after it has been escaped.
	 * @param string $text      The text prior to being escaped.
	 */
	return apply_filters( 'esc_html', $safe_text, $text );
}
```

**Usage:**
```php
echo '<div>' . esc_html( $user_content ) . '</div>';
```

#### esc_attr()

Escapes content for HTML attributes.

```4714:4729:wordpress/wp-includes/formatting.php
function esc_attr( $text ) {
	$safe_text = wp_check_invalid_utf8( $text );
	$safe_text = _wp_specialchars( $safe_text, ENT_QUOTES );
	/**
	 * Filters a string cleaned and escaped for output in an HTML attribute.
	 *
	 * Text passed to esc_attr() is stripped of invalid or special characters
	 * before output.
	 *
	 * @since 2.0.6
	 *
	 * @param string $safe_text The text after it has been escaped.
	 * @param string $text      The text prior to being escaped.
	 */
	return apply_filters( 'attribute_escape', $safe_text, $text );
}
```

**Usage:**
```php
echo '<input value="' . esc_attr( $user_input ) . '">';
```

### URL Context

#### esc_url()

Escapes URL for output.

```php
echo '<a href="' . esc_url( $user_url ) . '">Link</a>';
```

### JavaScript Context

#### esc_js()

Escapes content for JavaScript strings.

```php
echo '<script>var name = "' . esc_js( $user_name ) . '";</script>';
```

#### wp_json_encode()

Encodes data for JavaScript variables (preferred for complex data).

```php
echo '<script>var data = ' . wp_json_encode( $user_data ) . ';</script>';
```

### Textarea Context

#### esc_textarea()

Escapes content for textarea values.

```php
echo '<textarea>' . esc_textarea( $user_content ) . '</textarea>';
```

---

## 4. Function Selection Guide

### When to Sanitize (Before Storage)

| Data Type | Function | Example |
|----------|----------|---------|
| Text input | `sanitize_text_field()` | `sanitize_text_field( $_POST['title'] )` |
| Textarea | `sanitize_textarea_field()` | `sanitize_textarea_field( $_POST['content'] )` |
| Email | `sanitize_email()` | `sanitize_email( $_POST['email'] )` |
| URL (storage) | `esc_url_raw()` | `esc_url_raw( $_POST['url'] )` |
| Key | `sanitize_key()` | `sanitize_key( $_GET['key'] )` |
| File name | `sanitize_file_name()` | `sanitize_file_name( $_FILES['file']['name'] )` |
| Integer | `absint()` or `intval()` | `absint( $_GET['id'] )` |
| HTML content | `wp_kses_post()` | `wp_kses_post( $_POST['content'] )` |

### When to Escape (Before Output)

| Context | Function | Example |
|---------|----------|---------|
| HTML body | `esc_html()` | `echo esc_html( $content );` |
| HTML attribute | `esc_attr()` | `echo '<div class="' . esc_attr( $class ) . '">';` |
| URL | `esc_url()` | `echo '<a href="' . esc_url( $url ) . '">';` |
| JavaScript string | `esc_js()` | `echo '<script>var name = "' . esc_js( $name ) . '";</script>';` |
| JavaScript variable | `wp_json_encode()` | `echo '<script>var data = ' . wp_json_encode( $data ) . ';</script>';` |
| Textarea | `esc_textarea()` | `echo '<textarea>' . esc_textarea( $content ) . '</textarea>';` |

### When to Validate (Before Processing)

| Data Type | Function | Example |
|----------|----------|---------|
| Email | `is_email()` | `if ( ! is_email( $email ) ) { ... }` |
| File | `validate_file()` | `if ( 0 !== validate_file( $file ) ) { ... }` |
| URL | `wp_validate_redirect()` | `$redirect = wp_validate_redirect( $url );` |

---

## 5. Common Patterns

### Complete Form Handling

```php
function handle_form() {
	// 1. Validate
	if ( ! isset( $_POST['email'] ) || ! is_email( $_POST['email'] ) ) {
		wp_die( 'Invalid email' );
	}

	// 2. Sanitize
	$email = sanitize_email( $_POST['email'] );
	$name = sanitize_text_field( $_POST['name'] );
	$message = sanitize_textarea_field( $_POST['message'] );

	// 3. Store
	update_user_meta( $user_id, 'email', $email );
	update_user_meta( $user_id, 'name', $name );
	update_user_meta( $user_id, 'message', $message );

	// 4. Output (escape)
	echo '<div class="success">';
	echo '<p>Thank you, ' . esc_html( $name ) . '!</p>';
	echo '<p>Email: ' . esc_html( $email ) . '</p>';
	echo '</div>';
}
```

### Database Query with Sanitization

```php
global $wpdb;

// Sanitize input
$post_id = absint( $_GET['post_id'] );
$status = sanitize_text_field( $_GET['status'] );

// Use prepared statement
$query = $wpdb->prepare(
	"SELECT * FROM {$wpdb->posts} WHERE ID = %d AND post_status = %s",
	$post_id,
	$status
);
$results = $wpdb->get_results( $query );
```

### Meta Query with Sanitization

```php
// Sanitize meta query parameters
$meta_key = sanitize_key( $_GET['meta_key'] );
$meta_value = sanitize_text_field( $_GET['meta_value'] );

$args = array(
	'meta_query' => array(
		array(
			'key' => $meta_key,
			'value' => $meta_value,
			'compare' => '=',
		),
	),
);
$query = new WP_Query( $args );
```

---

## Exam Tips

### Key Points to Remember

1. **Sanitization (Before Storage):**
   - `sanitize_text_field()` - Text input
   - `sanitize_textarea_field()` - Textarea (preserves newlines)
   - `sanitize_email()` - Email addresses
   - `sanitize_key()` - Keys (alphanumeric, dashes, underscores)
   - `absint()` - Positive integers
   - `wp_kses_post()` - HTML content

2. **Validation (Before Processing):**
   - `is_email()` - Email format validation
   - `validate_file()` - File path validation
   - `wp_validate_redirect()` - URL validation

3. **Escaping (Before Output):**
   - `esc_html()` - HTML body
   - `esc_attr()` - HTML attributes
   - `esc_url()` - URLs
   - `esc_js()` - JavaScript strings
   - `wp_json_encode()` - JavaScript variables
   - `esc_textarea()` - Textarea values

4. **Common Mistakes:**
   - Using escaping functions for sanitization
   - Using sanitization functions for escaping
   - Not validating before sanitizing
   - Using wrong function for context

---

## Additional Resources

- [Data Validation - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/validation/)
- [Data Sanitization/Escaping - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/security/data-sanitization-escaping/)
- Core Files:
  - `wp-includes/formatting.php` - Sanitization and escaping functions
  - `wp-includes/kses.php` - HTML sanitization
