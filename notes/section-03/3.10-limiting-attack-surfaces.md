# 3.10 Limiting Attack Surfaces - Study Notes

## Overview

Limiting attack surfaces involves disabling or restricting unnecessary WordPress features and APIs that could be exploited. This reduces the potential entry points for attackers and minimizes security risks.

**Key Reference:** [Hardening WordPress - WordPress Codex](https://codex.wordpress.org/Hardening_WordPress)

---

## 1. Disabling File Editing

### Plugin/Theme Editor

Disable the built-in file editor to prevent code injection even if an attacker gains admin access:

```php
// In wp-config.php
define( 'DISALLOW_FILE_EDIT', true );
```

This removes the "Plugin Editor" and "Theme Editor" from the WordPress admin, even for users with `edit_plugins` or `edit_themes` capabilities.

### File Modifications

Disable all file modifications (more restrictive):

```php
// In wp-config.php
define( 'DISALLOW_FILE_MODS', true );
```

This prevents:
- Installing/updating plugins and themes from admin
- Editing plugin/theme files
- Requires FTP credentials for updates

---

## 2. Disabling XML-RPC

### Why Disable XML-RPC?

XML-RPC can be exploited for:
- Brute force attacks
- DDoS amplification
- Pingback attacks

### Disabling XML-RPC

**Method 1: Filter (Recommended)**
```php
// In functions.php
add_filter( 'xmlrpc_enabled', '__return_false' );
```

**Method 2: Server-Level Blocking**

Apache (.htaccess):
```apache
<Files xmlrpc.php>
	Order allow,deny
	Deny from all
</Files>
```

Nginx:
```nginx
location ~* xmlrpc.php {
	deny all;
}
```

**Method 3: Remove from Headers**
```php
// Remove XML-RPC from headers
remove_action( 'wp_head', 'rsd_link' );
remove_action( 'wp_head', 'wlwmanifest_link' );
```

---

## 3. Disabling REST API

### Disable REST API Completely

If not needed:
```php
// Remove REST API links from head
remove_action( 'wp_head', 'rest_output_link_wp_head' );
remove_action( 'wp_head', 'wp_oembed_add_discovery_links' );

// Disable REST API
add_filter( 'rest_enabled', '__return_false' );
add_filter( 'rest_jsonp_enabled', '__return_false' );

// Remove REST API from authentication
remove_action( 'rest_api_init', 'wp_oembed_register_route' );
```

### Restrict REST API Access

Allow only authenticated users:
```php
add_filter( 'rest_authentication_errors', function( $result ) {
	if ( ! empty( $result ) ) {
		return $result;
	}
	if ( ! is_user_logged_in() ) {
		return new WP_Error( 'rest_not_logged_in', 'You are not currently logged in.', array( 'status' => 401 ) );
	}
	return $result;
} );
```

---

## 4. Hiding WordPress Information

### Remove Version Number

```php
// Remove version from head
remove_action( 'wp_head', 'wp_generator' );

// Remove version from RSS
add_filter( 'the_generator', '__return_empty_string' );
```

### Remove Other Information

```php
// Remove RSD link
remove_action( 'wp_head', 'rsd_link' );

// Remove Windows Live Writer manifest
remove_action( 'wp_head', 'wlwmanifest_link' );

// Remove shortlink
remove_action( 'wp_head', 'wp_shortlink_wp_head' );
```

---

## 5. Disabling Unused Features

### Disable Trackbacks/Pingbacks

```php
// Disable trackbacks and pingbacks
add_filter( 'xmlrpc_enabled', '__return_false' );
add_filter( 'wp_headers', function( $headers ) {
	unset( $headers['X-Pingback'] );
	return $headers;
} );
```

Or in Settings > Discussion, uncheck:
- "Allow link notifications from other blogs (pingbacks and trackbacks)"

### Disable User Registration

If not needed:
```php
// In wp-config.php or functions.php
add_filter( 'option_users_can_register', '__return_false' );
```

Or in Settings > General, uncheck "Anyone can register".

### Disable Comments

If not needed:
```php
// Disable comments globally
add_filter( 'comments_open', '__return_false', 20, 2 );
add_filter( 'pings_open', '__return_false', 20, 2 );
```

---

## 6. Restricting Admin Access

### Limit Admin Access by IP

```php
function restrict_admin_access() {
	if ( is_admin() && ! current_user_can( 'manage_options' ) ) {
		$allowed_ips = array( '192.168.1.100', '10.0.0.50' );
		$user_ip = $_SERVER['REMOTE_ADDR'];

		if ( ! in_array( $user_ip, $allowed_ips, true ) ) {
			wp_die( 'Access denied' );
		}
	}
}
add_action( 'admin_init', 'restrict_admin_access' );
```

### Two-Factor Authentication

Implement 2FA for admin accounts:
- Use plugins like "Two Factor Authentication"
- Or implement custom 2FA solution

---

## 7. Disabling Directory Browsing

### Prevent Directory Listing

Apache (.htaccess):
```apache
Options -Indexes
```

Nginx:
```nginx
autoindex off;
```

Or create `index.php` in directories:
```php
<?php
// Silence is golden.
```

---

## 8. Blocking Unauthorized Access

### Protect wp-admin

```php
// Require SSL for admin
define( 'FORCE_SSL_ADMIN', true );
```

### Block Suspicious User Agents

```php
function block_suspicious_agents() {
	$blocked_agents = array( 'bot', 'crawler', 'spider' );
	$user_agent = $_SERVER['HTTP_USER_AGENT'];

	foreach ( $blocked_agents as $agent ) {
		if ( stripos( $user_agent, $agent ) !== false ) {
			wp_die( 'Access denied' );
		}
	}
}
add_action( 'init', 'block_suspicious_agents' );
```

---

## 9. Limiting File Uploads

### Restrict File Types

```php
function restrict_upload_types( $mimes ) {
	// Only allow images
	$allowed = array(
		'jpg|jpeg|jpe' => 'image/jpeg',
		'gif' => 'image/gif',
		'png' => 'image/png',
	);
	return $allowed;
}
add_filter( 'upload_mimes', 'restrict_upload_types' );
```

### Disable PHP Execution in Uploads

In `.htaccess` in `wp-content/uploads/`:
```apache
<Files *.php>
	deny from all
</Files>
```

---

## 10. Complete Hardening Example

```php
// functions.php - Complete hardening setup

// Disable file editing
if ( ! defined( 'DISALLOW_FILE_EDIT' ) ) {
	define( 'DISALLOW_FILE_EDIT', true );
}

// Disable XML-RPC
add_filter( 'xmlrpc_enabled', '__return_false' );
remove_action( 'wp_head', 'rsd_link' );
remove_action( 'wp_head', 'wlwmanifest_link' );

// Remove WordPress version
remove_action( 'wp_head', 'wp_generator' );
add_filter( 'the_generator', '__return_empty_string' );

// Remove unnecessary headers
remove_action( 'wp_head', 'wp_shortlink_wp_head' );

// Disable REST API for unauthenticated users
add_filter( 'rest_authentication_errors', function( $result ) {
	if ( ! empty( $result ) ) {
		return $result;
	}
	if ( ! is_user_logged_in() ) {
		return new WP_Error( 'rest_not_logged_in', 'Authentication required.', array( 'status' => 401 ) );
	}
	return $result;
} );

// Force SSL for admin
if ( ! defined( 'FORCE_SSL_ADMIN' ) ) {
	define( 'FORCE_SSL_ADMIN', true );
}
```

---

## Exam Tips

### Key Points to Remember

1. **File Editing:**
   - `DISALLOW_FILE_EDIT` - Disable editor
   - `DISALLOW_FILE_MODS` - Disable all file mods

2. **XML-RPC:**
   - Can be exploited for brute force
   - Disable if not needed
   - Block at server level for extra security

3. **REST API:**
   - Can expose information
   - Restrict to authenticated users if needed
   - Disable completely if not used

4. **Information Disclosure:**
   - Remove version numbers
   - Remove RSD links
   - Remove unnecessary headers

5. **Common Practices:**
   - Disable unused features
   - Restrict file uploads
   - Block directory browsing
   - Use SSL for admin

---

## Additional Resources

- [Hardening WordPress - WordPress Codex](https://codex.wordpress.org/Hardening_WordPress)
- [Security Best Practices - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/security/)
