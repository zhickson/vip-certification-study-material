# 3.23 Incorporating Security Checks into CI Pipelines - Study Notes

## Overview

Incorporating security checks into CI/CD pipelines ensures code is automatically scanned for vulnerabilities before deployment. This topic covers setting up automated security testing in continuous integration workflows.

**Key Reference:** [CI/CD Security - OWASP](https://owasp.org/www-project-devsecops/)

---

## 1. CI/CD Security Pipeline

### Pipeline Stages

```yaml
# .github/workflows/security.yml
name: Security Checks

on: [push, pull_request]

jobs:
	security:
		runs-on: ubuntu-latest
		steps:
			- uses: actions/checkout@v2

			# Setup PHP
			- uses: shivammathur/setup-php@v2
				with:
					php-version: '8.0'

			# Install dependencies
			- run: composer install

			# Security checks
			- name: PHPCS
				run: ./vendor/bin/phpcs --standard=WordPress src/

			- name: PHPStan
				run: ./vendor/bin/phpstan analyse

			- name: Security Checker
				run: ./vendor/bin/security-checker security:check

			- name: WPScan (if applicable)
				run: |
					gem install wpscan
					wpscan --url http://localhost --no-banner
```

---

## 2. Security Check Tools

### Dependency Scanning

**SensioLabs Security Checker:**
```yaml
- name: Check Dependencies
	run: |
		composer require --dev sensiolabs/security-checker
		./vendor/bin/security-checker security:check
```

**Snyk:**
```yaml
- name: Snyk Security Scan
	uses: snyk/actions/php@master
	env:
		SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
```

### Code Analysis

**PHPStan:**
```yaml
- name: PHPStan Analysis
	run: |
		composer require --dev phpstan/phpstan
		./vendor/bin/phpstan analyse --level=5
```

**Psalm:**
```yaml
- name: Psalm Analysis
	run: |
		composer require --dev vimeo/psalm
		./vendor/bin/psalm
```

### Coding Standards

**PHPCS:**
```yaml
- name: PHPCS Check
	run: |
		composer require --dev wp-coding-standards/wpcs
		./vendor/bin/phpcs --standard=WordPress --extensions=php src/
```

---

## 3. WordPress-Specific Checks

### WPScan Integration

```yaml
- name: WPScan Vulnerability Check
	run: |
		gem install wpscan
		wpscan --url ${{ secrets.SITE_URL }} \
			--api-token ${{ secrets.WPSCAN_API_TOKEN }} \
			--format json \
			--output wpscan-report.json
```

### Plugin Security Scan

```yaml
- name: Plugin Security Scan
	run: |
		# Check for common vulnerabilities
		./scripts/security-scan.sh
```

---

## 4. Automated Testing

### Security Test Suite

```php
// tests/security-tests.php
class Security_Tests extends WP_UnitTestCase {
	public function test_sql_injection_protection() {
		// Test that user input is properly sanitized
		$input = "'; DROP TABLE posts; --";
		$sanitized = sanitize_text_field( $input );
		$this->assertNotContains( 'DROP', $sanitized );
	}

	public function test_xss_protection() {
		// Test that output is escaped
		$input = '<script>alert("XSS")</script>';
		$escaped = esc_html( $input );
		$this->assertNotContains( '<script>', $escaped );
	}

	public function test_nonce_verification() {
		// Test that nonces are verified
		$_POST['nonce'] = 'invalid';
		$result = wp_verify_nonce( $_POST['nonce'], 'action' );
		$this->assertFalse( $result );
	}
}
```

### Running Tests in CI

```yaml
- name: Run Security Tests
	run: |
		composer require --dev phpunit/phpunit
		./vendor/bin/phpunit tests/security-tests.php
```

---

## 5. GitLab CI Example

```yaml
# .gitlab-ci.yml
stages:
	- security

security_checks:
	stage: security
	image: php:8.0
	before_script:
		- composer install
	script:
		- ./vendor/bin/phpcs --standard=WordPress src/
		- ./vendor/bin/phpstan analyse
		- ./vendor/bin/security-checker security:check
	only:
		- merge_requests
		- main
```

---

## 6. Jenkins Pipeline

```groovy
pipeline {
	agent any

	stages {
		stage('Security Checks') {
			steps {
				sh 'composer install'
				sh './vendor/bin/phpcs --standard=WordPress src/'
				sh './vendor/bin/phpstan analyse'
				sh './vendor/bin/security-checker security:check'
			}
		}
	}

	post {
		always {
			publishHTML([
				reportDir: 'reports',
				reportFiles: 'security-report.html',
				reportName: 'Security Report'
			])
		}
	}
}
```

---

## 7. Security Gates

### Fail on Critical Issues

```yaml
- name: Security Gate
	run: |
		# Run security checks
		phpcs_output=$(./vendor/bin/phpcs --standard=WordPress src/ 2>&1)
		phpcs_exit=$?

		# Check for critical issues
		if echo "$phpcs_output" | grep -q "ERROR"; then
			echo "Critical security issues found"
			exit 1
		fi

		# Allow warnings but log them
		if echo "$phpcs_output" | grep -q "WARNING"; then
			echo "Security warnings found (non-blocking)"
		fi

		exit $phpcs_exit
```

---

## Exam Tips

### Key Points to Remember

1. **CI/CD Security:**
   - Automated scanning
   - Dependency checks
   - Code analysis
   - Security tests

2. **Tools Integration:**
   - PHPCS for standards
   - PHPStan for bugs
   - Security checker for dependencies
   - WPScan for vulnerabilities

3. **Pipeline Stages:**
   - Install dependencies
   - Run security checks
   - Run tests
   - Generate reports

4. **Best Practices:**
   - Fail on critical issues
   - Warn on non-critical
   - Generate reports
   - Integrate with PRs

---

## Additional Resources

- [GitHub Actions](https://docs.github.com/en/actions)
- [GitLab CI](https://docs.gitlab.com/ee/ci/)
- [CI/CD Security - OWASP](https://owasp.org/www-project-devsecops/)
