# 3.18 Logging and Audit Trails in WordPress - Study Notes

## Overview

Logging and audit trails are essential for security forensics, detecting attacks, and compliance. WordPress provides various logging mechanisms, and custom logging can track critical security events.

**Key Reference:** [WordPress Debugging - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)

---

## 1. What to Log

### Critical Security Events

**Authentication Events:**
- Successful logins
- Failed login attempts
- Logout events
- Password changes
- Session creation/destruction

**Authorization Events:**
- Permission denials
- Capability checks
- Role changes
- User creation/deletion

**Content Changes:**
- Post creation/editing/deletion
- Plugin activation/deactivation
- Theme changes
- Settings modifications

**System Events:**
- File modifications
- Database changes
- Configuration changes
- Update installations

---

## 2. WordPress Built-in Logging

### Error Logging

```php
// Enable error logging
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_LOG', true );
define( 'WP_DEBUG_DISPLAY', false );

// Logs to: wp-content/debug.log
```

**Usage:**
```php
error_log( 'Security event: Failed login attempt' );
error_log( 'User ID: ' . $user_id . ' attempted unauthorized action' );
```

### Action and Filter Hooks

WordPress fires hooks that can be logged:

```php
// Log login events
add_action( 'wp_login', function( $user_login, $user ) {
	error_log( "User {$user_login} (ID: {$user->ID}) logged in" );
}, 10, 2 );

add_action( 'wp_login_failed', function( $username ) {
	$ip = $_SERVER['REMOTE_ADDR'];
	error_log( "Failed login attempt for {$username} from IP {$ip}" );
} );

// Log logout
add_action( 'wp_logout', function() {
	$user = wp_get_current_user();
	error_log( "User {$user->user_login} (ID: {$user->ID}) logged out" );
} );
```

---

## 3. Custom Logging System

### Database Logging

```php
function create_audit_log_table() {
	global $wpdb;

	$table_name = $wpdb->prefix . 'audit_log';

	$charset_collate = $wpdb->get_charset_collate();

	$sql = "CREATE TABLE IF NOT EXISTS {$table_name} (
		id bigint(20) NOT NULL AUTO_INCREMENT,
		user_id bigint(20) DEFAULT NULL,
		action varchar(100) NOT NULL,
		object_type varchar(50) DEFAULT NULL,
		object_id bigint(20) DEFAULT NULL,
		ip_address varchar(45) DEFAULT NULL,
		user_agent text,
		details text,
		timestamp datetime DEFAULT CURRENT_TIMESTAMP,
		PRIMARY KEY (id),
		KEY user_id (user_id),
		KEY action (action),
		KEY timestamp (timestamp)
	) {$charset_collate};";

	require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
	dbDelta( $sql );
}
register_activation_hook( __FILE__, 'create_audit_log_table' );
```

### Logging Function

```php
function log_security_event( $action, $object_type = null, $object_id = null, $details = array() ) {
	global $wpdb;

	$user_id = get_current_user_id();
	$ip = $_SERVER['REMOTE_ADDR'];
	$user_agent = $_SERVER['HTTP_USER_AGENT'];

	$wpdb->insert(
		$wpdb->prefix . 'audit_log',
		array(
			'user_id' => $user_id ? $user_id : null,
			'action' => $action,
			'object_type' => $object_type,
			'object_id' => $object_id,
			'ip_address' => $ip,
			'user_agent' => $user_agent,
			'details' => json_encode( $details ),
			'timestamp' => current_time( 'mysql' ),
		)
	);
}
```

---

## 4. Logging Specific Events

### Login Events

```php
add_action( 'wp_login', function( $user_login, $user ) {
	log_security_event(
		'login_success',
		'user',
		$user->ID,
		array( 'username' => $user_login )
	);
}, 10, 2 );

add_action( 'wp_login_failed', function( $username ) {
	log_security_event(
		'login_failed',
		'user',
		null,
		array( 'username' => $username )
	);
} );
```

### Post Changes

```php
add_action( 'save_post', function( $post_id, $post, $update ) {
	if ( $update ) {
		$action = 'post_updated';
	} else {
		$action = 'post_created';
	}

	log_security_event(
		$action,
		'post',
		$post_id,
		array(
			'post_type' => $post->post_type,
			'post_title' => $post->post_title,
		)
	);
}, 10, 3 );

add_action( 'before_delete_post', function( $post_id ) {
	$post = get_post( $post_id );
	log_security_event(
		'post_deleted',
		'post',
		$post_id,
		array(
			'post_type' => $post->post_type,
			'post_title' => $post->post_title,
		)
	);
} );
```

### Plugin/Theme Changes

```php
add_action( 'activated_plugin', function( $plugin ) {
	log_security_event(
		'plugin_activated',
		'plugin',
		null,
		array( 'plugin' => $plugin )
	);
} );

add_action( 'deactivated_plugin', function( $plugin ) {
	log_security_event(
		'plugin_deactivated',
		'plugin',
		null,
		array( 'plugin' => $plugin )
	);
} );

add_action( 'switch_theme', function( $new_theme ) {
	log_security_event(
		'theme_changed',
		'theme',
		null,
		array( 'theme' => $new_theme )
	);
} );
```

### User Changes

```php
add_action( 'user_register', function( $user_id ) {
	log_security_event(
		'user_created',
		'user',
		$user_id,
		array( 'username' => get_userdata( $user_id )->user_login )
	);
} );

add_action( 'delete_user', function( $user_id ) {
	$user = get_userdata( $user_id );
	log_security_event(
		'user_deleted',
		'user',
		$user_id,
		array( 'username' => $user->user_login )
	);
} );

add_action( 'set_user_role', function( $user_id, $role, $old_roles ) {
	log_security_event(
		'user_role_changed',
		'user',
		$user_id,
		array(
			'new_role' => $role,
			'old_roles' => $old_roles,
		)
	);
}, 10, 3 );
```

---

## 5. Log Storage and Security

### Secure Log Storage

```php
// Store logs outside web root
define( 'WP_DEBUG_LOG', '/var/log/wordpress/debug.log' );

// Or use database (more secure)
function log_to_database( $message, $level = 'info' ) {
	global $wpdb;
	$wpdb->insert(
		$wpdb->prefix . 'security_logs',
		array(
			'message' => $message,
			'level' => $level,
			'timestamp' => current_time( 'mysql' ),
		)
	);
}
```

### Log Rotation

```php
function rotate_logs() {
	$log_file = WP_CONTENT_DIR . '/debug.log';

	if ( file_exists( $log_file ) && filesize( $log_file ) > 10 * 1024 * 1024 ) { // 10MB
		$backup = $log_file . '.' . date( 'Y-m-d' );
		rename( $log_file, $backup );

		// Keep only last 7 days
		$old_logs = glob( $log_file . '.*' );
		foreach ( $old_logs as $old_log ) {
			if ( filemtime( $old_log ) < strtotime( '-7 days' ) ) {
				unlink( $old_log );
			}
		}
	}
}
add_action( 'wp_scheduled_delete', 'rotate_logs' );
```

---

## 6. Log Analysis

### Query Logs

```php
function get_security_logs( $args = array() ) {
	global $wpdb;

	$defaults = array(
		'action' => null,
		'user_id' => null,
		'limit' => 100,
		'offset' => 0,
	);
	$args = wp_parse_args( $args, $defaults );

	$where = array( '1=1' );

	if ( $args['action'] ) {
		$where[] = $wpdb->prepare( 'action = %s', $args['action'] );
	}

	if ( $args['user_id'] ) {
		$where[] = $wpdb->prepare( 'user_id = %d', $args['user_id'] );
	}

	$where_clause = implode( ' AND ', $where );

	$logs = $wpdb->get_results( $wpdb->prepare(
		"SELECT * FROM {$wpdb->prefix}audit_log
		WHERE {$where_clause}
		ORDER BY timestamp DESC
		LIMIT %d OFFSET %d",
		$args['limit'],
		$args['offset']
	) );

	return $logs;
}
```

### Statistics

```php
function get_login_statistics() {
	global $wpdb;

	$stats = $wpdb->get_results(
		"SELECT
			DATE(timestamp) as date,
			action,
			COUNT(*) as count
		FROM {$wpdb->prefix}audit_log
		WHERE action IN ('login_success', 'login_failed')
		AND timestamp >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY DATE(timestamp), action
		ORDER BY date DESC"
	);

	return $stats;
}
```

---

## Exam Tips

### Key Points to Remember

1. **What to Log:**
   - Authentication events
   - Authorization events
   - Content changes
   - System events

2. **Logging Methods:**
   - WordPress error_log()
   - Custom database tables
   - File-based logging
   - External logging services

3. **Security:**
   - Store logs securely
   - Rotate logs regularly
   - Protect log access
   - Encrypt sensitive data

4. **Analysis:**
   - Query logs for patterns
   - Generate statistics
   - Monitor for anomalies
   - Alert on critical events

---

## Additional Resources

- [WordPress Debugging - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/debug/debug-wordpress/)
- [Audit Logging - OWASP](https://owasp.org/www-community/Auditing)
