# 3.2 Secure Handling of User Input and Output - Study Notes

## Overview

Secure handling of user input and output is fundamental to WordPress security. All user data must be validated, sanitized, and escaped appropriately based on context. This topic covers the complete data flow from input to output.

**Key Reference:** [Data Validation - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/validation/) | [Data Sanitization/Escaping - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/security/data-sanitization-escaping/)

---

## 1. The Security Principle: Validate, Sanitize, Escape

### Three-Step Process

1. **Validate** - Check if data meets expected format/type (input validation)
2. **Sanitize** - Clean data before storing in database (input sanitization)
3. **Escape** - Escape data before outputting to browser (output escaping)

```php
// Complete flow example
function handle_form_submission() {
	// 1. VALIDATE - Check if data is valid
	if ( ! isset( $_POST['email'] ) || ! is_email( $_POST['email'] ) ) {
		wp_die( 'Invalid email address' );
	}

	// 2. SANITIZE - Clean data before storing
	$email = sanitize_email( $_POST['email'] );
	$name = sanitize_text_field( $_POST['name'] );

	// Store in database
	update_user_meta( $user_id, 'email', $email );
	update_user_meta( $user_id, 'name', $name );

	// 3. ESCAPE - Escape when outputting
	echo esc_html( $name );
	echo esc_attr( $email );
}
```

---

## 2. WordPress Sanitization Functions

### Text Field Sanitization

#### sanitize_text_field()

Sanitizes a string from user input or database. Removes invalid UTF-8, strips tags, removes line breaks.

```5590:5602:wordpress/wp-includes/formatting.php
function sanitize_text_field( $str ) {
	$filtered = _sanitize_text_fields( $str, false );

	/**
	 * Filters a sanitized text field string.
	 *
	 * @since 2.9.0
	 *
	 * @param string $filtered The sanitized string.
	 * @param string $str      The string prior to being sanitized.
	 */
	return apply_filters( 'sanitize_text_field', $filtered, $str );
}
```

**Usage:**
```php
// Sanitize text input
$title = sanitize_text_field( $_POST['title'] );
update_post_meta( $post_id, 'custom_title', $title );
```

#### sanitize_textarea_field()

Like `sanitize_text_field()` but preserves newlines and whitespace.

```5604:5630:wordpress/wp-includes/formatting.php
/**
 * Sanitizes a multiline string from user input or from the database.
 *
 * The function is like sanitize_text_field(), but preserves
 * new lines (\n) and other whitespace, which are legitimate
 * input in textarea elements.
 *
 * @see sanitize_text_field()
 *
 * @since 4.7.0
 *
 * @param string $str String to sanitize.
 * @return string Sanitized string.
 */
function sanitize_textarea_field( $str ) {
	$filtered = _sanitize_text_fields( $str, true );

	/**
	 * Filters a sanitized textarea field string.
	 *
	 * @since 4.7.0
	 *
	 * @param string $filtered The sanitized string.
	 * @param string $str      The string prior to being sanitized.
	 */
	return apply_filters( 'sanitize_textarea_field', $filtered, $str );
}
```

**Usage:**
```php
// Sanitize textarea input (preserves newlines)
$description = sanitize_textarea_field( $_POST['description'] );
update_post_meta( $post_id, 'description', $description );
```

### Email Sanitization

```php
// Sanitize email address
$email = sanitize_email( $_POST['email'] );

// Also validate
if ( ! is_email( $email ) ) {
	wp_die( 'Invalid email' );
}
```

### URL Sanitization

```php
// Sanitize URL
$url = esc_url_raw( $_POST['website'] ); // For database storage
$url = esc_url( $url ); // For output
```

### Key Sanitization

```php
// Sanitize key (alphanumeric, dashes, underscores)
$meta_key = sanitize_key( $_GET['key'] );
```

### File Name Sanitization

```php
// Sanitize file name
$filename = sanitize_file_name( $_FILES['upload']['name'] );
```

### Integer Sanitization

```php
// Sanitize integer
$post_id = absint( $_GET['post_id'] );
$user_id = intval( $_POST['user_id'] );
```

### HTML Sanitization

For content that should allow HTML tags:

```2495:2497:wordpress/wp-includes/kses.php
function wp_kses_post( $data ) {
	return wp_kses( $data, 'post' );
}
```

```php
// Allow post content HTML
$content = wp_kses_post( $_POST['content'] );
```

---

## 3. WordPress Escaping Functions

### HTML Context Escaping

#### esc_html()

Escapes content for HTML body:

```4689:4704:wordpress/wp-includes/formatting.php
function esc_html( $text ) {
	$safe_text = wp_check_invalid_utf8( $text );
	$safe_text = _wp_specialchars( $safe_text, ENT_QUOTES );
	/**
	 * Filters a string cleaned and escaped for output in HTML.
	 *
	 * Text passed to esc_html() is stripped of invalid or special characters
	 * before output.
	 *
	 * @since 2.8.0
	 *
	 * @param string $safe_text The text after it has been escaped.
	 * @param string $text      The text prior to being escaped.
	 */
	return apply_filters( 'esc_html', $safe_text, $text );
}
```

**Usage:**
```php
// Escape for HTML body
echo '<div>' . esc_html( $user_content ) . '</div>';
```

#### esc_attr()

Escapes content for HTML attributes:

```4714:4729:wordpress/wp-includes/formatting.php
function esc_attr( $text ) {
	$safe_text = wp_check_invalid_utf8( $text );
	$safe_text = _wp_specialchars( $safe_text, ENT_QUOTES );
	/**
	 * Filters a string cleaned and escaped for output in an HTML attribute.
	 *
	 * Text passed to esc_attr() is stripped of invalid or special characters
	 * before output.
	 *
	 * @since 2.0.6
	 *
	 * @param string $safe_text The text after it has been escaped.
	 * @param string $text      The text prior to being escaped.
	 */
	return apply_filters( 'attribute_escape', $safe_text, $text );
}
```

**Usage:**
```php
// Escape for HTML attributes
echo '<input type="text" value="' . esc_attr( $user_input ) . '">';
echo '<div class="' . esc_attr( $custom_class ) . '">';
```

### URL Context Escaping

```php
// Escape for URLs
echo '<a href="' . esc_url( $user_url ) . '">Link</a>';

// For database storage (no protocol filtering)
$url = esc_url_raw( $_POST['url'] );
```

### JavaScript Context Escaping

```php
// Escape for JavaScript
echo '<script>var data = ' . wp_json_encode( $user_data ) . ';</script>';

// Or use esc_js() for simple strings
echo '<script>var name = "' . esc_js( $user_name ) . '";</script>';
```

### CSS Context Escaping

```php
// Escape for CSS
echo '<div style="color: ' . esc_attr( $color ) . ';">'; // Use esc_attr for CSS
```

---

## 4. Context-Aware Escaping

### Choosing the Right Escaping Function

| Context | Function | Example |
|---------|----------|---------|
| HTML body | `esc_html()` | `<div><?php echo esc_html( $text ); ?></div>` |
| HTML attribute | `esc_attr()` | `<input value="<?php echo esc_attr( $value ); ?>">` |
| URL | `esc_url()` | `<a href="<?php echo esc_url( $url ); ?>">` |
| JavaScript variable | `wp_json_encode()` | `<script>var data = <?php echo wp_json_encode( $data ); ?>;</script>` |
| JavaScript string | `esc_js()` | `<script>var name = "<?php echo esc_js( $name ); ?>";</script>` |
| CSS | `esc_attr()` | `<div style="color: <?php echo esc_attr( $color ); ?>">` |

### Common Mistakes

```php
// ❌ BAD - Wrong context
echo '<input value="' . esc_html( $value ) . '">'; // Should use esc_attr()

// ❌ BAD - No escaping
echo '<div>' . $user_content . '</div>';

// ❌ BAD - Escaping too early (before database)
$content = esc_html( $_POST['content'] ); // Should sanitize, not escape
update_post_meta( $post_id, 'content', $content );

// ✅ GOOD - Correct flow
$content = sanitize_textarea_field( $_POST['content'] ); // Sanitize for storage
update_post_meta( $post_id, 'content', $content );
echo '<div>' . esc_html( $content ) . '</div>'; // Escape for output
```

---

## 5. Form Handling Best Practices

### Complete Form Example

```php
function handle_contact_form() {
	// Check nonce first
	if ( ! isset( $_POST['contact_nonce'] ) || ! wp_verify_nonce( $_POST['contact_nonce'], 'contact_form' ) ) {
		wp_die( 'Security check failed' );
	}

	// Check user capability
	if ( ! current_user_can( 'publish_posts' ) ) {
		wp_die( 'Insufficient permissions' );
	}

	// Validate required fields
	if ( empty( $_POST['name'] ) || empty( $_POST['email'] ) ) {
		wp_die( 'Name and email are required' );
	}

	// Validate email format
	if ( ! is_email( $_POST['email'] ) ) {
		wp_die( 'Invalid email address' );
	}

	// Sanitize all inputs
	$name = sanitize_text_field( $_POST['name'] );
	$email = sanitize_email( $_POST['email'] );
	$message = sanitize_textarea_field( $_POST['message'] );
	$website = esc_url_raw( $_POST['website'] );

	// Store in database
	$post_data = array(
		'post_title' => $name,
		'post_content' => $message,
		'post_status' => 'publish',
		'post_type' => 'contact_submission',
	);
	$post_id = wp_insert_post( $post_data );

	// Store meta
	update_post_meta( $post_id, 'email', $email );
	update_post_meta( $post_id, 'website', $website );

	// Output safely
	echo '<div class="success">';
	echo '<p>Thank you, ' . esc_html( $name ) . '!</p>';
	echo '<p>We received your message.</p>';
	echo '</div>';
}
```

### Form Display Example

```php
function render_contact_form() {
	?>
	<form method="post" action="">
		<?php wp_nonce_field( 'contact_form', 'contact_nonce' ); ?>

		<label for="name">Name:</label>
		<input type="text" id="name" name="name" value="<?php echo esc_attr( isset( $_POST['name'] ) ? $_POST['name'] : '' ); ?>" required>

		<label for="email">Email:</label>
		<input type="email" id="email" name="email" value="<?php echo esc_attr( isset( $_POST['email'] ) ? $_POST['email'] : '' ); ?>" required>

		<label for="message">Message:</label>
		<textarea id="message" name="message" required><?php echo esc_textarea( isset( $_POST['message'] ) ? $_POST['message'] : '' ); ?></textarea>

		<input type="submit" value="Submit">
	</form>
	<?php
}
```

---

## 6. Unsafe Patterns to Avoid

### Direct Superglobal Usage

```php
// ❌ BAD - Direct usage
echo $_GET['search'];
echo $_POST['title'];
echo $_REQUEST['data'];

// ✅ GOOD - Sanitize first
echo esc_html( sanitize_text_field( $_GET['search'] ) );
echo esc_html( sanitize_text_field( $_POST['title'] ) );
```

### Database Output Without Escaping

```php
// ❌ BAD - Data from database may be unsafe
$post = get_post( $post_id );
echo $post->post_content; // May contain malicious code

// ✅ GOOD - Escape database output
$post = get_post( $post_id );
echo wp_kses_post( $post->post_content ); // For post content
// OR
echo esc_html( $post->post_excerpt ); // For plain text
```

### Double Escaping

```php
// ❌ BAD - Double escaping
$content = esc_html( esc_html( $text ) ); // Unnecessary

// ✅ GOOD - Single escape
$content = esc_html( $text );
```

### Escaping Before Storage

```php
// ❌ BAD - Escaping before storage
$title = esc_html( $_POST['title'] );
update_post_meta( $post_id, 'title', $title ); // Stored escaped

// ✅ GOOD - Sanitize for storage, escape for output
$title = sanitize_text_field( $_POST['title'] );
update_post_meta( $post_id, 'title', $title );
echo esc_html( get_post_meta( $post_id, 'title', true ) ); // Escape on output
```

---

## Exam Tips

### Key Points to Remember

1. **Three-Step Process:**
   - Validate (check format/type)
   - Sanitize (clean before storage)
   - Escape (escape before output)

2. **Sanitization Functions:**
   - `sanitize_text_field()` - Text input
   - `sanitize_textarea_field()` - Textarea (preserves newlines)
   - `sanitize_email()` - Email addresses
   - `sanitize_key()` - Keys (alphanumeric, dashes, underscores)
   - `sanitize_file_name()` - File names
   - `absint()` - Positive integers
   - `wp_kses_post()` - HTML content

3. **Escaping Functions:**
   - `esc_html()` - HTML body
   - `esc_attr()` - HTML attributes
   - `esc_url()` - URLs
   - `esc_js()` - JavaScript strings
   - `wp_json_encode()` - JavaScript variables
   - `esc_textarea()` - Textarea values

4. **Common Mistakes:**
   - Using wrong escaping function for context
   - Escaping before storage instead of sanitizing
   - Not escaping database output
   - Direct superglobal usage
   - Double escaping

---

## Additional Resources

- [Data Validation - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/validation/)
- [Data Sanitization/Escaping - WordPress Developer Resources](https://developer.wordpress.org/apis/handbook/security/data-sanitization-escaping/)
- [Validating Sanitizing and Escaping User Data - WordPress Codex](https://codex.wordpress.org/Validating_Sanitizing_and_Escaping_User_Data)
- Core Files:
  - `wp-includes/formatting.php` - Sanitization and escaping functions
  - `wp-includes/kses.php` - HTML sanitization
