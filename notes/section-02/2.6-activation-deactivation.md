# 2.6 Activation and Deactivation - Study Notes

## Overview

Managing plugin lifecycle events (activation, deactivation, and uninstall) safely is crucial for WordPress development. This involves registering options, roles, or custom tables on activation, cleaning up on deactivation/uninstall, flushing rewrite rules, and ensuring reversibility.

**Key Reference:** [Plugin Lifecycle - WordPress Developer Resources](https://developer.wordpress.org/plugins/plugin-basics/activation-deactivation-hooks/)

---

## 1. Register Options, Roles, or Custom Tables on Activation

### Activation Hook Registration

**Function:** `register_activation_hook( $file, $callback )`

**Core Implementation:**
```879:882:wordpress/wp-includes/plugin.php
function register_activation_hook( $file, $callback ) {
	$file = plugin_basename( $file );
	add_action( 'activate_' . $file, $callback );
}
```

**Basic Example:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate() {
	// Activation code here
}
```

### Registering Options

**Example - Register Default Options:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate() {
	// Set default options if they don't exist
	$default_options = array(
		'api_key' => '',
		'enable_feature' => true,
		'cache_duration' => 3600,
	);

	// Only add if option doesn't exist
	if ( false === get_option( 'my_plugin_settings' ) ) {
		add_option( 'my_plugin_settings', $default_options );
	}

	// Or update existing with defaults
	$current = get_option( 'my_plugin_settings', array() );
	$merged = wp_parse_args( $current, $default_options );
	update_option( 'my_plugin_settings', $merged );
}
```

### Registering Custom Roles

**Example - Create Custom Role:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate() {
	// Add custom role
	add_role(
		'content_manager',
		__( 'Content Manager', 'my-plugin' ),
		array(
			'read' => true,
			'edit_posts' => true,
			'edit_published_posts' => true,
			'publish_posts' => true,
			'delete_posts' => true,
			'upload_files' => true,
		)
	);

	// Add capabilities to existing role
	$role = get_role( 'editor' );
	if ( $role ) {
		$role->add_cap( 'manage_my_plugin' );
	}
}
```

### Creating Custom Tables

**Example - Create Custom Table:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate() {
	global $wpdb;

	$table_name = $wpdb->prefix . 'my_plugin_data';
	$charset_collate = $wpdb->get_charset_collate();

	$sql = "CREATE TABLE $table_name (
		id bigint(20) NOT NULL AUTO_INCREMENT,
		user_id bigint(20) NOT NULL,
		data text NOT NULL,
		created_at datetime DEFAULT CURRENT_TIMESTAMP,
		PRIMARY KEY  (id),
		KEY user_id (user_id)
	) $charset_collate;";

	require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
	dbDelta( $sql );

	// Store version for future migrations
	update_option( 'my_plugin_db_version', '1.0' );
}
```

**Using dbDelta:**

The `dbDelta()` function:
- Creates table if it doesn't exist
- Updates structure if it exists but differs
- Handles charset/collation automatically

**Important:** Table structure must match exactly (spacing, formatting).

---

## 2. Clean Up Options, Roles, or Custom Data on Deactivation/Uninstall

### Deactivation Hook

**Function:** `register_deactivation_hook( $file, $callback )`

**Core Implementation:**
```902:905:wordpress/wp-includes/plugin.php
function register_deactivation_hook( $file, $callback ) {
	$file = plugin_basename( $file );
	add_action( 'deactivate_' . $file, $callback );
}
```

**Example - Deactivation:**

```php
register_deactivation_hook( __FILE__, 'my_plugin_deactivate' );

function my_plugin_deactivate() {
	// Clear scheduled events
	$timestamp = wp_next_scheduled( 'my_plugin_cron_event' );
	if ( $timestamp ) {
		wp_unschedule_event( $timestamp, 'my_plugin_cron_event' );
	}

	// Clear transients
	delete_transient( 'my_plugin_cache' );

	// Flush rewrite rules
	flush_rewrite_rules();
}
```

### Uninstall Hook

**Function:** `register_uninstall_hook( $file, $callback )`

**Important:** Uninstall hook runs when plugin is deleted, not just deactivated.

**Example - Uninstall:**

```php
register_uninstall_hook( __FILE__, 'my_plugin_uninstall' );

function my_plugin_uninstall() {
	// Delete options
	delete_option( 'my_plugin_settings' );
	delete_option( 'my_plugin_db_version' );

	// Delete transients
	delete_transient( 'my_plugin_cache' );

	// Delete custom table
	global $wpdb;
	$table_name = $wpdb->prefix . 'my_plugin_data';
	$wpdb->query( "DROP TABLE IF EXISTS $table_name" );

	// Remove custom role
	remove_role( 'content_manager' );

	// Remove capabilities from roles
	$role = get_role( 'editor' );
	if ( $role ) {
		$role->remove_cap( 'manage_my_plugin' );
	}
}
```

**Alternative - Uninstall File:**

Create `uninstall.php` in plugin root:

```php
<?php
/**
 * Uninstall handler.
 *
 * @package My_Plugin
 */

// If uninstall not called from WordPress, then exit.
if ( ! defined( 'WP_UNINSTALL_PLUGIN' ) ) {
	exit;
}

// Delete options
delete_option( 'my_plugin_settings' );

// Delete custom table
global $wpdb;
$table_name = $wpdb->prefix . 'my_plugin_data';
$wpdb->query( "DROP TABLE IF EXISTS $table_name" );

// Remove role
remove_role( 'content_manager' );
```

**What to Delete on Uninstall:**

- ✅ Plugin-specific options
- ✅ Custom tables
- ✅ Custom roles/capabilities
- ✅ Transients
- ✅ Scheduled events

**What NOT to Delete:**

- ❌ User data (unless explicitly requested)
- ❌ Content created by plugin (posts, pages)
- ❌ Other plugins' data

---

## 3. Flush Rewrite Rules When Appropriate

### When to Flush

**On Activation:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate() {
	// Register custom post types/taxonomies
	my_plugin_register_post_types();

	// Flush rewrite rules
	flush_rewrite_rules();
}
```

**On Deactivation:**

```php
register_deactivation_hook( __FILE__, 'my_plugin_deactivate' );

function my_plugin_deactivate() {
	// Flush to remove custom rewrite rules
	flush_rewrite_rules();
}
```

**Function:** `flush_rewrite_rules( $hard = true )`

**Core Implementation:**
```278:284:wordpress/wp-includes/rewrite.php
function flush_rewrite_rules( $hard = true ) {
	global $wp_rewrite;

	if ( is_callable( array( $wp_rewrite, 'flush_rules' ) ) ) {
		$wp_rewrite->flush_rules( $hard );
	}
}
```

**Important Notes:**

- `flush_rewrite_rules()` is expensive - only call on activation/deactivation
- Don't call on every page load
- Hard flush (`$hard = true`) updates `.htaccess` file
- Soft flush (`$hard = false`) only updates database option

**Example - Avoid Flushing on Every Request:**

```php
// ❌ BAD - Flushes on every page load
add_action( 'init', 'my_plugin_bad_init' );
function my_plugin_bad_init() {
	my_plugin_register_post_types();
	flush_rewrite_rules(); // Very expensive!
}

// ✅ GOOD - Only register, flush on activation
add_action( 'init', 'my_plugin_good_init' );
function my_plugin_good_init() {
	my_plugin_register_post_types();
	// Don't flush here
}

// Flush only on activation
register_activation_hook( __FILE__, 'my_plugin_activate' );
function my_plugin_activate() {
	my_plugin_register_post_types();
	flush_rewrite_rules();
}
```

---

## 4. Ensure Reversibility and Safe Failure States

### Reversibility

**Principle:** Activation should be reversible. If activation fails, deactivation should clean up.

**Example - Safe Activation:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate() {
	// Check requirements
	if ( ! my_plugin_check_requirements() ) {
		deactivate_plugins( plugin_basename( __FILE__ ) );
		wp_die( __( 'Plugin requirements not met.', 'my-plugin' ) );
	}

	// Create table with error handling
	global $wpdb;
	$table_name = $wpdb->prefix . 'my_plugin_data';

	$result = $wpdb->query( "CREATE TABLE IF NOT EXISTS $table_name..." );
	if ( false === $result ) {
		// Log error
		error_log( 'Failed to create table: ' . $wpdb->last_error );
		// Don't activate if critical setup fails
		deactivate_plugins( plugin_basename( __FILE__ ) );
		wp_die( __( 'Failed to create required database table.', 'my-plugin' ) );
	}

	// Set version flag
	update_option( 'my_plugin_activated', true );
	update_option( 'my_plugin_version', MY_PLUGIN_VERSION );
}
```

### Version Tracking

**Track Plugin Version:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate() {
	$current_version = get_option( 'my_plugin_version' );
	$new_version = MY_PLUGIN_VERSION;

	// First activation
	if ( false === $current_version ) {
		my_plugin_initial_setup();
		update_option( 'my_plugin_version', $new_version );
		return;
	}

	// Upgrade
	if ( version_compare( $current_version, $new_version, '<' ) ) {
		my_plugin_upgrade( $current_version, $new_version );
		update_option( 'my_plugin_version', $new_version );
	}
}

function my_plugin_upgrade( $old_version, $new_version ) {
	// Handle version-specific upgrades
	if ( version_compare( $old_version, '2.0.0', '<' ) ) {
		// Migrate data from v1 to v2
		my_plugin_migrate_v1_to_v2();
	}
}
```

### Safe Failure States

**Handle Errors Gracefully:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate() {
	$errors = array();

	// Try to create table
	if ( ! my_plugin_create_table() ) {
		$errors[] = __( 'Failed to create database table.', 'my-plugin' );
	}

	// Try to add role
	if ( ! my_plugin_add_role() ) {
		$errors[] = __( 'Failed to add custom role.', 'my-plugin' );
	}

	// If critical errors, don't activate
	if ( ! empty( $errors ) ) {
		deactivate_plugins( plugin_basename( __FILE__ ) );
		wp_die(
			implode( '<br>', $errors ),
			__( 'Activation Failed', 'my-plugin' ),
			array( 'back_link' => true )
		);
	}

	// Set activation flag
	update_option( 'my_plugin_activated', true );
}
```

**Check Activation Status:**

```php
// Check if plugin was properly activated
function my_plugin_is_activated() {
	return (bool) get_option( 'my_plugin_activated' );
}

// Use in plugin code
if ( ! my_plugin_is_activated() ) {
	add_action( 'admin_notices', 'my_plugin_activation_notice' );
}

function my_plugin_activation_notice() {
	?>
	<div class="notice notice-error">
		<p><?php esc_html_e( 'My Plugin was not properly activated. Please deactivate and reactivate.', 'my-plugin' ); ?></p>
	</div>
	<?php
}
```

### Multisite Considerations

**Network Activation:**

```php
register_activation_hook( __FILE__, 'my_plugin_activate' );

function my_plugin_activate( $network_wide ) {
	if ( is_multisite() && $network_wide ) {
		// Network activation
		$sites = get_sites();
		foreach ( $sites as $site ) {
			switch_to_blog( $site->blog_id );
			my_plugin_single_site_activate();
			restore_current_blog();
		}
	} else {
		// Single site activation
		my_plugin_single_site_activate();
	}
}

function my_plugin_single_site_activate() {
	// Single site activation code
	update_option( 'my_plugin_activated', true );
}
```

---

## Exam Tips

### Key Points to Remember

1. **Activation Hook:**
   - Use `register_activation_hook()`
   - Register options, roles, create tables
   - Flush rewrite rules
   - Check requirements

2. **Deactivation Hook:**
   - Use `register_deactivation_hook()`
   - Clear scheduled events
   - Clear transients
   - Flush rewrite rules

3. **Uninstall Hook:**
   - Use `register_uninstall_hook()` or `uninstall.php`
   - Delete all plugin data
   - Remove custom tables, roles, options
   - Don't delete user content

4. **Best Practices:**
   - Only flush rewrite rules on activation/deactivation
   - Track plugin version for upgrades
   - Handle errors gracefully
   - Ensure reversibility
   - Consider multisite

---

## Additional Resources

- [Plugin Lifecycle - WordPress Developer Resources](https://developer.wordpress.org/plugins/plugin-basics/activation-deactivation-hooks/)
- [register_activation_hook() - WordPress Codex](https://developer.wordpress.org/reference/functions/register_activation_hook/)
- [register_deactivation_hook() - WordPress Codex](https://developer.wordpress.org/reference/functions/register_deactivation_hook/)
- [register_uninstall_hook() - WordPress Codex](https://developer.wordpress.org/reference/functions/register_uninstall_hook/)
- Core Files:
  - `wp-includes/plugin.php` - Activation/deactivation functions
  - `wp-includes/rewrite.php` - Rewrite rule functions
