# 2.1 Block Editor - Study Notes

## Overview

The Block Editor (Gutenberg) is WordPress's modern content editing experience. This section covers developing with the block editor, block themes, custom blocks, block variations, patterns, and ensuring backward compatibility with the classic editor.

**Key Reference:** [Block Editor Handbook - WordPress Developer Resources](https://developer.wordpress.org/block-editor/)

---

## 1. Write a Block Theme Using theme.json and Block Templates

### Block Theme Structure

A block theme uses `theme.json` for configuration and HTML templates instead of PHP templates.

**Block Theme Detection:**

```2578:2578:wordpress/wp-includes/class-wp-theme.php
	public function is_block_theme() {
		if ( isset( $this->block_theme ) ) {
			return $this->block_theme;
		}

		$paths_to_index_block_template = array(
			$this->get_file_path( '/templates/index.html' ),
			$this->get_file_path( '/block-templates/index.html' ),
		);

		$this->block_theme = false;

		foreach ( $paths_to_index_block_template as $path_to_index_block_template ) {
			if ( is_file( $path_to_index_block_template ) && is_readable( $path_to_index_block_template ) ) {
				$this->block_theme = true;
				break;
			}
		}

		return $this->block_theme;
	}
```

### theme.json Configuration

`theme.json` defines global styles, block settings, and custom CSS properties.

**Example theme.json:**

```json
{
	"$schema": "https://schemas.wp.org/trunk/theme.json",
	"version": 2,
	"settings": {
		"color": {
			"palette": [
				{
					"slug": "primary",
					"color": "#0073aa",
					"name": "Primary"
				},
				{
					"slug": "secondary",
					"color": "#00a0d2",
					"name": "Secondary"
				}
			]
		},
		"typography": {
			"fontFamilies": [
				{
					"fontFamily": "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto",
					"slug": "system",
					"name": "System Font"
				}
			]
		},
		"spacing": {
			"spacingScale": {
				"steps": 0
			}
		}
	},
	"styles": {
		"color": {
			"background": "#ffffff",
			"text": "#000000"
		},
		"typography": {
			"fontSize": "16px"
		}
	},
	"templateParts": {
		"header": {
			"area": "header"
		},
		"footer": {
			"area": "footer"
		}
	}
}
```

### Block Templates

Block themes use HTML templates stored in:
- `/templates/` - User-editable templates (database)
- `/block-templates/` - Theme-provided templates (files)

**Example template structure:**

```
theme/
├── style.css
├── theme.json
├── templates/
│   ├── index.html
│   ├── single.html
│   └── archive.html
└── parts/
    ├── header.html
    └── footer.html
```

**Reference:** [Block Themes - WordPress Developer Resources](https://developer.wordpress.org/themes/block-themes/) | [theme.json - WordPress Developer Resources](https://developer.wordpress.org/themes/advanced-topics/theme-json/)

---

## 2. Build Custom Blocks with registerBlockType

### JavaScript Registration

**Function:** `registerBlockType( blockNameOrMetadata, settings )`

**Core Implementation:**
```6885:6910:wordpress/wp-includes/js/dist/blocks.js
function registerBlockType(blockNameOrMetadata, settings) {
  const name = isObject(blockNameOrMetadata) ? blockNameOrMetadata.name : blockNameOrMetadata;
  if (typeof name !== "string") {
    external_wp_warning_default()("Block names must be strings.");
    return;
  }
  if (!/^[a-z][a-z0-9-]*\/[a-z][a-z0-9-]*$/.test(name)) {
    external_wp_warning_default()(
      "Block names must contain a namespace prefix, include only lowercase alphanumeric characters or dashes, and start with a letter. Example: my-plugin/my-custom-block"
    );
    return;
  }
  if ((0,external_wp_data_namespaceObject.select)(store).getBlockType(name)) {
    external_wp_warning_default()('Block "' + name + '" is already registered.');
    return;
  }
  const { addBootstrappedBlockType, addUnprocessedBlockType } = unlock(
    (0,external_wp_data_namespaceObject.dispatch)(store)
  );
  if (isObject(blockNameOrMetadata)) {
    const metadata = getBlockSettingsFromMetadata(blockNameOrMetadata);
    addBootstrappedBlockType(name, metadata);
  }
  addUnprocessedBlockType(name, settings);
  return (0,external_wp_data_namespaceObject.select)(store).getBlockType(name);
}
```

**Example Block Registration:**

```javascript
import { registerBlockType } from '@wordpress/blocks';
import { useBlockProps } from '@wordpress/block-editor';

registerBlockType( 'my-plugin/my-block', {
	title: 'My Custom Block',
	icon: 'smiley',
	category: 'common',
	attributes: {
		title: {
			type: 'string',
			default: 'Hello World',
		},
		count: {
			type: 'number',
			default: 0,
		},
	},
	edit: ( { attributes, setAttributes } ) => {
		const blockProps = useBlockProps();
		return (
			<div { ...blockProps }>
				<input
					value={ attributes.title }
					onChange={ ( e ) => setAttributes( { title: e.target.value } ) }
				/>
			</div>
		);
	},
	save: ( { attributes } ) => {
		const blockProps = useBlockProps.save();
		return (
			<div { ...blockProps }>
				<h2>{ attributes.title }</h2>
			</div>
		);
	},
} );
```

### PHP Registration

**Function:** `register_block_type( $block_type, $args = array() )`

**Core Implementation:**
```783:789:wordpress/wp-includes/blocks.php
function register_block_type( $block_type, $args = array() ) {
	if ( is_string( $block_type ) && file_exists( $block_type ) ) {
		return register_block_type_from_metadata( $block_type, $args );
	}

	return WP_Block_Type_Registry::get_instance()->register( $block_type, $args );
}
```

**Example PHP Registration:**

```php
add_action( 'init', 'register_my_block' );
function register_my_block() {
	// Register from block.json directory
	register_block_type_from_metadata( __DIR__ . '/blocks/my-block' );

	// Or register manually
	register_block_type( 'my-plugin/my-block', array(
		'editor_script' => 'my-block-editor',
		'editor_style' => 'my-block-editor-style',
		'style' => 'my-block-style',
		'render_callback' => 'render_my_block',
	) );
}
```

### block.json Metadata

Modern blocks use `block.json` for metadata:

```json
{
	"$schema": "https://schemas.wp.org/trunk/block.json",
	"apiVersion": 3,
	"name": "my-plugin/my-block",
	"title": "My Custom Block",
	"category": "common",
	"icon": "smiley",
	"description": "A custom block example",
	"keywords": [ "custom", "example" ],
	"textdomain": "my-plugin",
	"attributes": {
		"title": {
			"type": "string",
			"default": ""
		}
	},
	"editorScript": "file:./index.js",
	"editorStyle": "file:./index.css",
	"style": "file:./style.css",
	"viewScript": "file:./view.js"
}
```

**Reference:** [Block Editor Handbook - WordPress Developer Resources](https://developer.wordpress.org/block-editor/) | [Block Registration - WordPress Developer Resources](https://developer.wordpress.org/block-editor/reference-guides/block-api/block-registration/)

---

## 3. Create Block Variations and Reusable Block Patterns

### Block Variations

Block variations provide pre-configured versions of a block with different default attributes.

**JavaScript Registration:**

```javascript
import { registerBlockVariation } from '@wordpress/blocks';

registerBlockVariation( 'core/button', {
	name: 'primary-button',
	title: 'Primary Button',
	attributes: {
		className: 'is-style-primary',
		backgroundColor: 'primary',
	},
	scope: [ 'inserter', 'transform' ],
} );
```

**PHP Registration:**

```php
add_action( 'init', 'register_block_variations' );
function register_block_variations() {
	register_block_variation( 'core/button', array(
		'name' => 'primary-button',
		'title' => 'Primary Button',
		'attributes' => array(
			'className' => 'is-style-primary',
			'backgroundColor' => 'primary',
		),
		'scope' => array( 'inserter', 'transform' ),
	) );
}
```

### Block Patterns

Block patterns are pre-designed block layouts that users can insert.

**PHP Registration:**

```php
add_action( 'init', 'register_block_patterns' );
function register_block_patterns() {
	register_block_pattern(
		'my-plugin/hero-section',
		array(
			'title' => 'Hero Section',
			'description' => 'A full-width hero section with heading and button',
			'content' => '<!-- wp:group {"layout":{"type":"constrained"}} -->
<div class="wp-block-group">
	<!-- wp:heading {"level":1} -->
	<h1>Welcome</h1>
	<!-- /wp:heading -->
	<!-- wp:paragraph -->
	<p>This is a hero section pattern.</p>
	<!-- /wp:paragraph -->
	<!-- wp:buttons -->
	<div class="wp-block-buttons">
		<!-- wp:button -->
		<div class="wp-block-button"><a class="wp-block-button__link">Learn More</a></div>
		<!-- /wp:button -->
	</div>
	<!-- /wp:buttons -->
</div>
<!-- /wp:group -->',
			'categories' => array( 'featured', 'call-to-action' ),
		)
	);
}
```

**Pattern Categories:**

```php
register_block_pattern_category( 'my-custom-category', array(
	'label' => 'My Custom Category',
) );
```

**Reference:** [Block Patterns - WordPress Developer Resources](https://developer.wordpress.org/block-editor/reference-guides/block-api/block-patterns/) | [Block Variations - WordPress Developer Resources](https://developer.wordpress.org/block-editor/reference-guides/block-api/block-variations/)

---

## 4. Distinguish Between Static and Dynamic Blocks

### Static Blocks

Static blocks save their content directly to the post content. The `save` function returns JSX/HTML that is stored in the database.

**Example Static Block:**

```javascript
registerBlockType( 'my-plugin/static-block', {
	// ... other settings
	save: ( { attributes } ) => {
		return (
			<div className="my-static-block">
				<h2>{ attributes.title }</h2>
				<p>{ attributes.content }</p>
			</div>
		);
	},
} );
```

**Characteristics:**
- Content is stored in post content
- No server-side rendering needed
- Faster rendering (no PHP execution)
- Limited to static content

### Dynamic Blocks

Dynamic blocks use PHP to render content on each page load. The `save` function returns `null`, and a `render_callback` handles output.

**Example Dynamic Block:**

```javascript
registerBlockType( 'my-plugin/dynamic-block', {
	// ... other settings
	save: () => null, // Dynamic blocks don't save content
} );
```

**PHP Render Callback:**

```php
register_block_type( 'my-plugin/dynamic-block', array(
	'render_callback' => 'render_dynamic_block',
	'attributes' => array(
		'postId' => array(
			'type' => 'number',
			'default' => 0,
		),
	),
) );

function render_dynamic_block( $attributes, $content, $block ) {
	$post_id = isset( $attributes['postId'] ) ? $attributes['postId'] : 0;

	if ( ! $post_id ) {
		return '';
	}

	$post = get_post( $post_id );
	if ( ! $post ) {
		return '';
	}

	ob_start();
	?>
	<div class="my-dynamic-block">
		<h2><?php echo esc_html( $post->post_title ); ?></h2>
		<div><?php echo wp_kses_post( $post->post_content ); ?></div>
	</div>
	<?php
	return ob_get_clean();
}
```

**When to Use Dynamic Blocks:**
- Content that changes frequently (latest posts, comments)
- Data from external APIs
- User-specific content
- Complex queries or calculations

**Reference:** [Dynamic Blocks - WordPress Developer Resources](https://developer.wordpress.org/block-editor/how-to-guides/block-tutorial/creating-dynamic-blocks/)

---

## 5. Ensure Backward Compatibility with Classic Editor

### Detecting Editor Type

```php
// Check if block editor is active
function is_block_editor_active() {
	if ( function_exists( 'get_current_screen' ) ) {
		$screen = get_current_screen();
		if ( $screen && method_exists( $screen, 'is_block_editor' ) ) {
			return $screen->is_block_editor();
		}
	}

	// Fallback: check for Gutenberg plugin or WordPress 5.0+
	return function_exists( 'register_block_type' );
}
```

### Supporting Both Editors

**1. Meta Box Compatibility:**

```php
// Register meta box for both editors
add_action( 'add_meta_boxes', 'register_custom_meta_box' );
function register_custom_meta_box() {
	add_meta_box(
		'my-custom-meta',
		'Custom Meta',
		'render_custom_meta_box',
		'post',
		'side',
		'default'
	);
}

// Also register as block editor sidebar panel
add_action( 'enqueue_block_editor_assets', 'enqueue_block_editor_meta' );
function enqueue_block_editor_meta() {
	wp_enqueue_script(
		'my-block-editor-meta',
		plugin_dir_url( __FILE__ ) . 'js/block-editor-meta.js',
		array( 'wp-plugins', 'wp-edit-post', 'wp-element' ),
		'1.0.0',
		true
	);
}
```

**2. Classic Editor Plugin Detection:**

```php
// Check if Classic Editor plugin is active
function is_classic_editor_active() {
	return is_plugin_active( 'classic-editor/classic-editor.php' );
}

// Conditionally load editor-specific code
if ( is_block_editor_active() && ! is_classic_editor_active() ) {
	// Block editor specific code
	add_action( 'enqueue_block_editor_assets', 'enqueue_block_assets' );
} else {
	// Classic editor specific code
	add_action( 'add_meta_boxes', 'add_classic_meta_boxes' );
}
```

**3. Content Migration:**

```php
// Convert classic editor content to blocks
function convert_classic_to_blocks( $content ) {
	if ( has_blocks( $content ) ) {
		return $content; // Already has blocks
	}

	// Wrap classic content in paragraph block
	$blocks = '<!-- wp:paragraph -->' . $content . '<!-- /wp:paragraph -->';

	return $blocks;
}

// Filter content for block editor
add_filter( 'the_content', 'convert_classic_to_blocks', 1 );
```

**4. TinyMCE Compatibility:**

```php
// Register TinyMCE button for classic editor
add_action( 'admin_init', 'register_tinymce_button' );
function register_tinymce_button() {
	if ( ! current_user_can( 'edit_posts' ) ) {
		return;
	}

	add_filter( 'mce_buttons', 'add_tinymce_button' );
	add_filter( 'mce_external_plugins', 'add_tinymce_plugin' );
}

function add_tinymce_button( $buttons ) {
	array_push( $buttons, 'my_custom_button' );
	return $buttons;
}

function add_tinymce_plugin( $plugins ) {
	$plugins['my_custom_button'] = plugin_dir_url( __FILE__ ) . 'js/tinymce-plugin.js';
	return $plugins;
}
```

**Reference:** [Classic Editor Plugin](https://wordpress.org/plugins/classic-editor/) | [Editor Compatibility - WordPress Developer Resources](https://developer.wordpress.org/block-editor/how-to-guides/backward-compatibility/)

---

## Exam Tips

### Key Points to Remember

1. **Block Themes:**
   - Use `theme.json` for configuration
   - Templates stored in `/templates/` or `/block-templates/`
   - Detected by presence of `index.html` template

2. **Block Registration:**
   - Use `registerBlockType()` in JavaScript
   - Use `register_block_type()` in PHP
   - Block names must be `namespace/block-name` format
   - Modern approach uses `block.json`

3. **Block Variations:**
   - Pre-configured versions of existing blocks
   - Registered with `registerBlockVariation()` or `register_block_variation()`
   - Can scope to inserter, transform, or both

4. **Block Patterns:**
   - Pre-designed block layouts
   - Registered with `register_block_pattern()`
   - Can be organized into categories

5. **Static vs Dynamic:**
   - Static: content saved in post, `save()` returns JSX
   - Dynamic: content rendered server-side, `save()` returns `null`, uses `render_callback`

6. **Backward Compatibility:**
   - Check editor type before loading editor-specific code
   - Support both meta boxes and block editor panels
   - Consider Classic Editor plugin users

---

## Additional Resources

- [Block Editor Handbook - WordPress Developer Resources](https://developer.wordpress.org/block-editor/)
- [Block Themes - WordPress Developer Resources](https://developer.wordpress.org/themes/block-themes/)
- [theme.json - WordPress Developer Resources](https://developer.wordpress.org/themes/advanced-topics/theme-json/)
- [Block Registration - WordPress Developer Resources](https://developer.wordpress.org/block-editor/reference-guides/block-api/block-registration/)
- [Block Patterns - WordPress Developer Resources](https://developer.wordpress.org/block-editor/reference-guides/block-api/block-patterns/)
- [Dynamic Blocks - WordPress Developer Resources](https://developer.wordpress.org/block-editor/how-to-guides/block-tutorial/creating-dynamic-blocks/)
- Core Files:
  - `wp-includes/blocks.php` - Block registration functions
  - `wp-includes/class-wp-block-type-registry.php` - Block type registry
  - `wp-includes/class-wp-theme-json.php` - theme.json processing
