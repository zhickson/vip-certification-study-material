# 2.8 Running Code in the Correct Context - Study Notes

## Overview

Differentiating execution contexts and scoping code accordingly is essential for WordPress development. This involves detecting WP-CLI context, running WP-CLI commands only during CLI execution, preventing CLI logic from running during HTTP requests, and separating context-specific logic.

**Key Reference:** [WP-CLI Handbook](https://wp-cli.org/)

---

## 1. Detect WP-CLI Context

### WP-CLI Detection

**Constant Check:**

```php
if ( defined( 'WP_CLI' ) && WP_CLI ) {
	// Running in WP-CLI context
}
```

**Example Usage:**

```php
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	// Skip HTTP-specific code in WP-CLI
	if ( defined( 'WP_CLI' ) && WP_CLI ) {
		return;
	}

	// HTTP-only initialization
	register_post_type( 'my_cpt', array( /* ... */ ) );
}
```

### Context Detection Helper

**Comprehensive Context Detection:**

```php
function my_plugin_get_context() {
	if ( defined( 'WP_CLI' ) && WP_CLI ) {
		return 'cli';
	}

	if ( wp_is_serving_rest_request() ) {
		return 'rest';
	}

	if ( wp_doing_ajax() ) {
		return 'ajax';
	}

	if ( defined( 'DOING_CRON' ) && DOING_CRON ) {
		return 'cron';
	}

	if ( is_admin() ) {
		return 'admin';
	}

	return 'frontend';
}
```

---

## 2. Run WP-CLI Commands Only During CLI Execution

### Registering WP-CLI Commands

**Basic Command Registration:**

```php
// Only register if WP-CLI is available
if ( defined( 'WP_CLI' ) && WP_CLI ) {
	require_once plugin_dir_path( __FILE__ ) . 'includes/class-wp-cli-commands.php';

	WP_CLI::add_command( 'my-plugin', 'My_Plugin_CLI_Commands' );
}
```

**Command Class:**

```php
// includes/class-wp-cli-commands.php
class My_Plugin_CLI_Commands {

	/**
	 * Example command.
	 *
	 * ## OPTIONS
	 *
	 * [--format=<format>]
	 * : Output format (table, json, csv)
	 *
	 * ## EXAMPLES
	 *
	 *     wp my-plugin example --format=json
	 *
	 * @param array $args Positional arguments
	 * @param array $assoc_args Associative arguments
	 */
	public function example( $args, $assoc_args ) {
		$format = isset( $assoc_args['format'] ) ? $assoc_args['format'] : 'table';

		WP_CLI::success( 'Command executed successfully' );
	}

	/**
	 * Sync data command.
	 *
	 * ## EXAMPLES
	 *
	 *     wp my-plugin sync
	 *
	 * @param array $args Positional arguments
	 * @param array $assoc_args Associative arguments
	 */
	public function sync( $args, $assoc_args ) {
		WP_CLI::line( 'Syncing data...' );

		// Sync logic
		$synced = my_plugin_sync_data();

		if ( $synced ) {
			WP_CLI::success( 'Data synced successfully' );
		} else {
			WP_CLI::error( 'Failed to sync data' );
		}
	}
}
```

**Usage:**

```bash
wp my-plugin example --format=json
wp my-plugin sync
```

### WP-CLI Output Methods

**Output Functions:**

```php
// Success message (green)
WP_CLI::success( 'Operation completed' );

// Error message (red)
WP_CLI::error( 'Operation failed' );

// Warning message (yellow)
WP_CLI::warning( 'This is a warning' );

// Info message (blue)
WP_CLI::info( 'This is information' );

// Line output
WP_CLI::line( 'Regular output' );

// Log message
WP_CLI::log( 'Log message' );

// Table output
WP_CLI\Utils\format_items( 'table', $items, array( 'id', 'name', 'email' ) );
```

**Example with Progress:**

```php
public function import( $args, $assoc_args ) {
	$items = get_items_to_import();
	$total = count( $items );

	$progress = \WP_CLI\Utils\make_progress_bar( 'Importing items', $total );

	foreach ( $items as $item ) {
		import_item( $item );
		$progress->tick();
	}

	$progress->finish();
	WP_CLI::success( "Imported {$total} items" );
}
```

---

## 3. Prevent CLI Logic from Running During HTTP Requests

### Conditional Loading

**Separate Files:**

```php
// Main plugin file
if ( defined( 'WP_CLI' ) && WP_CLI ) {
	require_once plugin_dir_path( __FILE__ ) . 'includes/class-wp-cli-commands.php';
	WP_CLI::add_command( 'my-plugin', 'My_Plugin_CLI_Commands' );
} else {
	// HTTP-specific initialization
	add_action( 'init', 'my_plugin_http_init' );
}
```

**Conditional Execution:**

```php
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	// Skip if WP-CLI
	if ( defined( 'WP_CLI' ) && WP_CLI ) {
		return;
	}

	// HTTP-only code
	register_post_type( 'my_cpt', array( /* ... */ ) );
	add_action( 'wp_enqueue_scripts', 'my_plugin_enqueue_assets' );
}
```

### Separate Initialization

**HTTP vs CLI:**

```php
// Main plugin file
if ( defined( 'WP_CLI' ) && WP_CLI ) {
	// CLI initialization
	require_once plugin_dir_path( __FILE__ ) . 'includes/cli-init.php';
} else {
	// HTTP initialization
	require_once plugin_dir_path( __FILE__ ) . 'includes/http-init.php';
}
```

**cli-init.php:**

```php
<?php
// CLI-specific initialization
require_once plugin_dir_path( __FILE__ ) . 'class-wp-cli-commands.php';

WP_CLI::add_command( 'my-plugin', 'My_Plugin_CLI_Commands' );
```

**http-init.php:**

```php
<?php
// HTTP-specific initialization
add_action( 'init', 'my_plugin_http_init' );
add_action( 'wp_enqueue_scripts', 'my_plugin_enqueue_assets' );
add_action( 'admin_menu', 'my_plugin_admin_menu' );
```

---

## 4. Separate Context-Specific Logic into Isolated Functions or Files

### File Organization

**Recommended Structure:**

```
my-plugin/
├── my-plugin.php
├── includes/
│   ├── class-core.php
│   ├── class-admin.php
│   ├── class-frontend.php
│   ├── class-cli.php          # CLI-specific
│   ├── class-rest-api.php     # REST API-specific
│   └── class-ajax.php         # AJAX-specific
└── cli/
    └── commands/
        └── class-sync-command.php
```

### Context-Specific Classes

**Core Class:**

```php
// includes/class-core.php
class My_Plugin_Core {

	public function __construct() {
		$this->load_context_specific_code();
	}

	private function load_context_specific_code() {
		if ( defined( 'WP_CLI' ) && WP_CLI ) {
			require_once plugin_dir_path( __FILE__ ) . 'class-cli.php';
			new My_Plugin_CLI();
		} elseif ( wp_is_serving_rest_request() ) {
			require_once plugin_dir_path( __FILE__ ) . 'class-rest-api.php';
			new My_Plugin_REST_API();
		} elseif ( wp_doing_ajax() ) {
			require_once plugin_dir_path( __FILE__ ) . 'class-ajax.php';
			new My_Plugin_AJAX();
		} elseif ( is_admin() ) {
			require_once plugin_dir_path( __FILE__ ) . 'class-admin.php';
			new My_Plugin_Admin();
		} else {
			require_once plugin_dir_path( __FILE__ ) . 'class-frontend.php';
			new My_Plugin_Frontend();
		}
	}
}
```

**CLI Class:**

```php
// includes/class-cli.php
class My_Plugin_CLI {

	public function __construct() {
		require_once plugin_dir_path( __FILE__ ) . 'class-wp-cli-commands.php';
		WP_CLI::add_command( 'my-plugin', 'My_Plugin_CLI_Commands' );
	}
}
```

**REST API Class:**

```php
// includes/class-rest-api.php
class My_Plugin_REST_API {

	public function __construct() {
		add_action( 'rest_api_init', array( $this, 'register_routes' ) );
	}

	public function register_routes() {
		register_rest_route( 'my-plugin/v1', '/endpoint', array(
			'methods' => 'GET',
			'callback' => array( $this, 'get_data' ),
		) );
	}
}
```

### Shared vs Context-Specific

**Shared Functionality:**

```php
// includes/class-shared.php
class My_Plugin_Shared {

	public static function get_data() {
		// Shared logic used by all contexts
		return get_option( 'my_plugin_data' );
	}

	public static function process_data( $data ) {
		// Shared processing logic
		return sanitize_text_field( $data );
	}
}
```

**Context-Specific Usage:**

```php
// CLI context
class My_Plugin_CLI_Commands {
	public function sync() {
		$data = My_Plugin_Shared::get_data();
		// CLI-specific processing
	}
}

// REST API context
class My_Plugin_REST_API {
	public function get_data() {
		$data = My_Plugin_Shared::get_data();
		// REST API-specific formatting
		return rest_ensure_response( $data );
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **WP-CLI Detection:**
   - Check `defined( 'WP_CLI' ) && WP_CLI`
   - Only register commands in CLI context

2. **Command Registration:**
   - Use `WP_CLI::add_command()`
   - Create command classes
   - Use proper output methods

3. **Prevent CLI in HTTP:**
   - Check context before executing
   - Separate files for CLI vs HTTP
   - Conditional loading

4. **Code Organization:**
   - Separate context-specific code
   - Use shared classes for common functionality
   - Organize by context (CLI, REST, AJAX, Admin, Frontend)

---

## Additional Resources

- [WP-CLI Handbook](https://wp-cli.org/)
- [WP-CLI Commands - WordPress Developer Resources](https://developer.wordpress.org/cli/commands/)
- [REST API - WordPress Developer Resources](https://developer.wordpress.org/rest-api/)
- [Plugin API - WordPress Developer Resources](https://developer.wordpress.org/plugins/plugin-basics/)
