# 2.2 Internationalization (i18n) - Study Notes

## Overview

Internationalization (i18n) makes WordPress projects translation-ready and multilingual-friendly. This involves preparing strings for translation, using WordPress translation functions, loading text domains, and working with translation files.

**Key Reference:** [Internationalization - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/i18n/)

---

## 1. Use WordPress Translation Functions

### Basic Translation Functions

WordPress provides several functions for translating strings:

**Core Implementation:**
```306:308:wordpress/wp-includes/l10n.php
function __( $text, $domain = 'default' ) {
return translate( $text, $domain );
}
```

**Common Translation Functions:**

| Function | Purpose | Returns |
|----------|---------|---------|
| `__( $text, $domain )` | Translate and return | String |
| `_e( $text, $domain )` | Translate and echo | void |
| `_x( $text, $context, $domain )` | Translate with context | String |
| `_ex( $text, $context, $domain )` | Translate with context and echo | void |
| `_n( $single, $plural, $number, $domain )` | Plural translation | String |
| `_nx( $single, $plural, $number, $context, $domain )` | Plural with context | String |
| `esc_attr__( $text, $domain )` | Translate and escape for attribute | String |
| `esc_html__( $text, $domain )` | Translate and escape for HTML | String |

### Basic Translation Examples

**Simple Translation:**

```php
// Translate and return
$translated = __( 'Hello World', 'my-plugin' );

// Translate and echo
_e( 'Welcome', 'my-plugin' );
```

**Translation with Context:**

```php
// Context helps translators understand usage
$button_text = _x( 'Post', 'verb: to submit', 'my-plugin' );
$noun_text = _x( 'Post', 'noun: blog post', 'my-plugin' );
```

**Plural Translation:**

```php
// Handle singular/plural forms
$message = _n(
	'%s item',
	'%s items',
	$count,
	'my-plugin'
);
printf( $message, number_format_i18n( $count ) );
```

**Plural with Context:**

```php
$message = _nx(
	'%s group',
	'%s groups',
	$number,
	'group of people',
	'my-plugin'
);
printf( $message, number_format_i18n( $number ) );
```

**Core Implementation - Plural:**
```483:516:wordpress/wp-includes/l10n.php
function _n( $single, $plural, $number, $domain = 'default' ) {
	$translations = get_translations_for_domain( $domain );
	$translation  = $translations->translate_plural( $single, $plural, $number );

	/**
	 * Filters the singular or plural form of a string.
	 *
	 * @since 2.2.0
	 *
	 * @param string $translation Translated text.
	 * @param string $single      The text to be used if the number is singular.
	 * @param string $plural      The text to be used if the number is plural.
	 * @param int    $number      The number to compare against to use either the singular or plural form.
	 * @param string $domain      Text domain. Unique identifier for retrieving translated strings.
	 */
	$translation = apply_filters( 'ngettext', $translation, $single, $plural, $number, $domain );

	/**
	 * Filters the singular or plural form of a string for a domain.
	 *
	 * The dynamic portion of the hook name, `$domain`, refers to the text domain.
	 *
	 * @since 5.5.0
	 *
	 * @param string $translation Translated text.
	 * @param string $single      The text to be used if the number is singular.
	 * @param string $plural      The text to be used if the number is plural.
	 * @param int    $number      The number to compare against to use either the singular or plural form.
	 * @param string $domain      Text domain. Unique identifier for retrieving translated strings.
	 */
	$translation = apply_filters( "ngettext_{$domain}", $translation, $single, $plural, $number, $domain );

	return $translation;
}
```

**Reference:** [Translating WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/i18n/)

---

## 2. Prepare Strings and Escape Output Properly for Translation

### String Preparation Best Practices

**1. Use Complete Sentences:**

```php
// ❌ BAD - Fragmented strings
echo __( 'Hello', 'my-plugin' ) . ' ' . __( 'World', 'my-plugin' );

// ✅ GOOD - Complete sentence
echo __( 'Hello World', 'my-plugin' );
```

**2. Avoid Variables in Strings:**

```php
// ❌ BAD - Variables can't be translated
echo __( "Hello $name", 'my-plugin' );

// ✅ GOOD - Use placeholders
printf( __( 'Hello %s', 'my-plugin' ), esc_html( $name ) );
```

**3. Use Descriptive Context:**

```php
// ❌ BAD - Ambiguous
_x( 'Post', 'my-plugin' );

// ✅ GOOD - Clear context
_x( 'Post', 'verb: to submit content', 'my-plugin' );
_x( 'Post', 'noun: a blog entry', 'my-plugin' );
```

**4. Escape Output After Translation:**

```php
// ❌ BAD - No escaping
echo __( 'User Name', 'my-plugin' );

// ✅ GOOD - Escape for HTML
echo esc_html__( 'User Name', 'my-plugin' );

// ✅ GOOD - Escape for attributes
$title = esc_attr__( 'Click me', 'my-plugin' );
echo '<button title="' . $title . '">';

// ✅ GOOD - Escape for URLs
$url = esc_url( home_url( '/' ) );
$link = sprintf(
	'<a href="%s">%s</a>',
	$url,
	esc_html__( 'Home', 'my-plugin' )
);
```

**5. Combine Translation with Escaping:**

```php
// For HTML output
echo esc_html__( 'Welcome', 'my-plugin' );

// For attributes
$class = esc_attr__( 'primary-button', 'my-plugin' );

// For JavaScript
$js_string = esc_js__( 'Loading...', 'my-plugin' );
```

**Core Implementation - Escaping Functions:**
```322:324:wordpress/wp-includes/l10n.php
function esc_attr__( $text, $domain = 'default' ) {
	return esc_attr( translate( $text, $domain ) );
}
```

```339:341:wordpress/wp-includes/l10n.php
function esc_html__( $text, $domain = 'default' ) {
	return esc_html( translate( $text, $domain ) );
}
```

---

## 3. Load Text Domains for Plugins/Themes

### Plugin Text Domain Loading

**Function:** `load_plugin_textdomain( $domain, $deprecated = false, $plugin_rel_path = false )`

**Core Implementation:**
```999:1082:wordpress/wp-includes/l10n.php
function load_plugin_textdomain( $domain, $deprecated = false, $plugin_rel_path = false ) {
	$locale = determine_locale();

	$mofile = $domain . '-' . $locale . '.mo';

	// Try to load from the languages directory first.
	if ( ! load_textdomain( $domain, WP_LANG_DIR . '/plugins/' . $mofile, $locale ) ) {
		$path = WP_PLUGIN_DIR . '/' . trim( $plugin_rel_path, '/' );
		load_textdomain( $domain, $path . '/' . $mofile, $locale );
	}
}
```

**Plugin Example:**

```php
add_action( 'plugins_loaded', 'my_plugin_load_textdomain' );
function my_plugin_load_textdomain() {
	load_plugin_textdomain(
		'my-plugin',
		false,
		dirname( plugin_basename( __FILE__ ) ) . '/languages'
	);
}
```

**Modern Approach (WordPress 4.6+):**

WordPress automatically loads translations from:
- `wp-content/languages/plugins/plugin-name-locale.mo`
- `wp-content/plugins/plugin-name/languages/plugin-name-locale.mo`

```php
// Just specify the text domain in plugin header
/*
 * Plugin Name: My Plugin
 * Text Domain: my-plugin
 */

// WordPress will auto-load from standard locations
```

### Theme Text Domain Loading

**Function:** `load_theme_textdomain( $domain, $path = false )`

**Core Implementation:**
```1083:1124:wordpress/wp-includes/l10n.php
function load_theme_textdomain( $domain, $path = false ) {
	$locale = determine_locale();

	$mofile = $domain . '-' . $locale . '.mo';

	// Try to load from the languages directory first.
	if ( ! load_textdomain( $domain, WP_LANG_DIR . '/themes/' . $mofile, $locale ) ) {
		$path = $path ? $path : get_template_directory();
		load_textdomain( $domain, $path . '/' . $mofile, $locale );
	}
}
```

**Theme Example:**

```php
add_action( 'after_setup_theme', 'my_theme_load_textdomain' );
function my_theme_load_textdomain() {
	load_theme_textdomain(
		'my-theme',
		get_template_directory() . '/languages'
	);
}
```

**Theme Header:**

```php
/*
 * Theme Name: My Theme
 * Text Domain: my-theme
 */
```

**Reference:** [Loading Text Domain - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/i18n/#loading-text-domain)

---

## 4. Work with .po and .mo Files

### Translation File Types

- **.pot** (Portable Object Template) - Template file with all translatable strings
- **.po** (Portable Object) - Human-readable translation file (editable)
- **.mo** (Machine Object) - Compiled binary translation file (used by WordPress)

### Generating .pot Files

**Using WP-CLI:**

```bash
# Generate .pot file for plugin
wp i18n make-pot . languages/my-plugin.pot --domain=my-plugin

# Generate .pot file for theme
wp i18n make-pot . languages/my-theme.pot --domain=my-theme
```

**Using gettext tools:**

```bash
# Extract strings from PHP files
xgettext --language=PHP --from-code=UTF-8 \
  --keyword=__ --keyword=_e --keyword=_x \
  --output=languages/my-plugin.pot *.php
```

### .po File Structure

**Example my-plugin-en_GB.po:**

```po
# Translation file for my-plugin
# Copyright (C) 2024 My Plugin
msgid ""
msgstr ""
"Project-Id-Version: My Plugin 1.0\n"
"Report-Msgid-Bugs-To: \n"
"POT-Creation-Date: 2024-01-01 12:00+0000\n"
"PO-Revision-Date: 2024-01-01 12:00+0000\n"
"Language: en_GB\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=UTF-8\n"
"Content-Transfer-Encoding: 8bit\n"

msgid "Hello World"
msgstr "Hello World"

msgid "Welcome"
msgstr "Welcome"

#: includes/admin.php:45
msgctxt "verb: to submit"
msgid "Post"
msgstr "Post"

#: includes/admin.php:46
msgctxt "noun: blog post"
msgid "Post"
msgstr "Post"
```

### Compiling .mo Files

**Using msgfmt:**

```bash
# Compile .po to .mo
msgfmt -o my-plugin-en_GB.mo my-plugin-en_GB.po
```

**Using WP-CLI:**

```bash
# Compile all .po files in directory
wp i18n make-mo languages/
```

### File Naming Convention

Translation files should be named:
- `{text-domain}-{locale}.po` (e.g., `my-plugin-en_GB.po`)
- `{text-domain}-{locale}.mo` (e.g., `my-plugin-en_GB.mo`)

**Reference:** [Translation Files - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/i18n/#translation-files)

---

## 5. Understand the Role and Limitations of Multilingual Plugins

### Multilingual Plugin Overview

Multilingual plugins (e.g., WPML, Polylang, Weglot) provide:
- Content translation management
- Language switchers
- URL structure for multiple languages
- Translation workflow tools

### How They Work

**1. Content Translation:**

Multilingual plugins typically:
- Store translations as separate posts/pages
- Link translations together via meta keys
- Provide admin interfaces for managing translations

**2. Language Detection:**

```php
// WPML example
if ( function_exists( 'icl_get_languages' ) ) {
	$languages = icl_get_languages();
	foreach ( $languages as $lang ) {
		echo $lang['native_name'];
	}
}

// Polylang example
if ( function_exists( 'pll_the_languages' ) ) {
	pll_the_languages();
}
```

**3. URL Structure:**

Plugins modify permalinks to include language codes:
- `example.com/en/page/`
- `example.com/fr/page/`
- `example.com/es/page/`

### Limitations

**1. Not a Replacement for i18n:**

Multilingual plugins translate **content**, not **code strings**. You still need:
- WordPress i18n functions (`__()`, `_e()`, etc.)
- Proper text domain loading
- Translation files (.po/.mo)

**2. Plugin Compatibility:**

Not all plugins/themes are compatible:
- Some hardcode language assumptions
- May not support language switching
- Can conflict with caching solutions

**3. Performance Impact:**

- Additional database queries for language detection
- More complex URL routing
- Potential caching complications

**4. SEO Considerations:**

- Requires proper hreflang tags
- Duplicate content concerns
- Language-specific sitemaps needed

### Best Practices with Multilingual Plugins

**1. Always Use i18n Functions:**

```php
// ✅ GOOD - Works with or without multilingual plugin
echo esc_html__( 'Save Changes', 'my-plugin' );

// ❌ BAD - Hardcoded, won't translate
echo 'Save Changes';
```

**2. Check for Plugin Functions:**

```php
// Check if WPML is active
if ( defined( 'ICL_SITEPRESS_VERSION' ) ) {
	// WPML-specific code
}

// Check if Polylang is active
if ( function_exists( 'pll_current_language' ) ) {
	$current_lang = pll_current_language();
}
```

**3. Use Plugin Hooks:**

```php
// WPML - Filter content language
add_filter( 'wpml_element_language_code', 'my_language_filter', 10, 2 );

// Polylang - Get current language
$lang = pll_current_language();
```

**4. Test Without Multilingual Plugin:**

Your code should work without multilingual plugins. They enhance functionality but shouldn't be required.

**Reference:** [Multilingual Plugins - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/i18n/#multilingual-plugins)

---

## Exam Tips

### Key Points to Remember

1. **Translation Functions:**
   - `__()` returns translated string
   - `_e()` echoes translated string
   - `_x()` adds context for translators
   - `_n()` handles singular/plural forms
   - Always escape output: `esc_html__()`, `esc_attr__()`

2. **String Preparation:**
   - Use complete sentences, not fragments
   - Avoid variables in strings (use placeholders)
   - Provide context when needed
   - Always escape after translation

3. **Text Domains:**
   - Load in `plugins_loaded` (plugins) or `after_setup_theme` (themes)
   - WordPress 4.6+ auto-loads from standard locations
   - Use unique text domain matching plugin/theme name

4. **Translation Files:**
   - `.pot` = template (source)
   - `.po` = editable translation file
   - `.mo` = compiled binary (used by WordPress)
   - Naming: `{domain}-{locale}.mo`

5. **Multilingual Plugins:**
   - Translate content, not code
   - Still need i18n functions
   - Check for plugin functions before using
   - Code should work without them

---

## Additional Resources

- [Internationalization - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/i18n/)
- [Translating WordPress - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/i18n/)
- [Loading Text Domain - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/wordpress/i18n/#loading-text-domain)
- [WP-CLI i18n Commands](https://developer.wordpress.org/cli/commands/i18n/)
- Core Files:
  - `wp-includes/l10n.php` - Translation functions
  - `wp-includes/class-wp-translations.php` - Translation handling
  - `wp-includes/class-wp-textdomain-registry.php` - Text domain registry
