# 2.3 Dependencies in WordPress Code - Study Notes

## Overview

Managing dependencies and loading assets correctly is crucial for WordPress development. This involves properly enqueuing scripts and styles, handling dependencies, versioning, load order, and understanding plugin dependency management strategies.

**Key Reference:** [Enqueuing Scripts and Styles - WordPress Developer Resources](https://developer.wordpress.org/themes/basics/including-css-javascript/)

---

## 1. Enqueue Scripts and Styles with wp_enqueue_script and wp_enqueue_style

### Enqueuing Scripts

**Function:** `wp_enqueue_script( $handle, $src = '', $deps = array(), $ver = false, $args = array() )`

**Core Implementation:**
```366:394:wordpress/wp-includes/functions.wp-scripts.php
function wp_enqueue_script( $handle, $src = '', $deps = array(), $ver = false, $args = array() ) {
	_wp_scripts_maybe_doing_it_wrong( __FUNCTION__, $handle );

	$wp_scripts = wp_scripts();

	if ( $src || ! empty( $args ) ) {
		$_handle = explode( '?', $handle );
		if ( ! is_array( $args ) ) {
			$args = array(
				'in_footer' => (bool) $args,
			);
		}

		if ( $src ) {
			$wp_scripts->add( $_handle[0], $src, $deps, $ver );
		}
		if ( ! empty( $args['in_footer'] ) ) {
			$wp_scripts->add_data( $_handle[0], 'group', 1 );
		}
		if ( ! empty( $args['strategy'] ) ) {
			$wp_scripts->add_data( $_handle[0], 'strategy', $args['strategy'] );
		}
		if ( ! empty( $args['fetchpriority'] ) ) {
			$wp_scripts->add_data( $_handle[0], 'fetchpriority', $args['fetchpriority'] );
		}
	}

	$wp_scripts->enqueue( $handle );
}
```

**Basic Example:**

```php
add_action( 'wp_enqueue_scripts', 'my_theme_enqueue_scripts' );
function my_theme_enqueue_scripts() {
	wp_enqueue_script(
		'my-theme-script',
		get_template_directory_uri() . '/js/script.js',
		array( 'jquery' ),
		'1.0.0',
		array( 'in_footer' => true )
	);
}
```

### Enqueuing Styles

**Function:** `wp_enqueue_style( $handle, $src = '', $deps = array(), $ver = false, $media = 'all' )`

**Core Implementation:**
```173:184:wordpress/wp-includes/functions.wp-styles.php
function wp_enqueue_style( $handle, $src = '', $deps = array(), $ver = false, $media = 'all' ) {
	_wp_scripts_maybe_doing_it_wrong( __FUNCTION__, $handle );

	$wp_styles = wp_styles();

	if ( $src ) {
		$_handle = explode( '?', $handle );
		$wp_styles->add( $_handle[0], $src, $deps, $ver, $media );
	}

	$wp_styles->enqueue( $handle );
}
```

**Basic Example:**

```php
add_action( 'wp_enqueue_scripts', 'my_theme_enqueue_styles' );
function my_theme_enqueue_styles() {
	wp_enqueue_style(
		'my-theme-style',
		get_stylesheet_uri(),
		array(),
		'1.0.0',
		'all'
	);
}
```

### Proper Hook Usage

**Front-end Assets:**

```php
// ✅ GOOD - Use wp_enqueue_scripts hook
add_action( 'wp_enqueue_scripts', 'my_plugin_enqueue_assets' );
function my_plugin_enqueue_assets() {
	wp_enqueue_script( 'my-script', 'path/to/script.js' );
	wp_enqueue_style( 'my-style', 'path/to/style.css' );
}
```

**Admin Assets:**

```php
// ✅ GOOD - Use admin_enqueue_scripts hook
add_action( 'admin_enqueue_scripts', 'my_plugin_admin_assets' );
function my_plugin_admin_assets( $hook ) {
	// Only load on specific admin pages
	if ( 'post.php' !== $hook ) {
		return;
	}

	wp_enqueue_script( 'my-admin-script', 'path/to/admin-script.js' );
	wp_enqueue_style( 'my-admin-style', 'path/to/admin-style.css' );
}
```

**Login Page Assets:**

```php
// ✅ GOOD - Use login_enqueue_scripts hook
add_action( 'login_enqueue_scripts', 'my_plugin_login_assets' );
function my_plugin_login_assets() {
	wp_enqueue_style( 'my-login-style', 'path/to/login-style.css' );
}
```

**Core Warning Implementation:**
```41:69:wordpress/wp-includes/functions.wp-scripts.php
function _wp_scripts_maybe_doing_it_wrong( $function_name, $handle = '' ) {
	if ( did_action( 'init' ) || did_action( 'wp_enqueue_scripts' )
		|| did_action( 'admin_enqueue_scripts' ) || did_action( 'login_enqueue_scripts' )
	) {
		return;
	}

	$message = sprintf(
		/* translators: 1: wp_enqueue_scripts, 2: admin_enqueue_scripts, 3: login_enqueue_scripts */
		__( 'Scripts and styles should not be registered or enqueued until the %1$s, %2$s, or %3$s hooks.' ),
		'<code>wp_enqueue_scripts</code>',
		'<code>admin_enqueue_scripts</code>',
		'<code>login_enqueue_scripts</code>'
	);

	if ( $handle ) {
		$message .= ' ' . sprintf(
			/* translators: %s: Name of the script or stylesheet. */
			__( 'This notice was triggered by the %s handle.' ),
			'<code>' . $handle . '</code>'
		);
	}

	_doing_it_wrong(
		$function_name,
		$message,
		'3.3.0'
	);
}
```

**Reference:** [Enqueuing Scripts and Styles - WordPress Developer Resources](https://developer.wordpress.org/themes/basics/including-css-javascript/)

---

## 2. Handle Dependencies, Versioning, and Load Order

### Dependencies

**Specify Dependencies:**

```php
// Script depends on jQuery and a custom library
wp_enqueue_script(
	'my-script',
	'path/to/script.js',
	array( 'jquery', 'my-library' ), // Dependencies
	'1.0.0'
);
```

**Common WordPress Dependencies:**

- `jquery` - jQuery library
- `jquery-ui-core` - jQuery UI core
- `wp-api` - REST API client
- `wp-blocks` - Block editor blocks
- `wp-element` - React element utilities
- `wp-components` - Block editor components

**Example with Multiple Dependencies:**

```php
wp_enqueue_script(
	'my-block-editor-script',
	'path/to/block-editor.js',
	array(
		'wp-blocks',
		'wp-element',
		'wp-components',
		'wp-editor',
	),
	'1.0.0'
);
```

### Versioning

**Purpose:** Cache busting - ensures browsers load updated files.

**Version Options:**

```php
// 1. String version
wp_enqueue_script( 'my-script', 'path/to/script.js', array(), '1.2.3' );
// Output: script.js?ver=1.2.3

// 2. Use file modification time
wp_enqueue_script(
	'my-script',
	'path/to/script.js',
	array(),
	filemtime( get_template_directory() . '/js/script.js' )
);

// 3. Use theme/plugin version constant
define( 'MY_PLUGIN_VERSION', '1.0.0' );
wp_enqueue_script(
	'my-script',
	'path/to/script.js',
	array(),
	MY_PLUGIN_VERSION
);

// 4. null = no version (not recommended)
wp_enqueue_script( 'my-script', 'path/to/script.js', array(), null );

// 5. false = WordPress version (default)
wp_enqueue_script( 'my-script', 'path/to/script.js', array(), false );
// Output: script.js?ver=6.4.0 (current WP version)
```

**Best Practice:**

```php
// Use file modification time for development
// Use version constant for production
$version = defined( 'WP_DEBUG' ) && WP_DEBUG
	? filemtime( __DIR__ . '/js/script.js' )
	: MY_PLUGIN_VERSION;

wp_enqueue_script( 'my-script', 'path/to/script.js', array(), $version );
```

### Load Order

Dependencies determine load order automatically. Scripts load in dependency order.

**Example Load Order:**

```php
// Register in any order - WordPress handles dependencies
wp_enqueue_script( 'script-c', 'c.js', array( 'script-b' ) );
wp_enqueue_script( 'script-a', 'a.js', array() );
wp_enqueue_script( 'script-b', 'b.js', array( 'script-a' ) );

// Load order: script-a → script-b → script-c
```

**Footer vs Header:**

```php
// Load in footer (default for scripts)
wp_enqueue_script(
	'my-script',
	'path/to/script.js',
	array(),
	'1.0.0',
	array( 'in_footer' => true ) // Modern syntax
);

// Load in header (legacy syntax, still works)
wp_enqueue_script(
	'my-script',
	'path/to/script.js',
	array(),
	'1.0.0',
	false // false = header, true = footer
);
```

**Styles Always Load in Header:**

```php
// Styles always load in <head>
wp_enqueue_style( 'my-style', 'path/to/style.css' );

// Media query support
wp_enqueue_style(
	'my-print-style',
	'path/to/print.css',
	array(),
	'1.0.0',
	'print' // Media type
);
```

---

## 3. Register and Deregister Assets Responsibly

### Registering Assets

**Register Without Enqueuing:**

```php
// Register script (doesn't load it yet)
wp_register_script(
	'my-library',
	'path/to/library.js',
	array( 'jquery' ),
	'1.0.0',
	true
);

// Later, enqueue it
wp_enqueue_script( 'my-library' );

// Or use it as a dependency
wp_enqueue_script(
	'my-script',
	'path/to/script.js',
	array( 'my-library' ), // Uses registered library
	'1.0.0'
);
```

**Benefits of Registration:**

- Reusable across multiple scripts
- Conditional loading
- Better dependency management

### Deregistering Assets

**Deregister Core Scripts (Use with Caution):**

```php
// ❌ BAD - Deregister core scripts without replacement
add_action( 'wp_enqueue_scripts', 'bad_deregister', 999 );
function bad_deregister() {
	wp_deregister_script( 'jquery' ); // Breaks other plugins!
}

// ✅ GOOD - Replace with custom version if needed
add_action( 'wp_enqueue_scripts', 'good_replace_jquery', 100 );
function good_replace_jquery() {
	wp_deregister_script( 'jquery' );
	wp_register_script(
		'jquery',
		'https://cdn.example.com/jquery.min.js',
		array(),
		'3.6.0'
	);
}
```

**Deregister Plugin/Theme Scripts:**

```php
// Remove another plugin's script (use carefully)
add_action( 'wp_enqueue_scripts', 'remove_plugin_script', 999 );
function remove_plugin_script() {
	wp_dequeue_script( 'other-plugin-script' );
	wp_deregister_script( 'other-plugin-script' );
}
```

**Dequeue vs Deregister:**

- `wp_dequeue_script()` - Removes from queue but keeps registration
- `wp_deregister_script()` - Completely removes registration

```php
// Dequeue (temporary removal)
wp_dequeue_script( 'some-script' );

// Deregister (permanent removal)
wp_deregister_script( 'some-script' );
```

---

## 4. Use Action and Filter Hooks Appropriately When Loading Assets

### Proper Hook Usage

**Front-end:**

```php
add_action( 'wp_enqueue_scripts', 'my_frontend_assets' );
```

**Admin:**

```php
add_action( 'admin_enqueue_scripts', 'my_admin_assets' );
function my_admin_assets( $hook ) {
	// $hook contains current admin page
	if ( 'post.php' === $hook || 'post-new.php' === $hook ) {
		wp_enqueue_script( 'my-post-editor-script', '...' );
	}
}
```

**Login:**

```php
add_action( 'login_enqueue_scripts', 'my_login_assets' );
```

**Block Editor:**

```php
add_action( 'enqueue_block_editor_assets', 'my_block_editor_assets' );
```

### Conditional Loading

**Check Context Before Loading:**

```php
add_action( 'wp_enqueue_scripts', 'conditional_assets' );
function conditional_assets() {
	// Only on single posts
	if ( is_single() ) {
		wp_enqueue_script( 'single-post-script', '...' );
	}

	// Only on specific page template
	if ( is_page_template( 'custom-template.php' ) ) {
		wp_enqueue_style( 'custom-template-style', '...' );
	}

	// Only for logged-in users
	if ( is_user_logged_in() ) {
		wp_enqueue_script( 'user-script', '...' );
	}
}
```

**Use Filters to Modify Assets:**

```php
// Modify script source
add_filter( 'script_loader_src', 'modify_script_src', 10, 2 );
function modify_script_src( $src, $handle ) {
	if ( 'my-script' === $handle ) {
		// Replace with CDN version
		$src = 'https://cdn.example.com/script.js';
	}
	return $src;
}

// Add attributes to scripts
add_filter( 'script_loader_tag', 'add_script_attributes', 10, 3 );
function add_script_attributes( $tag, $handle, $src ) {
	if ( 'my-script' === $handle ) {
		$tag = str_replace( '<script ', '<script defer ', $tag );
	}
	return $tag;
}
```

---

## 5. Understand Strategies for Plugin Dependency Management

### Dependency Detection

**Check if Script is Registered:**

```php
if ( wp_script_is( 'jquery', 'registered' ) ) {
	// jQuery is available
	wp_enqueue_script( 'my-script', '...', array( 'jquery' ) );
}
```

**Check if Script is Enqueued:**

```php
if ( wp_script_is( 'my-library', 'enqueued' ) ) {
	// Library is already loaded
}
```

### Plugin Dependency Strategies

**1. Declare Dependencies in Plugin Header:**

```php
/*
 * Plugin Name: My Plugin
 * Requires Plugins: another-plugin, yet-another-plugin
 */
```

**2. Check for Required Plugins:**

```php
add_action( 'admin_init', 'check_plugin_dependencies' );
function check_plugin_dependencies() {
	$required_plugins = array(
		'plugin-folder/plugin-file.php' => 'Plugin Name',
	);

	$missing = array();
	foreach ( $required_plugins as $plugin => $name ) {
		if ( ! is_plugin_active( $plugin ) ) {
			$missing[] = $name;
		}
	}

	if ( ! empty( $missing ) ) {
		add_action( 'admin_notices', function() use ( $missing ) {
			printf(
				'<div class="error"><p>%s</p></div>',
				sprintf(
					__( 'My Plugin requires: %s', 'my-plugin' ),
					implode( ', ', $missing )
				)
			);
		} );
	}
}
```

**3. Load Dependencies on Demand:**

```php
add_action( 'wp_enqueue_scripts', 'load_conditional_dependencies' );
function load_conditional_dependencies() {
	// Only load if other plugin's script isn't already loaded
	if ( ! wp_script_is( 'other-plugin-script', 'enqueued' ) ) {
		wp_enqueue_script( 'fallback-script', '...' );
	}
}
```

**4. Use Dependency Injection:**

```php
// Allow other plugins to provide dependencies
$dependency = apply_filters( 'my_plugin_dependency', 'default-value' );
wp_enqueue_script( 'my-script', '...', array( $dependency ) );
```

**5. Version Compatibility:**

```php
// Check plugin version
if ( defined( 'OTHER_PLUGIN_VERSION' ) ) {
	$required_version = '2.0.0';
	if ( version_compare( OTHER_PLUGIN_VERSION, $required_version, '<' ) ) {
		// Show warning or disable functionality
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Enqueue Functions:**
   - `wp_enqueue_script()` - Load JavaScript
   - `wp_enqueue_style()` - Load CSS
   - Use appropriate hooks: `wp_enqueue_scripts`, `admin_enqueue_scripts`, `login_enqueue_scripts`

2. **Dependencies:**
   - Specify in `$deps` array
   - WordPress handles load order automatically
   - Common: `jquery`, `wp-api`, `wp-blocks`

3. **Versioning:**
   - Use for cache busting
   - Options: string, filemtime, constant, null, false
   - Best: filemtime for dev, constant for production

4. **Registration:**
   - `wp_register_script()` - Register without loading
   - Allows reuse and conditional loading
   - `wp_deregister_script()` - Remove registration (use carefully)

5. **Dependency Management:**
   - Check with `wp_script_is()`
   - Declare in plugin header
   - Check for required plugins on activation
   - Load dependencies conditionally

---

## Additional Resources

- [Enqueuing Scripts and Styles - WordPress Developer Resources](https://developer.wordpress.org/themes/basics/including-css-javascript/)
- [wp_enqueue_script() - WordPress Codex](https://developer.wordpress.org/reference/functions/wp_enqueue_script/)
- [wp_enqueue_style() - WordPress Codex](https://developer.wordpress.org/reference/functions/wp_enqueue_style/)
- Core Files:
  - `wp-includes/functions.wp-scripts.php` - Script functions
  - `wp-includes/functions.wp-styles.php` - Style functions
  - `wp-includes/class-wp-scripts.php` - Scripts class
  - `wp-includes/class-wp-styles.php` - Styles class
