# 2.7 Correct Hook Use for Loading Plugin Code - Study Notes

## Overview

Loading plugin logic only in the proper context is essential for performance and functionality. This involves using hooks to defer execution until WordPress is ready, avoiding heavy operations on every request, and preventing execution during unintended contexts.

**Key Reference:** [Plugin API - WordPress Developer Resources](https://developer.wordpress.org/plugins/plugin-basics/)

---

## 1. Use Hooks to Defer Execution Until WordPress is Ready

### Common Initialization Hooks

**Hook Execution Order:**

1. `plugins_loaded` - Plugins are loaded
2. `init` - WordPress is initialized
3. `wp_loaded` - WordPress is fully loaded
4. `wp` - Main query is set up
5. `template_redirect` - Template is about to load

**Example - Proper Hook Usage:**

```php
// ✅ GOOD - Wait for WordPress to be ready
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	// WordPress is ready, safe to use functions
	register_post_type( 'my_cpt', array( /* ... */ ) );
}

// ❌ BAD - Runs too early, WordPress not ready
// This code runs immediately when plugin loads
register_post_type( 'my_cpt', array( /* ... */ ) );
```

### plugins_loaded Hook

**Use For:** Loading plugin code that doesn't depend on WordPress being fully initialized.

```php
add_action( 'plugins_loaded', 'my_plugin_early_init' );
function my_plugin_early_init() {
	// Load text domain
	load_plugin_textdomain( 'my-plugin', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );

	// Load dependencies
	require_once plugin_dir_path( __FILE__ ) . 'includes/class-dependency.php';
}
```

### init Hook

**Use For:** Registering post types, taxonomies, and other core functionality.

```php
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	// Register post types
	register_post_type( 'my_cpt', array(
		'public' => true,
		'label' => 'My CPT',
	) );

	// Register taxonomies
	register_taxonomy( 'my_taxonomy', 'my_cpt', array(
		'public' => true,
	) );

	// Register rewrite rules
	add_rewrite_rule( '^custom/([^/]+)/?$', 'index.php?custom=$matches[1]', 'top' );
}
```

### wp_loaded Hook

**Use For:** Code that needs WordPress to be fully loaded but before main query.

```php
add_action( 'wp_loaded', 'my_plugin_wp_loaded' );
function my_plugin_wp_loaded() {
	// WordPress is fully loaded
	// Safe to use all WordPress functions
}
```

### Context-Specific Hooks

**Admin Only:**

```php
add_action( 'admin_init', 'my_plugin_admin_init' );
function my_plugin_admin_init() {
	// Only runs in admin area
	register_setting( 'my_plugin_settings', 'my_plugin_option' );
}
```

**Frontend Only:**

```php
add_action( 'wp', 'my_plugin_frontend_init' );
function my_plugin_frontend_init() {
	// Only runs on frontend
	if ( is_single() ) {
		// Single post specific code
	}
}
```

---

## 2. Avoid Running License Checks, API Calls, or Heavy Logic on Every Request

### Conditional Execution

**Check Context Before Heavy Operations:**

```php
// ❌ BAD - Runs on every request
add_action( 'init', 'my_plugin_bad_init' );
function my_plugin_bad_init() {
	// License check on every page load
	$license = check_license_status(); // Expensive API call!

	// Heavy database query
	$data = get_expensive_data();
}

// ✅ GOOD - Only when needed
add_action( 'admin_init', 'my_plugin_good_init' );
function my_plugin_good_init() {
	// Only check license in admin, and cache result
	$license_status = get_transient( 'my_plugin_license_status' );

	if ( false === $license_status ) {
		$license_status = check_license_status();
		set_transient( 'my_plugin_license_status', $license_status, HOUR_IN_SECONDS );
	}
}
```

### Cache Expensive Operations

**Use Transients:**

```php
add_action( 'init', 'my_plugin_load_data' );
function my_plugin_load_data() {
	$cache_key = 'my_plugin_expensive_data';
	$data = get_transient( $cache_key );

	if ( false === $data ) {
		// Expensive operation
		$data = fetch_data_from_api();

		// Cache for 1 hour
		set_transient( $cache_key, $data, HOUR_IN_SECONDS );
	}

	return $data;
}
```

### Defer Heavy Operations

**Use Shutdown Hook:**

```php
// ✅ GOOD - Defer to end of request
add_action( 'shutdown', 'my_plugin_deferred_task' );
function my_plugin_deferred_task() {
	// Heavy operation that doesn't block page load
	process_background_tasks();
}
```

**Use Scheduled Events:**

```php
// Schedule instead of running immediately
add_action( 'init', 'my_plugin_schedule_tasks' );
function my_plugin_schedule_tasks() {
	if ( ! wp_next_scheduled( 'my_plugin_daily_task' ) ) {
		wp_schedule_event( time(), 'daily', 'my_plugin_daily_task' );
	}
}

add_action( 'my_plugin_daily_task', 'my_plugin_do_daily_task' );
function my_plugin_do_daily_task() {
	// Heavy operation runs once per day
	update_license_status();
	sync_external_data();
}
```

---

## 3. Prevent Execution During Unintended Contexts (REST API Calls, WP-CLI)

### Detect REST API Requests

**Check for REST API:**

```php
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	// Skip if REST API request
	if ( defined( 'REST_REQUEST' ) && REST_REQUEST ) {
		return;
	}

	// Or use helper function (WordPress 4.7+)
	if ( wp_is_serving_rest_request() ) {
		return;
	}

	// Normal initialization
	register_post_type( 'my_cpt', array( /* ... */ ) );
}
```

**Core Implementation:**
```3467:3489:wordpress/wp-includes/rest-api.php
function wp_is_rest_endpoint() {
	/* @var WP_REST_Server $wp_rest_server */
	global $wp_rest_server;

	// Check whether this is a standalone REST request.
	$is_rest_endpoint = wp_is_serving_rest_request();
	if ( ! $is_rest_endpoint ) {
		// Otherwise, check whether an internal REST request is currently being handled.
		$is_rest_endpoint = isset( $wp_rest_server )
			&& $wp_rest_server->is_dispatching();
	}

	/**
	 * Filters whether a REST endpoint request is currently being handled.
	 *
	 * This may be a standalone REST API request, or an internal request dispatched from within a regular page load.
	 *
	 * @since 6.5.0
	 *
	 * @param bool $is_request_endpoint Whether a REST endpoint request is currently being handled.
	 */
	return (bool) apply_filters( 'wp_is_rest_endpoint', $is_rest_endpoint );
}
```

### Detect WP-CLI Context

**Check for WP-CLI:**

```php
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	// Skip if WP-CLI
	if ( defined( 'WP_CLI' ) && WP_CLI ) {
		return;
	}

	// Normal initialization
	register_post_type( 'my_cpt', array( /* ... */ ) );
}
```

**WP-CLI Specific Code:**

```php
// Only register WP-CLI commands in WP-CLI context
if ( defined( 'WP_CLI' ) && WP_CLI ) {
	require_once plugin_dir_path( __FILE__ ) . 'includes/class-wp-cli-commands.php';
	WP_CLI::add_command( 'my-plugin', 'My_Plugin_CLI_Commands' );
}
```

### Detect AJAX Requests

**Check for AJAX:**

```php
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	// Skip if AJAX request (unless it's our AJAX)
	if ( wp_doing_ajax() && ! isset( $_REQUEST['action'] ) || 'my_plugin_action' !== $_REQUEST['action'] ) {
		return;
	}

	// Normal initialization
}
```

**AJAX-Specific Hook:**

```php
// Only register AJAX handlers for our actions
add_action( 'wp_ajax_my_plugin_action', 'my_plugin_ajax_handler' );
add_action( 'wp_ajax_nopriv_my_plugin_action', 'my_plugin_ajax_handler' );

function my_plugin_ajax_handler() {
	// AJAX handler code
	wp_send_json_success( array( 'message' => 'Success' ) );
}
```

### Detect Cron Requests

**Check for Cron:**

```php
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	// Skip if WP-Cron
	if ( defined( 'DOING_CRON' ) && DOING_CRON ) {
		return;
	}

	// Normal initialization
}
```

---

## 4. Scope Code Correctly to Admin, Frontend, or Login Contexts

### Admin Context

**Admin-Only Code:**

```php
// Only in admin
if ( is_admin() ) {
	add_action( 'admin_init', 'my_plugin_admin_init' );
	add_action( 'admin_menu', 'my_plugin_admin_menu' );
	add_action( 'admin_enqueue_scripts', 'my_plugin_admin_assets' );
}

function my_plugin_admin_init() {
	// Admin initialization
}

function my_plugin_admin_menu() {
	add_options_page(
		'My Plugin Settings',
		'My Plugin',
		'manage_options',
		'my-plugin',
		'my_plugin_settings_page'
	);
}
```

**Specific Admin Pages:**

```php
add_action( 'admin_enqueue_scripts', 'my_plugin_admin_assets' );
function my_plugin_admin_assets( $hook ) {
	// Only on specific admin pages
	if ( 'post.php' !== $hook && 'post-new.php' !== $hook ) {
		return;
	}

	wp_enqueue_script( 'my-plugin-admin', '...' );
}
```

### Frontend Context

**Frontend-Only Code:**

```php
// Only on frontend
if ( ! is_admin() ) {
	add_action( 'wp', 'my_plugin_frontend_init' );
	add_action( 'wp_enqueue_scripts', 'my_plugin_frontend_assets' );
	add_action( 'wp_head', 'my_plugin_frontend_head' );
}

function my_plugin_frontend_init() {
	// Frontend initialization
	if ( is_single() ) {
		// Single post specific
	}
}
```

### Login Context

**Login Page Code:**

```php
add_action( 'login_enqueue_scripts', 'my_plugin_login_assets' );
add_action( 'login_head', 'my_plugin_login_head' );

function my_plugin_login_assets() {
	wp_enqueue_style( 'my-plugin-login', '...' );
}
```

### Combined Context Detection

**Helper Function:**

```php
function my_plugin_get_context() {
	if ( defined( 'WP_CLI' ) && WP_CLI ) {
		return 'cli';
	}

	if ( wp_is_serving_rest_request() ) {
		return 'rest';
	}

	if ( wp_doing_ajax() ) {
		return 'ajax';
	}

	if ( defined( 'DOING_CRON' ) && DOING_CRON ) {
		return 'cron';
	}

	if ( is_admin() ) {
		return 'admin';
	}

	return 'frontend';
}

// Use context
add_action( 'init', 'my_plugin_init' );
function my_plugin_init() {
	$context = my_plugin_get_context();

	switch ( $context ) {
		case 'admin':
			my_plugin_admin_init();
			break;
		case 'frontend':
			my_plugin_frontend_init();
			break;
		case 'rest':
		case 'ajax':
		case 'cli':
		case 'cron':
			// Skip or handle differently
			return;
	}
}
```

---

## Exam Tips

### Key Points to Remember

1. **Hook Execution Order:**
   - `plugins_loaded` → `init` → `wp_loaded` → `wp` → `template_redirect`
   - Use appropriate hook for your needs

2. **Avoid Heavy Operations:**
   - Cache expensive operations with transients
   - Defer to shutdown hook or scheduled events
   - Only run when needed

3. **Context Detection:**
   - REST API: `wp_is_serving_rest_request()` or `REST_REQUEST` constant
   - WP-CLI: `WP_CLI` constant
   - AJAX: `wp_doing_ajax()`
   - Cron: `DOING_CRON` constant
   - Admin: `is_admin()`

4. **Scope Code:**
   - Admin: `is_admin()`, `admin_init`, `admin_enqueue_scripts`
   - Frontend: `! is_admin()`, `wp_enqueue_scripts`
   - Login: `login_enqueue_scripts`

---

## Additional Resources

- [Plugin API - WordPress Developer Resources](https://developer.wordpress.org/plugins/plugin-basics/)
- [Action Reference - WordPress Codex](https://codex.wordpress.org/Plugin_API/Action_Reference)
- [REST API - WordPress Developer Resources](https://developer.wordpress.org/rest-api/)
- [WP-CLI Handbook](https://wp-cli.org/)
