# 8.3 Identifying and Cleaning Corrupted Data - Study Notes

## Overview

Identifying and cleaning corrupted or compromised database entries is essential for maintaining WordPress site integrity. Understanding how to detect malformed content, orphaned metadata, and inconsistent taxonomy relationships is critical for disaster recovery.

**Key Reference:** [Database Description - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/upgrade/database/)

---

## 1. Finding Malformed Content

### Detect Corrupted Post Content

**Check for Invalid Post Data:**
```sql
-- Find posts with NULL or empty titles
SELECT ID, post_title, post_type, post_status
FROM wp_posts
WHERE post_title IS NULL
   OR post_title = ''
   OR post_title = '0';

-- Find posts with invalid post_status
SELECT ID, post_title, post_status
FROM wp_posts
WHERE post_status NOT IN ('publish', 'draft', 'pending', 'private', 'trash', 'auto-draft', 'inherit');

-- Find posts with invalid post_type
SELECT ID, post_title, post_type
FROM wp_posts
WHERE post_type NOT IN ('post', 'page', 'attachment', 'revision', 'nav_menu_item', 'custom_css', 'customize_changeset', 'oembed_cache', 'user_request', 'wp_block');
```

**WP-CLI Detection:**
```bash
# Find posts with issues
wp db query "SELECT ID, post_title FROM wp_posts WHERE post_title IS NULL OR post_title = ''"

# Find posts with invalid dates
wp db query "SELECT ID, post_title, post_date FROM wp_posts WHERE post_date = '0000-00-00 00:00:00'"

# Find posts with invalid GUID
wp db query "SELECT ID, post_title, guid FROM wp_posts WHERE guid IS NULL OR guid = ''"
```

**PHP Detection Script:**
```php
<?php
// detect-corrupted-posts.php

require_once 'wp-load.php';

global $wpdb;

// Find posts with NULL titles
$corrupted_posts = $wpdb->get_results(
	"SELECT ID, post_title, post_type, post_status
	FROM {$wpdb->posts}
	WHERE post_title IS NULL
	   OR post_title = ''
	   OR post_title = '0'"
);

if ( ! empty( $corrupted_posts ) ) {
	echo "Found " . count( $corrupted_posts ) . " posts with corrupted titles:\n";
	foreach ( $corrupted_posts as $post ) {
		echo "Post ID: {$post->ID}, Type: {$post->post_type}, Status: {$post->post_status}\n";
	}
}

// Find posts with invalid post_date
$invalid_dates = $wpdb->get_results(
	"SELECT ID, post_title, post_date
	FROM {$wpdb->posts}
	WHERE post_date = '0000-00-00 00:00:00'
	   OR post_date IS NULL"
);

if ( ! empty( $invalid_dates ) ) {
	echo "\nFound " . count( $invalid_dates ) . " posts with invalid dates:\n";
	foreach ( $invalid_dates as $post ) {
		echo "Post ID: {$post->ID}, Date: {$post->post_date}\n";
	}
}
```

### Detect Corrupted Serialized Data

**Check Serialized Options:**
```sql
-- Find potentially corrupted serialized data
SELECT option_name, option_value
FROM wp_options
WHERE option_value LIKE 'a:%'
   OR option_value LIKE 'O:%'
   OR option_value LIKE 's:%';
```

**PHP Serialization Check:**
```php
<?php
// check-serialized-data.php

require_once 'wp-load.php';

global $wpdb;

// Check options table
$options = $wpdb->get_results(
	"SELECT option_name, option_value
	FROM {$wpdb->options}
	WHERE option_value LIKE 'a:%'
	   OR option_value LIKE 'O:%'"
);

$corrupted = array();

foreach ( $options as $option ) {
	if ( is_serialized( $option->option_value ) ) {
		$unserialized = @unserialize( $option->option_value );
		if ( false === $unserialized && $option->option_value !== serialize( false ) ) {
			$corrupted[] = $option->option_name;
		}
	}
}

if ( ! empty( $corrupted ) ) {
	echo "Found corrupted serialized data in options:\n";
	foreach ( $corrupted as $option_name ) {
		echo "  - $option_name\n";
	}
}
```

---

## 2. Diagnosing Inconsistent Taxonomy Relationships

### Find Orphaned Term Relationships

**Detect Orphaned Relationships:**
```sql
-- Find term relationships without valid posts
SELECT tr.object_id, tr.term_taxonomy_id, tt.taxonomy
FROM wp_term_relationships tr
LEFT JOIN wp_posts p ON tr.object_id = p.ID
LEFT JOIN wp_term_taxonomy tt ON tr.term_taxonomy_id = tt.term_taxonomy_id
WHERE p.ID IS NULL;

-- Find term relationships without valid terms
SELECT tr.object_id, tr.term_taxonomy_id
FROM wp_term_relationships tr
LEFT JOIN wp_term_taxonomy tt ON tr.term_taxonomy_id = tt.term_taxonomy_id
WHERE tt.term_taxonomy_id IS NULL;

-- Find terms without taxonomy
SELECT t.term_id, t.name
FROM wp_terms t
LEFT JOIN wp_term_taxonomy tt ON t.term_id = tt.term_id
WHERE tt.term_id IS NULL;
```

**WP-CLI Detection:**
```bash
# Count orphaned term relationships
wp db query "SELECT COUNT(*) FROM wp_term_relationships tr LEFT JOIN wp_posts p ON tr.object_id = p.ID WHERE p.ID IS NULL"

# List orphaned relationships
wp db query "SELECT tr.object_id, tr.term_taxonomy_id FROM wp_term_relationships tr LEFT JOIN wp_posts p ON tr.object_id = p.ID WHERE p.ID IS NULL"
```

**PHP Detection Script:**
```php
<?php
// detect-orphaned-taxonomies.php

require_once 'wp-load.php';

global $wpdb;

// Find orphaned term relationships
$orphaned_relationships = $wpdb->get_results(
	"SELECT tr.object_id, tr.term_taxonomy_id, tt.taxonomy
	FROM {$wpdb->term_relationships} tr
	LEFT JOIN {$wpdb->posts} p ON tr.object_id = p.ID
	LEFT JOIN {$wpdb->term_taxonomy} tt ON tr.term_taxonomy_id = tt.term_taxonomy_id
	WHERE p.ID IS NULL"
);

if ( ! empty( $orphaned_relationships ) ) {
	echo "Found " . count( $orphaned_relationships ) . " orphaned term relationships:\n";
	foreach ( $orphaned_relationships as $rel ) {
		echo "  Object ID: {$rel->object_id}, Taxonomy: {$rel->taxonomy}\n";
	}
}

// Find terms without taxonomy
$orphaned_terms = $wpdb->get_results(
	"SELECT t.term_id, t.name
	FROM {$wpdb->terms} t
	LEFT JOIN {$wpdb->term_taxonomy} tt ON t.term_id = tt.term_id
	WHERE tt.term_id IS NULL"
);

if ( ! empty( $orphaned_terms ) ) {
	echo "\nFound " . count( $orphaned_terms ) . " orphaned terms:\n";
	foreach ( $orphaned_terms as $term ) {
		echo "  Term ID: {$term->term_id}, Name: {$term->name}\n";
	}
}
```

### Find Invalid Taxonomy Counts

**Check Taxonomy Counts:**
```sql
-- Find taxonomies with incorrect counts
SELECT tt.term_taxonomy_id, tt.term_id, tt.taxonomy, tt.count,
       (SELECT COUNT(*) FROM wp_term_relationships WHERE term_taxonomy_id = tt.term_taxonomy_id) as actual_count
FROM wp_term_taxonomy tt
HAVING tt.count != actual_count;
```

**Fix Taxonomy Counts:**
```php
<?php
// fix-taxonomy-counts.php

require_once 'wp-load.php';

global $wpdb;

// Get all taxonomies
$taxonomies = $wpdb->get_results(
	"SELECT term_taxonomy_id, term_id, taxonomy
	FROM {$wpdb->term_taxonomy}"
);

foreach ( $taxonomies as $taxonomy ) {
	// Count actual relationships
	$actual_count = $wpdb->get_var(
		$wpdb->prepare(
			"SELECT COUNT(*)
			FROM {$wpdb->term_relationships}
			WHERE term_taxonomy_id = %d",
			$taxonomy->term_taxonomy_id
		)
	);

	// Update count if different
	if ( $taxonomy->count != $actual_count ) {
		$wpdb->update(
			$wpdb->term_taxonomy,
			array( 'count' => $actual_count ),
			array( 'term_taxonomy_id' => $taxonomy->term_taxonomy_id )
		);
		echo "Updated {$taxonomy->taxonomy} term {$taxonomy->term_id}: {$taxonomy->count} -> {$actual_count}\n";
	}
}
```

---

## 3. Cleaning Corrupted Data

### Clean Orphaned Post Meta

**Find Orphaned Post Meta:**
```sql
-- Find post meta without valid posts
SELECT pm.meta_id, pm.post_id, pm.meta_key
FROM wp_postmeta pm
LEFT JOIN wp_posts p ON pm.post_id = p.ID
WHERE p.ID IS NULL;
```

**Clean Orphaned Post Meta:**
```php
<?php
// clean-orphaned-post-meta.php

require_once 'wp-load.php';

global $wpdb;

// Find orphaned post meta
$orphaned_meta = $wpdb->get_results(
	"SELECT pm.meta_id, pm.post_id, pm.meta_key
	FROM {$wpdb->postmeta} pm
	LEFT JOIN {$wpdb->posts} p ON pm.post_id = p.ID
	WHERE p.ID IS NULL"
);

if ( empty( $orphaned_meta ) ) {
	echo "No orphaned post meta found.\n";
	exit;
}

echo "Found " . count( $orphaned_meta ) . " orphaned post meta entries.\n";
echo "Deleting...\n";

// Delete orphaned meta
$deleted = $wpdb->query(
	"DELETE pm FROM {$wpdb->postmeta} pm
	LEFT JOIN {$wpdb->posts} p ON pm.post_id = p.ID
	WHERE p.ID IS NULL"
);

echo "Deleted {$deleted} orphaned post meta entries.\n";
```

### Clean Orphaned Comment Meta

**Find and Clean Orphaned Comment Meta:**
```php
<?php
// clean-orphaned-comment-meta.php

require_once 'wp-load.php';

global $wpdb;

// Find orphaned comment meta
$orphaned_meta = $wpdb->get_results(
	"SELECT cm.meta_id, cm.comment_id, cm.meta_key
	FROM {$wpdb->commentmeta} cm
	LEFT JOIN {$wpdb->comments} c ON cm.comment_id = c.comment_ID
	WHERE c.comment_ID IS NULL"
);

if ( ! empty( $orphaned_meta ) ) {
	echo "Found " . count( $orphaned_meta ) . " orphaned comment meta entries.\n";

	// Delete orphaned meta
	$deleted = $wpdb->query(
		"DELETE cm FROM {$wpdb->commentmeta} cm
		LEFT JOIN {$wpdb->comments} c ON cm.comment_id = c.comment_ID
		WHERE c.comment_ID IS NULL"
	);

	echo "Deleted {$deleted} orphaned comment meta entries.\n";
} else {
	echo "No orphaned comment meta found.\n";
}
```

### Clean Orphaned User Meta

**Find and Clean Orphaned User Meta:**
```php
<?php
// clean-orphaned-user-meta.php

require_once 'wp-load.php';

global $wpdb;

// Find orphaned user meta
$orphaned_meta = $wpdb->get_results(
	"SELECT um.umeta_id, um.user_id, um.meta_key
	FROM {$wpdb->usermeta} um
	LEFT JOIN {$wpdb->users} u ON um.user_id = u.ID
	WHERE u.ID IS NULL"
);

if ( ! empty( $orphaned_meta ) ) {
	echo "Found " . count( $orphaned_meta ) . " orphaned user meta entries.\n";

	// Delete orphaned meta
	$deleted = $wpdb->query(
		"DELETE um FROM {$wpdb->usermeta} um
		LEFT JOIN {$wpdb->users} u ON um.user_id = u.ID
		WHERE u.ID IS NULL"
	);

	echo "Deleted {$deleted} orphaned user meta entries.\n";
} else {
	echo "No orphaned user meta found.\n";
}
```

### Clean Orphaned Term Relationships

**Remove Orphaned Term Relationships:**
```php
<?php
// clean-orphaned-term-relationships.php

require_once 'wp-load.php';

global $wpdb;

// Find orphaned term relationships
$orphaned_rels = $wpdb->get_results(
	"SELECT tr.object_id, tr.term_taxonomy_id
	FROM {$wpdb->term_relationships} tr
	LEFT JOIN {$wpdb->posts} p ON tr.object_id = p.ID
	WHERE p.ID IS NULL"
);

if ( ! empty( $orphaned_rels ) ) {
	echo "Found " . count( $orphaned_rels ) . " orphaned term relationships.\n";

	// Delete orphaned relationships
	$deleted = $wpdb->query(
		"DELETE tr FROM {$wpdb->term_relationships} tr
		LEFT JOIN {$wpdb->posts} p ON tr.object_id = p.ID
		WHERE p.ID IS NULL"
	);

	echo "Deleted {$deleted} orphaned term relationships.\n";

	// Update taxonomy counts
	wp_update_term_count_now( array(), 'category' );
	wp_update_term_count_now( array(), 'post_tag' );

	echo "Updated taxonomy counts.\n";
} else {
	echo "No orphaned term relationships found.\n";
}
```

---

## 4. Repairing Corrupted Content

### Fix Corrupted Post Titles

**Repair NULL or Empty Titles:**
```php
<?php
// fix-corrupted-post-titles.php

require_once 'wp-load.php';

global $wpdb;

// Find posts with corrupted titles
$corrupted_posts = $wpdb->get_results(
	"SELECT ID, post_title, post_type, post_status
	FROM {$wpdb->posts}
	WHERE (post_title IS NULL OR post_title = '' OR post_title = '0')
	   AND post_type NOT IN ('revision', 'nav_menu_item')"
);

if ( empty( $corrupted_posts ) ) {
	echo "No corrupted post titles found.\n";
	exit;
}

echo "Found " . count( $corrupted_posts ) . " posts with corrupted titles.\n";

foreach ( $corrupted_posts as $post ) {
	// Generate default title
	$new_title = "Untitled {$post->post_type} #{$post->ID}";

	// Update post
	$wpdb->update(
		$wpdb->posts,
		array( 'post_title' => $new_title ),
		array( 'ID' => $post->ID )
	);

	echo "Fixed post ID {$post->ID}: '{$new_title}'\n";
}
```

### Fix Invalid Post Dates

**Repair Invalid Post Dates:**
```php
<?php
// fix-invalid-post-dates.php

require_once 'wp-load.php';

global $wpdb;

// Find posts with invalid dates
$invalid_dates = $wpdb->get_results(
	"SELECT ID, post_title, post_date, post_date_gmt
	FROM {$wpdb->posts}
	WHERE post_date = '0000-00-00 00:00:00'
	   OR post_date IS NULL"
);

if ( empty( $invalid_dates ) ) {
	echo "No posts with invalid dates found.\n";
	exit;
}

echo "Found " . count( $invalid_dates ) . " posts with invalid dates.\n";

$current_time = current_time( 'mysql' );
$current_time_gmt = current_time( 'mysql', 1 );

foreach ( $invalid_dates as $post ) {
	// Use current time or post modified date
	$new_date = $post->post_modified && $post->post_modified !== '0000-00-00 00:00:00'
		? $post->post_modified
		: $current_time;

	$new_date_gmt = $post->post_modified_gmt && $post->post_modified_gmt !== '0000-00-00 00:00:00'
		? $post->post_modified_gmt
		: $current_time_gmt;

	// Update post
	$wpdb->update(
		$wpdb->posts,
		array(
			'post_date' => $new_date,
			'post_date_gmt' => $new_date_gmt,
		),
		array( 'ID' => $post->ID )
	);

	echo "Fixed post ID {$post->ID}: date set to {$new_date}\n";
}
```

### Fix Corrupted Serialized Data

**Repair Serialized Options:**
```php
<?php
// fix-serialized-options.php

require_once 'wp-load.php';

global $wpdb;

// Get all options with serialized data
$options = $wpdb->get_results(
	"SELECT option_name, option_value
	FROM {$wpdb->options}
	WHERE option_value LIKE 'a:%'
	   OR option_value LIKE 'O:%'"
);

$fixed = 0;

foreach ( $options as $option ) {
	if ( ! is_serialized( $option->option_value ) ) {
		continue;
	}

	$unserialized = @unserialize( $option->option_value );

	// If unserialize failed, try to fix
	if ( false === $unserialized && $option->option_value !== serialize( false ) ) {
		// Try to repair by removing null bytes or fixing encoding
		$cleaned = preg_replace( '/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/', '', $option->option_value );

		$repaired = @unserialize( $cleaned );

		if ( false !== $repaired ) {
			// Update with repaired value
			$wpdb->update(
				$wpdb->options,
				array( 'option_value' => serialize( $repaired ) ),
				array( 'option_name' => $option->option_name )
			);
			echo "Fixed option: {$option->option_name}\n";
			$fixed++;
		} else {
			// If can't repair, delete or set to default
			echo "Cannot repair option: {$option->option_name}, deleting\n";
			$wpdb->delete(
				$wpdb->options,
				array( 'option_name' => $option->option_name )
			);
		}
	}
}

echo "Fixed {$fixed} corrupted options.\n";
```

---

## 5. Documenting and Validating Cleanup Actions

### Create Cleanup Log

**Logging Cleanup Actions:**
```php
<?php
// cleanup-with-logging.php

require_once 'wp-load.php';

global $wpdb;

$log_file = WP_CONTENT_DIR . '/cleanup-log-' . date( 'Y-m-d-H-i-s' ) . '.txt';

function log_cleanup( $message ) {
	global $log_file;
	$timestamp = date( 'Y-m-d H:i:s' );
	file_put_contents( $log_file, "[{$timestamp}] {$message}\n", FILE_APPEND );
	echo "{$message}\n";
}

log_cleanup( "Starting cleanup process" );

// Backup before cleanup
$backup_file = WP_CONTENT_DIR . '/backup-before-cleanup-' . date( 'YmdHis' ) . '.sql';
exec( "wp db export {$backup_file}" );
log_cleanup( "Backup created: {$backup_file}" );

// Clean orphaned post meta
$orphaned_meta = $wpdb->get_var(
	"SELECT COUNT(*)
	FROM {$wpdb->postmeta} pm
	LEFT JOIN {$wpdb->posts} p ON pm.post_id = p.ID
	WHERE p.ID IS NULL"
);

if ( $orphaned_meta > 0 ) {
	$deleted = $wpdb->query(
		"DELETE pm FROM {$wpdb->postmeta} pm
		LEFT JOIN {$wpdb->posts} p ON pm.post_id = p.ID
		WHERE p.ID IS NULL"
	);
	log_cleanup( "Deleted {$deleted} orphaned post meta entries" );
}

// Clean orphaned term relationships
$orphaned_rels = $wpdb->get_var(
	"SELECT COUNT(*)
	FROM {$wpdb->term_relationships} tr
	LEFT JOIN {$wpdb->posts} p ON tr.object_id = p.ID
	WHERE p.ID IS NULL"
);

if ( $orphaned_rels > 0 ) {
	$deleted = $wpdb->query(
		"DELETE tr FROM {$wpdb->term_relationships} tr
		LEFT JOIN {$wpdb->posts} p ON tr.object_id = p.ID
		WHERE p.ID IS NULL"
	);
	log_cleanup( "Deleted {$deleted} orphaned term relationships" );
}

log_cleanup( "Cleanup process completed" );
log_cleanup( "Log file: {$log_file}" );
```

### Validate After Cleanup

**Post-Cleanup Validation:**
```bash
#!/bin/bash
# validate-after-cleanup.sh

echo "Validating database after cleanup..."

# Check for remaining orphaned data
ORPHANED_META=$(wp db query "SELECT COUNT(*) FROM wp_postmeta pm LEFT JOIN wp_posts p ON pm.post_id = p.ID WHERE p.ID IS NULL" --skip-column-names)

if [ "$ORPHANED_META" -eq 0 ]; then
	echo "✓ No orphaned post meta"
else
	echo "✗ WARNING: Still found $ORPHANED_META orphaned post meta entries"
fi

# Check database integrity
if wp db check; then
	echo "✓ Database integrity check passed"
else
	echo "✗ ERROR: Database integrity check failed"
	exit 1
fi

# Verify WordPress functionality
if wp core verify-checksums; then
	echo "✓ WordPress core checksums verified"
else
	echo "✗ WARNING: Core checksum verification failed"
fi

echo "Validation complete"
```

---

## Exam Tips

### Key Points to Remember

1. **Detecting Corrupted Data:**
   - Check for NULL/empty values in required fields
   - Verify serialized data integrity
   - Check for invalid dates (0000-00-00)
   - Validate foreign key relationships

2. **Orphaned Data Types:**
   - Post meta without posts
   - Comment meta without comments
   - User meta without users
   - Term relationships without posts/terms

3. **Taxonomy Issues:**
   - Orphaned term relationships
   - Terms without taxonomy
   - Incorrect taxonomy counts
   - Missing term taxonomy entries

4. **Cleaning Process:**
   - Always backup before cleanup
   - Use LEFT JOIN to find orphans
   - Delete orphaned entries carefully
   - Update counts after cleanup

5. **Repairing Corrupted Content:**
   - Fix NULL titles with defaults
   - Repair invalid dates
   - Fix broken serialized data
   - Validate after repairs

6. **Documentation:**
   - Log all cleanup actions
   - Document what was cleaned
   - Keep backup of pre-cleanup state
   - Validate after cleanup

---

## Additional Resources

- [Database Description - WordPress Developer Resources](https://developer.wordpress.org/advanced-administration/upgrade/database/)
- [WP-CLI Database Commands](https://wp-cli.org/commands/db/)
- [WordPress Database Schema](https://codex.wordpress.org/Database_Description)
- Core Files:
  - `wp-includes/wp-db.php` - Database class
  - `wp-admin/includes/upgrade.php` - Database upgrade functions
